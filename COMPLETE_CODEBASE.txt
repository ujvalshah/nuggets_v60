
================================================================================
NUGGETS V60 - COMPLETE FRONTEND CODEBASE
Generated: 2025-12-10 12:37:15
================================================================================

This file contains ALL source code files from the frontend codebase.
Each file is separated by a clear delimiter.

================================================================================

================================================================================
FILE: src\admin\auth\adminPermissions.ts
================================================================================

import { AdminRole, AdminPermission } from '../types/admin';
import { User } from '../../types/user'; // Frontend User Type

// Define capability sets
const ROLE_PERMISSIONS: Record<AdminRole, AdminPermission[]> = {
  user: [], // Regular users have no admin access
  
  admin: [
    'admin.access',
    'admin.users.view',
    'admin.users.suspend', // Can suspend, but maybe not change role
    'admin.nuggets.view',
    'admin.nuggets.hide',
    'admin.collections.view',
    'admin.collections.edit',
    'admin.tags.manage',
    'admin.config.manage',
  ],
  
  superadmin: [
    'admin.access',
    'admin.users.view',
    'admin.users.edit',
    'admin.users.suspend',
    'admin.nuggets.view',
    'admin.nuggets.hide',
    'admin.nuggets.delete', // Only superadmin can hard delete
    'admin.collections.view',
    'admin.collections.edit',
    'admin.tags.manage',
    'admin.config.manage',
  ]
};

/**
 * Checks if a user has a specific permission.
 * Falls back to 'user' role if user object is missing or role is unrecognized.
 */
export const checkPermission = (user: User | null | undefined, permission: AdminPermission): boolean => {
  if (!user) return false;
  
  // Map frontend roles to admin roles
  // Note: Your app currently uses 'admin' | 'user' strings. 
  // We treat 'admin' as 'superadmin' for this stub unless you have a specific superadmin flag.
  const userRole: AdminRole = (user.role === 'admin') ? 'superadmin' : 'user';
  
  const allowed = ROLE_PERMISSIONS[userRole] || [];
  return allowed.includes(permission);
};





================================================================================
FILE: src\admin\components\AdminDrawer.tsx
================================================================================

import React, { useEffect } from 'react';
import { createPortal } from 'react-dom';
import { X } from 'lucide-react';

interface AdminDrawerProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  footer?: React.ReactNode;
  width?: 'md' | 'lg' | 'xl';
}

export const AdminDrawer: React.FC<AdminDrawerProps> = ({ 
  isOpen, 
  onClose, 
  title, 
  children, 
  footer,
  width = 'md' 
}) => {
  useEffect(() => {
    if (isOpen) document.body.style.overflow = 'hidden';
    else document.body.style.overflow = 'unset';
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen]);

  useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [onClose]);

  if (!isOpen) return null;

  const widthClasses = {
    md: 'max-w-md',
    lg: 'max-w-lg',
    xl: 'max-w-2xl'
  };

  return createPortal(
    <div className="fixed inset-0 z-[60] flex justify-end">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm animate-in fade-in duration-300"
        onClick={onClose}
      />
      
      {/* Drawer */}
      <div className={`
        relative w-full ${widthClasses[width]} h-full bg-white dark:bg-slate-900 
        shadow-2xl flex flex-col border-l border-slate-200 dark:border-slate-800
        animate-in slide-in-from-right duration-300 ease-out
      `}>
        
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100 dark:border-slate-800">
          <h3 className="text-lg font-bold text-slate-900 dark:text-white">{title}</h3>
          <button 
            onClick={onClose}
            className="p-1 text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
          >
            <X size={20} />
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto custom-scrollbar p-6">
          {children}
        </div>

        {/* Footer */}
        {footer && (
          <div className="px-6 py-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 flex justify-end gap-3">
            {footer}
          </div>
        )}
      </div>
    </div>,
    document.body
  );
};





================================================================================
FILE: src\admin\components\AdminPageHeader.tsx
================================================================================

import React from 'react';

interface AdminPageHeaderProps {
  title: string;
  description?: string;
  action?: React.ReactNode;
}

export const AdminPageHeader: React.FC<AdminPageHeaderProps> = ({ title, description, action }) => {
  return (
    <div className="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
      <div>
        <h1 className="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">
          {title}
        </h1>
        {description && (
          <p className="text-slate-500 dark:text-slate-400 mt-1 max-w-2xl">
            {description}
          </p>
        )}
      </div>
      {action && (
        <div className="shrink-0">
          {action}
        </div>
      )}
    </div>
  );
};





================================================================================
FILE: src\admin\components\AdminSidebar.tsx
================================================================================

import React from 'react';
import { NavLink } from 'react-router-dom';
import { LayoutDashboard, Users, FileText, Layers, Hash, Settings, LogOut, Flag, Activity, MessageSquare, Download, Scale } from 'lucide-react';
import { useAuth } from '../../hooks/useAuth';

interface AdminSidebarProps {
  isOpen: boolean;
  onClose: () => void;
}

const NAV_ITEMS = [
  { path: '/admin', end: true, label: 'Dashboard', icon: LayoutDashboard },
  { path: '/admin/users', label: 'Users', icon: Users },
  { path: '/admin/nuggets', label: 'Nuggets', icon: FileText },
  { path: '/admin/collections', label: 'Collections', icon: Layers },
  { path: '/admin/tags', label: 'Tags', icon: Hash },
  { path: '/admin/moderation', label: 'Moderation', icon: Flag },
  { path: '/admin/feedback', label: 'Feedback', icon: MessageSquare },
  { path: '/admin/activity', label: 'Activity Log', icon: Activity },
  { path: '/admin/downloads', label: 'Data Export', icon: Download },
  { path: '/admin/legal', label: 'Legal Pages', icon: Scale },
  { path: '/admin/config', label: 'Settings & Access', icon: Settings },
];

export const AdminSidebar: React.FC<AdminSidebarProps> = ({ isOpen, onClose }) => {
  const { logout } = useAuth();

  return (
    <>
      {/* Mobile Backdrop */}
      {isOpen && (
        <div 
          className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-30 lg:hidden"
          onClick={onClose}
        />
      )}

      {/* Sidebar Container */}
      <aside className={`
        fixed lg:static inset-y-0 left-0 z-40
        w-64 bg-white dark:bg-slate-900 
        border-r border-slate-200 dark:border-slate-800
        transform transition-transform duration-300 ease-in-out
        ${isOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
        flex flex-col
      `}>
        {/* Logo Area */}
        <div className="h-16 flex items-center px-6 border-b border-slate-100 dark:border-slate-800 shrink-0">
          <div className="w-8 h-8 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg flex items-center justify-center font-bold mr-3">
            A
          </div>
          <span className="font-bold text-lg text-slate-900 dark:text-white">Admin Panel</span>
        </div>

        {/* Nav Items */}
        <div className="flex-1 overflow-y-auto py-6 px-3 space-y-1">
          {NAV_ITEMS.map((item) => (
            <NavLink
              key={item.path}
              to={item.path}
              end={item.end}
              onClick={() => onClose()} // Close on mobile click
              className={({ isActive }) => `
                flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-colors
                ${isActive 
                  ? 'bg-primary-50 dark:bg-primary-900/10 text-primary-700 dark:text-primary-400' 
                  : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-slate-200'
                }
              `}
            >
              <item.icon size={18} />
              {item.label}
            </NavLink>
          ))}
        </div>

        {/* Footer Actions */}
        <div className="p-4 border-t border-slate-100 dark:border-slate-800 shrink-0">
          <button 
            onClick={() => { logout(); }}
            className="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors"
          >
            <LogOut size={18} />
            Sign Out
          </button>
        </div>
      </aside>
    </>
  );
};





================================================================================
FILE: src\admin\components\AdminSummaryBar.tsx
================================================================================
import React from 'react';

interface SummaryItem {
  label: string;
  value: string | number;
  hint?: string;
  icon?: React.ReactNode;
}

interface AdminSummaryBarProps {
  items: SummaryItem[];
  isLoading?: boolean;
}

export const AdminSummaryBar: React.FC<AdminSummaryBarProps> = ({ items, isLoading }) => {
  if (isLoading) {
    return (
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        {[1, 2, 3].map((i) => (
          <div key={i} className="h-24 rounded-xl bg-slate-100 dark:bg-slate-800 animate-pulse border border-slate-200 dark:border-slate-700" />
        ))}
      </div>
    );
  }

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
      {items.map((item, index) => (
        <div 
          key={index} 
          className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border border-slate-200 dark:border-slate-800 rounded-xl p-4 shadow-sm flex flex-col justify-between transition-all hover:border-slate-300 dark:hover:border-slate-700"
        >
          <div className="flex items-center justify-between mb-2">
            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">{item.label}</span>
            {item.icon && <div className="text-slate-400 dark:text-slate-500">{item.icon}</div>}
          </div>
          <div>
            <div className="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">{item.value}</div>
            {item.hint && <div className="text-[10px] font-medium text-slate-400 mt-1">{item.hint}</div>}
          </div>
        </div>
      ))}
    </div>
  );
};








================================================================================
FILE: src\admin\components\AdminTable.tsx
================================================================================

import React from 'react';
import { ChevronLeft, ChevronRight, Loader2, Search, ArrowUp, ArrowDown } from 'lucide-react';

export interface Column<T> {
  key: string;
  header: string;
  width?: string;
  minWidth?: string; 
  align?: 'left' | 'center' | 'right';
  render?: (item: T, index: number) => React.ReactNode;
  sortable?: boolean;
  sortKey?: string;
  hideOnMobile?: boolean;
  sticky?: 'left' | 'right';
}

interface AdminTableProps<T> {
  columns: Column<T>[];
  data: T[];
  isLoading?: boolean;
  filters?: React.ReactNode;
  actions?: React.ReactNode;
  pagination?: {
    page: number;
    totalPages: number;
    onPageChange: (page: number) => void;
  };
  onSearch?: (query: string) => void;
  placeholder?: string;
  
  // Sorting Props
  sortKey?: string | null;
  sortDirection?: 'asc' | 'desc';
  onSortChange?: (key: string, direction: 'asc' | 'desc') => void;

  // Row Click Prop
  onRowClick?: (row: T) => void;

  // Selection Props
  selection?: {
    selectedIds: string[];
    onSelect: (ids: string[]) => void;
    enabled: boolean;
  };
}

export function AdminTable<T extends { id: string }>({ 
  columns, 
  data, 
  isLoading, 
  filters,
  actions,
  pagination,
  onSearch,
  placeholder = "Search...",
  sortKey,
  sortDirection,
  onSortChange,
  onRowClick,
  selection
}: AdminTableProps<T>) {

  const handleHeaderClick = (col: Column<T>) => {
    if (!col.sortable || !onSortChange) return;
    const key = col.sortKey || col.key;
    const newDirection = (key === sortKey && sortDirection === 'desc') ? 'asc' : 'desc';
    onSortChange(key, newDirection);
  };

  const handleSelectAll = (checked: boolean) => {
    if (!selection) return;
    if (checked) {
      selection.onSelect(data.map(item => item.id));
    } else {
      selection.onSelect([]);
    }
  };

  const handleSelectRow = (id: string, checked: boolean) => {
    if (!selection) return;
    if (checked) {
      selection.onSelect([...selection.selectedIds, id]);
    } else {
      selection.onSelect(selection.selectedIds.filter(selectedId => selectedId !== id));
    }
  };

  // Improved sticky classes with solid backgrounds to cover content when scrolling
  const getStickyClass = (col: Column<T>, isHeader: boolean) => {
    if (!col.sticky) return '';
    const bgClass = isHeader 
        ? 'bg-slate-50 dark:bg-slate-800' 
        : 'bg-white dark:bg-slate-900 group-hover:bg-slate-50 dark:group-hover:bg-slate-800/40';
    
    if (col.sticky === 'left') return `sticky left-0 z-20 ${bgClass} shadow-[1px_0_5px_-2px_rgba(0,0,0,0.1)]`;
    if (col.sticky === 'right') return `sticky right-0 z-20 ${bgClass} shadow-[-1px_0_5px_-2px_rgba(0,0,0,0.1)]`;
    return '';
  };
  
  return (
    <div className="space-y-4">
      {/* Toolbar */}
      {(filters || actions || onSearch) && (
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-3 bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
          <div className="flex-1 flex flex-wrap items-center gap-2">
            {onSearch && (
              <div className="relative w-full md:w-auto">
                <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                <input 
                  type="text" 
                  placeholder={placeholder}
                  onChange={(e) => onSearch(e.target.value)}
                  className="pl-8 pr-3 py-1.5 text-xs font-medium bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 w-full md:w-48 lg:w-64 transition-all"
                />
              </div>
            )}
            {filters}
          </div>
          {actions && (
            <div className="flex items-center gap-2 shrink-0">
              {actions}
            </div>
          )}
        </div>
      )}

      {/* Table Container */}
      <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden shadow-sm relative flex flex-col">
        {isLoading && (
          <div className="absolute inset-0 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm z-30 flex items-center justify-center">
            <Loader2 className="w-8 h-8 text-primary-500 animate-spin" />
          </div>
        )}

        <div className="overflow-x-auto custom-scrollbar">
          <table className="w-full text-left border-collapse">
            <thead className="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-800">
              <tr>
                {/* Selection Header */}
                {selection?.enabled && (
                  <th className="px-4 py-3 w-10 sticky left-0 z-20 bg-slate-50 dark:bg-slate-800">
                    <input 
                      type="checkbox" 
                      className="rounded border-slate-300 dark:border-slate-600 focus:ring-primary-500 cursor-pointer"
                      checked={data.length > 0 && selection.selectedIds.length === data.length}
                      onChange={(e) => handleSelectAll(e.target.checked)}
                    />
                  </th>
                )}

                {columns.map((col, idx) => (
                  <th 
                    key={col.key || idx} 
                    onClick={() => handleHeaderClick(col)}
                    style={{ minWidth: col.minWidth }}
                    className={`
                      px-4 py-3 text-[13px] font-bold text-slate-600 dark:text-slate-300 select-none whitespace-nowrap
                      ${col.width || ''} 
                      ${col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : 'text-left'}
                      ${col.hideOnMobile ? 'hidden md:table-cell' : ''}
                      ${col.sortable ? 'cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors group' : ''}
                      ${getStickyClass(col, true)}
                    `}
                  >
                    <div className={`flex items-center gap-1.5 ${col.align === 'right' ? 'justify-end' : col.align === 'center' ? 'justify-center' : 'justify-start'}`}>
                        {col.header}
                        {col.sortable && (
                          <div className="flex flex-col text-slate-400 group-hover:text-primary-500 transition-colors">
                             {sortKey === (col.sortKey || col.key) ? (
                               sortDirection === 'asc' ? <ArrowUp size={12} /> : <ArrowDown size={12} />
                             ) : (
                               <div className="h-3 w-3 opacity-0 group-hover:opacity-50"><ArrowDown size={12} /></div> 
                             )}
                          </div>
                        )}
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
              {data.length === 0 && !isLoading ? (
                <tr>
                  <td colSpan={columns.length + (selection?.enabled ? 1 : 0)} className="px-6 py-12 text-center">
                    <div className="flex flex-col items-center justify-center text-slate-400">
                      <p className="text-sm font-medium">No records found</p>
                      <p className="text-xs">Try adjusting filters</p>
                    </div>
                  </td>
                </tr>
              ) : (
                data.map((row, index) => {
                  const isSelected = selection?.selectedIds.includes(row.id);
                  return (
                    <tr 
                      key={row.id} 
                      onClick={() => onRowClick?.(row)}
                      className={`
                          group border-b border-slate-50 dark:border-slate-800/50 last:border-0 transition-colors
                          ${onRowClick ? 'cursor-pointer' : ''}
                          ${isSelected ? 'bg-primary-50/50 dark:bg-primary-900/10' : 'hover:bg-slate-50/80 dark:hover:bg-slate-800/40'}
                      `}
                    >
                      {/* Selection Cell */}
                      {selection?.enabled && (
                        <td className={`px-4 py-3 w-10 sticky left-0 z-20 ${isSelected ? 'bg-primary-50/50 dark:bg-primary-900/10' : 'bg-white dark:bg-slate-900 group-hover:bg-slate-50/80 dark:group-hover:bg-slate-800/40'} shadow-[1px_0_5px_-2px_rgba(0,0,0,0.1)]`} onClick={e => e.stopPropagation()}>
                          <input 
                            type="checkbox" 
                            className="rounded border-slate-300 dark:border-slate-600 focus:ring-primary-500 cursor-pointer"
                            checked={isSelected}
                            onChange={(e) => handleSelectRow(row.id, e.target.checked)}
                          />
                        </td>
                      )}

                      {columns.map((col, colIdx) => (
                        <td 
                          key={`${row.id}-${col.key || colIdx}`} 
                          className={`
                            px-4 py-3 align-middle text-sm whitespace-nowrap
                            ${col.align === 'center' ? 'text-center' : col.align === 'right' ? 'text-right' : 'text-left'}
                            ${col.hideOnMobile ? 'hidden md:table-cell' : ''}
                            ${getStickyClass(col, false)}
                          `}
                        >
                          {col.render ? col.render(row, index) : (row as any)[col.key]}
                        </td>
                      ))}
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>

        {/* Pagination */}
        {pagination && pagination.totalPages > 1 && (
          <div className="border-t border-slate-100 dark:border-slate-800 px-4 py-2 flex items-center justify-between bg-slate-50/50 dark:bg-slate-900 sticky left-0 right-0">
            <span className="text-[10px] font-medium text-slate-500">
              Page {pagination.page} of {pagination.totalPages}
            </span>
            <div className="flex items-center gap-1">
              <button 
                onClick={() => pagination.onPageChange(Math.max(1, pagination.page - 1))}
                disabled={pagination.page === 1}
                className="p-1 rounded-md hover:bg-white dark:hover:bg-slate-800 border border-transparent hover:border-slate-200 dark:hover:border-slate-700 disabled:opacity-50 transition-all"
              >
                <ChevronLeft size={14} />
              </button>
              <button 
                onClick={() => pagination.onPageChange(Math.min(pagination.totalPages, pagination.page + 1))}
                disabled={pagination.page === pagination.totalPages}
                className="p-1 rounded-md hover:bg-white dark:hover:bg-slate-800 border border-transparent hover:border-slate-200 dark:hover:border-slate-700 disabled:opacity-50 transition-all"
              >
                <ChevronRight size={14} />
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}





================================================================================
FILE: src\admin\components\AdminTopbar.tsx
================================================================================

import React from 'react';
import { Menu } from 'lucide-react';
import { Avatar } from '../../components/shared/Avatar';
import { useAuth } from '../../hooks/useAuth';

interface AdminTopbarProps {
  onMenuClick: () => void;
  title: string;
  description?: string;
  actions?: React.ReactNode;
}

export const AdminTopbar: React.FC<AdminTopbarProps> = ({ onMenuClick, title, description, actions }) => {
  const { user } = useAuth();

  return (
    <header className="h-auto min-h-[4rem] py-2 px-4 lg:px-8 bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border-b border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 sticky top-0 z-20">
      
      <div className="flex items-center gap-4 flex-1 min-w-0">
        <button 
          onClick={onMenuClick}
          className="p-2 -ml-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg lg:hidden shrink-0"
        >
          <Menu size={20} />
        </button>
        
        <div className="flex flex-col">
          <h1 className="text-lg font-bold text-slate-900 dark:text-white leading-tight truncate">
            {title || 'Admin Panel'}
          </h1>
          {description && (
            <p className="text-xs text-slate-500 dark:text-slate-400 hidden md:block truncate">
              {description}
            </p>
          )}
        </div>
      </div>

      <div className="flex items-center gap-4 shrink-0 self-end sm:self-center ml-auto sm:ml-0">
        
        {actions && (
          <div className="flex items-center gap-2">
            {actions}
            <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2" />
          </div>
        )}

        <div className="flex items-center gap-3">
          <div className="text-right hidden sm:block">
            <div className="text-sm font-bold text-slate-900 dark:text-white">{user?.name}</div>
            <div className="text-[10px] font-bold text-slate-400 tracking-wider">Super Admin</div>
          </div>
          <Avatar name={user?.name || 'Admin'} size="md" className="bg-slate-900 text-white" />
        </div>
      </div>
    </header>
  );
};





================================================================================
FILE: src\admin\components\RequireAdmin.tsx
================================================================================

import React from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from '../../hooks/useAuth';
import { Loader2, ShieldAlert } from 'lucide-react';

export const RequireAdmin: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user, isAuthenticated, isLoading } = useAuth();
  const location = useLocation();

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-950">
        <Loader2 className="w-8 h-8 animate-spin text-primary-500" />
      </div>
    );
  }

  if (!isAuthenticated) {
    return <Navigate to="/" state={{ from: location }} replace />;
  }

  // Check for admin role
  if (user?.role !== 'admin') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-950 p-4 text-center">
        <div className="w-16 h-16 bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-full flex items-center justify-center mb-6">
          <ShieldAlert size={32} />
        </div>
        <h1 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">Access Denied</h1>
        <p className="text-slate-500 dark:text-slate-400 max-w-md mb-8">
          You do not have permission to view this area. This incident will be reported.
        </p>
        <Navigate to="/" replace />
      </div>
    );
  }

  return <>{children}</>;
};





================================================================================
FILE: src\admin\hooks\useAdminPermissions.ts
================================================================================

import { useCallback } from 'react';
import { useAuth } from '../../hooks/useAuth';
import { checkPermission } from '../auth/adminPermissions';
import { AdminPermission } from '../types/admin';

export const useAdminPermissions = () => {
  const { modularUser } = useAuth();

  const can = useCallback((permission: AdminPermission) => {
    return checkPermission(modularUser, permission);
  }, [modularUser]);

  return { can };
};





================================================================================
FILE: src\admin\layout\AdminLayout.tsx
================================================================================

import React, { useState } from 'react';
import { Outlet, useOutletContext } from 'react-router-dom';
import { AdminSidebar } from '../components/AdminSidebar';
import { AdminTopbar } from '../components/AdminTopbar';

export interface AdminHeaderContext {
  setPageHeader: (title: string, description?: string, actions?: React.ReactNode) => void;
}

export const useAdminHeader = () => useOutletContext<AdminHeaderContext>();

export const AdminLayout: React.FC = () => {
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [headerState, setHeaderState] = useState({
    title: '',
    description: '',
    actions: null as React.ReactNode | null
  });

  const setPageHeader = (title: string, description: string = '', actions: React.ReactNode = null) => {
    // Prevent infinite loops by checking equality (basic shallow check)
    setHeaderState(prev => {
      if (prev.title === title && prev.description === description && prev.actions === actions) return prev;
      return { title, description, actions };
    });
  };

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex font-sans">
      <AdminSidebar isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} />
      
      <div className="flex-1 flex flex-col min-w-0 transition-all duration-300">
        <AdminTopbar 
          onMenuClick={() => setIsSidebarOpen(true)} 
          title={headerState.title}
          description={headerState.description}
          actions={headerState.actions}
        />
        
        <main className="flex-1 p-4 lg:p-8 overflow-x-hidden">
          <div className="max-w-7xl mx-auto">
            <Outlet context={{ setPageHeader }} />
          </div>
        </main>
      </div>
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminActivityLogPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from 'react';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminSummaryBar } from '../components/AdminSummaryBar';
import { AdminActivityEvent } from '../types/admin';
import { adminActivityService } from '../services/adminActivityService';
import { Activity, ShieldAlert, CheckCircle2, Info, AlertTriangle } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { Avatar } from '../../components/shared/Avatar';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminActivityLogPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [logs, setLogs] = useState<AdminActivityEvent[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  
  // Filtering & Sorting
  const [searchQuery, setSearchQuery] = useState('');
  const [typeFilter, setTypeFilter] = useState<'all' | 'info' | 'warning' | 'danger' | 'success'>('all');
  const [dateFilter, setDateFilter] = useState('');
  const [sortKey, setSortKey] = useState<string>('timestamp');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');

  const toast = useToast();

  useEffect(() => {
    setPageHeader("Activity Log", "Audit trail of administrative actions.");
  }, []);

  useEffect(() => {
    const loadLogs = async () => {
        setIsLoading(true);
        try {
            const data = await adminActivityService.listActivityEvents();
            setLogs(data);
        } catch (e) {
            toast.error("Failed to load activity logs");
        } finally {
            setIsLoading(false);
        }
    };
    loadLogs();
  }, []);

  const processedLogs = useMemo(() => {
    let result = [...logs];

    // Filter
    if (typeFilter !== 'all') {
        result = result.filter(l => l.type === typeFilter);
    }
    if (dateFilter) {
      const d = new Date(dateFilter).toDateString();
      result = result.filter(l => new Date(l.timestamp).toDateString() === d);
    }
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        result = result.filter(l => 
            l.action.toLowerCase().includes(q) || 
            l.actor.name.toLowerCase().includes(q) ||
            (l.target && l.target.toLowerCase().includes(q))
        );
    }

    // Sort
    result.sort((a, b) => {
        let valA: any = a[sortKey as keyof AdminActivityEvent] || '';
        let valB: any = b[sortKey as keyof AdminActivityEvent] || '';

        if (sortKey === 'actor') {
            valA = a.actor.name.toLowerCase();
            valB = b.actor.name.toLowerCase();
        } else if (sortKey === 'timestamp') {
            valA = new Date(a.timestamp).getTime();
            valB = new Date(b.timestamp).getTime();
        }

        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });

    return result;
  }, [logs, typeFilter, dateFilter, searchQuery, sortKey, sortDirection]);

  const columns: Column<AdminActivityEvent>[] = [
    {
        key: 'actor',
        header: 'Actor',
        width: 'w-48',
        minWidth: '200px',
        sticky: 'left',
        sortable: true,
        render: (l) => (
            <div className="flex items-center gap-3">
                <Avatar name={l.actor.name} size="xs" />
                <span className="text-sm font-bold text-slate-700 dark:text-slate-300">{l.actor.name}</span>
            </div>
        )
    },
    {
        key: 'action',
        header: 'Action',
        width: 'w-48',
        minWidth: '200px',
        render: (l) => <span className="font-medium text-slate-900 dark:text-white capitalize">{l.action}</span>
    },
    {
        key: 'target',
        header: 'Target',
        width: 'w-40',
        minWidth: '150px',
        render: (l) => l.target ? (
            <span className="inline-flex px-2 py-0.5 bg-slate-100 dark:bg-slate-800 rounded text-xs font-mono text-slate-600 dark:text-slate-400">
                {l.target}
            </span>
        ) : <span className="text-slate-300">-</span>
    },
    {
        key: 'type',
        header: 'Type',
        width: 'w-24',
        minWidth: '100px',
        render: (l) => {
            const config = {
                danger: { color: 'text-red-600 bg-red-50', icon: <ShieldAlert size={14} /> },
                warning: { color: 'text-amber-600 bg-amber-50', icon: <AlertTriangle size={14} /> },
                success: { color: 'text-green-600 bg-green-50', icon: <CheckCircle2 size={14} /> },
                info: { color: 'text-blue-600 bg-blue-50', icon: <Info size={14} /> },
            }[l.type];
            return (
                <span className={`inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-bold capitalize ${config.color} dark:bg-opacity-20`}>
                    {config.icon} {l.type}
                </span>
            );
        }
    },
    {
        key: 'date',
        header: 'Date',
        width: 'w-32',
        minWidth: '120px',
        sortable: true,
        sortKey: 'timestamp',
        render: (l) => <span className="text-xs text-slate-500">{new Date(l.timestamp).toLocaleDateString()}</span>
    },
    {
        key: 'time',
        header: 'Time',
        width: 'w-24',
        minWidth: '100px',
        render: (l) => <span className="text-xs text-slate-400">{new Date(l.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
    }
  ];

  const Filters = (
      <div className="flex bg-slate-100 dark:bg-slate-800 p-0.5 rounded-lg gap-2">
          <div className="flex">
            {['all', 'info', 'warning', 'danger', 'success'].map(t => (
                <button
                    key={t}
                    onClick={() => setTypeFilter(t as any)}
                    className={`px-3 py-1.5 text-[10px] font-bold capitalize rounded-md transition-all ${typeFilter === t ? 'bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    {t}
                </button>
            ))}
          </div>
          <input 
                type="date" 
                value={dateFilter}
                onChange={(e) => setDateFilter(e.target.value)}
                className="pl-3 pr-2 py-1.5 text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-primary-500"
            />
      </div>
  );

  return (
    <div>
      <AdminSummaryBar 
        items={[
            { label: 'Total Events', value: logs.length, icon: <Activity size={18} /> },
            { label: 'Critical Events', value: logs.filter(l => l.type === 'danger').length, icon: <ShieldAlert size={18} /> },
        ]}
        isLoading={isLoading}
      />

      <AdminTable 
        columns={columns}
        data={processedLogs}
        isLoading={isLoading}
        filters={Filters}
        onSearch={setSearchQuery}
        placeholder="Search logs..."
        
        sortKey={sortKey}
        sortDirection={sortDirection}
        onSortChange={(k, d) => { setSortKey(k); setSortDirection(d); }}
        
        pagination={{ page: 1, totalPages: 1, onPageChange: () => {} }}
      />
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminCollectionsPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from 'react';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminSummaryBar } from '../components/AdminSummaryBar';
import { AdminCollection } from '../types/admin';
import { adminCollectionsService } from '../services/adminCollectionsService';
import { Eye, Trash2, Lock, Globe, EyeOff, Folder, Layers } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { AdminDrawer } from '../components/AdminDrawer';
import { ConfirmActionModal } from '../../components/settings/ConfirmActionModal';
import { useAdminPermissions } from '../hooks/useAdminPermissions';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminCollectionsPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [collections, setCollections] = useState<AdminCollection[]>([]);
  const [stats, setStats] = useState({ totalCommunity: 0, totalNuggetsInCommunity: 0 });
  const [isLoading, setIsLoading] = useState(true);
  const [selectedCollection, setSelectedCollection] = useState<AdminCollection | null>(null);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  
  // Sorting & Filtering
  const [sortKey, setSortKey] = useState<string>('createdAt');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const [dateFilter, setDateFilter] = useState('');

  // Selection
  const [selectedIds, setSelectedIds] = useState<string[]>([]);

  const toast = useToast();
  const { can } = useAdminPermissions();

  const loadData = async (q?: string) => {
    setIsLoading(true);
    try {
      const [colsData, statsData] = await Promise.all([
        adminCollectionsService.listCollections(q),
        adminCollectionsService.getStats()
      ]);
      setCollections(colsData);
      setStats(statsData);
    } catch (e) {
      toast.error("Failed to load collections");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    setPageHeader("Collections", "Review and manage user collections.");
    loadData();
  }, []);

  // Derived state
  const processedCollections = useMemo(() => {
    let result = [...collections];
    
    // Date Filter
    if (dateFilter) {
      const filterDate = new Date(dateFilter).toDateString();
      result = result.filter(c => new Date(c.createdAt).toDateString() === filterDate);
    }

    result.sort((a, b) => {
      let valA: any = a[sortKey as keyof AdminCollection] || '';
      let valB: any = b[sortKey as keyof AdminCollection] || '';

      if (sortKey === 'creator') {
        valA = a.creator.name.toLowerCase();
        valB = b.creator.name.toLowerCase();
      } else if (sortKey === 'createdAt') {
        valA = new Date(a.createdAt).getTime();
        valB = new Date(b.createdAt).getTime();
      }

      if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    return result;
  }, [collections, dateFilter, sortKey, sortDirection]);

  const handleDelete = async () => {
    if (!selectedCollection) return;
    try {
      await adminCollectionsService.deleteCollection(selectedCollection.id);
      setCollections(prev => prev.filter(c => c.id !== selectedCollection.id));
      const newStats = await adminCollectionsService.getStats();
      setStats(newStats);
      toast.success("Collection deleted");
      setSelectedCollection(null);
      setShowDeleteConfirm(false);
    } catch (e) {
      toast.error("Delete failed");
    }
  };

  const handleToggleStatus = async (col: AdminCollection) => {
    const newStatus = col.status === 'active' ? 'hidden' : 'active';
    try {
        await adminCollectionsService.updateCollectionStatus(col.id, newStatus);
        setCollections(prev => prev.map(c => c.id === col.id ? { ...c, status: newStatus } : c));
        toast.success(`Collection is now ${newStatus}`);
    } catch(e) {
        toast.error("Status update failed");
    }
  };

  const handleBulkAction = (action: string) => {
      toast.info(`${action} ${selectedIds.length} items (Not implemented)`);
      setSelectedIds([]);
  };

  const columns: Column<AdminCollection>[] = [
    {
      key: 'name',
      header: 'Collection Name',
      width: 'w-72',
      minWidth: '250px',
      sortable: true,
      sticky: 'left',
      render: (c) => (
        <div className="flex items-center gap-3">
          <div className="p-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-500">
             <Folder size={16} />
          </div>
          <div className="min-w-0">
              <div className="font-bold text-slate-900 dark:text-white truncate">{c.name}</div>
              {c.status === 'hidden' && <span className="text-[9px] px-1.5 py-0.5 bg-slate-200 dark:bg-slate-700 text-slate-500 rounded font-bold uppercase">Hidden</span>}
          </div>
        </div>
      )
    },
    {
      key: 'creator',
      header: 'Owner',
      width: 'w-40',
      minWidth: '150px',
      sortable: true,
      sortKey: 'creator',
      render: (c) => <span className="text-sm font-medium text-slate-600 dark:text-slate-300">{c.creator.name}</span>
    },
    {
      key: 'type',
      header: 'Visibility',
      width: 'w-24',
      minWidth: '100px',
      sortable: true,
      render: (c) => (
        <span className="flex items-center gap-1 text-[10px] font-bold uppercase text-slate-500">
            {c.type === 'private' ? <Lock size={12} /> : <Globe size={12} />}
            {c.type}
        </span>
      )
    },
    {
      key: 'followerCount',
      header: 'Followers',
      width: 'w-24',
      minWidth: '100px',
      sortable: true,
      align: 'center',
      render: (c) => <span className="text-xs font-bold">{c.followerCount}</span>
    },
    {
      key: 'itemCount',
      header: 'Nuggets',
      width: 'w-24',
      minWidth: '100px',
      sortable: true,
      align: 'center',
      render: (c) => <span className="text-xs font-bold">{c.itemCount}</span>
    },
    {
      key: 'createdDate',
      header: 'Date',
      width: 'w-32',
      minWidth: '120px',
      sortable: true,
      sortKey: 'createdAt',
      render: (c) => <span className="text-xs text-slate-500">{new Date(c.createdAt).toLocaleDateString()}</span>
    },
    {
      key: 'createdTime',
      header: 'Time',
      width: 'w-24',
      minWidth: '100px',
      render: (c) => <span className="text-xs text-slate-400">{new Date(c.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
    },
    {
      key: 'actions',
      header: 'Actions',
      align: 'right',
      width: 'w-24',
      minWidth: '100px',
      sticky: 'right',
      render: (c) => (
        <div className="flex justify-end gap-2" onClick={(e) => e.stopPropagation()}>
          {can('admin.collections.view') && (
             <button 
                onClick={() => setSelectedCollection(c)}
                className="flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md text-[10px] font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
             >
                <Eye size={14} /> <span className="hidden md:inline">View</span>
             </button>
          )}
          {can('admin.collections.edit') && (
             <button 
                onClick={() => handleToggleStatus(c)}
                className="flex items-center gap-1.5 px-2 py-1.5 md:px-3 md:py-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md text-[10px] font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                title={c.status === 'active' ? "Hide" : "Unhide"}
             >
                {c.status === 'active' ? <EyeOff size={14} /> : <Eye size={14} />}
             </button>
          )}
        </div>
      )
    }
  ];

  const BulkActions = selectedIds.length > 0 ? (
      <div className="flex items-center gap-2 animate-in fade-in slide-in-from-right-2 duration-200">
          <span className="text-xs font-bold text-slate-500">{selectedIds.length} selected</span>
          <button onClick={() => handleBulkAction('hide')} className="px-3 py-1.5 bg-slate-100 text-slate-700 hover:bg-slate-200 rounded-lg text-[10px] font-bold transition-colors">Hide</button>
          <button onClick={() => handleBulkAction('delete')} className="px-3 py-1.5 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg text-[10px] font-bold transition-colors">Delete</button>
      </div>
  ) : null;

  return (
    <div>
      <AdminSummaryBar 
        items={[
          { label: 'Community Collections', value: stats.totalCommunity, icon: <Layers size={18} /> },
          { label: 'Total Nuggets', value: stats.totalNuggetsInCommunity, icon: <Folder size={18} />, hint: 'In public collections' },
        ]}
        isLoading={isLoading}
      />

      <AdminTable 
        columns={columns} 
        data={processedCollections} 
        isLoading={isLoading} 
        actions={BulkActions}
        onSearch={(q) => loadData(q)} 
        placeholder="Search collections..."
        
        // Add date filter to toolbar
        filters={
            <input 
                type="date" 
                value={dateFilter}
                onChange={(e) => setDateFilter(e.target.value)}
                className="ml-2 pl-3 pr-2 py-1.5 text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-primary-500"
            />
        }
        
        sortKey={sortKey}
        sortDirection={sortDirection}
        onSortChange={(k, d) => { setSortKey(k); setSortDirection(d); }}
        
        onRowClick={(c) => setSelectedCollection(c)}
        selection={{
            enabled: true,
            selectedIds: selectedIds,
            onSelect: setSelectedIds
        }}
      />

      <AdminDrawer
        isOpen={!!selectedCollection}
        onClose={() => setSelectedCollection(null)}
        title="Collection Details"
        width="lg"
        footer={
            <div className="flex justify-between w-full">
                {can('admin.collections.edit') && (
                    <button 
                        onClick={() => setShowDeleteConfirm(true)} 
                        className="flex items-center gap-2 px-3 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg text-sm font-bold transition-colors"
                    >
                        <Trash2 size={16} /> Delete
                    </button>
                )}
            </div>
        }
      >
        {selectedCollection && (
            <div className="space-y-6">
                <div className="flex gap-4">
                    <div className="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-slate-400 shrink-0">
                        <Folder size={32} />
                    </div>
                    <div>
                        <h2 className="text-xl font-bold text-slate-900 dark:text-white leading-tight mb-1">{selectedCollection.name}</h2>
                        <p className="text-sm text-slate-500">{selectedCollection.description || 'No description provided.'}</p>
                    </div>
                </div>
            </div>
        )}
      </AdminDrawer>

      <ConfirmActionModal 
        isOpen={showDeleteConfirm}
        onClose={() => setShowDeleteConfirm(false)}
        onConfirm={handleDelete}
        title="Delete Collection?"
        description="This will permanently delete the collection. The nuggets inside will not be deleted."
        actionLabel="Delete"
        isDestructive
      />
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminConfigPage.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { Megaphone, Save, Info, AlertTriangle, XCircle, CheckCircle2, Clock, Shield, Check, ToggleLeft, ToggleRight, Settings, Users, ClipboardType } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { RichTextEditor } from '../../components/RichTextEditor';
import { RichTextRenderer } from '../../components/RichTextRenderer';
import { useAdminHeader } from '../layout/AdminLayout';
import { adminConfigService, AVAILABLE_SERVICES } from '../services/adminConfigService';
import { RolePermissions, ServiceId, AdminRole, FeatureFlags, SignupConfig } from '../types/admin';

interface SystemAnnouncement {
  active: boolean;
  type: 'info' | 'warning' | 'error' | 'success';
  message: string;
  expiresAt: string;
}

export const AdminConfigPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const toast = useToast();
  
  // --- Announcement State ---
  const [announcement, setAnnouncement] = useState<SystemAnnouncement>({
    active: false,
    type: 'info',
    message: '**Scheduled maintenance:** The system will be down for 15 mins at 2 AM UTC.',
    expiresAt: ''
  });

  // --- Config State ---
  const [permissions, setPermissions] = useState<RolePermissions | null>(null);
  const [flags, setFlags] = useState<FeatureFlags | null>(null);
  const [signupConfig, setSignupConfig] = useState<SignupConfig | null>(null);
  const [isSavingPerms, setIsSavingPerms] = useState(false);

  useEffect(() => {
    setPageHeader("System Configuration", "Manage global settings, feature toggles, and system alerts.");
    loadConfig();
  }, []);

  const loadConfig = async () => {
    try {
      const [permData, flagsData, signupData] = await Promise.all([
        adminConfigService.getRolePermissions(),
        adminConfigService.getFeatureFlags(),
        adminConfigService.getSignupConfig()
      ]);
      setPermissions(permData);
      setFlags(flagsData);
      setSignupConfig(signupData);
    } catch (e) {
      toast.error("Failed to load configuration");
    }
  };

  const handleSaveAnnouncement = () => {
    toast.success("System announcement updated");
  };

  const handleTogglePermission = (role: AdminRole, serviceId: ServiceId) => {
    if (!permissions) return;
    const current = permissions[role];
    const updated = current.includes(serviceId)
      ? current.filter(id => id !== serviceId)
      : [...current, serviceId];
    
    setPermissions({ ...permissions, [role]: updated });
  };

  const handleToggleFlag = async (key: keyof FeatureFlags) => {
    if (!flags) return;
    const newValue = !flags[key];
    setFlags({ ...flags, [key]: newValue }); // Optimistic
    try {
        await adminConfigService.updateFeatureFlag(key, newValue);
        toast.success(`Updated ${key}`);
    } catch (e) {
        toast.error("Failed to update flag");
        setFlags({ ...flags }); // Revert
    }
  };

  const handleUpdateSignupRule = async (field: keyof SignupConfig, ruleKey: 'show' | 'required') => {
      if (!signupConfig) return;
      const currentRule = signupConfig[field];
      const newValue = !currentRule[ruleKey];
      
      const newConfig = { ...signupConfig, [field]: { ...currentRule, [ruleKey]: newValue } };
      setSignupConfig(newConfig);

      try {
          await adminConfigService.updateSignupConfig(field, { [ruleKey]: newValue });
      } catch (e) {
          toast.error("Failed to update rule");
          setSignupConfig(signupConfig); // Revert
      }
  };

  const handleSavePermissions = async () => {
    if (!permissions) return;
    setIsSavingPerms(true);
    try {
      await Promise.all([
        adminConfigService.updateRolePermission('user', permissions.user),
        adminConfigService.updateRolePermission('admin', permissions.admin),
      ]);
      toast.success("Access privileges updated");
    } catch (e) {
      toast.error("Failed to save privileges");
    } finally {
      setIsSavingPerms(false);
    }
  };

  // Group services by category for cleaner UI
  const groupedServices = {
    'AI Services': AVAILABLE_SERVICES.filter(s => s.category === 'ai'),
    'Data & Import': AVAILABLE_SERVICES.filter(s => s.category === 'data'),
    'Content Features': AVAILABLE_SERVICES.filter(s => s.category === 'content'),
  };

  return (
    <div>
      <div className="max-w-5xl space-y-8">
        
        {/* 1. FEATURE FLAGS */}
        <section className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
            <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                    <Settings size={20} />
                </div>
                <div>
                    <h3 className="text-lg font-bold text-slate-900 dark:text-white">Feature Flags</h3>
                    <p className="text-xs text-slate-500">Toggle system capabilities on or off globally.</p>
                </div>
            </div>

            {flags ? (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {/* AVATAR UPLOAD */}
                    <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div className="text-sm font-bold text-slate-900 dark:text-white">Avatar File Uploads</div>
                            <div className="text-xs text-slate-500 mt-0.5">Allow users to upload custom images.</div>
                        </div>
                        <button 
                            onClick={() => handleToggleFlag('enableAvatarUpload')}
                            className={`transition-colors ${flags.enableAvatarUpload ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                        >
                            {flags.enableAvatarUpload ? <ToggleRight size={36} /> : <ToggleLeft size={36} />}
                        </button>
                    </div>

                    {/* PUBLIC REGISTRATION */}
                    <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div className="text-sm font-bold text-slate-900 dark:text-white">Public Registration</div>
                            <div className="text-xs text-slate-500 mt-0.5">Allow new users to sign up.</div>
                        </div>
                        <button 
                            onClick={() => handleToggleFlag('enablePublicSignup')}
                            className={`transition-colors ${flags.enablePublicSignup ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                        >
                            {flags.enablePublicSignup ? <ToggleRight size={36} /> : <ToggleLeft size={36} />}
                        </button>
                    </div>

                    {/* EMAIL VERIFICATION */}
                    <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div className="text-sm font-bold text-slate-900 dark:text-white">Email Verification</div>
                            <div className="text-xs text-slate-500 mt-0.5">Require verification before login.</div>
                        </div>
                        <button 
                            onClick={() => handleToggleFlag('enableEmailVerification')}
                            className={`transition-colors ${flags.enableEmailVerification ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                        >
                            {flags.enableEmailVerification ? <ToggleRight size={36} /> : <ToggleLeft size={36} />}
                        </button>
                    </div>

                    {/* MAINTENANCE */}
                    <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div className="text-sm font-bold text-slate-900 dark:text-white">Maintenance Mode</div>
                            <div className="text-xs text-slate-500 mt-0.5">Restrict access to admins only.</div>
                        </div>
                        <button 
                            onClick={() => handleToggleFlag('maintenanceMode')}
                            className={`transition-colors ${flags.maintenanceMode ? 'text-amber-600' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                        >
                            {flags.maintenanceMode ? <ToggleRight size={36} /> : <ToggleLeft size={36} />}
                        </button>
                    </div>
                </div>
            ) : (
                <div className="text-center py-4 text-slate-400">Loading flags...</div>
            )}
        </section>

        {/* 2. SIGNUP FORM CUSTOMIZATION */}
        <section className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
            <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                    <ClipboardType size={20} />
                </div>
                <div>
                    <h3 className="text-lg font-bold text-slate-900 dark:text-white">Signup Form Customization</h3>
                    <p className="text-xs text-slate-500">Manage which fields are visible or mandatory during registration.</p>
                </div>
            </div>

            {signupConfig ? (
                <div className="overflow-hidden rounded-xl border border-slate-200 dark:border-slate-800">
                    <table className="w-full text-left">
                        <thead className="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800">
                            <tr>
                                <th className="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Field Name</th>
                                <th className="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Visible</th>
                                <th className="px-6 py-3 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">Required</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-slate-900">
                            {[
                                { key: 'location', label: 'Location (Pincode/City/Country)' },
                                { key: 'gender', label: 'Gender Selection' },
                                { key: 'phone', label: 'Phone Number' },
                                { key: 'dob', label: 'Date of Birth' }
                            ].map((row) => {
                                const config = signupConfig[row.key as keyof SignupConfig];
                                return (
                                    <tr key={row.key} className="hover:bg-slate-50 dark:hover:bg-slate-800/20 transition-colors">
                                        <td className="px-6 py-4">
                                            <span className="text-sm font-bold text-slate-700 dark:text-slate-300">{row.label}</span>
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <button 
                                                onClick={() => handleUpdateSignupRule(row.key as keyof SignupConfig, 'show')}
                                                className={`transition-colors ${config.show ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600'}`}
                                            >
                                                {config.show ? <ToggleRight size={28} /> : <ToggleLeft size={28} />}
                                            </button>
                                        </td>
                                        <td className="px-6 py-4 text-center">
                                            <button 
                                                onClick={() => handleUpdateSignupRule(row.key as keyof SignupConfig, 'required')}
                                                disabled={!config.show}
                                                className={`transition-colors ${!config.show ? 'opacity-30 cursor-not-allowed' : ''} ${config.required ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-300 dark:text-slate-600'}`}
                                            >
                                                {config.required ? <ToggleRight size={28} /> : <ToggleLeft size={28} />}
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            ) : (
                <div className="text-center py-4 text-slate-400">Loading form config...</div>
            )}
        </section>

        {/* 3. GUEST RESTRICTIONS */}
        <section className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
            <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-amber-50 text-amber-600 rounded-lg">
                    <Users size={20} />
                </div>
                <div>
                    <h3 className="text-lg font-bold text-slate-900 dark:text-white">Guest Permissions</h3>
                    <p className="text-xs text-slate-500">Configure what non-authenticated users can do.</p>
                </div>
            </div>

            {flags ? (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div className="text-sm font-bold text-slate-900 dark:text-white">Allow Guest Bookmarks</div>
                            <div className="text-xs text-slate-500 mt-0.5">Save to device local storage without login.</div>
                        </div>
                        <button 
                            onClick={() => handleToggleFlag('guestBookmarks')}
                            className={`transition-colors ${flags.guestBookmarks ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                        >
                            {flags.guestBookmarks ? <ToggleRight size={36} /> : <ToggleLeft size={36} />}
                        </button>
                    </div>

                    <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                        <div>
                            <div className="text-sm font-bold text-slate-900 dark:text-white">Allow Guest Reports</div>
                            <div className="text-xs text-slate-500 mt-0.5">Anonymous content reporting.</div>
                        </div>
                        <button 
                            onClick={() => handleToggleFlag('guestReports')}
                            className={`transition-colors ${flags.guestReports ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                        >
                            {flags.guestReports ? <ToggleRight size={36} /> : <ToggleLeft size={36} />}
                        </button>
                    </div>
                </div>
            ) : null}
        </section>

        {/* 4. RBAC MATRIX */}
        <section className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-purple-50 text-purple-600 rounded-lg">
                <Shield size={20} />
              </div>
              <div>
                <h3 className="text-lg font-bold text-slate-900 dark:text-white">Registered User Privileges</h3>
                <p className="text-xs text-slate-500">Fine-grained access control for signed-in accounts.</p>
              </div>
            </div>
            <button 
              onClick={handleSavePermissions}
              disabled={isSavingPerms}
              className="px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl text-xs font-bold shadow-sm hover:opacity-90 transition-all flex items-center gap-2 disabled:opacity-50"
            >
              {isSavingPerms ? 'Saving...' : <><Save size={14} /> Save Privileges</>}
            </button>
          </div>

          {!permissions ? (
            <div className="text-center py-8 text-slate-400">Loading configuration...</div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="border-b border-slate-100 dark:border-slate-800">
                    <th className="py-3 px-4 text-xs font-bold text-slate-500 uppercase tracking-wider w-1/2">Feature / Service</th>
                    <th className="py-3 px-4 text-center text-xs font-bold text-slate-900 dark:text-white w-1/4 bg-slate-50 dark:bg-slate-800/50 rounded-t-xl">Standard User</th>
                    <th className="py-3 px-4 text-center text-xs font-bold text-purple-600 dark:text-purple-400 w-1/4 bg-purple-50 dark:bg-purple-900/10 rounded-t-xl">Admin</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                  {Object.entries(groupedServices).map(([category, services]) => (
                    <React.Fragment key={category}>
                      <tr className="bg-slate-50/50 dark:bg-slate-800/30">
                        <td colSpan={3} className="py-2 px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                          {category}
                        </td>
                      </tr>
                      {services.map(service => (
                        <tr key={service.id} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group">
                          <td className="py-3 px-4">
                            <div className="font-bold text-sm text-slate-700 dark:text-slate-200">{service.label}</div>
                            <div className="text-xs text-slate-400 font-medium">{service.description}</div>
                          </td>
                          
                          {/* User Column */}
                          <td className="py-3 px-4 text-center align-middle bg-slate-50/30 dark:bg-slate-800/20">
                            <label className="relative inline-flex items-center justify-center cursor-pointer p-2">
                              <input 
                                type="checkbox" 
                                className="peer sr-only"
                                checked={permissions['user'].includes(service.id)}
                                onChange={() => handleTogglePermission('user', service.id)}
                              />
                              <div className="w-5 h-5 border-2 border-slate-300 dark:border-slate-600 rounded flex items-center justify-center peer-checked:bg-slate-900 peer-checked:border-slate-900 dark:peer-checked:bg-white dark:peer-checked:border-white transition-all">
                                <Check size={12} className="text-white dark:text-slate-900 opacity-0 peer-checked:opacity-100" strokeWidth={3} />
                              </div>
                            </label>
                          </td>

                          {/* Admin Column */}
                          <td className="py-3 px-4 text-center align-middle bg-purple-50/30 dark:bg-purple-900/5">
                            <label className="relative inline-flex items-center justify-center cursor-pointer p-2">
                              <input 
                                type="checkbox" 
                                className="peer sr-only"
                                checked={permissions['admin'].includes(service.id)}
                                onChange={() => handleTogglePermission('admin', service.id)}
                              />
                              <div className="w-5 h-5 border-2 border-purple-200 dark:border-purple-800 rounded flex items-center justify-center peer-checked:bg-purple-600 peer-checked:border-purple-600 transition-all">
                                <Check size={12} className="text-white opacity-0 peer-checked:opacity-100" strokeWidth={3} />
                              </div>
                            </label>
                          </td>
                        </tr>
                      ))}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* 5. SYSTEM ANNOUNCEMENT */}
        <section className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
          <div className="flex items-center gap-3 mb-6">
            <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
              <Megaphone size={20} />
            </div>
            <div>
              <h3 className="text-lg font-bold text-slate-900 dark:text-white">System Announcement</h3>
              <p className="text-xs text-slate-500">Broadcast a message to all users (e.g. maintenance, downtime).</p>
            </div>
          </div>

          <div className="space-y-4">
            <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
              <span className="text-sm font-bold text-slate-700 dark:text-slate-300">Enable Announcement Banner</span>
              <button 
                onClick={() => setAnnouncement(p => ({ ...p, active: !p.active }))}
                className={`w-12 h-6 rounded-full transition-colors flex items-center px-1 ${announcement.active ? 'bg-primary-500' : 'bg-slate-300'}`}
              >
                <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${announcement.active ? 'translate-x-6' : 'translate-x-0'}`} />
              </button>
            </div>

            {announcement.active && (
              <div className="space-y-6 animate-in fade-in slide-in-from-top-2 pt-2">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Message Type</label>
                        <div className="flex gap-2">
                            {['info', 'warning', 'error', 'success'].map((t) => (
                            <button
                                key={t}
                                onClick={() => setAnnouncement(p => ({ ...p, type: t as any }))}
                                className={`px-3 py-2 rounded-lg text-xs font-bold capitalize border transition-all ${announcement.type === t ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'}`}
                            >
                                {t}
                            </button>
                            ))}
                        </div>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Auto-Expire At</label>
                        <div className="relative">
                            <Clock size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                            <input 
                                type="datetime-local" 
                                value={announcement.expiresAt}
                                onChange={(e) => setAnnouncement(p => ({ ...p, expiresAt: e.target.value }))}
                                className="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-primary-500"
                            />
                        </div>
                        <p className="text-[10px] text-slate-400 mt-1">Banner will automatically hide after this time.</p>
                    </div>
                </div>

                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Banner Message</label>
                  <RichTextEditor 
                    value={announcement.message}
                    onChange={(val) => setAnnouncement(p => ({ ...p, message: val }))}
                    placeholder="Enter announcement text..."
                    className="min-h-[150px]"
                  />
                </div>

                {/* Preview */}
                <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Live Preview</label>
                    <div className={`p-4 rounded-lg flex items-start gap-3 text-sm font-medium ${
                    announcement.type === 'info' ? 'bg-blue-100 text-blue-800' :
                    announcement.type === 'warning' ? 'bg-amber-100 text-amber-800' :
                    announcement.type === 'error' ? 'bg-red-100 text-red-800' :
                    'bg-green-100 text-green-800'
                    }`}>
                    <div className="shrink-0 mt-0.5">
                        {announcement.type === 'info' && <Info size={18} />}
                        {announcement.type === 'warning' && <AlertTriangle size={18} />}
                        {announcement.type === 'error' && <XCircle size={18} />}
                        {announcement.type === 'success' && <CheckCircle2 size={18} />}
                    </div>
                    <div className="flex-1">
                        <RichTextRenderer content={announcement.message} className="prose-sm max-w-none" />
                    </div>
                    </div>
                </div>
              </div>
            )}
          </div>

          <div className="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800 flex justify-end">
            <button onClick={handleSaveAnnouncement} className="flex items-center gap-2 px-6 py-2.5 bg-slate-900 text-white rounded-xl text-sm font-bold hover:opacity-90 shadow-lg shadow-slate-900/10">
              <Save size={16} /> Save Announcement
            </button>
          </div>
        </section>

      </div>
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminDashboardPage.tsx
================================================================================

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Users, FileText, Layers, Flag, MessageSquare, Globe, Lock, Hash, Bookmark } from 'lucide-react';
import { adminUsersService } from '../services/adminUsersService';
import { adminNuggetsService } from '../services/adminNuggetsService';
import { adminCollectionsService } from '../services/adminCollectionsService';
import { adminTagsService } from '../services/adminTagsService';
import { adminModerationService } from '../services/adminModerationService';
import { adminFeedbackService } from '../services/adminFeedbackService';
import { useAdminHeader } from '../layout/AdminLayout';

interface DashboardMetrics {
  users: { total: number };
  nuggets: { total: number; public: number; private: number };
  collections: { community: number; nuggetsInCommunity: number };
  tags: { total: number };
  reports: { open: number };
  bookmarks: { total: number };
  feedback: { total: number };
}

const MetricCard = ({ label, value, subValue, icon, onClick, colorClass }: any) => (
  <div 
    onClick={onClick}
    className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm cursor-pointer hover:border-slate-300 dark:hover:border-slate-700 hover:shadow-md transition-all group"
  >
    <div className="flex justify-between items-start">
        <div>
            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">{label}</p>
            <h3 className="text-2xl font-bold text-slate-900 dark:text-white leading-tight">{value}</h3>
            {subValue && <p className="text-xs text-slate-400 mt-1">{subValue}</p>}
        </div>
        <div className={`p-2 rounded-lg ${colorClass} group-hover:scale-110 transition-transform`}>
            {icon}
        </div>
    </div>
  </div>
);

export const AdminDashboardPage: React.FC = () => {
  const navigate = useNavigate();
  const [metrics, setMetrics] = useState<DashboardMetrics | null>(null);
  const { setPageHeader } = useAdminHeader();

  useEffect(() => {
    setPageHeader(
      "Dashboard", 
      "Platform overview at a glance.",
      <button className="px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:opacity-90">Download Report</button>
    );
  }, []);

  useEffect(() => {
    const loadAll = async () => {
        const [users, nuggets, cols, tags, reports, feed] = await Promise.all([
            adminUsersService.getStats(),
            adminNuggetsService.getStats(),
            adminCollectionsService.getStats(),
            adminTagsService.getStats(),
            adminModerationService.getStats(),
            adminFeedbackService.getStats()
        ]);

        setMetrics({
            users: { total: users.total },
            nuggets: { total: nuggets.total, public: nuggets.public, private: nuggets.private },
            collections: { community: cols.totalCommunity, nuggetsInCommunity: cols.totalNuggetsInCommunity },
            tags: { total: tags.totalTags },
            reports: { open: reports.open },
            bookmarks: { total: users.bookmarks }, 
            feedback: { total: feed.total }
        });
    };
    loadAll();
  }, []);

  if (!metrics) return <div className="p-8 text-center text-slate-400">Loading dashboard...</div>;

  return (
    <div>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
        <MetricCard 
            label="Standard Users" 
            value={metrics.users.total} 
            icon={<Users size={18} />} 
            colorClass="bg-blue-50 text-blue-600"
            onClick={() => navigate('/admin/users')}
        />
        <MetricCard 
            label="Total Nuggets" 
            value={metrics.nuggets.total} 
            icon={<FileText size={18} />} 
            colorClass="bg-indigo-50 text-indigo-600"
            onClick={() => navigate('/admin/nuggets')}
        />
        <MetricCard 
            label="Public Nuggets" 
            value={metrics.nuggets.public} 
            icon={<Globe size={18} />} 
            colorClass="bg-green-50 text-green-600"
            onClick={() => navigate('/admin/nuggets')}
        />
        <MetricCard 
            label="Private Nuggets" 
            value={metrics.nuggets.private} 
            icon={<Lock size={18} />} 
            colorClass="bg-slate-100 text-slate-600"
            onClick={() => navigate('/admin/nuggets')}
        />
        <MetricCard 
            label="Comm. Collections" 
            value={metrics.collections.community} 
            subValue={`${metrics.collections.nuggetsInCommunity} items`}
            icon={<Layers size={18} />} 
            colorClass="bg-purple-50 text-purple-600"
            onClick={() => navigate('/admin/collections')}
        />
        <MetricCard 
            label="Total Bookmarks" 
            value={metrics.bookmarks.total} 
            icon={<Bookmark size={18} />} 
            colorClass="bg-amber-50 text-amber-600"
            onClick={() => navigate('/admin/users')}
        />
        <MetricCard 
            label="Total Tags" 
            value={metrics.tags.total} 
            icon={<Hash size={18} />} 
            colorClass="bg-pink-50 text-pink-600"
            onClick={() => navigate('/admin/tags')}
        />
        <MetricCard 
            label="Open Reports" 
            value={metrics.reports.open} 
            icon={<Flag size={18} />} 
            colorClass="bg-red-50 text-red-600"
            onClick={() => navigate('/admin/moderation')}
        />
        <MetricCard 
            label="Total Feedback" 
            value={metrics.feedback.total} 
            icon={<MessageSquare size={18} />} 
            colorClass="bg-teal-50 text-teal-600"
            onClick={() => navigate('/admin/feedback')}
        />
        <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" onClick={() => navigate('/admin/downloads')}>
            <span className="text-xs font-bold text-slate-500">Download Data</span>
            <span className="text-[10px] text-slate-400 mt-1">Export Reports</span>
        </div>
      </div>

      {/* Quick Status Section */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-5">
            <div className="flex items-center justify-between mb-4">
                <h3 className="font-bold text-slate-900 dark:text-white">System Health</h3>
                <span className="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full">Operational</span>
            </div>
            <div className="space-y-3">
                <div className="flex justify-between text-sm">
                    <span className="text-slate-500">Database</span>
                    <span className="font-mono text-slate-700 dark:text-slate-300">Healthy</span>
                </div>
                <div className="flex justify-between text-sm">
                    <span className="text-slate-500">Storage</span>
                    <span className="font-mono text-slate-700 dark:text-slate-300">24% Used</span>
                </div>
                <div className="flex justify-between text-sm">
                    <span className="text-slate-500">Last Backup</span>
                    <span className="font-mono text-slate-700 dark:text-slate-300">2 hours ago</span>
                </div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-5">
            <div className="flex items-center justify-between mb-4">
                <h3 className="font-bold text-slate-900 dark:text-white">Admin Actions</h3>
            </div>
            <div className="grid grid-cols-2 gap-3">
                <button onClick={() => navigate('/admin/users')} className="p-3 rounded-xl bg-slate-50 dark:bg-slate-800 text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <span className="block text-xs font-bold text-slate-500 mb-1">Users</span>
                    <span className="text-sm font-bold text-slate-900 dark:text-white">Manage Access</span>
                </button>
                <button onClick={() => navigate('/admin/config')} className="p-3 rounded-xl bg-slate-50 dark:bg-slate-800 text-left hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                    <span className="block text-xs font-bold text-slate-500 mb-1">Config</span>
                    <span className="text-sm font-bold text-slate-900 dark:text-white">System Settings</span>
                </button>
            </div>
        </div>
      </div>
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminDownloadsPage.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { Download, Save } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminDownloadsPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [entity, setEntity] = useState<'users' | 'nuggets'>('users');
  const [selectedColumns, setSelectedColumns] = useState<string[]>([]);
  const toast = useToast();

  useEffect(() => {
    setPageHeader("Data Export", "Create custom reports and download data.");
  }, []);

  const userCols = ['id', 'name', 'email', 'role', 'status', 'joinedAt', 'nuggets_count'];
  const nuggetCols = ['id', 'title', 'author', 'visibility', 'createdAt', 'reports_count'];

  const handleDownload = () => {
      toast.success(`Downloading ${entity} report...`);
  };

  const toggleCol = (c: string) => {
      if (selectedColumns.includes(c)) setSelectedColumns(selectedColumns.filter(x => x !== c));
      else setSelectedColumns([...selectedColumns, c]);
  };

  return (
    <div>
      <div className="max-w-2xl bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800">
          <div className="mb-6">
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Select Entity</label>
              <div className="flex gap-3">
                  <button onClick={() => { setEntity('users'); setSelectedColumns([]); }} className={`px-4 py-2 rounded-lg text-sm font-bold border ${entity === 'users' ? 'bg-primary-50 border-primary-500 text-primary-700' : 'bg-white border-slate-200 text-slate-600'}`}>Users</button>
                  <button onClick={() => { setEntity('nuggets'); setSelectedColumns([]); }} className={`px-4 py-2 rounded-lg text-sm font-bold border ${entity === 'nuggets' ? 'bg-primary-50 border-primary-500 text-primary-700' : 'bg-white border-slate-200 text-slate-600'}`}>Nuggets</button>
              </div>
          </div>

          <div className="mb-8">
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Select Columns</label>
              <div className="grid grid-cols-3 gap-3">
                  {(entity === 'users' ? userCols : nuggetCols).map(col => (
                      <label key={col} className="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded-lg border border-transparent hover:border-slate-100">
                          <input type="checkbox" checked={selectedColumns.includes(col)} onChange={() => toggleCol(col)} className="rounded text-primary-600 focus:ring-primary-500" />
                          <span className="text-sm font-medium text-slate-700 dark:text-slate-300 capitalize">{col.replace('_', ' ')}</span>
                      </label>
                  ))}
              </div>
          </div>

          <div className="flex justify-between pt-6 border-t border-slate-100 dark:border-slate-800">
              <button className="flex items-center gap-2 text-slate-500 font-bold text-sm hover:text-slate-800">
                  <Save size={16} /> Save Template
              </button>
              <button onClick={handleDownload} disabled={selectedColumns.length === 0} className="flex items-center gap-2 px-6 py-2.5 bg-slate-900 text-white rounded-xl font-bold text-sm hover:opacity-90 disabled:opacity-50">
                  <Download size={16} /> Download CSV
              </button>
          </div>
      </div>
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminFeedbackPage.tsx
================================================================================

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminFeedback } from '../types/admin';
import { adminFeedbackService } from '../services/adminFeedbackService';
import { Check, Archive, User } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { Avatar } from '../../components/shared/Avatar';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminFeedbackPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [feedback, setFeedback] = useState<AdminFeedback[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [filter, setFilter] = useState<'new' | 'read' | 'archived'>('new');
  const [dateFilter, setDateFilter] = useState('');
  
  const toast = useToast();
  const navigate = useNavigate();

  useEffect(() => {
    setPageHeader(
      "User Feedback", 
      "Listen to your users.",
      <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl items-center gap-2">
          <div className="flex">
              {['new', 'read', 'archived'].map(s => (
                  <button key={s} onClick={() => setFilter(s as any)} className={`px-3 py-1.5 text-xs font-bold capitalize rounded-lg transition-all ${filter === s ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{s}</button>
              ))}
          </div>
          <input 
              type="date" 
              value={dateFilter}
              onChange={(e) => setDateFilter(e.target.value)}
              className="pl-3 pr-2 py-1.5 text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-primary-500"
          />
      </div>
    );
  }, [filter, dateFilter]);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const data = await adminFeedbackService.listFeedback(filter);
      
      let filtered = data;
      if (dateFilter) {
          const d = new Date(dateFilter).toDateString();
          filtered = data.filter((f: AdminFeedback) => new Date(f.createdAt).toDateString() === d);
      }

      setFeedback(filtered);
    } catch (e) {
      toast.error("Failed to load feedback");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, [filter, dateFilter]);

  const handleStatus = async (id: string, status: 'read' | 'archived') => {
      await adminFeedbackService.updateStatus(id, status);
      setFeedback(prev => prev.filter(f => f.id !== id));
      toast.success("Updated");
  };

  const columns: Column<AdminFeedback>[] = [
    {
      key: 'type',
      header: 'Type',
      width: 'w-24',
      render: (f) => (
        <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
            f.type === 'bug' ? 'bg-red-100 text-red-600' :
            f.type === 'feature' ? 'bg-purple-100 text-purple-600' :
            'bg-slate-100 text-slate-600'
        }`}>
            {f.type}
        </span>
      )
    },
    {
      key: 'content',
      header: 'Feedback',
      render: (f) => <p className="text-sm text-slate-700 dark:text-slate-300 font-medium leading-relaxed">{f.content}</p>
    },
    {
      key: 'user',
      header: 'User',
      width: 'w-56',
      render: (f) => f.user ? (
          <div 
            className="flex items-center gap-3 cursor-pointer group"
            onClick={(e) => { e.stopPropagation(); navigate(`/profile/${f.user!.id}`); }}
          >
              <Avatar name={f.user.name} size="sm" src={f.user.avatar} />
              <div>
                  <div className="text-xs font-bold text-slate-900 dark:text-white group-hover:text-primary-600 group-hover:underline">{f.user.fullName || f.user.name}</div>
                  <div className="text-[10px] text-slate-500">@{f.user.username}</div>
              </div>
          </div>
      ) : (
          <div className="flex items-center gap-2 text-xs text-slate-400">
              <User size={14} /> Anonymous
          </div>
      )
    },
    {
      key: 'date',
      header: 'Date',
      width: 'w-32',
      render: (f) => <span className="text-xs text-slate-400">{new Date(f.createdAt).toLocaleDateString()}</span>
    },
    {
      key: 'time',
      header: 'Time',
      width: 'w-24',
      render: (f) => <span className="text-xs text-slate-400">{new Date(f.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
    },
    {
      key: 'actions',
      header: 'Actions',
      align: 'right',
      width: 'w-32',
      render: (f) => (
          <div className="flex justify-end gap-2">
              {f.status === 'new' && (
                  <button onClick={() => handleStatus(f.id, 'read')} className="p-1.5 text-green-600 hover:bg-green-50 rounded" title="Mark Read"><Check size={14} /></button>
              )}
              {f.status !== 'archived' && (
                  <button onClick={() => handleStatus(f.id, 'archived')} className="p-1.5 text-slate-400 hover:bg-slate-100 rounded" title="Archive"><Archive size={14} /></button>
              )}
          </div>
      )
    }
  ];

  return (
    <div>
      <AdminTable columns={columns} data={feedback} isLoading={isLoading} />
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminLegalPages.tsx
================================================================================

import React, { useEffect, useState } from 'react';
import { useAdminHeader } from '../layout/AdminLayout';
import { adminConfigService } from '../services/adminConfigService';
import { LegalPage } from '../../types/legal';
import { useToast } from '../../hooks/useToast';
import { RichTextEditor } from '../../components/RichTextEditor';
import { ToggleLeft, ToggleRight, Edit3, Globe, Save, ExternalLink } from 'lucide-react';
import { AdminDrawer } from '../components/AdminDrawer';
import { formatDate } from '../../utils/formatters';

export const AdminLegalPages: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [pages, setPages] = useState<LegalPage[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingPage, setEditingPage] = useState<LegalPage | null>(null);
  const [editorContent, setEditorContent] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const toast = useToast();

  useEffect(() => {
    setPageHeader("Legal & Info Pages", "Manage site content, terms, and policies.");
    loadPages();
  }, []);

  const loadPages = async () => {
    setLoading(true);
    const data = await adminConfigService.getLegalPages();
    setPages(data);
    setLoading(false);
  };

  const handleToggle = async (page: LegalPage) => {
    const newState = !page.isEnabled;
    // Optimistic UI
    setPages(prev => prev.map(p => p.id === page.id ? { ...p, isEnabled: newState } : p));
    
    try {
        await adminConfigService.updateLegalPage(page.id, { isEnabled: newState });
        toast.success(`${page.title} is now ${newState ? 'Active' : 'Disabled'}`);
    } catch (e) {
        toast.error("Failed to update status");
        loadPages(); // Revert
    }
  };

  const openEditor = (page: LegalPage) => {
      setEditingPage(page);
      setEditorContent(page.content);
  };

  const handleSaveContent = async () => {
      if (!editingPage) return;
      setIsSaving(true);
      try {
          await adminConfigService.updateLegalPage(editingPage.id, { content: editorContent });
          toast.success("Content saved");
          setEditingPage(null);
          loadPages();
      } catch (e) {
          toast.error("Failed to save content");
      } finally {
          setIsSaving(false);
      }
  };

  if (loading) return <div className="p-8 text-center text-slate-400">Loading pages...</div>;

  return (
    <div className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {pages.map(page => (
                <div key={page.id} className={`group relative bg-white dark:bg-slate-900 border ${page.isEnabled ? 'border-slate-200 dark:border-slate-800' : 'border-slate-100 dark:border-slate-800/50 opacity-70'} rounded-2xl p-6 shadow-sm hover:shadow-md transition-all`}>
                    
                    <div className="flex justify-between items-start mb-4">
                        <div className={`p-3 rounded-xl ${page.isEnabled ? 'bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white' : 'bg-slate-50 dark:bg-slate-900 text-slate-400'}`}>
                            <Globe size={24} />
                        </div>
                        <button 
                            onClick={() => handleToggle(page)}
                            className={`transition-colors ${page.isEnabled ? 'text-green-600 dark:text-green-400' : 'text-slate-300 dark:text-slate-600 hover:text-slate-500'}`}
                            title={page.isEnabled ? "Click to Disable" : "Click to Enable"}
                        >
                            {page.isEnabled ? <ToggleRight size={32} /> : <ToggleLeft size={32} />}
                        </button>
                    </div>

                    <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-1">{page.title}</h3>
                    <p className="text-xs text-slate-500 mb-6 font-mono">/{page.slug}</p>

                    <div className="flex items-center justify-between border-t border-slate-100 dark:border-slate-800 pt-4">
                        <span className="text-[10px] text-slate-400 font-medium">
                            Updated {formatDate(page.lastUpdated)}
                        </span>
                        <button 
                            onClick={() => openEditor(page)}
                            className="flex items-center gap-2 text-sm font-bold text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
                        >
                            <Edit3 size={16} /> Edit
                        </button>
                    </div>
                </div>
            ))}
        </div>

        {/* EDITOR DRAWER */}
        <AdminDrawer 
            isOpen={!!editingPage}
            onClose={() => setEditingPage(null)}
            title={editingPage ? `Edit ${editingPage.title}` : 'Editor'}
            width="xl"
            footer={
                <div className="flex justify-between w-full">
                    <button onClick={() => setEditingPage(null)} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg">Cancel</button>
                    <button 
                        onClick={handleSaveContent} 
                        disabled={isSaving}
                        className="flex items-center gap-2 px-6 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg font-bold hover:opacity-90 disabled:opacity-50"
                    >
                        <Save size={16} /> {isSaving ? 'Saving...' : 'Save Changes'}
                    </button>
                </div>
            }
        >
            <div className="h-full flex flex-col gap-4">
                <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl flex items-center gap-3 text-sm text-blue-700 dark:text-blue-300">
                    <ExternalLink size={18} />
                    <span>
                        This content uses Markdown formatting. 
                        <a href={`/#/${editingPage?.slug}`} target="_blank" rel="noreferrer" className="underline ml-1 font-bold">
                            View Live Page
                        </a>
                    </span>
                </div>
                
                <div className="flex-1">
                    <RichTextEditor 
                        value={editorContent}
                        onChange={setEditorContent}
                        className="h-[60vh]"
                        placeholder="# Start writing..."
                    />
                </div>
            </div>
        </AdminDrawer>
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminModerationPage.tsx
================================================================================

import React, { useEffect, useState } from 'react';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminSummaryBar } from '../components/AdminSummaryBar';
import { AdminReport } from '../types/admin';
import { adminModerationService } from '../services/adminModerationService';
import { AlertCircle, CheckCircle, XCircle, FileText, User, Layers, Info, ExternalLink } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { AdminDrawer } from '../components/AdminDrawer';
import { ConfirmActionModal } from '../../components/settings/ConfirmActionModal';
import { formatDate } from '../../utils/formatters';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminModerationPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [reports, setReports] = useState<AdminReport[]>([]);
  const [stats, setStats] = useState({ open: 0, resolved: 0, dismissed: 0 });
  const [isLoading, setIsLoading] = useState(true);
  const [selectedReport, setSelectedReport] = useState<AdminReport | null>(null);
  const [filter, setFilter] = useState<'open' | 'resolved' | 'dismissed'>('open');
  const [dateFilter, setDateFilter] = useState('');
  const [resolveTarget, setResolveTarget] = useState<{ id: string; status: 'resolved' | 'dismissed' } | null>(null);
  
  const toast = useToast();

  useEffect(() => {
    setPageHeader(
      "Moderation Queue", 
      "Review and resolve user reports.",
      <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
          {['open', 'resolved', 'dismissed'].map((status) => (
              <button 
                  key={status}
                  onClick={() => setFilter(status as any)}
                  className={`px-3 py-1.5 text-xs font-bold rounded-lg capitalize transition-all ${filter === status ? 'bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500'}`}
              >
                  {status}
              </button>
          ))}
      </div>
    );
  }, [filter]);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [reportsData, statsData] = await Promise.all([
        adminModerationService.listReports(filter),
        adminModerationService.getStats()
      ]);
      
      let filteredReports = reportsData;
      if (dateFilter) {
          const d = new Date(dateFilter).toDateString();
          filteredReports = reportsData.filter(r => new Date(r.createdAt).toDateString() === d);
      }

      setReports(filteredReports);
      setStats(statsData);
    } catch (e) {
      toast.error("Failed to load reports");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, [filter, dateFilter]);

  const executeResolution = async () => {
    if (!resolveTarget) return;
    try {
      await adminModerationService.resolveReport(resolveTarget.id, resolveTarget.status);
      setReports(prev => prev.filter(r => r.id !== resolveTarget.id));
      toast.success(resolveTarget.status === 'resolved' ? "Report Resolved" : "Report Dismissed");
      setResolveTarget(null);
      setSelectedReport(null);
      if (filter !== 'open') loadData(); 
    } catch (e) {
      toast.error("Action failed");
    }
  };

  const getTargetIcon = (type: string) => {
    switch (type) {
        case 'nugget': return <FileText size={14} />;
        case 'user': return <User size={14} />;
        case 'collection': return <Layers size={14} />;
        default: return <Info size={14} />;
    }
  };

  const columns: Column<AdminReport>[] = [
    {
      key: 'reason',
      header: 'Reason',
      width: 'w-40',
      render: (r) => (
        <div className="flex items-center gap-2">
            <span className={`p-1.5 rounded-lg ${r.reason === 'spam' ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'} dark:bg-opacity-20`}>
                <AlertCircle size={14} />
            </span>
            <span className="font-bold text-slate-900 dark:text-white capitalize">{r.reason}</span>
        </div>
      )
    },
    {
      key: 'reporter',
      header: 'Complainant',
      render: (r) => <span className="text-xs text-slate-600">{r.reporter.name}</span>
    },
    {
      key: 'respondent',
      header: 'Respondent',
      render: (r) => <span className="text-xs font-bold text-slate-700">{r.respondent?.name || 'Unknown'}</span>
    },
    {
      key: 'targetType',
      header: 'Type',
      render: (r) => (
        <span className="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-slate-100 dark:bg-slate-800 text-xs font-medium capitalize">
            {getTargetIcon(r.targetType)} {r.targetType}
        </span>
      )
    },
    {
      key: 'description',
      header: 'Description',
      render: (r) => (
        <span className="text-sm text-slate-500 line-clamp-1 max-w-xs" title={r.description}>{r.description || 'No details provided'}</span>
      )
    },
    {
      key: 'createdAt',
      header: 'Reported',
      render: (r) => <span className="text-xs text-slate-500">{formatDate(r.createdAt, true)}</span>
    },
    {
      key: 'actions',
      header: 'Action',
      render: (r) => (
        <button 
            onClick={() => setSelectedReport(r)}
            className="text-primary-600 hover:text-primary-700 text-xs font-bold"
        >
            Review
        </button>
      )
    }
  ];

  return (
    <div>
      <AdminSummaryBar items={[{label:'Open', value: stats.open}, {label: 'Resolved', value: stats.resolved}]} isLoading={isLoading} />
      
      <AdminTable 
        columns={columns} 
        data={reports} 
        isLoading={isLoading} 
        placeholder="Search reports..."
        filters={
            <input 
                type="date" 
                value={dateFilter}
                onChange={(e) => setDateFilter(e.target.value)}
                className="pl-3 pr-2 py-1.5 text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-primary-500"
            />
        }
      />

      <AdminDrawer
        isOpen={!!selectedReport}
        onClose={() => setSelectedReport(null)}
        title="Review Report"
        footer={
            selectedReport?.status === 'open' && (
                <div className="grid grid-cols-2 gap-3 w-full">
                    <button 
                        onClick={() => setResolveTarget({ id: selectedReport.id, status: 'dismissed' })}
                        className="px-4 py-2.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center gap-2 transition-colors"
                    >
                        <XCircle size={16} /> Dismiss
                    </button>
                    <button 
                        onClick={() => setResolveTarget({ id: selectedReport.id, status: 'resolved' })}
                        className="px-4 py-2.5 bg-red-600 text-white rounded-xl text-sm font-bold hover:bg-red-700 flex items-center justify-center gap-2 transition-colors"
                    >
                        <CheckCircle size={16} /> Take Action
                    </button>
                </div>
            )
        }
      >
        {selectedReport && (
            <div className="space-y-6">
                
                {/* Reporter Info */}
                <div className="p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wide">Reporter</span>
                        <span className="text-xs text-slate-500">{formatDate(selectedReport.createdAt, true)}</span>
                    </div>
                    <div className="flex items-center gap-2 font-medium text-slate-900 dark:text-white">
                        <User size={16} className="text-slate-400" />
                        {selectedReport.reporter.name}
                    </div>
                </div>

                {/* The Report */}
                <div>
                    <h3 className="text-sm font-bold text-slate-900 dark:text-white mb-2 flex items-center gap-2">
                        <AlertCircle size={16} className="text-red-500" />
                        Reason: <span className="capitalize">{selectedReport.reason}</span>
                    </h3>
                    <p className="text-sm text-slate-600 dark:text-slate-300 bg-red-50 dark:bg-red-900/10 p-3 rounded-xl border border-red-100 dark:border-red-900/20 leading-relaxed">
                        "{selectedReport.description || 'No description provided.'}"
                    </p>
                </div>

                {/* Targeted Content Stub */}
                <div className="border-t border-slate-100 dark:border-slate-800 pt-6">
                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Targeted Content</h3>
                    <div className="p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-sm opacity-80">
                        <div className="flex items-center gap-2 mb-2">
                            <span className="text-xs font-bold px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-800 uppercase">{selectedReport.targetType}</span>
                            <span className="text-xs text-slate-400">ID: {selectedReport.targetId}</span>
                        </div>
                        <div className="h-16 bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-center text-slate-400 text-xs italic">
                            Content Preview Stub
                        </div>
                        <div className="mt-3 flex justify-end">
                            <button className="text-xs font-bold text-primary-600 flex items-center gap-1 hover:underline">
                                View Full Entity <ExternalLink size={12} />
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        )}
      </AdminDrawer>

      <ConfirmActionModal 
        isOpen={!!resolveTarget} 
        onClose={() => setResolveTarget(null)} 
        onConfirm={executeResolution} 
        title={resolveTarget?.status === 'resolved' ? "Resolve Report?" : "Dismiss Report?"} 
        description={resolveTarget?.status === 'resolved' ? "This will mark the report as resolved and close the ticket." : "This will dismiss the report without action."}
        actionLabel={resolveTarget?.status === 'resolved' ? "Resolve" : "Dismiss"}
      />
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminNuggetsPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from 'react';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminSummaryBar } from '../components/AdminSummaryBar';
import { AdminNugget } from '../types/admin';
import { adminNuggetsService } from '../services/adminNuggetsService';
import { AlertTriangle, Trash2, EyeOff, Globe, Lock, Video, Image as ImageIcon, Link as LinkIcon, StickyNote, CheckCircle2, FileText, PlusCircle, Edit2, Save, Layout } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { useAdminPermissions } from '../hooks/useAdminPermissions';
import { AdminDrawer } from '../components/AdminDrawer';
import { ConfirmActionModal } from '../../components/settings/ConfirmActionModal';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminNuggetsPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [nuggets, setNuggets] = useState<AdminNugget[]>([]);
  const [stats, setStats] = useState({ total: 0, flagged: 0, createdToday: 0, public: 0, private: 0 });
  const [isLoading, setIsLoading] = useState(true);
  
  // Filters
  const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'hidden' | 'flagged'>('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [dateFilter, setDateFilter] = useState('');

  // Sorting
  const [sortKey, setSortKey] = useState<string>('createdAt');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');

  // Selection & UI
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [visibleColumns, setVisibleColumns] = useState<string[]>([
    'title', 'author', 'visibility', 'status', 'createdDate', 'createdTime', 'actions'
  ]);
  const [showColumnMenu, setShowColumnMenu] = useState(false);

  // Actions
  const [selectedNugget, setSelectedNugget] = useState<AdminNugget | null>(null);
  const [itemToDelete, setItemToDelete] = useState<AdminNugget | null>(null);
  const [editMode, setEditMode] = useState(false);
  
  // Edit Form State
  const [editTitle, setEditTitle] = useState('');
  const [editExcerpt, setEditExcerpt] = useState('');
  const [isSaving, setIsSaving] = useState(false);

  const toast = useToast();
  const { can } = useAdminPermissions();

  useEffect(() => {
    setPageHeader("Content Management", "Review, moderate, and manage nuggets.");
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [nuggetsData, statsData] = await Promise.all([
        adminNuggetsService.listNuggets(statusFilter === 'all' ? undefined : statusFilter as any),
        adminNuggetsService.getStats()
      ]);
      setNuggets(nuggetsData);
      setStats(statsData);
    } catch (e) {
      toast.error("Failed to load nuggets");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    const timer = setTimeout(loadData, 300);
    return () => clearTimeout(timer);
  }, [statusFilter]);

  // Derived state
  const processedNuggets = useMemo(() => {
    let result = [...nuggets];

    // Search
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      result = result.filter(n => 
        n.title.toLowerCase().includes(q) || 
        n.author.name.toLowerCase().includes(q)
      );
    }

    // Filter Date
    if (dateFilter) {
      const filterDate = new Date(dateFilter).toDateString();
      result = result.filter(n => new Date(n.createdAt).toDateString() === filterDate);
    }

    // Sort
    result.sort((a, b) => {
      let valA: any = a[sortKey as keyof AdminNugget] || '';
      let valB: any = b[sortKey as keyof AdminNugget] || '';

      if (sortKey === 'author.name') {
        valA = a.author.name.toLowerCase();
        valB = b.author.name.toLowerCase();
      } else if (sortKey === 'createdAt') {
        valA = new Date(a.createdAt).getTime();
        valB = new Date(b.createdAt).getTime();
      }

      if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    return result;
  }, [nuggets, searchQuery, dateFilter, sortKey, sortDirection]);

  // Populate form when opening edit mode
  useEffect(() => {
    if (selectedNugget && editMode) {
      setEditTitle(selectedNugget.title);
      setEditExcerpt(selectedNugget.excerpt);
    }
  }, [selectedNugget, editMode]);

  const handleStatusChange = async (nugget: AdminNugget, newStatus: 'active' | 'hidden') => {
    try {
      await adminNuggetsService.updateNuggetStatus(nugget.id, newStatus);
      setNuggets(prev => prev.map(n => n.id === nugget.id ? { ...n, status: newStatus } : n));
      const newStats = await adminNuggetsService.getStats();
      setStats(newStats);
      toast.success(newStatus === 'active' ? 'Nugget Approved' : 'Nugget Hidden');
    } catch (e) {
      toast.error("Action failed");
    }
  };

  const handleSaveChanges = async () => {
    if (!selectedNugget) return;
    setIsSaving(true);
    try {
      // Mock save delay
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // Update local state
      const updated = { ...selectedNugget, title: editTitle, excerpt: editExcerpt };
      setNuggets(prev => prev.map(n => n.id === selectedNugget.id ? updated : n));
      
      toast.success("Changes saved");
      setEditMode(false);
      setSelectedNugget(null);
    } catch (e) {
      toast.error("Failed to save changes");
    } finally {
      setIsSaving(false);
    }
  };

  const handleDelete = async () => {
    if (!itemToDelete) return;
    try {
      await adminNuggetsService.deleteNugget(itemToDelete.id);
      setNuggets(prev => prev.filter(n => n.id !== itemToDelete.id));
      const newStats = await adminNuggetsService.getStats();
      setStats(newStats);
      toast.success("Nugget deleted");
      setItemToDelete(null);
    } catch (e) {
      toast.error("Delete failed");
    }
  };

  const handleBulkAction = (action: string) => {
      toast.info(`${action} ${selectedIds.length} items (Not implemented)`);
      setSelectedIds([]);
  };

  const getTypeIcon = (type: string) => {
    switch(type) {
        case 'video': return <Video size={14} />;
        case 'image': return <ImageIcon size={14} />;
        case 'link': return <LinkIcon size={14} />;
        default: return <StickyNote size={14} />;
    }
  };

  const allColumns: Column<AdminNugget>[] = [
    {
      key: 'id',
      header: 'ID',
      width: 'w-20',
      minWidth: '80px',
      render: (n) => <span className="text-[10px] font-mono text-slate-400">#{n.id.split('-')[1]}</span>
    },
    {
      key: 'title',
      header: 'Title & Snippet',
      width: 'w-72',
      minWidth: '280px',
      sortable: true,
      sticky: 'left',
      render: (n) => (
        <div className="flex gap-3 py-1">
          <div className={`shrink-0 w-8 h-8 rounded-lg flex items-center justify-center ${n.status === 'flagged' ? 'bg-red-100 text-red-600' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}>
            {getTypeIcon(n.type)}
          </div>
          <div className="min-w-0 flex-1">
            <div className="font-bold text-xs text-indigo-600 dark:text-indigo-400 truncate group-hover:text-indigo-500 transition-colors">
              {n.title}
            </div>
            <p className="text-[10px] text-slate-500 truncate mt-0.5">{n.excerpt}</p>
          </div>
        </div>
      )
    },
    {
      key: 'author',
      header: 'Author',
      width: 'w-40',
      minWidth: '150px',
      sortable: true,
      sortKey: 'author.name',
      render: (n) => (
        <span className="text-xs font-medium text-slate-700 dark:text-slate-300">{n.author.name}</span>
      )
    },
    {
      key: 'visibility',
      header: 'Visibility',
      width: 'w-28',
      minWidth: '100px',
      sortable: true,
      render: (n) => (
        <span className="flex items-center gap-1.5 text-[10px] font-bold uppercase text-slate-500">
            {n.visibility === 'public' ? <Globe size={12} /> : <Lock size={12} />}
            {n.visibility}
        </span>
      )
    },
    {
      key: 'status',
      header: 'Status',
      width: 'w-32',
      minWidth: '120px',
      sortable: true,
      render: (n) => (
        <div className="flex items-center gap-2">
            <span className={`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[9px] font-bold capitalize border ${n.status === 'flagged' ? 'bg-red-50 text-red-700 border-red-200' : n.status === 'hidden' ? 'bg-slate-100 text-slate-600 border-slate-200' : 'bg-green-50 text-green-700 border-green-200'}`}>
                {n.status === 'flagged' && <AlertTriangle size={8} />}
                {n.status}
            </span>
            {n.reports > 0 && (
                <span className="text-[10px] font-bold text-red-500 bg-red-50 px-1.5 rounded-full">{n.reports} reports</span>
            )}
        </div>
      )
    },
    {
      key: 'createdDate',
      header: 'Created Date',
      width: 'w-32',
      minWidth: '120px',
      sortable: true,
      sortKey: 'createdAt',
      render: (n) => <span className="text-xs text-slate-500">{new Date(n.createdAt).toLocaleDateString()}</span>
    },
    {
      key: 'createdTime',
      header: 'Time',
      width: 'w-24',
      minWidth: '100px',
      render: (n) => <span className="text-xs text-slate-400">{new Date(n.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
    },
    {
      key: 'actions',
      header: 'Actions',
      align: 'right',
      width: 'w-32',
      minWidth: '130px',
      sticky: 'right',
      render: (n) => (
        <div className="flex justify-end gap-2" onClick={(e) => e.stopPropagation()}>
          <button 
            onClick={() => { setEditMode(true); setSelectedNugget(n); }}
            className="flex items-center gap-1.5 px-2 py-1.5 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 hover:border-slate-300 rounded-md text-[10px] font-bold transition-colors"
            title="Edit Nugget"
          >
            <Edit2 size={14} />
            <span className="hidden md:inline">Edit</span>
          </button>
          
          {can('admin.nuggets.hide') && (
            <button 
              onClick={() => handleStatusChange(n, n.status === 'active' ? 'hidden' : 'active')} 
              className={`flex items-center gap-1.5 px-2 py-1.5 rounded-md text-[10px] font-bold border transition-colors ${n.status === 'active' ? 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50' : 'bg-green-50 border-green-100 text-green-700 hover:bg-green-100'}`}
              title={n.status === 'active' ? "Hide Content" : "Approve Content"}
            >
              {n.status === 'active' ? <EyeOff size={14} /> : <CheckCircle2 size={14} />}
            </button>
          )}
          {can('admin.nuggets.delete') && (
            <button 
              onClick={() => setItemToDelete(n)} 
              className="flex items-center gap-1.5 px-2 py-1.5 bg-white border border-slate-200 text-slate-400 hover:text-red-600 hover:border-red-200 rounded-md text-[10px] font-bold transition-colors"
              title="Delete Permanently"
            >
              <Trash2 size={14} />
            </button>
          )}
        </div>
      )
    }
  ];

  const activeColumns = allColumns.filter(c => visibleColumns.includes(c.key));

  const Filters = (
    <div className="flex items-center gap-2">
      <div className="bg-slate-100 dark:bg-slate-800 p-0.5 rounded-lg flex">
        <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value as any)} className="text-[10px] bg-transparent font-bold text-slate-600 dark:text-slate-300 focus:outline-none cursor-pointer px-2 py-1">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="hidden">Hidden</option>
            <option value="flagged">Flagged</option>
        </select>
      </div>

      <div className="relative flex items-center">
        <input 
            type="date" 
            value={dateFilter}
            onChange={(e) => setDateFilter(e.target.value)}
            className="pl-3 pr-2 py-1 text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-primary-500"
        />
      </div>

      <div className="relative">
        <button 
            onClick={() => setShowColumnMenu(!showColumnMenu)}
            className="px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-[10px] font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 transition-colors flex items-center gap-1.5"
        >
            <Layout size={12} /> Columns
        </button>
        {showColumnMenu && (
            <>
                <div className="fixed inset-0 z-40" onClick={() => setShowColumnMenu(false)} />
                <div className="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-50 p-2 max-h-64 overflow-y-auto custom-scrollbar">
                    {allColumns.filter(c => c.key !== 'title' && c.key !== 'actions').map(col => (
                        <label key={col.key} className="flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg cursor-pointer">
                            <input 
                                type="checkbox" 
                                checked={visibleColumns.includes(col.key)}
                                onChange={(e) => {
                                    if (e.target.checked) setVisibleColumns([...visibleColumns, col.key]);
                                    else setVisibleColumns(visibleColumns.filter(k => k !== col.key));
                                }}
                                className="rounded border-slate-300 text-primary-600 focus:ring-primary-500"
                            />
                            <span className="text-xs font-medium text-slate-700 dark:text-slate-300">{col.header}</span>
                        </label>
                    ))}
                </div>
            </>
        )}
      </div>
    </div>
  );

  const BulkActions = selectedIds.length > 0 ? (
      <div className="flex items-center gap-2 animate-in fade-in slide-in-from-right-2 duration-200">
          <span className="text-xs font-bold text-slate-500">{selectedIds.length} selected</span>
          <button onClick={() => handleBulkAction('approve')} className="px-3 py-1.5 bg-green-50 text-green-700 hover:bg-green-100 rounded-lg text-[10px] font-bold transition-colors">Approve</button>
          <button onClick={() => handleBulkAction('hide')} className="px-3 py-1.5 bg-slate-100 text-slate-700 hover:bg-slate-200 rounded-lg text-[10px] font-bold transition-colors">Hide</button>
          <button onClick={() => handleBulkAction('delete')} className="px-3 py-1.5 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg text-[10px] font-bold transition-colors">Delete</button>
      </div>
  ) : null;

  return (
    <div>
      <AdminSummaryBar 
        items={[
          { label: 'Total Nuggets', value: stats.total, icon: <FileText size={18} /> },
          { label: 'Public', value: stats.public, icon: <Globe size={18} /> },
          { label: 'Private', value: stats.private, icon: <Lock size={18} /> },
          { label: 'Created Today', value: stats.createdToday, icon: <PlusCircle size={18} />, hint: 'New content velocity' },
        ]}
        isLoading={isLoading}
      />

      <AdminTable 
        columns={activeColumns} 
        data={processedNuggets} 
        isLoading={isLoading} 
        filters={Filters} 
        actions={BulkActions}
        onSearch={setSearchQuery} 
        pagination={{ page: 1, totalPages: 1, onPageChange: () => {} }}
        
        sortKey={sortKey}
        sortDirection={sortDirection}
        onSortChange={(k, d) => { setSortKey(k); setSortDirection(d); }}

        onRowClick={(n) => { setEditMode(false); setSelectedNugget(n); }}
        selection={{
            enabled: true,
            selectedIds: selectedIds,
            onSelect: setSelectedIds
        }}
      />
      
      <AdminDrawer 
        isOpen={!!selectedNugget} 
        onClose={() => { setSelectedNugget(null); setEditMode(false); }} 
        title={editMode ? "Edit Nugget" : "Nugget Details"} 
        width="lg"
        footer={editMode && (
            <div className="flex justify-end gap-2 w-full">
                <button 
                    onClick={() => { setEditMode(false); }}
                    className="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-50 transition-colors"
                >
                    Cancel
                </button>
                <button 
                    onClick={handleSaveChanges}
                    disabled={isSaving || !editTitle.trim()}
                    className="flex items-center gap-2 px-6 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold hover:bg-slate-800 transition-colors disabled:opacity-50"
                >
                    {isSaving ? 'Saving...' : <><Save size={16} /> Save Changes</>}
                </button>
            </div>
        )}
      >
        {selectedNugget && (
            <div className="space-y-6">
                <div>
                    {editMode ? (
                        <div className="space-y-2 mb-4">
                            <label className="text-xs font-bold text-slate-500 uppercase">Title</label>
                            <input 
                                value={editTitle}
                                onChange={(e) => setEditTitle(e.target.value)}
                                className="w-full text-xl font-bold text-slate-900 dark:text-white bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                            />
                        </div>
                    ) : (
                        <h2 className="text-xl font-bold text-slate-900 dark:text-white leading-tight mb-2">{selectedNugget.title}</h2>
                    )}
                    
                    <div className="flex items-center gap-2 text-xs text-slate-500">
                        <span>Posted by {selectedNugget.author.name}</span>
                        <span>•</span>
                        <span>{new Date(selectedNugget.createdAt).toLocaleDateString()}</span>
                    </div>
                </div>

                <div>
                    {editMode && <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Excerpt / Content</label>}
                    <div className={`rounded-xl border ${editMode ? 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900' : 'border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50'} p-4`}>
                        {editMode ? (
                            <textarea 
                                value={editExcerpt}
                                onChange={(e) => setEditExcerpt(e.target.value)}
                                className="w-full h-48 bg-transparent focus:outline-none text-slate-700 dark:text-slate-300 leading-relaxed text-sm resize-none"
                            />
                        ) : (
                            <p className="text-slate-700 dark:text-slate-300 leading-relaxed text-sm whitespace-pre-wrap">{selectedNugget.excerpt}</p>
                        )}
                    </div>
                </div>

                {!editMode && (
                    <div className="grid grid-cols-2 gap-4 text-xs">
                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <span className="block text-slate-400 font-bold uppercase mb-1">Status</span>
                            <span className="font-medium capitalize">{selectedNugget.status}</span>
                        </div>
                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <span className="block text-slate-400 font-bold uppercase mb-1">Reports</span>
                            <span className="font-medium">{selectedNugget.reports}</span>
                        </div>
                    </div>
                )}
            </div>
        )}
      </AdminDrawer>

      <ConfirmActionModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={handleDelete} title="Delete Nugget?" description="Permanently remove this content." actionLabel="Delete" isDestructive />
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminTagsPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from 'react';
import { createPortal } from 'react-dom';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminSummaryBar } from '../components/AdminSummaryBar';
import { AdminTag } from '../types/admin';
import { adminTagsService } from '../services/adminTagsService';
import { Trash2, Plus, Edit2, Hash, Tag, Layers, GitMerge } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { AdminDrawer } from '../components/AdminDrawer';
import { ConfirmActionModal } from '../../components/settings/ConfirmActionModal';
import { useAdminHeader } from '../layout/AdminLayout';

// --- Merge Modal Component ---
const MergeModal: React.FC<{ isOpen: boolean; onClose: () => void; onConfirm: (name: string) => void; count: number }> = ({ isOpen, onClose, onConfirm, count }) => {
    const [targetName, setTargetName] = useState('');
    if (!isOpen) return null;

    return createPortal(
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in" onClick={onClose} />
            <div className="relative w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-xl p-6 animate-in zoom-in-95 border border-slate-200 dark:border-slate-800">
                <div className="mb-4">
                    <div className="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-3">
                        <GitMerge size={24} />
                    </div>
                    <h3 className="text-lg font-bold text-slate-900 dark:text-white">Merge {count} Tags</h3>
                    <p className="text-sm text-slate-500 mt-1">
                        Merging will combine usage counts and remove the original tags. Enter the name for the final tag.
                    </p>
                </div>
                <input 
                    autoFocus
                    value={targetName}
                    onChange={(e) => setTargetName(e.target.value)}
                    placeholder="e.g. Technology"
                    className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 mb-6 focus:outline-none focus:ring-2 focus:ring-purple-500 dark:text-white"
                />
                <div className="flex justify-end gap-2">
                    <button onClick={onClose} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">Cancel</button>
                    <button 
                        onClick={() => onConfirm(targetName)}
                        disabled={!targetName.trim()}
                        className="px-6 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 disabled:opacity-50"
                    >
                        Merge
                    </button>
                </div>
            </div>
        </div>,
        document.body
    );
};

// --- Rename Modal Component ---
const RenameModal: React.FC<{ isOpen: boolean; onClose: () => void; onConfirm: (name: string) => void; initialName: string }> = ({ isOpen, onClose, onConfirm, initialName }) => {
    const [newName, setNewName] = useState(initialName);
    useEffect(() => { if (isOpen) setNewName(initialName); }, [isOpen, initialName]);
    
    if (!isOpen) return null;

    return createPortal(
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in" onClick={onClose} />
            <div className="relative w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-xl p-6 animate-in zoom-in-95 border border-slate-200 dark:border-slate-800">
                <div className="mb-4">
                    <h3 className="text-lg font-bold text-slate-900 dark:text-white">Rename Tag</h3>
                    <p className="text-sm text-slate-500 mt-1">This will update the tag across all existing nuggets.</p>
                </div>
                <input 
                    autoFocus
                    value={newName}
                    onChange={(e) => setNewName(e.target.value)}
                    className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 mb-6 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:text-white"
                />
                <div className="flex justify-end gap-2">
                    <button onClick={onClose} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg">Cancel</button>
                    <button onClick={() => onConfirm(newName)} disabled={!newName.trim() || newName === initialName} className="px-6 py-2 bg-primary-500 text-slate-900 rounded-lg font-bold hover:bg-primary-400 disabled:opacity-50">Save</button>
                </div>
            </div>
        </div>,
        document.body
    );
};

export const AdminTagsPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [tags, setTags] = useState<AdminTag[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState({ totalTags: 0, pending: 0, categories: 0 });
  
  // Table State
  const [searchQuery, _setSearchQuery] = useState('');
  const [sortKey, setSortKey] = useState<string>('usageCount');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const [selectedIds, setSelectedIds] = useState<string[]>([]);

  // Actions
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const [tagNameInput, setTagNameInput] = useState(''); 
  
  const [isMergeOpen, setIsMergeOpen] = useState(false);
  const [renameTarget, setRenameTarget] = useState<AdminTag | null>(null);
  const [deleteId, setDeleteId] = useState<string | null>(null);

  const toast = useToast();

  const openCreate = () => {
      setTagNameInput('');
      setIsDrawerOpen(true);
  };

  useEffect(() => {
    setPageHeader(
      "Tags & Taxonomy", 
      "Manage global categories and review user-suggested tags.",
      <button onClick={openCreate} className="flex items-center gap-2 px-4 py-2 bg-primary-500 text-slate-900 rounded-lg text-sm font-bold hover:bg-primary-400 shadow-sm transition-colors">
          <Plus size={16} /> Create Tag
      </button>
    );
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [data, statsData] = await Promise.all([
          adminTagsService.listTags(searchQuery),
          adminTagsService.getStats()
      ]);
      setTags(data);
      setStats(statsData);
    } catch (e) {
      toast.error("Failed to load tags");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    const timer = setTimeout(loadData, 300);
    return () => clearTimeout(timer);
  }, [searchQuery]);

  const processedTags = useMemo(() => {
    let result = [...tags];
    result.sort((a, b) => {
      let valA: any = a[sortKey as keyof AdminTag] || '';
      let valB: any = b[sortKey as keyof AdminTag] || '';

      if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
    return result;
  }, [tags, sortKey, sortDirection]);

  // -- Actions --

  const handleInlineUpdate = async (id: string, updates: Partial<AdminTag>) => {
      setTags(prev => prev.map(t => t.id === id ? { ...t, ...updates } : t));
      try {
          await adminTagsService.updateTag(id, updates);
          toast.success("Tag updated");
      } catch (e) {
          toast.error("Update failed");
          loadData();
      }
  };

  const handleRename = async (newName: string) => {
      if (!renameTarget) return;
      try {
          await adminTagsService.renameTag(renameTarget.id, newName);
          setTags(prev => prev.map(t => t.id === renameTarget.id ? { ...t, name: newName } : t));
          toast.success("Tag renamed successfully");
          setRenameTarget(null);
      } catch (e) {
          toast.error("Rename failed");
      }
  };

  const handleMerge = async (targetName: string) => {
      setIsMergeOpen(false);
      try {
          await adminTagsService.mergeTags(selectedIds, targetName);
          toast.success(`Merged ${selectedIds.length} tags into "${targetName}"`);
          setSelectedIds([]);
          loadData();
      } catch (e) {
          toast.error("Merge failed");
      }
  };

  const handleDelete = async () => {
      if (!deleteId) return;
      try {
          await adminTagsService.deleteTag(deleteId);
          setTags(prev => prev.filter(t => t.id !== deleteId));
          toast.success("Tag deleted");
          setDeleteId(null);
      } catch (e) {
          toast.error("Delete failed");
      }
  };

  const handleBulkDelete = async () => {
      if (!window.confirm(`Delete ${selectedIds.length} tags?`)) return;
      for (const id of selectedIds) {
          await adminTagsService.deleteTag(id);
      }
      toast.success("Tags deleted");
      setSelectedIds([]);
      loadData();
  };

  const saveDrawer = async () => {
      const newTag: AdminTag = {
          id: `t-${Date.now()}`,
          name: tagNameInput,
          type: 'tag',
          usageCount: 0,
          isOfficial: false,
          status: 'active'
      };
      setTags(prev => [newTag, ...prev]);
      toast.success("Tag created");
      setIsDrawerOpen(false);
  };

  // -- Columns --
  const columns: Column<AdminTag>[] = [
    {
      key: 'name',
      header: 'Tag Name',
      width: 'w-64',
      minWidth: '200px',
      sticky: 'left',
      sortable: true,
      render: (t) => (
        <div className="flex items-center gap-2 group/name">
            <span className="text-slate-400 font-bold">#</span>
            <span className="font-bold text-slate-900 dark:text-white">{t.name}</span>
            <button 
                onClick={(e) => { e.stopPropagation(); setRenameTarget(t); }}
                className="opacity-0 group-hover/name:opacity-100 p-1 text-slate-400 hover:text-primary-600 transition-all"
            >
                <Edit2 size={12} />
            </button>
            {t.requestedBy && (
                <span className="ml-2 text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold uppercase tracking-wide">
                    Request
                </span>
            )}
        </div>
      )
    },
    {
      key: 'type',
      header: 'Type',
      width: 'w-40',
      minWidth: '150px',
      sortable: true,
      render: (t) => (
        <div className="relative w-32" onClick={e => e.stopPropagation()}>
            <select 
                value={t.type}
                onChange={(e) => handleInlineUpdate(t.id, { type: e.target.value as any })}
                className={`
                    appearance-none w-full pl-2 pr-6 py-1 rounded-lg text-[11px] font-bold uppercase tracking-wide border cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500/50
                    ${t.type === 'category' 
                        ? 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-800' 
                        : 'bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'
                    }
                `}
            >
                <option value="tag">Tag</option>
                <option value="category">Category</option>
            </select>
        </div>
      )
    },
    {
      key: 'status',
      header: 'Status',
      width: 'w-40',
      minWidth: '150px',
      sortable: true,
      render: (t) => (
        <div className="relative w-32" onClick={e => e.stopPropagation()}>
            <select 
                value={t.status}
                onChange={(e) => handleInlineUpdate(t.id, { status: e.target.value as any })}
                className={`
                    appearance-none w-full pl-2 pr-6 py-1 rounded-lg text-[11px] font-bold uppercase tracking-wide border cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500/50
                    ${t.status === 'active' 
                        ? 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800' 
                        : t.status === 'pending'
                        ? 'bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-900/20 dark:text-amber-400 dark:border-amber-800'
                        : 'bg-slate-100 text-slate-500 border-slate-200'
                    }
                `}
            >
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="deprecated">Deprecated</option>
            </select>
        </div>
      )
    },
    {
      key: 'usageCount',
      header: 'Usage',
      width: 'w-32',
      minWidth: '100px',
      sortable: true,
      render: (t) => <span className="text-xs font-medium text-slate-600 dark:text-slate-400">{t.usageCount} items</span>
    },
    {
      key: 'actions',
      header: 'Actions',
      align: 'right',
      width: 'w-24',
      minWidth: '100px',
      sticky: 'right',
      render: (t) => (
        <div className="flex justify-end gap-2" onClick={(e) => e.stopPropagation()}>
            <button 
                onClick={() => setDeleteId(t.id)} 
                className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
            >
                <Trash2 size={14} />
            </button>
        </div>
      )
    }
  ];

  const BulkActions = selectedIds.length > 0 ? (
      <div className="flex items-center gap-2 animate-in fade-in slide-in-from-right-2 duration-200">
          <span className="text-xs font-bold text-slate-500">{selectedIds.length} selected</span>
          <button 
            onClick={() => setIsMergeOpen(true)}
            className="flex items-center gap-1 px-3 py-1.5 bg-purple-50 text-purple-700 hover:bg-purple-100 rounded-lg text-[10px] font-bold transition-colors"
          >
              <GitMerge size={12} /> Merge
          </button>
          <button 
            onClick={handleBulkDelete}
            className="flex items-center gap-1 px-3 py-1.5 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg text-[10px] font-bold transition-colors"
          >
              <Trash2 size={12} /> Delete
          </button>
      </div>
  ) : null;

  return (
    <div>
      <AdminSummaryBar 
        items={[
            { label: 'Total Tags', value: stats.totalTags, icon: <Hash size={18} /> },
            { label: 'Pending Requests', value: stats.pending, icon: <Tag size={18} /> },
            { label: 'Categories', value: stats.categories, icon: <Layers size={18} /> },
        ]}
        isLoading={isLoading}
      />

      <AdminTable 
        columns={columns} 
        data={processedTags} 
        isLoading={isLoading} 
        placeholder="Search tags..."
        actions={BulkActions}
        
        sortKey={sortKey}
        sortDirection={sortDirection}
        onSortChange={(k, d) => { setSortKey(k); setSortDirection(d); }}
        
        selection={{
            enabled: true,
            selectedIds: selectedIds,
            onSelect: setSelectedIds
        }}
      />

      {/* CREATE DRAWER */}
      <AdminDrawer 
        isOpen={isDrawerOpen} 
        onClose={() => setIsDrawerOpen(false)} 
        title="Create New Tag"
        footer={
            <div className="flex justify-end gap-2 w-full">
                <button onClick={() => setIsDrawerOpen(false)} className="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg font-bold text-sm hover:bg-slate-200">Cancel</button>
                <button onClick={saveDrawer} className="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold text-sm hover:opacity-90">Create</button>
            </div>
        }
      >
          <div className="space-y-4">
              <div>
                  <label className="text-xs font-bold text-slate-500 uppercase">Tag Name</label>
                  <input 
                    value={tagNameInput} 
                    onChange={e => setTagNameInput(e.target.value)} 
                    className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 mt-1 focus:outline-none focus:ring-2 focus:ring-primary-500 font-bold" 
                    placeholder="e.g. Finance"
                  />
                  <p className="text-xs text-slate-400 mt-2">New tags are created as 'Active' standard tags by default. You can change the type in the table later.</p>
              </div>
          </div>
      </AdminDrawer>

      {/* MODALS */}
      <MergeModal 
        isOpen={isMergeOpen} 
        onClose={() => setIsMergeOpen(false)} 
        onConfirm={handleMerge}
        count={selectedIds.length}
      />

      <RenameModal 
        isOpen={!!renameTarget}
        onClose={() => setRenameTarget(null)}
        initialName={renameTarget?.name || ''}
        onConfirm={handleRename}
      />

      <ConfirmActionModal 
        isOpen={!!deleteId}
        onClose={() => setDeleteId(null)}
        onConfirm={handleDelete}
        title="Delete Tag?"
        description="This will remove the tag from all nuggets that currently use it."
        actionLabel="Delete"
        isDestructive
      />
    </div>
  );
};





================================================================================
FILE: src\admin\pages\AdminUsersPage.tsx
================================================================================

import React, { useEffect, useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { AdminTable, Column } from '../components/AdminTable';
import { AdminSummaryBar } from '../components/AdminSummaryBar';
import { AdminUser, AdminRole, AdminUserStatus } from '../types/admin';
import { adminUsersService } from '../services/adminUsersService';
import { Shield, Ban, CheckCircle, Edit, Users, UserPlus, Bookmark, BarChart3, ChevronDown, Layout } from 'lucide-react';
import { useToast } from '../../hooks/useToast';
import { useAdminPermissions } from '../hooks/useAdminPermissions';
import { Avatar } from '../../components/shared/Avatar';
import { ConfirmActionModal } from '../../components/settings/ConfirmActionModal';
import { AdminDrawer } from '../components/AdminDrawer';
import { useAdminHeader } from '../layout/AdminLayout';

export const AdminUsersPage: React.FC = () => {
  const { setPageHeader } = useAdminHeader();
  const [users, setUsers] = useState<AdminUser[]>([]);
  const [stats, setStats] = useState({ total: 0, active: 0, newToday: 0, admins: 0, bookmarks: 0 });
  const [isLoading, setIsLoading] = useState(true);
  
  // Filtering & Sorting
  const [searchQuery, setSearchQuery] = useState('');
  const [roleFilter, setRoleFilter] = useState<'all' | 'admin' | 'user'>('all');
  const [dateFilter, setDateFilter] = useState('');
  const [sortKey, setSortKey] = useState<string>('joinedAt');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');
  const [showInactiveOnly, _setShowInactiveOnly] = useState(false);

  // Selection & Columns
  const [selectedUserIds, setSelectedUserIds] = useState<string[]>([]);
  const [visibleColumns, setVisibleColumns] = useState<string[]>([
    'user', 'fullName', 'role', 'status', 'nuggets', 'joinedDate', 'joinedTime', 'lastLoginDate', 'actions'
  ]);
  const [showColumnMenu, setShowColumnMenu] = useState(false);

  // Actions State
  const [selectedUser, setSelectedUser] = useState<AdminUser | null>(null);
  const [roleChangeCandidate, setRoleChangeCandidate] = useState<{ user: AdminUser, newRole: AdminRole } | null>(null);
  const [statusChangeCandidate, setStatusChangeCandidate] = useState<{ user: AdminUser, newStatus: AdminUserStatus } | null>(null);
  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState<{ name: string; username: string; email: string }>({ name: '', username: '', email: '' });

  const toast = useToast();
  const navigate = useNavigate();
  const { can } = useAdminPermissions();

  useEffect(() => {
    setPageHeader("User Management", "Overview of all registered users.");
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      const [usersData, statsData] = await Promise.all([
        adminUsersService.listUsers(searchQuery),
        adminUsersService.getStats()
      ]);
      setUsers(usersData);
      setStats(statsData);
    } catch (e) {
      toast.error("Failed to load users");
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    const timer = setTimeout(loadData, 300);
    return () => clearTimeout(timer);
  }, [searchQuery]);

  // Derived state for sorting and filtering
  const processedUsers = useMemo(() => {
    let result = [...users];
    
    // Filter Role
    if (roleFilter !== 'all') {
      result = result.filter(u => u.role === roleFilter);
    }

    // Filter Date
    if (dateFilter) {
      const filterDate = new Date(dateFilter).toDateString();
      result = result.filter(u => new Date(u.joinedAt).toDateString() === filterDate);
    }

    // Filter Inactive
    if (showInactiveOnly) {
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).getTime();
        result = result.filter(u => {
            const lastLogin = u.lastLoginAt ? new Date(u.lastLoginAt).getTime() : 0;
            return lastLogin < thirtyDaysAgo;
        });
    }

    // Sort
    result.sort((a, b) => {
      let valA: any = a[sortKey as keyof AdminUser] || '';
      let valB: any = b[sortKey as keyof AdminUser] || '';

      if (sortKey === 'name') {
        valA = a.name.toLowerCase();
        valB = b.name.toLowerCase();
      } else if (sortKey === 'joinedAt') {
        valA = new Date(a.joinedAt).getTime();
        valB = new Date(b.joinedAt).getTime();
      } else if (sortKey === 'lastLogin') {
        valA = a.lastLoginAt ? new Date(a.lastLoginAt).getTime() : 0;
        valB = b.lastLoginAt ? new Date(b.lastLoginAt).getTime() : 0;
      } else if (sortKey.startsWith('stats.')) {
        const key = sortKey.split('.')[1] as keyof typeof a.stats;
        valA = a.stats[key];
        valB = b.stats[key];
      }

      if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    return result;
  }, [users, roleFilter, dateFilter, showInactiveOnly, sortKey, sortDirection]);

  // -- Handlers --

  const handleOpenUser = (u: AdminUser) => {
      setSelectedUser(u);
      setIsEditing(false);
      setEditForm({ name: u.name, username: u.username, email: u.email });
  };

  const handleSaveEdit = async () => {
      if (!selectedUser) return;
      await new Promise(r => setTimeout(r, 800));
      const updatedUser = { ...selectedUser, ...editForm };
      setUsers(prev => prev.map(u => u.id === selectedUser.id ? updatedUser : u));
      setSelectedUser(updatedUser);
      setIsEditing(false);
      toast.success("User profile updated");
  };

  const handleStatusChange = async () => {
    if (!statusChangeCandidate) return;
    try {
      await adminUsersService.updateUserStatus(statusChangeCandidate.user.id, statusChangeCandidate.newStatus);
      setUsers(prev => prev.map(u => u.id === statusChangeCandidate.user.id ? { ...u, status: statusChangeCandidate.newStatus } : u));
      toast.success(`User status updated to ${statusChangeCandidate.newStatus}`);
      setStatusChangeCandidate(null);
    } catch (e) {
      toast.error("Action failed");
    }
  };

  const handleRoleChange = async () => {
    if (!roleChangeCandidate) return;
    try {
      await adminUsersService.updateUserRole(roleChangeCandidate.user.id, roleChangeCandidate.newRole);
      setUsers(prev => prev.map(u => u.id === roleChangeCandidate.user.id ? { ...u, role: roleChangeCandidate.newRole } : u));
      toast.success(`Role updated to ${roleChangeCandidate.newRole}`);
      setRoleChangeCandidate(null);
    } catch (e) {
      toast.error("Role update failed");
    }
  };

  const handleBulkAction = (action: 'suspend' | 'activate' | 'delete') => {
      toast.info(`${action} ${selectedUserIds.length} users (Not implemented)`);
      setSelectedUserIds([]);
  };

  // -- Columns Definition --
  
  const allColumns: Column<AdminUser>[] = [
    {
      key: 'user',
      header: 'User',
      width: 'w-64',
      minWidth: '250px',
      sticky: 'left',
      sortable: true,
      sortKey: 'name',
      render: (u) => (
        <div 
            className="flex items-center gap-3 cursor-pointer group/user"
            onClick={(e) => { e.stopPropagation(); handleOpenUser(u); }}
        >
          <Avatar name={u.name} size="sm" src={u.avatarUrl} className={u.status === 'suspended' ? 'opacity-50 grayscale' : ''} />
          <div className="min-w-0">
            <div className="flex items-center gap-1.5">
                <span className={`font-bold text-sm truncate group-hover/user:text-primary-600 group-hover/user:underline transition-colors ${u.status === 'suspended' ? 'text-slate-500 line-through' : 'text-slate-900 dark:text-white'}`}>
                  {u.name}
                </span>
                {u.role === 'admin' && <Shield size={12} className="text-purple-500 fill-purple-100 dark:fill-purple-900/30" />}
            </div>
            <div className="text-[10px] text-slate-500 truncate">@{u.username}</div>
          </div>
        </div>
      )
    },
    {
      key: 'fullName',
      header: 'Full Name',
      width: 'w-40',
      minWidth: '160px',
      sortable: true,
      render: (u) => <span className="text-sm text-slate-600 dark:text-slate-400">{u.fullName}</span>
    },
    {
      key: 'role',
      header: 'Role',
      width: 'w-32',
      minWidth: '130px',
      sortable: true,
      render: (u) => (
        <div onClick={(e) => e.stopPropagation()}>
            <div className="relative group/select w-28">
                <select 
                    value={u.role}
                    onChange={(e) => setRoleChangeCandidate({ user: u, newRole: e.target.value as AdminRole })}
                    className={`
                        appearance-none w-full pl-2 pr-6 py-1 rounded-lg text-[11px] font-bold capitalize tracking-wide border cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500/50
                        ${u.role === 'admin' 
                            ? 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-800' 
                            : 'bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'
                        }
                    `}
                >
                    <option value="user">Standard</option>
                    <option value="admin">Admin</option>
                </select>
                <ChevronDown size={12} className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none opacity-50" />
            </div>
        </div>
      )
    },
    {
      key: 'status',
      header: 'Status',
      width: 'w-32',
      minWidth: '130px',
      sortable: true,
      render: (u) => (
        <div onClick={(e) => e.stopPropagation()}>
            <div className="relative group/select w-28">
                <select 
                    value={u.status}
                    onChange={(e) => setStatusChangeCandidate({ user: u, newStatus: e.target.value as AdminUserStatus })}
                    className={`
                        appearance-none w-full pl-2 pr-6 py-1 rounded-lg text-[11px] font-bold capitalize tracking-wide border cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-500/50
                        ${u.status === 'active' 
                            ? 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800' 
                            : 'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800'
                        }
                    `}
                >
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                </select>
                <ChevronDown size={12} className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none opacity-50" />
            </div>
        </div>
      )
    },
    {
      key: 'nuggets',
      header: 'Nuggets',
      align: 'center',
      width: 'w-24',
      minWidth: '100px',
      sortable: true,
      sortKey: 'stats.nuggets',
      render: (u) => <span className="font-bold text-slate-700 dark:text-slate-300">{u.stats.nuggets}</span>
    },
    {
      key: 'joinedDate',
      header: 'Joined Date',
      width: 'w-32',
      minWidth: '120px',
      sortable: true,
      sortKey: 'joinedAt',
      render: (u) => <span className="text-xs text-slate-500 whitespace-nowrap">{new Date(u.joinedAt).toLocaleDateString()}</span>
    },
    {
      key: 'joinedTime',
      header: 'Joined Time',
      width: 'w-24',
      minWidth: '100px',
      render: (u) => <span className="text-xs text-slate-400 whitespace-nowrap">{new Date(u.joinedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
    },
    {
      key: 'lastLoginDate',
      header: 'Last Login',
      width: 'w-32',
      minWidth: '120px',
      sortable: true,
      sortKey: 'lastLoginAt',
      render: (u) => <span className="text-xs text-slate-500">{u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleDateString() : 'Never'}</span>
    },
    {
      key: 'lastLoginTime',
      header: 'Login Time',
      width: 'w-24',
      minWidth: '100px',
      render: (u) => <span className="text-xs text-slate-400">{u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '-'}</span>
    },
    {
      key: 'actions',
      header: 'Action',
      align: 'right',
      width: 'w-20',
      minWidth: '80px',
      sticky: 'right',
      render: (u) => (
        <div className="flex justify-end" onClick={(e) => e.stopPropagation()}>
          {can('admin.users.edit') && (
             <button 
                onClick={() => handleOpenUser(u)}
                className="flex items-center justify-center w-8 h-8 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 hover:text-primary-600 hover:border-primary-200 transition-colors shadow-sm"
                title="Edit User"
             >
                <Edit size={14} />
             </button>
          )}
        </div>
      )
    }
  ];

  // Filter visible columns
  const activeColumns = allColumns.filter(c => visibleColumns.includes(c.key));

  const Filters = (
    <div className="flex items-center gap-2">
      {/* Role Tabs */}
      <div className="flex bg-slate-100 dark:bg-slate-800 p-0.5 rounded-lg">
        {['all', 'admin', 'user'].map((role) => (
            <button
                key={role}
                onClick={() => setRoleFilter(role as any)}
                className={`px-3 py-1.5 text-[10px] font-bold capitalize rounded-md transition-all ${roleFilter === role ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
            >
                {role}
            </button>
        ))}
      </div>

      {/* Date Filter */}
      <div className="relative flex items-center">
        <input 
            type="date" 
            value={dateFilter}
            onChange={(e) => setDateFilter(e.target.value)}
            className="pl-3 pr-2 py-1.5 text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 focus:outline-none focus:ring-1 focus:ring-primary-500"
        />
      </div>

      {/* Columns Toggle */}
      <div className="relative">
        <button 
            onClick={() => setShowColumnMenu(!showColumnMenu)}
            className="px-3 py-1.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-[10px] font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 transition-colors flex items-center gap-1.5"
        >
            <Layout size={12} /> Columns
        </button>
        {showColumnMenu && (
            <>
                <div className="fixed inset-0 z-40" onClick={() => setShowColumnMenu(false)} />
                <div className="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-50 p-2 max-h-64 overflow-y-auto custom-scrollbar">
                    {allColumns.filter(c => c.key !== 'user' && c.key !== 'actions').map(col => (
                        <label key={col.key} className="flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg cursor-pointer">
                            <input 
                                type="checkbox" 
                                checked={visibleColumns.includes(col.key)}
                                onChange={(e) => {
                                    if (e.target.checked) setVisibleColumns([...visibleColumns, col.key]);
                                    else setVisibleColumns(visibleColumns.filter(k => k !== col.key));
                                }}
                                className="rounded border-slate-300 text-primary-600 focus:ring-primary-500"
                            />
                            <span className="text-xs font-medium text-slate-700 dark:text-slate-300">{col.header}</span>
                        </label>
                    ))}
                </div>
            </>
        )}
      </div>
    </div>
  );

  const BulkActions = selectedUserIds.length > 0 ? (
      <div className="flex items-center gap-2 animate-in fade-in slide-in-from-right-2 duration-200">
          <span className="text-xs font-bold text-slate-500">{selectedUserIds.length} selected</span>
          <button onClick={() => handleBulkAction('activate')} className="px-3 py-1.5 bg-green-50 text-green-700 hover:bg-green-100 rounded-lg text-[10px] font-bold transition-colors">Activate</button>
          <button onClick={() => handleBulkAction('suspend')} className="px-3 py-1.5 bg-amber-50 text-amber-700 hover:bg-amber-100 rounded-lg text-[10px] font-bold transition-colors">Suspend</button>
          <button onClick={() => handleBulkAction('delete')} className="px-3 py-1.5 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg text-[10px] font-bold transition-colors">Delete</button>
      </div>
  ) : null;

  return (
    <div>
      <AdminSummaryBar 
        items={[
          { label: 'Total Users', value: stats.total, icon: <Users size={18} /> },
          { label: 'Total Admins', value: stats.admins, icon: <Shield size={18} /> },
          { label: 'Total Bookmarks', value: stats.bookmarks, icon: <Bookmark size={18} /> },
          { label: 'New Today', value: stats.newToday, icon: <UserPlus size={18} />, hint: 'Since midnight' },
        ]}
        isLoading={isLoading}
      />

      <AdminTable 
        columns={activeColumns} 
        data={processedUsers} 
        isLoading={isLoading} 
        filters={Filters}
        actions={BulkActions}
        onSearch={setSearchQuery}
        pagination={{ page: 1, totalPages: 1, onPageChange: () => {} }}
        
        sortKey={sortKey}
        sortDirection={sortDirection}
        onSortChange={(k, d) => { setSortKey(k); setSortDirection(d); }}
        
        onRowClick={handleOpenUser}
        selection={{
            enabled: true,
            selectedIds: selectedUserIds,
            onSelect: setSelectedUserIds
        }}
      />

      {/* Drawer */}
      <AdminDrawer 
        isOpen={!!selectedUser} 
        onClose={() => setSelectedUser(null)} 
        title={isEditing ? "Edit User" : "User Details"} 
        width="lg"
        footer={
            <div className="flex justify-between w-full">
                {isEditing ? (
                    <>
                        <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-100 rounded-lg">Cancel</button>
                        <button onClick={handleSaveEdit} className="px-4 py-2 bg-primary-500 text-slate-900 font-bold rounded-lg hover:bg-primary-400">Save Changes</button>
                    </>
                ) : (
                    <>
                        {selectedUser?.status === 'active' ? (
                            <button 
                                onClick={() => { setSelectedUser(null); setStatusChangeCandidate({ user: selectedUser, newStatus: 'suspended' }); }}
                                className="flex items-center gap-2 px-3 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg text-sm font-bold transition-colors"
                            >
                                <Ban size={16} /> Suspend User
                            </button>
                        ) : (
                            <button 
                                onClick={() => { setSelectedUser(null); setStatusChangeCandidate({ user: selectedUser!, newStatus: 'active' }); }}
                                className="flex items-center gap-2 px-3 py-2 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/10 rounded-lg text-sm font-bold transition-colors"
                            >
                                <CheckCircle size={16} /> Activate User
                            </button>
                        )}
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setIsEditing(true)}
                                className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg text-sm font-bold shadow-sm hover:bg-slate-50"
                            >
                                <Edit size={14} /> Edit Profile
                            </button>
                            <button 
                                onClick={() => { navigate(`/profile/${selectedUser?.id}`); }}
                                className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-sm hover:opacity-90"
                            >
                                Public Profile
                            </button>
                        </div>
                    </>
                )}
            </div>
        }
      >
        {selectedUser && (
            <div className="space-y-8">
                {/* Header Profile */}
                <div className="flex items-start gap-4">
                    <Avatar name={selectedUser.name} size="xl" src={selectedUser.avatarUrl} className="shadow-lg" />
                    <div className="flex-1 pt-1">
                        {isEditing ? (
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Display Name</label>
                                    <input 
                                        className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 font-bold"
                                        value={editForm.name}
                                        onChange={e => setEditForm({...editForm, name: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Username</label>
                                    <input 
                                        className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2"
                                        value={editForm.username}
                                        onChange={e => setEditForm({...editForm, username: e.target.value})}
                                    />
                                </div>
                            </div>
                        ) : (
                            <>
                                <h2 className="text-2xl font-bold text-slate-900 dark:text-white leading-tight">{selectedUser.name}</h2>
                                <p className="text-sm text-slate-500">{selectedUser.fullName}</p>
                                <div className="flex items-center gap-2 text-slate-500 dark:text-slate-400 font-medium text-sm mt-1">
                                    <span>@{selectedUser.username}</span>
                                    <span>•</span>
                                    <span className="font-mono text-xs opacity-70 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">{selectedUser.id}</span>
                                </div>
                            </>
                        )}
                        
                        {!isEditing && (
                            <div className="flex flex-wrap gap-2 mt-3">
                                <span className={`inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold capitalize border ${selectedUser.role === 'admin' ? 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-800' : 'bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'}`}>
                                    {selectedUser.role === 'admin' && <Shield size={12} className="mr-1" />}
                                    {selectedUser.role}
                                </span>
                                <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold capitalize ${selectedUser.status === 'active' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}`}>
                                    {selectedUser.status}
                                </span>
                            </div>
                        )}
                    </div>
                </div>

                {/* Stats Breakdown */}
                <div>
                    <h3 className="text-sm font-bold text-slate-900 dark:text-white mb-3 flex items-center gap-2">
                        <BarChart3 size={16} /> Detailed Activity
                    </h3>
                    <div className="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-4 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <span className="block text-xs font-bold text-slate-400 uppercase mb-1">Total Nuggets</span>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">{selectedUser.stats.nuggets}</span>
                            </div>
                            <div>
                                <span className="block text-xs font-bold text-slate-400 uppercase mb-1">Collections Created</span>
                                <span className="text-xl font-bold text-slate-900 dark:text-white">{selectedUser.stats.collections}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        )}
      </AdminDrawer>

      <ConfirmActionModal 
        isOpen={!!statusChangeCandidate}
        onClose={() => setStatusChangeCandidate(null)}
        onConfirm={handleStatusChange}
        title={statusChangeCandidate?.newStatus === 'active' ? "Reactivate User?" : "Suspend User?"}
        description={statusChangeCandidate?.newStatus === 'active' ? `Reactivate access for ${statusChangeCandidate?.user.name}?` : `Are you sure you want to suspend ${statusChangeCandidate?.user.name}? They will lose access immediately.`}
        actionLabel={statusChangeCandidate?.newStatus === 'active' ? "Reactivate" : "Suspend"}
        isDestructive={statusChangeCandidate?.newStatus === 'suspended'}
      />

      <ConfirmActionModal 
        isOpen={!!roleChangeCandidate}
        onClose={() => setRoleChangeCandidate(null)}
        onConfirm={handleRoleChange}
        title="Change Account Type?"
        description={`Are you sure you want to change ${roleChangeCandidate?.user.name}'s role to ${roleChangeCandidate?.newRole.toUpperCase()}? This will affect their access permissions immediately.`}
        actionLabel="Update Role"
      />
    </div>
  );
};





================================================================================
FILE: src\admin\services\adminActivityService.ts
================================================================================

import { AdminActivityEvent } from '../types/admin';
import { MOCK_ACTIVITY_LOG } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminActivityService {
  private logs = [...MOCK_ACTIVITY_LOG];

  async listActivityEvents(limit: number = 50): Promise<AdminActivityEvent[]> {
    await delay(400);
    return this.logs.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()).slice(0, limit);
  }

  async addEvent(event: Omit<AdminActivityEvent, 'id' | 'timestamp'>): Promise<void> {
    const newEvent: AdminActivityEvent = {
        ...event,
        id: `ev-${Date.now()}`,
        timestamp: new Date().toISOString()
    };
    this.logs.unshift(newEvent);
  }
}

export const adminActivityService = new AdminActivityService();





================================================================================
FILE: src\admin\services\adminCollectionsService.ts
================================================================================

import { AdminCollection } from '../types/admin';
import { MOCK_ADMIN_COLLECTIONS } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminCollectionsService {
  private collections = [...MOCK_ADMIN_COLLECTIONS];

  async listCollections(query?: string): Promise<AdminCollection[]> {
    await delay(600);
    if (!query) return this.collections;
    const q = query.toLowerCase();
    return this.collections.filter(c => c.name.toLowerCase().includes(q));
  }

  async getCollectionDetails(id: string): Promise<AdminCollection | undefined> {
    await delay(300);
    return this.collections.find(c => c.id === id);
  }

  async getStats(): Promise<{ totalCommunity: number; totalNuggetsInCommunity: number }> {
    await delay(200);
    const publicCols = this.collections.filter(c => c.type === 'public');
    return {
      totalCommunity: publicCols.length,
      totalNuggetsInCommunity: publicCols.reduce((acc, c) => acc + c.itemCount, 0)
    };
  }

  async updateCollectionStatus(id: string, status: 'active' | 'hidden'): Promise<void> {
    await delay(400);
    this.collections = this.collections.map(c => c.id === id ? { ...c, status } : c);
  }

  async deleteCollection(id: string): Promise<void> {
    await delay(500);
    this.collections = this.collections.filter(c => c.id !== id);
  }
}

export const adminCollectionsService = new AdminCollectionsService();





================================================================================
FILE: src\admin\services\adminConfigService.ts
================================================================================

import { RolePermissions, ServiceDefinition, FeatureFlags, SignupConfig } from '../types/admin';
import { LegalPage, LegalPageSlug, LegalConfig } from '../../types/legal';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

export const AVAILABLE_SERVICES: ServiceDefinition[] = [
  { id: 'batch_import', label: 'Batch Import', description: 'Import content via CSV/Excel.', category: 'data' },
  { id: 'data_export', label: 'Data Export', description: 'Download personal data.', category: 'data' },
  { id: 'ai_summary', label: 'AI Summaries', description: 'Generate AI takeaways for nuggets.', category: 'ai' },
  { id: 'ai_auto_tag', label: 'AI Auto-Tagging', description: 'Suggest tags based on content.', category: 'ai' },
  { id: 'create_public_collection', label: 'Public Collections', description: 'Publish collections to the community.', category: 'content' },
  { id: 'view_analytics', label: 'View Analytics', description: 'Access read/view counts on content.', category: 'content' },
  { id: 'unlimited_nuggets', label: 'Unlimited Nuggets', description: 'Bypass storage quotas.', category: 'content' },
];

const INITIAL_PERMISSIONS: RolePermissions = {
  admin: ['batch_import', 'data_export', 'ai_summary', 'ai_auto_tag', 'create_public_collection', 'view_analytics', 'unlimited_nuggets'],
  user: ['create_public_collection', 'ai_summary'],
  superadmin: ['batch_import', 'data_export', 'ai_summary', 'ai_auto_tag', 'create_public_collection', 'view_analytics', 'unlimited_nuggets']
};

const INITIAL_FLAGS: FeatureFlags = {
  enableAvatarUpload: false, 
  enablePublicSignup: true,
  enableEmailVerification: false,
  maintenanceMode: false,
  guestBookmarks: false,
  guestReports: false,
};

const INITIAL_SIGNUP_CONFIG: SignupConfig = {
  phone: { show: true, required: false },
  gender: { show: true, required: false }, // Visible but optional by default
  location: { show: true, required: true }, // Pincode/City/Country group
  dob: { show: false, required: false }, // Hidden by default (Best Practice)
};

// --- MOCK LEGAL CONTENT ---
const INITIAL_LEGAL_CONFIG: LegalConfig = {
  pages: {
    about: {
      id: 'about',
      title: 'About Us',
      slug: 'about',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# About Nuggets

**Busy people need relevant information in less time.**

Nuggets is designed to strip away the noise of the modern web. We believe in high-signal, low-latency knowledge consumption. 

### Our Mission
To empower professionals to stay informed without the doom-scrolling. We curate, summarize, and organize the world's most valuable insights into bite-sized "nuggets".

### The Team
We are a small, distributed team of designers, engineers, and curators passionate about information architecture and digital wellbeing.`
    },
    terms: {
      id: 'terms',
      title: 'Terms of Service',
      slug: 'terms',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Terms of Service

By using Nuggets, you agree to these terms.

1. **Acceptable Use**: You agree not to misuse the platform or post harmful content.
2. **Content Ownership**: You retain rights to your content, but grant us a license to display it.
3. **Termination**: We reserve the right to suspend accounts that violate our policies.

*These terms are subject to change.*`
    },
    privacy: {
      id: 'privacy',
      title: 'Privacy Policy',
      slug: 'privacy',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Privacy Policy

Your privacy is paramount.

**Data We Collect**:
- Account information (email, name)
- Usage data (bookmarks, collections)

**How We Use It**:
- To provide and improve the service.
- We **do not** sell your data to third parties.

**Your Rights**:
- You can export or delete your data at any time via the Settings page.`
    },
    contact: {
      id: 'contact',
      title: 'Contact Us',
      slug: 'contact',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Contact Us

We'd love to hear from you.

**Support**: support@nuggets.app  
**Partnerships**: partners@nuggets.app  
**Press**: press@nuggets.app

Or use the **Feedback** form located in the Main Menu (click the top-left menu icon).`
    },
    guidelines: {
      id: 'guidelines',
      title: 'Community Guidelines',
      slug: 'guidelines',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Community Guidelines

1. **Be Respectful**: Disagreement is fine, harassment is not.
2. **No Spam**: Do not use Nuggets purely for self-promotion.
3. **Quality Matters**: Ensure your shared nuggets provide value to others.

Violations may result in content removal or account suspension.`
    },
    disclaimer: {
      id: 'disclaimer',
      title: 'Disclaimer',
      slug: 'disclaimer',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Disclaimer

The content provided on Nuggets is for informational purposes only. We do not guarantee the accuracy or completeness of any information found here. 

Links to third-party websites are provided for convenience; we do not endorse their content.`
    },
    'cookie-policy': {
      id: 'cookie-policy',
      title: 'Cookie Policy',
      slug: 'cookie-policy',
      isEnabled: false, // Disabled by default
      lastUpdated: new Date().toISOString(),
      content: `# Cookie Policy

We use cookies to improve your experience.

- **Essential Cookies**: Required for login and security.
- **Analytics Cookies**: Help us understand how you use the site.

You can manage cookie preferences in your browser settings.`
    }
  }
};

class AdminConfigService {
  // In-memory mock storage
  private permissions: RolePermissions = { ...INITIAL_PERMISSIONS };
  private legalConfig: LegalConfig = { ...INITIAL_LEGAL_CONFIG };
  private featureFlags: FeatureFlags = { ...INITIAL_FLAGS };
  private signupConfig: SignupConfig = { ...INITIAL_SIGNUP_CONFIG };

  // --- RBAC ---
  async getRolePermissions(): Promise<RolePermissions> {
    await delay(400);
    return JSON.parse(JSON.stringify(this.permissions));
  }

  async updateRolePermission(role: keyof RolePermissions, services: string[]): Promise<void> {
    await delay(300);
    this.permissions[role] = services as any;
    console.log(`[Config] Updated permissions for ${String(role)}:`, services);
  }

  // --- FLAGS ---
  async getFeatureFlags(): Promise<FeatureFlags> {
    await delay(200);
    return { ...this.featureFlags };
  }

  async updateFeatureFlag(key: keyof FeatureFlags, value: boolean): Promise<void> {
    await delay(300);
    this.featureFlags[key] = value;
    console.log(`[Config] Updated flag ${String(key)} to ${value}`);
  }

  // --- SIGNUP CONFIG ---
  async getSignupConfig(): Promise<SignupConfig> {
    await delay(200);
    return { ...this.signupConfig };
  }

  async updateSignupConfig(key: keyof SignupConfig, rule: Partial<{ show: boolean, required: boolean }>): Promise<void> {
    await delay(300);
    this.signupConfig[key] = { ...this.signupConfig[key], ...rule };
    console.log(`[Config] Updated signup rule for ${key}:`, this.signupConfig[key]);
  }

  // --- LEGAL PAGES ---
  async getLegalPages(): Promise<LegalPage[]> {
    await delay(300);
    return Object.values(this.legalConfig.pages);
  }

  async getLegalPage(slug: string): Promise<LegalPage | undefined> {
    await delay(200);
    return Object.values(this.legalConfig.pages).find(p => p.slug === slug);
  }

  async updateLegalPage(id: LegalPageSlug, updates: Partial<LegalPage>): Promise<void> {
    await delay(500);
    const current = this.legalConfig.pages[id];
    if (current) {
        this.legalConfig.pages[id] = { 
            ...current, 
            ...updates,
            lastUpdated: updates.content ? new Date().toISOString() : current.lastUpdated 
        };
    }
  }
}

export const adminConfigService = new AdminConfigService();





================================================================================
FILE: src\admin\services\adminFeedbackService.ts
================================================================================

import { AdminFeedback } from '../types/admin';
import { MOCK_FEEDBACK } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminFeedbackService {
  private feedback = [...MOCK_FEEDBACK];

  async listFeedback(filter?: 'new' | 'read' | 'archived'): Promise<AdminFeedback[]> {
    await delay(300);
    
    if (filter === 'new') {
      return this.feedback.filter(f => f.status === 'new');
    }
    if (filter === 'read') {
      return this.feedback.filter(f => f.status === 'read');
    }
    if (filter === 'archived') {
      return this.feedback.filter(f => f.status === 'archived');
    }
    return this.feedback;
  }

  async updateStatus(id: string, status: 'read' | 'archived'): Promise<void> {
    await delay(300);
    this.feedback = this.feedback.map(f => f.id === id ? { ...f, status } : f);
  }

  async getStats(): Promise<{ total: number }> {
    await delay(200);
    return {
      total: this.feedback.length
    };
  }
}

export const adminFeedbackService = new AdminFeedbackService();






================================================================================
FILE: src\admin\services\adminModerationService.ts
================================================================================

import { AdminReport } from '../types/admin';
import { MOCK_REPORTS } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminModerationService {
  private reports = [...MOCK_REPORTS];

  async listReports(filter?: 'open' | 'resolved' | 'dismissed'): Promise<AdminReport[]> {
    await delay(500);
    if (filter) {
      return this.reports.filter(r => r.status === filter);
    }
    return this.reports.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
  }

  async getReportDetails(id: string): Promise<AdminReport | undefined> {
    await delay(200);
    return this.reports.find(r => r.id === id);
  }

  async getStats(): Promise<{ open: number; resolved: number; dismissed: number }> {
    await delay(200);
    return {
      open: this.reports.filter(r => r.status === 'open').length,
      resolved: this.reports.filter(r => r.status === 'resolved').length,
      dismissed: this.reports.filter(r => r.status === 'dismissed').length,
    };
  }

  async resolveReport(id: string, resolution: 'resolved' | 'dismissed'): Promise<void> {
    await delay(400);
    this.reports = this.reports.map(r => r.id === id ? { ...r, status: resolution } : r);
  }
}

export const adminModerationService = new AdminModerationService();





================================================================================
FILE: src\admin\services\adminNuggetsService.ts
================================================================================

import { AdminNugget, AdminNuggetStatus } from '../types/admin';
import { MOCK_ADMIN_NUGGETS } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminNuggetsService {
  private nuggets = [...MOCK_ADMIN_NUGGETS];

  async listNuggets(filter?: 'all' | 'flagged' | 'hidden'): Promise<AdminNugget[]> {
    await delay(300); 
    
    // Privacy Rule: Filter out 'private' nuggets from the table view
    // Admins can only see public content in the list
    let result = this.nuggets.filter(n => n.visibility === 'public');

    if (filter === 'flagged') {
      return result.filter(n => n.status === 'flagged');
    }
    if (filter === 'hidden') {
      return result.filter(n => n.status === 'hidden');
    }
    return result;
  }

  async getNuggetDetails(id: string): Promise<AdminNugget | undefined> {
    await delay(200);
    return this.nuggets.find(n => n.id === id);
  }

  async getStats(): Promise<{ total: number; flagged: number; createdToday: number; public: number; private: number }> {
    await delay(200);
    const todayStr = new Date().toDateString();
    return {
      total: this.nuggets.length,
      flagged: this.nuggets.filter(n => n.status === 'flagged').length,
      createdToday: this.nuggets.filter(n => new Date(n.createdAt).toDateString() === todayStr).length,
      public: this.nuggets.filter(n => n.visibility === 'public').length,
      private: this.nuggets.filter(n => n.visibility === 'private').length,
    };
  }

  async updateNuggetStatus(id: string, status: AdminNuggetStatus): Promise<void> {
    await delay(300);
    this.nuggets = this.nuggets.map(n => n.id === id ? { ...n, status, reports: status === 'active' ? 0 : n.reports } : n);
  }

  async deleteNugget(id: string): Promise<void> {
    await delay(400);
    this.nuggets = this.nuggets.filter(n => n.id !== id);
  }
}

export const adminNuggetsService = new AdminNuggetsService();





================================================================================
FILE: src\admin\services\adminTagsService.ts
================================================================================

import { AdminTag, AdminTagRequest } from '../types/admin';
import { MOCK_ADMIN_TAGS } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminTagsService {
  private tags = [...MOCK_ADMIN_TAGS];

  async listTags(query?: string): Promise<AdminTag[]> {
    await delay(500);
    let result = this.tags.filter(t => t.status !== 'pending');
    
    if (query) {
      const q = query.toLowerCase();
      result = result.filter(t => t.name.toLowerCase().includes(q));
    }
    
    return result.sort((a, b) => b.usageCount - a.usageCount);
  }

  async listRequests(): Promise<AdminTagRequest[]> {
    await delay(400);
    return this.tags
      .filter(t => t.status === 'pending')
      .map(t => ({
        id: t.id,
        name: t.name,
        requestedBy: {
          id: 'u-unknown',
          name: t.requestedBy || 'Unknown User'
        },
        requestedAt: new Date().toISOString(), // Mock date
        status: 'pending'
      }));
  }

  async getStats(): Promise<{ total: number; totalTags: number; pending: number; categories: number }> {
    await delay(200);
    return {
      total: this.tags.length,
      totalTags: this.tags.filter(t => t.status !== 'pending').length,
      pending: this.tags.filter(t => t.status === 'pending').length,
      categories: this.tags.filter(t => t.type === 'category' && t.status !== 'pending').length
    };
  }

  async toggleOfficialStatus(id: string): Promise<void> {
    await delay(300);
    this.tags = this.tags.map(t => t.id === id ? { ...t, isOfficial: !t.isOfficial, type: !t.isOfficial ? 'category' : 'tag' } : t);
  }

  async updateTag(id: string, updates: Partial<AdminTag>): Promise<void> {
    await delay(300);
    this.tags = this.tags.map(t => t.id === id ? { ...t, ...updates } : t);
  }

  async renameTag(id: string, newName: string): Promise<void> {
    await delay(600);
    // In a real app, this would trigger a massive DB update for all related nuggets
    this.tags = this.tags.map(t => t.id === id ? { ...t, name: newName } : t);
  }

  async deleteTag(id: string): Promise<void> {
    await delay(400);
    this.tags = this.tags.filter(t => t.id !== id);
  }

  async approveRequest(id: string): Promise<void> {
    await delay(500);
    const tag = this.tags.find(t => t.id === id);
    if (tag) {
        tag.status = 'active';
        tag.isOfficial = true; 
        tag.type = 'category';
    }
  }

  async rejectRequest(id: string): Promise<void> {
    await delay(500);
    this.tags = this.tags.filter(t => t.id !== id);
  }

  async mergeTags(sourceIds: string[], targetName: string): Promise<void> {
    await delay(800);
    
    // 1. Calculate total usage of source tags
    const sources = this.tags.filter(t => sourceIds.includes(t.id));
    const totalUsage = sources.reduce((acc, t) => acc + t.usageCount, 0);

    // 2. Remove source tags
    this.tags = this.tags.filter(t => !sourceIds.includes(t.id));

    // 3. Find or Create target tag
    const existingTargetIndex = this.tags.findIndex(t => t.name.toLowerCase() === targetName.toLowerCase());
    
    if (existingTargetIndex !== -1) {
        // Update existing
        this.tags[existingTargetIndex].usageCount += totalUsage;
    } else {
        // Create new
        this.tags.push({
            id: `t-merged-${Date.now()}`,
            name: targetName,
            type: 'tag',
            status: 'active',
            isOfficial: false,
            usageCount: totalUsage
        });
    }
  }
}

export const adminTagsService = new AdminTagsService();





================================================================================
FILE: src\admin\services\adminUsersService.ts
================================================================================

import { AdminUser, AdminUserStatus, AdminRole } from '../types/admin';
import { MOCK_ADMIN_USERS } from './mockData';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class AdminUsersService {
  private users = [...MOCK_ADMIN_USERS];

  async listUsers(query?: string): Promise<AdminUser[]> {
    await delay(300); // Snappy
    if (!query) return this.users;
    const q = query.toLowerCase();
    return this.users.filter(u => 
      u.name.toLowerCase().includes(q) || 
      u.username.toLowerCase().includes(q) ||
      u.email.toLowerCase().includes(q)
    );
  }

  async getUserDetails(id: string): Promise<AdminUser | undefined> {
    await delay(200);
    return this.users.find(u => u.id === id);
  }

  async getStats(): Promise<{ total: number; active: number; newToday: number; admins: number; bookmarks: number }> {
    await delay(200);
    const now = new Date();
    const todayStr = now.toDateString();
    
    // Simulate bookmarks count (randomized based on user count for mock realism)
    const simulatedBookmarks = this.users.length * 12 + 45;

    return {
      total: this.users.length,
      active: this.users.filter(u => u.status === 'active').length,
      newToday: this.users.filter(u => new Date(u.joinedAt).toDateString() === todayStr).length,
      admins: this.users.filter(u => u.role === 'admin').length,
      bookmarks: simulatedBookmarks
    };
  }

  async updateUserStatus(id: string, status: AdminUserStatus): Promise<void> {
    await delay(300);
    this.users = this.users.map(u => u.id === id ? { ...u, status } : u);
  }

  async updateUserRole(id: string, role: AdminRole): Promise<void> {
    await delay(300);
    this.users = this.users.map(u => u.id === id ? { ...u, role } : u);
  }

  async deleteUser(id: string): Promise<void> {
    await delay(500);
    this.users = this.users.filter(u => u.id !== id);
  }
}

export const adminUsersService = new AdminUsersService();





================================================================================
FILE: src\admin\services\mockData.ts
================================================================================

import { AdminUser, AdminNugget, AdminCollection, AdminTag, AdminReport, AdminActivityEvent, AdminFeedback } from '../types/admin';

export const MOCK_ADMIN_USERS: AdminUser[] = Array.from({ length: 25 }).map((_, i) => {
  const totalNuggets = Math.floor(Math.random() * 50);
  const publicNuggets = Math.floor(totalNuggets * 0.7); // 70% public
  const firstName = ['Alice', 'Bob', 'Charlie', 'David', 'Eva', 'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'][i % 10];
  const lastName = ['Smith', 'Johnson', 'Williams', 'Jones', 'Brown', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor'][i % 10];
  
  return {
    id: `u-${1000 + i + 1}`,
    name: i === 0 ? 'Akash Solanki' : `${firstName} ${lastName}`,
    fullName: i === 0 ? 'Akash Solanki' : `${firstName} James ${lastName}`,
    username: i === 0 ? 'akash_ux' : `user_${i + 1}`,
    email: i === 0 ? 'akash@nuggets.app' : `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`,
    role: i === 0 ? 'admin' : 'user',
    status: i % 7 === 0 ? 'suspended' : 'active',
    joinedAt: new Date(Date.now() - Math.random() * 10000000000).toISOString(),
    lastLoginAt: i % 3 === 0 ? new Date(Date.now() - Math.random() * 8640000000).toISOString() : new Date().toISOString(), // Some inactive
    stats: {
      nuggets: totalNuggets,
      nuggetsPublic: publicNuggets,
      nuggetsPrivate: totalNuggets - publicNuggets,
      collections: Math.floor(Math.random() * 8),
      collectionsFollowing: Math.floor(Math.random() * 15),
      reports: Math.floor(Math.random() * 2),
    }
  };
});

export const MOCK_ADMIN_NUGGETS: AdminNugget[] = Array.from({ length: 20 }).map((_, i) => ({
  id: `n-${i + 1}`,
  title: [
    "The Future of SaaS", 
    "React 19 Features", 
    "Minimalist Design Principles", 
    "How to Scale Node.js", 
    "AI in 2025"
  ][i % 5] + ` (Part ${i + 1})`,
  excerpt: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",
  author: {
    id: `u-${(i % 5) + 1}`,
    name: `User ${(i % 5) + 1}`,
    email: `user${(i % 5) + 1}@example.com`,
  },
  type: ['link', 'text', 'video', 'image'][i % 4] as any,
  url: 'https://example.com',
  visibility: i % 3 === 0 ? 'private' : 'public',
  status: i === 2 ? 'flagged' : 'active',
  createdAt: new Date(Date.now() - Math.random() * 1000000000).toISOString(),
  reports: i === 2 ? 3 : 0,
  tags: ['Tech', 'Design']
}));

export const MOCK_ADMIN_COLLECTIONS: AdminCollection[] = Array.from({ length: 10 }).map((_, i) => ({
  id: `c-${i + 1}`,
  name: ["Must Read Tech", "Design Systems", "My Favs", "Startup Ideas", "Daily News"][i % 5],
  description: "A curated list of the most important updates in the industry.",
  creator: {
    id: `u-${(i % 5) + 1}`,
    name: `User ${(i % 5) + 1}`,
  },
  type: i % 4 === 0 ? 'private' : 'public',
  itemCount: Math.floor(Math.random() * 100),
  followerCount: Math.floor(Math.random() * 500),
  status: 'active',
  createdAt: new Date(Date.now() - Math.random() * 10000000000).toISOString(),
  updatedAt: new Date().toISOString(),
}));

export const MOCK_ADMIN_TAGS: AdminTag[] = [
  { id: 't-1', name: 'Technology', usageCount: 1240, type: 'category', isOfficial: true, status: 'active' },
  { id: 't-2', name: 'Design', usageCount: 890, type: 'category', isOfficial: true, status: 'active' },
  { id: 't-3', name: 'Business', usageCount: 650, type: 'category', isOfficial: true, status: 'active' },
  { id: 't-4', name: 'productivity', usageCount: 120, type: 'tag', isOfficial: false, status: 'active' },
  { id: 't-5', name: 'ai-tools', usageCount: 85, type: 'tag', isOfficial: false, status: 'active' },
  { id: 't-6', name: 'Health', usageCount: 430, type: 'category', isOfficial: true, status: 'active' },
  { id: 't-7', name: 'startup-life', usageCount: 45, type: 'tag', isOfficial: false, status: 'active' },
  { id: 'new-1', name: 'India Growth', usageCount: 320, type: 'tag', isOfficial: false, status: 'active' },
  { id: 'req-1', name: 'Crypto', usageCount: 0, type: 'tag', isOfficial: false, status: 'pending', requestedBy: 'User 2' },
  { id: 'req-2', name: 'Sustainability', usageCount: 0, type: 'category', isOfficial: false, status: 'pending', requestedBy: 'User 3' },
];

export const MOCK_REPORTS: AdminReport[] = [
  {
    id: 'r-1',
    targetId: 'n-3',
    targetType: 'nugget',
    reason: 'spam',
    description: 'This is clearly just an advertisement for a crypto scam.',
    reporter: { id: 'u-5', name: 'User 5' },
    respondent: { id: 'u-3', name: 'User 3' },
    status: 'open',
    createdAt: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
  },
  {
    id: 'r-2',
    targetId: 'u-4',
    targetType: 'user',
    reason: 'harassment',
    description: 'User is posting offensive comments on multiple collections.',
    reporter: { id: 'u-2', name: 'User 2' },
    respondent: { id: 'u-4', name: 'User 4' },
    status: 'open',
    createdAt: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
  },
  {
    id: 'r-3',
    targetId: 'c-2',
    targetType: 'collection',
    reason: 'misinformation',
    description: 'Collection promotes dangerous health advice.',
    reporter: { id: 'u-8', name: 'User 8' },
    respondent: { id: 'u-1', name: 'Akash Solanki' },
    status: 'resolved',
    createdAt: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
  }
];

export const MOCK_FEEDBACK: AdminFeedback[] = [
  { 
    id: 'f-1', 
    user: { id: 'u-2', name: 'Bob Johnson', fullName: 'Bob James Johnson', username: 'bobby_j' },
    type: 'bug', 
    content: 'Dark mode flickers on iOS Safari.', 
    status: 'new', 
    createdAt: new Date(Date.now() - 3600000).toISOString() 
  },
  { 
    id: 'f-2', 
    user: { id: 'u-5', name: 'Eva Brown', fullName: 'Eva Brown', username: 'eva_b' },
    type: 'feature', 
    content: 'Please add folder support for collections!', 
    status: 'new', 
    createdAt: new Date(Date.now() - 7200000).toISOString() 
  },
  { 
    id: 'f-3', 
    type: 'general', 
    content: 'Love the app, but the font size is too small on mobile.', 
    status: 'read', 
    createdAt: new Date(Date.now() - 86400000).toISOString() 
  },
  { 
    id: 'f-4', 
    user: { id: 'u-10', name: 'Jack Taylor', fullName: 'Jack Taylor', username: 'jack_t' },
    type: 'bug', 
    content: 'Login with Google failing intermittently.', 
    status: 'archived', 
    createdAt: new Date(Date.now() - 172800000).toISOString() 
  },
];

export const MOCK_ACTIVITY_LOG: AdminActivityEvent[] = [
  { id: 'ev-1', actor: { id: 'u-1', name: 'Akash Solanki' }, action: 'suspended', target: 'u-bad', metadata: 'Spam activity detected', timestamp: new Date(Date.now() - 300000).toISOString(), type: 'danger' },
  { id: 'ev-2', actor: { id: 'u-1', name: 'Akash Solanki' }, action: 'approved tag', target: '#IndiaGrowth', timestamp: new Date(Date.now() - 3600000).toISOString(), type: 'success' },
  { id: 'ev-3', actor: { id: 'u-1', name: 'Akash Solanki' }, action: 'updated config', target: 'Feature Flags', metadata: 'Enabled beta search', timestamp: new Date(Date.now() - 86400000).toISOString(), type: 'warning' },
  { id: 'ev-4', actor: { id: 'u-1', name: 'Akash Solanki' }, action: 'resolved report', target: 'r-3', timestamp: new Date(Date.now() - 172800000).toISOString(), type: 'info' },
  { id: 'ev-5', actor: { id: 'u-1', name: 'Akash Solanki' }, action: 'login', timestamp: new Date(Date.now() - 200000000).toISOString(), type: 'info' },
  { id: 'ev-6', actor: { id: 'u-admin-2', name: 'Sarah Admin' }, action: 'deleted nugget', target: 'n-291', metadata: 'Copyright violation', timestamp: new Date(Date.now() - 250000000).toISOString(), type: 'danger' },
];





================================================================================
FILE: src\admin\types\admin.ts
================================================================================

import React from 'react';

// --- RBAC Types ---
export type AdminRole = 'user' | 'admin' | 'superadmin';

export type AdminPermission = 
  | 'admin.access'
  | 'admin.users.view'
  | 'admin.users.edit'
  | 'admin.users.suspend'
  | 'admin.nuggets.view'
  | 'admin.nuggets.hide'
  | 'admin.nuggets.delete'
  | 'admin.collections.view'
  | 'admin.collections.edit'
  | 'admin.tags.manage'
  | 'admin.config.manage'
  | 'admin.moderation.view'
  | 'admin.activity.view'
  | 'admin.feedback.view';

// --- Service Privilege Types ---
export type ServiceId = 
  | 'batch_import'
  | 'ai_summary'
  | 'ai_auto_tag'
  | 'create_public_collection'
  | 'view_analytics'
  | 'data_export'
  | 'unlimited_nuggets';

export interface ServiceDefinition {
  id: ServiceId;
  label: string;
  description: string;
  category: 'content' | 'ai' | 'data';
}

export type RolePermissions = Record<AdminRole, ServiceId[]>;

export interface FeatureFlags {
  enableAvatarUpload: boolean;
  enablePublicSignup: boolean;
  enableEmailVerification: boolean;
  maintenanceMode: boolean;
  // Guest Capabilities
  guestBookmarks: boolean;
  guestReports: boolean;
}

// --- Signup Configuration Types ---
export interface FieldRule {
  show: boolean;
  required: boolean;
}

export interface SignupConfig {
  phone: FieldRule;
  gender: FieldRule;
  location: FieldRule; // Covers Pincode, City, Country
  dob: FieldRule; // New Date of Birth field
}

// --- Entity Types ---

export type AdminUserStatus = 'active' | 'suspended' | 'pending';

export interface AdminUser {
  id: string;
  name: string; // Display Name
  fullName: string; // Real Name
  username: string;
  email: string;
  role: AdminRole;
  status: AdminUserStatus;
  avatarUrl?: string;
  joinedAt: string;
  lastLoginAt?: string;
  stats: {
    nuggets: number;
    nuggetsPublic: number;
    nuggetsPrivate: number;
    collections: number;
    collectionsFollowing: number;
    reports: number;
  };
}

export type AdminNuggetStatus = 'active' | 'hidden' | 'flagged';

export interface AdminNugget {
  id: string;
  title: string;
  excerpt: string;
  author: {
    id: string;
    name: string;
    email: string;
    avatar?: string;
  };
  type: 'link' | 'text' | 'video' | 'image' | 'idea';
  url?: string;
  visibility: 'public' | 'private';
  status: AdminNuggetStatus;
  createdAt: string;
  reports: number;
  tags: string[];
}

export interface AdminCollection {
  id: string;
  name: string;
  description?: string;
  creator: {
    id: string;
    name: string;
  };
  type: 'public' | 'private';
  itemCount: number;
  followerCount: number;
  status: 'active' | 'hidden';
  createdAt: string;
  updatedAt: string;
}

export interface AdminTag {
  id: string;
  name: string;
  usageCount: number;
  type: 'category' | 'tag';
  isOfficial: boolean;
  status: 'active' | 'deprecated' | 'pending';
  requestedBy?: string;
}

export interface AdminTagRequest {
  id: string;
  name: string;
  requestedBy: {
    id: string;
    name: string;
  };
  requestedAt: string;
  status: 'pending' | 'approved' | 'rejected';
}

export interface AdminReport {
  id: string;
  targetId: string;
  targetType: 'nugget' | 'user' | 'collection';
  reason: 'spam' | 'harassment' | 'misinformation' | 'copyright' | 'other';
  description?: string;
  reporter: {
    id: string;
    name: string;
  };
  respondent: {
    id: string;
    name: string;
  };
  status: 'open' | 'resolved' | 'dismissed';
  createdAt: string;
}

export interface AdminFeedback {
  id: string;
  user?: {
    id: string;
    name: string;
    fullName?: string;
    username?: string;
    avatar?: string;
  };
  type: 'bug' | 'feature' | 'general';
  content: string;
  status: 'new' | 'read' | 'archived';
  createdAt: string;
}

export interface AdminActivityEvent {
  id: string;
  actor: {
    id: string;
    name: string;
    avatar?: string;
  };
  action: string;
  target?: string;
  metadata?: string;
  timestamp: string;
  type: 'info' | 'warning' | 'danger' | 'success';
}

export interface AdminStat {
  label: string;
  value: string | number;
  trend?: string;
  trendUp?: boolean;
  icon?: React.ReactNode;
}





================================================================================
FILE: src\App.tsx
================================================================================
import React, { useState, useEffect, Suspense, lazy } from 'react';
import { Routes, Route, Navigate } from 'react-router-dom';
import { Header } from './components/Header';
import { BackToTopButton } from './components/UI/BackToTopButton';
import { FeedbackButton } from './components/UI/FeedbackButton';
import { ToastContainer } from './components/UI/Toast';
import { MainLayout } from './components/layouts/MainLayout';
import { SortOrder } from './types';
import { Loader2 } from 'lucide-react';
import { CreateNuggetModal } from './components/CreateNuggetModal';
import { useAuth } from './hooks/useAuth';
import { AuthModal } from './components/auth/AuthModal';
import { ProtectedRoute } from './components/auth/ProtectedRoute';
import { LegalPageRenderer } from './pages/LegalPageRenderer';

// Lazy Load Pages
const HomePage = lazy(() => import('./pages/HomePage').then(module => ({ default: module.HomePage })));
const CollectionsPage = lazy(() => import('./pages/CollectionsPage').then(module => ({ default: module.CollectionsPage })));
const CollectionDetailPage = lazy(() => import('./pages/CollectionDetailPage').then(module => ({ default: module.CollectionDetailPage })));
const MySpacePage = lazy(() => import('./pages/MySpacePage').then(module => ({ default: module.MySpacePage })));
const AccountSettingsPage = lazy(() => import('./pages/AccountSettingsPage').then(module => ({ default: module.AccountSettingsPage })));
const AdminPanelPage = lazy(() => import('./pages/AdminPanelPage').then(module => ({ default: module.AdminPanelPage })));
const VerifyEmailPage = lazy(() => import('./pages/VerifyEmailPage').then(module => ({ default: module.VerifyEmailPage })));
const ResetPasswordPage = lazy(() => import('./pages/ResetPasswordPage').then(module => ({ default: module.ResetPasswordPage })));
const BulkCreateNuggetsPage = lazy(() => import('./pages/BulkCreateNuggetsPage').then(module => ({ default: module.BulkCreateNuggetsPage })));

const AppContent: React.FC = () => {
  const [isDark, setIsDark] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [viewMode, setViewMode] = useState<'grid' | 'feed'>('grid');
  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
  const [selectedTag, setSelectedTag] = useState<string | null>(null);
  const [sortOrder, setSortOrder] = useState<SortOrder>('latest');
  const [isCreateOpen, setIsCreateOpen] = useState(false);

  // Use Auth hook for user context
  const { currentUserId } = useAuth();

  // Initialize dark mode from system preference and listen for changes
  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    
    // Set initial value
    const updateTheme = (e: MediaQueryList | MediaQueryListEvent) => {
      setIsDark(e.matches);
    };
    
    updateTheme(mediaQuery);
    
    // Listen for changes
    if (mediaQuery.addEventListener) {
      mediaQuery.addEventListener('change', updateTheme);
      return () => mediaQuery.removeEventListener('change', updateTheme);
    } else {
      // Fallback for older browsers
      mediaQuery.addListener(updateTheme);
      return () => mediaQuery.removeListener(updateTheme);
    }
  }, []);

  useEffect(() => {
    const html = document.documentElement;
    if (isDark) html.classList.add('dark');
    else html.classList.remove('dark');
  }, [isDark]);

  return (
    <MainLayout>
      <Header 
        isDark={isDark} 
        toggleTheme={() => setIsDark(!isDark)} 
        searchQuery={searchQuery}
        setSearchQuery={setSearchQuery}
        sidebarOpen={sidebarOpen}
        setSidebarOpen={setSidebarOpen}
        viewMode={viewMode}
        setViewMode={setViewMode}
        selectedCategories={selectedCategories}
        setSelectedCategories={setSelectedCategories}
        selectedTag={selectedTag}
        setSelectedTag={setSelectedTag}
        sortOrder={sortOrder}
        setSortOrder={setSortOrder}
        onCreateNugget={() => setIsCreateOpen(true)}
        currentUserId={currentUserId}
      />

      <Suspense fallback={<div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin w-8 h-8 text-primary-500" /></div>}>
        <Routes>
          <Route path="/" element={<HomePage searchQuery={searchQuery} viewMode={viewMode} setViewMode={setViewMode} selectedCategories={selectedCategories} setSelectedCategories={setSelectedCategories} selectedTag={selectedTag} setSelectedTag={setSelectedTag} sortOrder={sortOrder} />} />
          
          <Route path="/collections" element={<CollectionsPage />} />
          <Route path="/collections/:collectionId" element={<CollectionDetailPage />} />
          
          {/* My Space (Current User) - Protected */}
          <Route path="/myspace" element={
            <ProtectedRoute>
              <Navigate to={`/profile/${currentUserId}`} replace />
            </ProtectedRoute>
          } />
          
          {/* Profile Page (Handles both My Space and Public Profiles) */}
          <Route path="/profile/:userId" element={<MySpacePage currentUserId={currentUserId} />} />
          
          <Route path="/account" element={
            <ProtectedRoute>
              <AccountSettingsPage userId={currentUserId} />
            </ProtectedRoute>
          } />

          {/* Admin Route with Wildcard for nested routing */}
          <Route path="/admin/*" element={
            <ProtectedRoute>
              <AdminPanelPage />
            </ProtectedRoute>
          } />

          <Route path="/bulk-create" element={
            <ProtectedRoute>
              <BulkCreateNuggetsPage />
            </ProtectedRoute>
          } />

          {/* Legal Pages - Static Routes */}
          <Route path="/about" element={<LegalPageRenderer />} />
          <Route path="/terms" element={<LegalPageRenderer />} />
          <Route path="/privacy" element={<LegalPageRenderer />} />
          <Route path="/contact" element={<LegalPageRenderer />} />
          <Route path="/guidelines" element={<LegalPageRenderer />} />
          <Route path="/disclaimer" element={<LegalPageRenderer />} />
          <Route path="/cookie-policy" element={<LegalPageRenderer />} />

          {/* Auth Routes */}
          <Route path="/verify-email" element={<VerifyEmailPage />} />
          <Route path="/reset-password" element={<ResetPasswordPage />} />

          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      </Suspense>
      
      <FeedbackButton />
      <BackToTopButton />
      <ToastContainer />
      
      <CreateNuggetModal isOpen={isCreateOpen} onClose={() => setIsCreateOpen(false)} />
      <AuthModal />
    </MainLayout>
  );
};

const App: React.FC = () => {
  return <AppContent />;
};

export default App;





================================================================================
FILE: src\components\AddToCollectionModal.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { X, Plus, Check, Folder, Search, Lock, Globe, Loader2 } from 'lucide-react';
import { storageService } from '@/services/storageService';
import { Collection } from '@/types';
import { useAuth } from '@/hooks/useAuth';
import { useToast } from '@/hooks/useToast';

interface AddToCollectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  articleIds: string[]; // Changed to array for bulk support
  mode?: 'public' | 'private';
}

export const AddToCollectionModal: React.FC<AddToCollectionModalProps> = ({ 
  isOpen, 
  onClose, 
  articleIds,
  mode = 'public' 
}) => {
  const [collections, setCollections] = useState<Collection[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [newCollectionName, setNewCollectionName] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const [processingId, setProcessingId] = useState<string | null>(null);
  
  const { currentUserId } = useAuth();
  const toast = useToast();

  useEffect(() => {
    if (isOpen) {
      loadCollections();
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen]);

  const loadCollections = async () => {
    const cols = await storageService.getCollections();
    // Filter to show only collections created by the user matching the mode
    setCollections(cols.filter(c => c.creatorId === currentUserId && c.type === mode));
  };

  const toggleCollection = async (collectionId: string, isFullySelected: boolean) => {
    setProcessingId(collectionId);
    try {
        if (isFullySelected) {
            // Remove all selected articles from this collection
            for (const id of articleIds) {
                await storageService.removeArticleFromCollection(collectionId, id, currentUserId);
            }
            toast.success(`Removed ${articleIds.length} nuggets from ${mode === 'private' ? 'folder' : 'collection'}`);
        } else {
            // Add all selected articles to this collection
            for (const id of articleIds) {
                await storageService.addArticleToCollection(collectionId, id, currentUserId);
            }
            toast.success(`Added ${articleIds.length} nuggets to ${mode === 'private' ? 'folder' : 'collection'}`);
        }
        await loadCollections();
    } catch (e) {
        toast.error("Failed to update");
    } finally {
        setProcessingId(null);
    }
  };

  const createCollection = async () => {
    if (!newCollectionName.trim()) return;
    setIsCreating(true);
    try {
        const newCol = await storageService.createCollection(newCollectionName, '', currentUserId, mode as 'public' | 'private');
        // Add all articles to new collection immediately
        for (const id of articleIds) {
            await storageService.addArticleToCollection(newCol.id, id, currentUserId);
        }
        setNewCollectionName('');
        setIsCreating(false);
        await loadCollections();
        toast.success(`Created ${mode === 'private' ? 'folder' : 'collection'} and added nuggets`);
    } catch (e) {
        toast.error("Failed to create");
    } finally {
        setIsCreating(false);
    }
  };

  if (!isOpen) return null;

  const filteredCollections = collections.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
  
  // Dynamic labels based on mode
  const title = mode === 'private' ? 'Save to Folder' : 'Add to Collection';
  const entityName = mode === 'private' ? 'folder' : 'collection';

  return createPortal(
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6" onClick={(e) => e.stopPropagation()}>
      <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in" onClick={onClose} />
      
      <div className="relative w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-xl flex flex-col overflow-hidden animate-in zoom-in-95 border border-slate-200 dark:border-slate-800">
        
        {/* Header */}
        <div className="px-4 py-3 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <h3 className="font-bold text-slate-900 dark:text-white">
                {title}
            </h3>
            {mode === 'private' ? <Lock size={14} className="text-slate-400" /> : <Globe size={14} className="text-slate-400" />}
          </div>
          <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
            <X size={18} className="text-slate-500" />
          </button>
        </div>

        {/* Subheader for Bulk Context */}
        {articleIds.length > 1 && (
            <div className="px-4 py-2 bg-primary-50 dark:bg-primary-900/10 text-xs font-medium text-primary-700 dark:text-primary-400 border-b border-primary-100 dark:border-primary-900/20">
                Adding {articleIds.length} nuggets...
            </div>
        )}

        {/* Search / List */}
        <div className="p-4 flex flex-col gap-3 max-h-[60vh] overflow-y-auto custom-scrollbar">
          
          {/* Search Bar */}
          <div className="relative">
            <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
            <input 
              autoFocus
              className="w-full bg-slate-100 dark:bg-slate-800 rounded-lg pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50 dark:text-white placeholder-slate-400 border-none"
              placeholder={`Find ${entityName}...`}
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>

          {/* List */}
          <div className="flex flex-col gap-1">
            {filteredCollections.length > 0 ? filteredCollections.map(col => {
              // Check if ALL selected articles are in this collection
              const isFullySelected = articleIds.every(id => col.entries.some(e => e.articleId === id));
              // Check if SOME are in
              const isPartiallySelected = !isFullySelected && articleIds.some(id => col.entries.some(e => e.articleId === id));
              
              const isProcessing = processingId === col.id;

              return (
                <button
                  key={col.id}
                  onClick={() => toggleCollection(col.id, isFullySelected)}
                  disabled={isProcessing}
                  className="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors group text-left"
                >
                  <div className="flex items-center gap-3 overflow-hidden">
                    <div className={`w-8 h-8 rounded-lg shrink-0 flex items-center justify-center ${isFullySelected ? 'bg-primary-100 text-primary-600 dark:bg-primary-900/20 dark:text-primary-400' : isPartiallySelected ? 'bg-slate-200 text-slate-600' : 'bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400'}`}>
                      {isProcessing ? <Loader2 size={16} className="animate-spin" /> : <Folder size={16} fill={isFullySelected ? "currentColor" : "none"} />}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className={`text-sm font-bold truncate ${isFullySelected ? 'text-primary-700 dark:text-primary-400' : 'text-slate-700 dark:text-slate-300'}`}>{col.name}</div>
                      <div className="text-[10px] text-slate-400">{col.entries.length} items</div>
                    </div>
                  </div>
                  {isFullySelected && <Check size={16} className="text-primary-500 shrink-0" />}
                  {isPartiallySelected && <div className="w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600 mr-1" />}
                </button>
              );
            }) : (
                <div className="text-center py-4 text-xs text-slate-400">
                    {searchQuery ? `No matching ${entityName}s found.` : `No ${entityName}s yet.`}
                </div>
            )}
          </div>

          {/* Create New */}
          {isCreating ? (
            <div className="flex items-center gap-2 animate-in fade-in slide-in-from-top-1">
              <input 
                autoFocus
                className="flex-1 bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary-500 dark:text-white"
                placeholder={`${mode === 'private' ? 'Folder' : 'Collection'} name...`}
                value={newCollectionName}
                onChange={(e) => setNewCollectionName(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && createCollection()}
              />
              <button onClick={createCollection} className="p-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600"><Check size={16} /></button>
              <button onClick={() => setIsCreating(false)} className="p-2 bg-slate-100 dark:bg-slate-800 text-slate-500 rounded-lg"><X size={16} /></button>
            </div>
          ) : (
            <button 
              onClick={() => setIsCreating(true)}
              className="flex items-center gap-2 p-2 text-sm font-bold text-primary-600 dark:text-primary-400 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg transition-colors justify-center mt-2 border border-dashed border-primary-200 dark:border-primary-800"
            >
              <Plus size={16} />
              <span>Create new {entityName}</span>
            </button>
          )}

        </div>
      </div>
    </div>,
    document.body
  );
};









================================================================================
FILE: src\components\ArticleDetail.tsx
================================================================================
import React, { useState } from 'react';
import { Article } from '@/types';
import { X, Clock, ExternalLink, Sparkles, Loader2, Bookmark, FolderPlus, Heart, Eye } from 'lucide-react';
import { formatDate } from '@/utils/formatters';
import { Avatar } from './shared/Avatar';
import { useBookmarks } from '@/hooks/useBookmarks';
import { useToast } from '@/hooks/useToast';
import { AddToCollectionModal } from './AddToCollectionModal';
import { ShareMenu } from './shared/ShareMenu';
import { aiService } from '@/services/aiService';
import { RichTextRenderer } from './RichTextRenderer';
import { EmbeddedMedia } from './embeds/EmbeddedMedia';
import { useRequireAuth } from '@/hooks/useRequireAuth';

interface ArticleDetailProps {
  article: Article;
  onClose?: () => void;
  isModal?: boolean;
}

export const ArticleDetail: React.FC<ArticleDetailProps> = ({ article, onClose, isModal = false }) => {
  const { isBookmarked, toggleBookmark } = useBookmarks();
  const [isCollectionModalOpen, setIsCollectionModalOpen] = useState(false);
  const [collectionMode, setCollectionMode] = useState<'public' | 'private'>('public');
  const [aiSummary, setAiSummary] = useState<string | null>(null);
  const [isAiLoading, setIsAiLoading] = useState(false);
  
  const { withAuth } = useRequireAuth();
  const toast = useToast();

  const handleGenerateSummary = async () => {
    setIsAiLoading(true);
    try {
        const summary = await aiService.generateTakeaways(article.content || article.excerpt);
        setAiSummary(summary);
    } catch (e) {
        toast.error("Failed to generate summary");
    } finally {
        setIsAiLoading(false);
    }
  };

  const handleBookmark = () => {
      toggleBookmark(article.id);
      if (!isBookmarked(article.id)) {
          toast.success("Saved to bookmarks");
      } else {
          toast.info("Removed from bookmarks");
      }
  };

  const handleAddToCollection = (mode: 'public' | 'private') => {
      setCollectionMode(mode);
      setIsCollectionModalOpen(true);
  };

  return (
    <div className={`bg-white dark:bg-slate-950 min-h-full flex flex-col ${isModal ? '' : 'pt-20'}`}>
       {/* Header / Nav */}
       {isModal && (
           <div className="sticky top-0 z-10 flex items-center justify-between px-4 py-3 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md border-b border-slate-100 dark:border-slate-800">
               <div className="flex items-center gap-3">
                   <Avatar name={article.author.name} size="sm" />
                   <div className="text-sm font-bold text-slate-900 dark:text-white">{article.author.name}</div>
               </div>
               <div className="flex items-center gap-2">
                   <ShareMenu 
                       data={{ type: 'nugget', id: article.id, title: article.title, shareUrl: window.location.href }} 
                       className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"
                   />
                   <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                       <X size={20} className="text-slate-500" />
                   </button>
               </div>
           </div>
       )}

       <div className="flex-1 overflow-y-auto custom-scrollbar">
           {/* Hero Media */}
           {article.media && (
               <div className="w-full aspect-video bg-slate-100 dark:bg-slate-900">
                   <EmbeddedMedia media={article.media} />
               </div>
           )}
           
           <div className="max-w-3xl mx-auto px-6 py-8 space-y-8">
               {/* Title & Meta */}
               <div>
                   <div className="flex flex-wrap gap-2 mb-4">
                       {article.categories.map(cat => (
                           <span key={cat} className="px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-bold rounded-lg uppercase tracking-wide">
                               {cat}
                           </span>
                       ))}
                   </div>
                   <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 dark:text-white leading-tight mb-4">
                       {article.title}
                   </h1>
                   <div className="flex items-center gap-4 text-xs font-medium text-slate-500 dark:text-slate-400">
                       <div className="flex items-center gap-1.5">
                           <Clock size={14} />
                           <span>{article.readTime} min read</span>
                       </div>
                       <div>{formatDate(article.publishedAt)}</div>
                   </div>
               </div>

               {/* AI Summary Widget */}
               <div className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/10 dark:to-purple-900/10 rounded-2xl p-5 border border-indigo-100 dark:border-indigo-900/30">
                   <div className="flex items-center justify-between mb-3">
                       <div className="flex items-center gap-2 text-indigo-700 dark:text-indigo-400 font-bold text-sm">
                           <Sparkles size={16} />
                           AI Key Takeaways
                       </div>
                       {!aiSummary && (
                           <button 
                               onClick={handleGenerateSummary}
                               disabled={isAiLoading}
                               className="px-3 py-1.5 bg-white dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 rounded-lg text-xs font-bold shadow-sm hover:scale-105 transition-transform disabled:opacity-50"
                           >
                               {isAiLoading ? <Loader2 size={12} className="animate-spin" /> : 'Generate'}
                           </button>
                       )}
                   </div>
                   {isAiLoading ? (
                       <div className="space-y-2 animate-pulse">
                           <div className="h-2 bg-indigo-200 dark:bg-indigo-800 rounded w-3/4"></div>
                           <div className="h-2 bg-indigo-200 dark:bg-indigo-800 rounded w-1/2"></div>
                       </div>
                   ) : aiSummary ? (
                       <div className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">
                           <RichTextRenderer content={aiSummary} />
                       </div>
                   ) : (
                       <p className="text-xs text-slate-500 italic">Get a quick summary of this nugget with AI.</p>
                   )}
               </div>

               {/* Content */}
               <div className="prose prose-slate dark:prose-invert max-w-none">
                   <RichTextRenderer content={article.content} />
               </div>

               {/* Link Source */}
               {article.source_type === 'link' && (article.media?.url || (article as any).url) && (
                   <a 
                       href={article.media?.url || (article as any).url} 
                       target="_blank" 
                       rel="noopener noreferrer"
                       className="flex items-center gap-2 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group"
                   >
                       <ExternalLink size={18} className="group-hover:text-primary-500 transition-colors" />
                       <span className="text-sm font-bold truncate flex-1">Read original source</span>
                   </a>
               )}
               
               {/* Engagement Footer */}
               <div className="flex items-center justify-between pt-6 border-t border-slate-100 dark:border-slate-800">
                   <div className="flex gap-4">
                       <button onClick={withAuth(handleBookmark, 'guestBookmarks')} className={`flex items-center gap-1.5 text-sm font-bold transition-colors ${isBookmarked(article.id) ? 'text-primary-600' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>
                           <Bookmark size={18} fill={isBookmarked(article.id) ? "currentColor" : "none"} />
                           {isBookmarked(article.id) ? 'Saved' : 'Save'}
                       </button>
                       <button onClick={withAuth(() => handleAddToCollection('public'))} className="flex items-center gap-1.5 text-sm font-bold text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors">
                           <FolderPlus size={18} />
                           Add to Collection
                       </button>
                   </div>
                   
                   <div className="flex gap-4 text-slate-400 text-xs font-medium">
                       <span className="flex items-center gap-1"><Heart size={14} /> {article.engagement?.likes || 0}</span>
                       <span className="flex items-center gap-1"><Eye size={14} /> {article.engagement?.views || 0}</span>
                   </div>
               </div>
           </div>
       </div>

       <AddToCollectionModal 
           isOpen={isCollectionModalOpen} 
           onClose={() => setIsCollectionModalOpen(false)} 
           articleIds={[article.id]} 
           mode={collectionMode} 
       />
    </div>
  );
};





================================================================================
FILE: src\components\ArticleGrid.tsx
================================================================================
import React from 'react';
import { Article } from '@/types';
import { NewsCard } from './NewsCard';
import { EmptyState } from './UI/EmptyState';
import { SearchX } from 'lucide-react';
import { useRowExpansion } from '@/hooks/useRowExpansion';

interface ArticleGridProps {
  articles: Article[];
  viewMode: 'grid' | 'feed';
  isLoading: boolean;
  onArticleClick: (article: Article) => void;
  isBookmarked: (id: string) => boolean;
  onToggleBookmark: (id: string) => void;
  onCategoryClick: (category: string) => void;
  emptyTitle?: string;
  emptyMessage?: string;
  currentUserId?: string;
  // Selection Props
  selectionMode?: boolean;
  selectedIds?: string[];
  onSelect?: (id: string) => void;
}

export const ArticleGrid: React.FC<ArticleGridProps> = ({
  articles,
  viewMode,
  isLoading,
  onArticleClick,
  isBookmarked,
  onToggleBookmark,
  onCategoryClick,
  emptyTitle = "No nuggets found",
  emptyMessage = "Try adjusting your search or filters.",
  currentUserId,
  selectionMode = false,
  selectedIds = [],
  onSelect
}) => {
  const { expandedId, toggleExpansion, registerCard } = useRowExpansion();

  if (isLoading) {
    return (
      <div
        className={
          viewMode === 'feed'
            ? "max-w-2xl mx-auto flex flex-col gap-8"
            : "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 auto-rows-auto items-stretch mx-auto w-full"
        }
      >
        {[1, 2, 3, 4, 5, 6].map((i) => (
          <div key={i} className="bg-slate-100 dark:bg-slate-800 rounded-2xl h-80 animate-pulse" />
        ))}
      </div>
    );
  }

  if (articles.length === 0) {
    return (
      <EmptyState
        icon={<SearchX />}
        title={emptyTitle}
        description={emptyMessage}
      />
    );
  }

  return (
    <div
      className={
        viewMode === 'feed'
          ? "max-w-2xl mx-auto flex flex-col gap-8"
          : "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 auto-rows-auto items-stretch mx-auto w-full"
      }
    >
      {articles.map((article) => (
        <NewsCard
          key={article.id}
          ref={(el) => registerCard(article.id, el)}
          article={article}
          viewMode={viewMode}
          isBookmarked={isBookmarked(article.id)}
          onToggleBookmark={onToggleBookmark}
          onCategoryClick={onCategoryClick}
          onClick={onArticleClick}
          expanded={expandedId === article.id}
          onToggleExpand={() => toggleExpansion(article.id)}
          currentUserId={currentUserId}
          selectionMode={selectionMode}
          isSelected={selectedIds.includes(article.id)}
          onSelect={onSelect}
        />
      ))}
    </div>
  );
};









================================================================================
FILE: src\components\ArticleModal.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { Article } from '@/types';
import { ArticleDetail } from './ArticleDetail';

interface ArticleModalProps {
  isOpen: boolean;
  onClose: () => void;
  article: Article;
}

export const ArticleModal: React.FC<ArticleModalProps> = ({ 
  isOpen, 
  onClose, 
  article: initialArticle
}) => {
  const [article, setArticle] = useState(initialArticle);

  useEffect(() => {
    setArticle(initialArticle);
  }, [initialArticle]);

  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isOpen) return;
      if (e.key === 'Escape') onClose();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return createPortal(
    <div 
      className="fixed inset-0 z-[60] flex justify-end isolation-auto"
      role="dialog"
      aria-modal="true"
    >
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-300"
        onClick={onClose}
        aria-hidden="true"
      />
      
      {/* Drawer Container - Right Aligned, Full Height */}
      <div 
        className="
          relative w-full sm:max-w-2xl h-full bg-white dark:bg-slate-950 shadow-2xl 
          flex flex-col border-l border-slate-200 dark:border-slate-800
          animate-in slide-in-from-right duration-300 ease-out
        "
      >
        <div className="flex-1 overflow-y-auto custom-scrollbar bg-white dark:bg-slate-950 relative h-full">
            <ArticleDetail 
              article={article} 
              isModal={true} 
              onClose={onClose}
            />
        </div>
      </div>
    </div>,
    document.body
  );
};









================================================================================
FILE: src\components\auth\AuthModal.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { X, Mail, Lock, ArrowRight, Loader2, Chrome, ChevronLeft, Shield, User as UserIcon, AtSign, Calendar } from 'lucide-react';
import { useAuth } from '../../hooks/useAuth';
import { Input } from '../UI/Input';
import { ENABLED_SOCIAL_PROVIDERS } from '../../types/auth';

// Simple mock for Pincode lookup
const mockPincodeLookup = async (pincode: string) => {
    await new Promise(r => setTimeout(r, 600)); // Simulate net delay
    // Deterministic mock based on last digit
    const lastDigit = pincode.slice(-1);
    if (['1','2','3'].includes(lastDigit)) return { city: 'New York', country: 'USA' };
    if (['4','5','6'].includes(lastDigit)) return { city: 'London', country: 'UK' };
    if (['7','8','9'].includes(lastDigit)) return { city: 'Mumbai', country: 'India' };
    return { city: 'Unknown City', country: 'Unknown Country' };
};

export const AuthModal: React.FC = () => {
  const { isAuthModalOpen, closeAuthModal, authModalView, login, signup, socialLogin, featureFlags, signupConfig } = useAuth();
  
  const [view, setView] = useState<'login' | 'signup' | 'forgot' | 'verify_pending'>(authModalView);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // Login Form
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [keepSignedIn, setKeepSignedIn] = useState(true);

  // Signup Form
  const [fullName, setFullName] = useState('');
  const [username, setUsername] = useState('');
  const [pincode, setPincode] = useState('');
  const [city, setCity] = useState('');
  const [country, setCountry] = useState('');
  const [gender, setGender] = useState('');
  const [phone, setPhone] = useState('');
  const [dob, setDob] = useState('');
  const [isLookingUpPin, setIsLookingUpPin] = useState(false);

  // Reset state when modal opens
  useEffect(() => {
    setView(authModalView);
    setError(null);
    setEmail('');
    setPassword('');
    // Reset Signup
    setFullName('');
    setUsername('');
    setPincode('');
    setCity('');
    setCountry('');
    setGender('');
    setPhone('');
    setDob('');
  }, [isAuthModalOpen, authModalView]);

  useEffect(() => {
    if (isAuthModalOpen) document.body.style.overflow = 'hidden';
    else document.body.style.overflow = 'unset';
    return () => { document.body.style.overflow = 'unset'; };
  }, [isAuthModalOpen]);

  // Handle Pincode Auto-fill
  useEffect(() => {
      if (pincode.length >= 5) {
          const fetchLoc = async () => {
              setIsLookingUpPin(true);
              try {
                  const data = await mockPincodeLookup(pincode);
                  if (data) {
                      setCity(data.city);
                      setCountry(data.country);
                  }
              } catch (e) {
                  // ignore
              } finally {
                  setIsLookingUpPin(false);
              }
          };
          const timer = setTimeout(fetchLoc, 500); // Debounce
          return () => clearTimeout(timer);
      }
  }, [pincode]);

  const handleUsernameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      // Sanitize: Remove @ and spaces, allow alphanum + underscore
      const val = e.target.value.replace(/[@\s]/g, '').replace(/[^a-zA-Z0-9_]/g, '');
      setUsername(val);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setIsLoading(true);

    try {
        if (view === 'login') {
            await login({ email, password });
        } else if (view === 'signup') {
            await signup({ 
                fullName, 
                username, 
                email, 
                password, 
                pincode, 
                city, 
                country, 
                gender,
                phoneNumber: phone,
                dateOfBirth: dob
            });
            
            // Check if verification is required
            if (featureFlags?.enableEmailVerification) {
                setView('verify_pending');
            } else {
                // Auth context handles close
            }
        } else if (view === 'forgot') {
            await new Promise(r => setTimeout(r, 1000));
            alert("If an account exists, a reset link has been sent.");
            setView('login');
        }
    } catch (err: any) {
        setError(err.message || "An error occurred");
    } finally {
        setIsLoading(false);
    }
  };

  const handleDemoLogin = async (role: 'admin' | 'user') => {
      setIsLoading(true);
      setError(null);
      try {
          const email = role === 'admin' ? 'akash@example.com' : 'hemant@example.com';
          await login({ email, password: 'password' }); 
      } catch (err: any) {
          setError("Demo login failed.");
      } finally {
          setIsLoading(false);
      }
  };

  if (!isAuthModalOpen) return null;

  const inputClass = "bg-white/60 dark:bg-black/20 border-slate-200/80 dark:border-slate-700/60 focus:ring-primary-400/50 focus:border-primary-400 dark:text-white backdrop-blur-sm transition-all shadow-sm";
  const labelClass = "block text-xs font-semibold text-slate-500 dark:text-slate-400 mb-1.5 ml-1 uppercase tracking-wider";

  return createPortal(
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      <div 
        className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-300"
        onClick={closeAuthModal}
      />
      
      <div className="
        relative w-full max-w-md 
        bg-white/90 dark:bg-slate-950/80 backdrop-blur-xl 
        rounded-2xl shadow-2xl 
        border border-white/20 dark:border-white/10
        flex flex-col overflow-hidden 
        animate-in zoom-in-95 fade-in slide-in-from-bottom-4 duration-300
        max-h-[90vh]
      ">
        
        <button 
            onClick={closeAuthModal} 
            className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-black/5 dark:hover:bg-white/10 rounded-full transition-colors z-20"
        >
            <X size={20} />
        </button>

        {/* Verification Pending View */}
        {view === 'verify_pending' ? (
            <div className="p-8 text-center flex flex-col items-center justify-center h-full min-h-[400px]">
                <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-6">
                    <Mail size={32} />
                </div>
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">Check your inbox</h2>
                <p className="text-slate-500 dark:text-slate-400 mb-8 max-w-xs">
                    We've sent a verification link to <strong>{email}</strong>. Please click the link to activate your account.
                </p>
                <button onClick={() => setView('login')} className="text-sm font-bold text-primary-600 hover:underline">
                    Return to Login
                </button>
            </div>
        ) : (
            <>
                <div className="px-8 pt-10 pb-2 text-center shrink-0">
                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white tracking-tight mb-2">
                        {view === 'login' && 'Welcome Back'}
                        {view === 'signup' && 'Join Nuggets'}
                        {view === 'forgot' && 'Reset Password'}
                    </h2>
                    {view === 'login' && <p className="text-sm text-slate-500 dark:text-slate-400">Sign in to continue to your space.</p>}
                </div>

                <div className="flex-1 overflow-y-auto custom-scrollbar px-8 pb-8 pt-6">
                    
                    {/* Toggle Tabs */}
                    {view !== 'forgot' && (
                        <div className="flex bg-slate-100/50 dark:bg-slate-800/50 p-1 rounded-xl mb-6 relative border border-slate-200/50 dark:border-slate-700/50">
                            <button onClick={() => setView('login')} className={`flex-1 py-1.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all ${view === 'login' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500'}`}>Log in</button>
                            <button onClick={() => setView('signup')} className={`flex-1 py-1.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all ${view === 'signup' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500'}`}>Sign up</button>
                        </div>
                    )}

                    {/* Social Login */}
                    {view !== 'forgot' && (
                        <div className="space-y-3 mb-6">
                            {ENABLED_SOCIAL_PROVIDERS.includes('google') && (
                                <button type="button" onClick={() => socialLogin('google')} className="w-full flex items-center justify-center gap-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-white/5 hover:bg-white dark:hover:bg-white/10 transition-colors font-medium text-sm text-slate-700 dark:text-slate-200 group shadow-sm">
                                    <Chrome size={18} className="text-slate-500 group-hover:text-blue-500 transition-colors" /> <span>Google</span>
                                </button>
                            )}
                            <div className="relative py-2 flex items-center justify-center mt-2">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200 dark:border-slate-700/60"></div></div>
                                <span className="relative px-2 text-[10px] uppercase font-bold text-slate-400 bg-white/90 dark:bg-slate-900/90 rounded-full">or</span>
                            </div>
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300">
                        
                        {/* SIGNUP FIELDS */}
                        {view === 'signup' && (
                            <>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className={labelClass}>Full Name</label>
                                        <Input placeholder="John Doe" value={fullName} onChange={e => setFullName(e.target.value)} required className={inputClass} />
                                    </div>
                                    <div>
                                        <label className={labelClass}>Username</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                                <AtSign size={14} />
                                            </div>
                                            <input 
                                                className={`block w-full py-2.5 pl-8 pr-4 ${inputClass} rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500`}
                                                placeholder="username" 
                                                value={username} 
                                                onChange={handleUsernameChange}
                                                required 
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label className={labelClass}>Email</label>
                                    <Input type="email" placeholder="you@example.com" value={email} onChange={e => setEmail(e.target.value)} required className={inputClass} />
                                </div>

                                <div>
                                    <label className={labelClass}>Password</label>
                                    <Input type="password" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} required className={inputClass} />
                                </div>

                                {/* LOCATION GROUP - Configurable */}
                                {signupConfig?.location.show && (
                                    <div className="grid grid-cols-3 gap-4">
                                        <div className="col-span-1">
                                            <label className={labelClass}>Pincode {signupConfig.location.required ? '*' : ''}</label>
                                            <Input 
                                                placeholder="Zip" 
                                                value={pincode} 
                                                onChange={e => setPincode(e.target.value)} 
                                                required={signupConfig.location.required}
                                                className={inputClass} 
                                                maxLength={10}
                                            />
                                        </div>
                                        <div className="col-span-2 relative">
                                            {isLookingUpPin && <div className="absolute right-2 top-8"><Loader2 size={14} className="animate-spin text-primary-500"/></div>}
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className={labelClass}>City</label>
                                                    <Input value={city} onChange={e => setCity(e.target.value)} placeholder="City" className={inputClass} />
                                                </div>
                                                <div>
                                                    <label className={labelClass}>Country</label>
                                                    <Input value={country} onChange={e => setCountry(e.target.value)} placeholder="Country" className={inputClass} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-4">
                                    {/* GENDER - Configurable */}
                                    {signupConfig?.gender.show && (
                                        <div>
                                            <label className={labelClass}>Gender {signupConfig.gender.required ? '*' : ''}</label>
                                            <select 
                                                value={gender} 
                                                onChange={e => setGender(e.target.value)} 
                                                className={`w-full py-2.5 px-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 ${inputClass}`}
                                                required={signupConfig.gender.required}
                                            >
                                                <option value="" disabled>Select</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="other">Other</option>
                                                <option value="prefer_not_to_say">Prefer not to say</option>
                                            </select>
                                        </div>
                                    )}
                                    
                                    {/* PHONE - Configurable */}
                                    {signupConfig?.phone.show && (
                                        <div>
                                            <label className={labelClass}>Mobile {signupConfig.phone.required ? '*' : <span className="normal-case opacity-50 font-normal">(Optional)</span>}</label>
                                            <Input 
                                                type="tel" 
                                                placeholder="+1..." 
                                                value={phone} 
                                                onChange={e => setPhone(e.target.value)} 
                                                className={inputClass} 
                                                required={signupConfig.phone.required}
                                            />
                                        </div>
                                    )}
                                </div>

                                {/* DATE OF BIRTH - Configurable */}
                                {signupConfig?.dob.show && (
                                    <div>
                                        <label className={labelClass}>Date of Birth {signupConfig.dob.required ? '*' : ''}</label>
                                        <Input 
                                            type="date" 
                                            value={dob}
                                            onChange={e => setDob(e.target.value)}
                                            required={signupConfig.dob.required}
                                            className={inputClass}
                                            leftIcon={<Calendar size={16} />}
                                        />
                                    </div>
                                )}
                            </>
                        )}

                        {/* LOGIN FIELDS */}
                        {view === 'login' && (
                            <>
                                <div>
                                    <label className={labelClass}>Email Address</label>
                                    <Input type="email" placeholder="you@example.com" leftIcon={<Mail size={16} />} value={email} onChange={e => setEmail(e.target.value)} required className={inputClass} />
                                </div>
                                <div>
                                    <div className="flex justify-between items-center mb-1.5 ml-1">
                                        <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Password</label>
                                    </div>
                                    <Input type="password" placeholder="••••••••" leftIcon={<Lock size={16} />} value={password} onChange={e => setPassword(e.target.value)} required className={inputClass} />
                                </div>
                                <div className="flex items-center justify-between">
                                    <label className="flex items-center gap-2 cursor-pointer group">
                                        <div className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${keepSignedIn ? 'bg-primary-500 border-primary-500 text-white' : 'bg-white/50 border-slate-300 dark:border-slate-600 dark:bg-black/20'}`}>
                                            {keepSignedIn && <div className="w-2 h-2 bg-white rounded-sm" />}
                                        </div>
                                        <input type="checkbox" className="hidden" checked={keepSignedIn} onChange={(e) => setKeepSignedIn(e.target.checked)} />
                                        <span className="text-xs font-medium text-slate-600 dark:text-slate-400 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">Remember me</span>
                                    </label>
                                    <button type="button" onClick={() => setView('forgot')} className="text-xs font-bold text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white underline transition-colors">Forgot?</button>
                                </div>
                            </>
                        )}

                        {/* FORGOT FIELDS */}
                        {view === 'forgot' && (
                            <div>
                                <label className={labelClass}>Email Address</label>
                                <Input type="email" placeholder="you@example.com" leftIcon={<Mail size={16} />} value={email} onChange={e => setEmail(e.target.value)} required className={inputClass} />
                            </div>
                        )}

                        {error && (
                            <div className="p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 text-red-600 dark:text-red-400 text-xs font-bold flex items-center gap-2 animate-in fade-in slide-in-from-top-1">
                                <div className="w-1.5 h-1.5 rounded-full bg-red-500 shrink-0" />
                                {error}
                            </div>
                        )}

                        <button 
                            type="submit"
                            disabled={isLoading}
                            className="w-full py-3 bg-primary-500 hover:bg-primary-400 text-slate-900 rounded-xl font-bold text-sm transition-all shadow-lg shadow-primary-500/20 active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-4"
                        >
                            {isLoading ? <Loader2 size={18} className="animate-spin" /> : (
                                <>
                                    {view === 'login' && 'Sign In'}
                                    {view === 'signup' && 'Create Account'}
                                    {view === 'forgot' && 'Send Reset Link'}
                                    {!isLoading && view !== 'forgot' && <ArrowRight size={16} />}
                                </>
                            )}
                        </button>

                        {view === 'forgot' && (
                            <button type="button" onClick={() => setView('login')} className="w-full py-3 mt-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white font-bold text-sm flex items-center justify-center gap-2 transition-colors">
                                <ChevronLeft size={16} /> Back to Login
                            </button>
                        )}
                    </form>

                    {/* DEMO ACCOUNTS */}
                    {view === 'login' && (
                        <div className="mt-8 pt-6 border-t border-slate-200 dark:border-slate-800">
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center mb-3">Quick Demo Login</p>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => handleDemoLogin('admin')} className="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-white/5 hover:bg-white dark:hover:bg-slate-800 hover:border-primary-300 transition-all group">
                                    <Shield size={16} className="text-slate-400 group-hover:text-primary-500 mb-1.5" />
                                    <span className="text-xs font-bold text-slate-600 dark:text-slate-300">Admin</span>
                                </button>
                                <button onClick={() => handleDemoLogin('user')} className="flex flex-col items-center justify-center p-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-white/5 hover:bg-white dark:hover:bg-slate-800 hover:border-primary-300 transition-all group">
                                    <UserIcon size={16} className="text-slate-400 group-hover:text-primary-500 mb-1.5" />
                                    <span className="text-xs font-bold text-slate-600 dark:text-slate-300">User</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            </>
        )}
      </div>
    </div>,
    document.body
  );
};





================================================================================
FILE: src\components\auth\ProtectedRoute.tsx
================================================================================
import React, { useEffect } from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from '@/hooks/useAuth';

interface ProtectedRouteProps {
  children: React.ReactNode;
}

export const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ children }) => {
  const { isAuthenticated, isLoading, openAuthModal } = useAuth();
  const location = useLocation();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      openAuthModal('login');
    }
  }, [isLoading, isAuthenticated, openAuthModal]);

  if (isLoading) {
    return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div></div>;
  }

  if (!isAuthenticated) {
    // Redirect to home but keep the URL so we could potentially redirect back after login (not implemented here yet)
    return <Navigate to="/" replace state={{ from: location }} />;
  }

  return <>{children}</>;
};









================================================================================
FILE: src\components\batch\BatchPreviewTable.tsx
================================================================================
import React from 'react';
import { BatchRow } from '@/types/batch';
import { ExternalLink, Trash2, AlertCircle, CheckCircle2, Loader2, RefreshCw } from 'lucide-react';

interface BatchPreviewTableProps {
  rows: BatchRow[];
  onUpdateRow: (id: string, updates: Partial<BatchRow>) => void;
  onRemoveRow: (id: string) => void;
  onRetryRow: (id: string) => void;
}

export const BatchPreviewTable: React.FC<BatchPreviewTableProps> = ({ 
  rows, 
  onUpdateRow, 
  onRemoveRow,
  onRetryRow
}) => {
  return (
    <div className="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden shadow-sm">
      <div className="overflow-auto custom-scrollbar max-h-[600px]">
        <table className="w-full text-left text-sm">
          <thead className="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800 text-xs uppercase text-slate-500 font-bold tracking-wider sticky top-0 z-10 backdrop-blur-md">
            <tr>
              <th className="px-4 py-3 w-10">
                <input 
                    type="checkbox" 
                    checked={rows.length > 0 && rows.every(r => r.selected)}
                    onChange={(e) => rows.forEach(r => onUpdateRow(r.id, { selected: e.target.checked }))}
                    className="rounded border-slate-300 dark:border-slate-600 focus:ring-primary-500"
                />
              </th>
              <th className="px-4 py-3 w-8">Status</th>
              <th className="px-4 py-3 min-w-[200px]">URL & Title</th>
              <th className="px-4 py-3 min-w-[200px]">Excerpt / Note</th>
              <th className="px-4 py-3 w-40">Categories</th>
              <th className="px-4 py-3 w-28">Visibility</th>
              <th className="px-4 py-3 w-12">Action</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
            {rows.map((row) => (
              <tr key={row.id} className={`group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${!row.selected ? 'opacity-50' : ''}`}>
                
                {/* Checkbox */}
                <td className="px-4 py-3 align-top pt-4">
                  <input 
                    type="checkbox" 
                    checked={row.selected}
                    onChange={(e) => onUpdateRow(row.id, { selected: e.target.checked })}
                    disabled={row.status === 'success'}
                    className="rounded border-slate-300 dark:border-slate-600 focus:ring-primary-500"
                  />
                </td>

                {/* Status Icon */}
                <td className="px-4 py-3 align-top pt-4">
                  {row.status === 'fetching' && <Loader2 size={16} className="text-blue-500 animate-spin" />}
                  {row.status === 'ready' && <div className="w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-600" title="Ready" />}
                  {row.status === 'success' && <CheckCircle2 size={18} className="text-green-500" />}
                  {row.status === 'error' && (
                    <div title={row.errorMessage}>
                      <AlertCircle size={18} className="text-red-500" aria-label={row.errorMessage} />
                    </div>
                  )}
                  {row.status === 'pending' && <div className="w-3 h-3 rounded-full border border-slate-300" />}
                </td>

                {/* URL & Title */}
                <td className="px-4 py-3 align-top space-y-2">
                  <div className="flex items-center gap-1.5 text-xs text-blue-600 dark:text-blue-400 max-w-[250px]">
                    <a href={row.url} target="_blank" rel="noreferrer" className="truncate hover:underline" title={row.url}>{row.url}</a>
                    <ExternalLink size={10} className="shrink-0" />
                  </div>
                  <input 
                    type="text" 
                    value={row.title}
                    onChange={(e) => onUpdateRow(row.id, { title: e.target.value })}
                    placeholder="Enter title..."
                    className="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-primary-500 focus:outline-none py-1 text-sm font-bold text-slate-900 dark:text-white transition-colors"
                  />
                  {row.status === 'error' && (
                      <p className="text-[10px] text-red-500">{row.errorMessage}</p>
                  )}
                </td>

                {/* Content */}
                <td className="px-4 py-3 align-top">
                    <textarea 
                        value={row.content}
                        onChange={(e) => onUpdateRow(row.id, { content: e.target.value })}
                        placeholder="Add a note or excerpt..."
                        rows={2}
                        className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-primary-500 rounded-lg p-1.5 text-xs focus:outline-none text-slate-600 dark:text-slate-300 resize-none transition-colors"
                    />
                </td>

                {/* Categories */}
                <td className="px-4 py-3 align-top">
                    <input 
                        type="text" 
                        value={row.categories.join(', ')}
                        onChange={(e) => onUpdateRow(row.id, { categories: e.target.value.split(',').map(s => s.trim()).filter(Boolean) })}
                        placeholder="tech, news..."
                        className="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-primary-500 focus:outline-none py-1 text-xs text-slate-700 dark:text-slate-300 transition-colors"
                    />
                </td>

                {/* Visibility */}
                <td className="px-4 py-3 align-top pt-3">
                    <select 
                        value={row.visibility}
                        onChange={(e) => onUpdateRow(row.id, { visibility: e.target.value as 'public' | 'private' })}
                        className="bg-transparent text-xs font-medium text-slate-600 dark:text-slate-400 focus:outline-none cursor-pointer"
                    >
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                    </select>
                </td>

                {/* Actions */}
                <td className="px-4 py-3 align-top pt-3 text-right">
                    <div className="flex justify-end gap-2">
                        {row.status === 'error' && (
                            <button onClick={() => onRetryRow(row.id)} className="text-slate-400 hover:text-blue-500 transition-colors">
                                <RefreshCw size={16} />
                            </button>
                        )}
                        <button onClick={() => onRemoveRow(row.id)} className="text-slate-400 hover:text-red-500 transition-colors">
                            <Trash2 size={16} />
                        </button>
                    </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};









================================================================================
FILE: src\components\CollectionPopover.tsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { Plus, Check, Folder, Lock, Globe, X } from 'lucide-react';
import { storageService } from '@/services/storageService';
import { Collection } from '@/types';
import { useToast } from '@/hooks/useToast';
import { useAuth } from '@/hooks/useAuth';

interface CollectionPopoverProps {
  isOpen: boolean;
  onClose: () => void;
  articleId: string;
  mode: 'public' | 'private';
  anchorRect?: DOMRect | null;
}

export const CollectionPopover: React.FC<CollectionPopoverProps> = ({ 
  isOpen, 
  onClose, 
  articleId,
  mode,
  anchorRect
}) => {
  const [collections, setCollections] = useState<Collection[]>([]);
  const [newCollectionName, setNewCollectionName] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const modalRef = useRef<HTMLDivElement>(null);
  const toast = useToast();
  const { currentUserId } = useAuth();

  useEffect(() => {
    if (isOpen) {
      loadCollections();
    }
  }, [isOpen, mode]);

  const handleCloseInternal = async () => {
      // Fallback: If in private mode (folders), ensure the nugget is at least in "General Bookmarks"
      // if it's not in any other folder.
      if (mode === 'private' && collections.length > 0) {
          const inAny = collections.some(c => c.entries.some(e => e.articleId === articleId));
          if (!inAny) {
              const general = collections.find(c => c.name === 'General Bookmarks');
              if (general) {
                  try {
                      await storageService.addArticleToCollection(general.id, articleId, currentUserId);
                      toast.success("Saved to General Bookmarks");
                  } catch (e) {
                      console.error("Auto-save failed", e);
                  }
              }
          }
      }
      onClose();
  };

  // Handle clicking outside & scroll
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
        if (modalRef.current && !modalRef.current.contains(e.target as Node)) {
            handleCloseInternal();
        }
    };
    if (isOpen) {
        // slight delay to prevent immediate close if the click that opened it bubbles
        setTimeout(() => {
            window.addEventListener('mousedown', handleClickOutside);
            window.addEventListener('scroll', handleCloseInternal, { capture: true });
            window.addEventListener('resize', handleCloseInternal);
        }, 100);
    }
    return () => {
        window.removeEventListener('mousedown', handleClickOutside);
        window.removeEventListener('scroll', handleCloseInternal, { capture: true });
        window.removeEventListener('resize', handleCloseInternal);
    };
  }, [isOpen, onClose, collections]); 

  const loadCollections = async () => {
    const cols = await storageService.getCollections();
    // Filter by mode and user ownership
    setCollections(cols.filter(c => c.creatorId === currentUserId && c.type === mode));
  };

  const toggleCollection = async (collectionId: string, isInCollection: boolean, colName: string) => {
    // Optimistic update
    setCollections(prev => prev.map(c => {
      if (c.id === collectionId) {
        if (isInCollection) {
          return { ...c, entries: c.entries.filter(e => e.articleId !== articleId) };
        } else {
          return { ...c, entries: [...c.entries, { articleId, addedByUserId: currentUserId, addedAt: new Date().toISOString(), flaggedBy: [] }] };
        }
      }
      return c;
    }));

    try {
      if (isInCollection) {
        await storageService.removeArticleFromCollection(collectionId, articleId, currentUserId);
        toast.info(`Removed from "${colName}"`);
      } else {
        await storageService.addArticleToCollection(collectionId, articleId, currentUserId);
        toast.success(`Added to "${colName}"`);
      }
    } catch (e) {
      toast.error("Failed to update");
      loadCollections(); // Revert on error
    }
  };

  const createCollection = async () => {
    if (!newCollectionName.trim()) return;
    try {
      const newCol = await storageService.createCollection(newCollectionName, '', currentUserId, mode);
      await storageService.addArticleToCollection(newCol.id, articleId, currentUserId);
      toast.success(`Created "${newCollectionName}"`);
      setNewCollectionName('');
      setIsCreating(false);
      loadCollections();
    } catch (e) {
      toast.error("Failed to create");
    }
  };

  if (!isOpen || !anchorRect) return null;

  // Positioning logic
  const width = 240;
  const margin = 12; 
  
  let left = anchorRect.left + window.scrollX - (width / 2) + (anchorRect.width / 2);
  if (left < 10) left = 10;
  if (left + width > window.innerWidth - 10) left = window.innerWidth - width - 10;

  const spaceBelow = window.innerHeight - anchorRect.bottom;
  const spaceAbove = anchorRect.top;
  const estimatedHeight = 280; 

  let style: React.CSSProperties = { left };
  
  if (spaceBelow < estimatedHeight && spaceAbove > spaceBelow) {
      style.top = anchorRect.top + window.scrollY - margin;
      style.transform = 'translateY(-100%)'; 
      style.transformOrigin = 'bottom center';
  } else {
      style.top = anchorRect.bottom + window.scrollY + margin;
      style.transformOrigin = 'top center';
  }

  // Dynamic naming based on mode
  const headerText = mode === 'private' ? 'Save to Folder' : 'Add to Collection';
  const entityName = mode === 'private' ? 'folder' : 'collection';

  return createPortal(
    <div 
      ref={modalRef}
      className={`absolute z-[60] bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden animate-in zoom-in-95 fade-in duration-200 w-[240px]`}
      style={style}
      onClick={(e) => e.stopPropagation()}
    >
        {/* Minimal Header */}
        <div className="px-3 py-2 bg-slate-50/50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700/50 flex items-center justify-between shrink-0">
            <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1.5">
                {mode === 'private' ? <Lock size={10} /> : <Globe size={10} />}
                {headerText}
            </span>
            <button 
                onClick={(e) => { e.stopPropagation(); handleCloseInternal(); }}
                className="p-1 -mr-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                aria-label="Close"
            >
                <X size={14} />
            </button>
        </div>

        {/* List */}
        <div className="max-h-48 overflow-y-auto custom-scrollbar p-1">
            {collections.length === 0 ? (
                <div className="text-center py-4 px-2">
                    <p className="text-xs text-slate-400">No {entityName}s yet.</p>
                </div>
            ) : (
                collections.map(col => {
                    const isInCollection = col.entries.some(e => e.articleId === articleId);
                    return (
                        <button
                            key={col.id}
                            onClick={() => toggleCollection(col.id, isInCollection, col.name)}
                            className={`w-full flex items-center gap-2.5 px-2 py-1.5 rounded-lg text-left transition-colors group ${isInCollection ? 'bg-primary-50 dark:bg-primary-900/10' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        >
                            <div className={`w-5 h-5 rounded flex items-center justify-center shrink-0 transition-colors ${isInCollection ? 'text-primary-600 dark:text-primary-400' : 'text-slate-300 dark:text-slate-600 group-hover:text-slate-400'}`}>
                                {isInCollection ? <Check size={14} strokeWidth={3} /> : <Folder size={14} />}
                            </div>
                            <span className={`text-xs font-medium truncate flex-1 ${isInCollection ? 'text-primary-700 dark:text-primary-400' : 'text-slate-600 dark:text-slate-300'}`}>
                                {col.name}
                            </span>
                        </button>
                    );
                })
            )}
        </div>

        {/* Inline Create */}
        <div className="p-1 border-t border-slate-100 dark:border-slate-800 shrink-0">
            {isCreating ? (
                <div className="flex items-center gap-1 px-1 py-1">
                    <input 
                        autoFocus
                        className="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md px-2 py-1 text-xs focus:outline-none focus:border-primary-500 dark:text-white placeholder-slate-400"
                        placeholder="Name..."
                        value={newCollectionName}
                        onChange={(e) => setNewCollectionName(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && createCollection()}
                    />
                    <button 
                        onClick={createCollection} 
                        className="p-1 bg-primary-500 text-slate-900 rounded-md hover:bg-primary-400 transition-colors"
                    >
                        <Check size={12} />
                    </button>
                </div>
            ) : (
                <button 
                    onClick={() => setIsCreating(true)}
                    className="w-full flex items-center gap-2 px-2 py-1.5 text-xs font-medium text-slate-500 hover:text-slate-900 dark:hover:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors"
                >
                    <Plus size={14} /> 
                    <span>New {entityName}</span>
                </button>
            )}
        </div>
    </div>,
    document.body
  );
};





================================================================================
FILE: src\components\collections\CollectionCard.tsx
================================================================================
import React, { useState } from 'react';
import { Collection } from '@/types';
import { getCollectionTheme } from '@/constants/theme';
import { Folder, Lock, Check, Plus, Layers, Users, ArrowRight } from 'lucide-react';
import { ShareMenu } from '../shared/ShareMenu';

interface CollectionCardProps {
  collection: Collection;
  onClick: () => void;
  // Selection Props
  selectionMode?: boolean;
  isSelected?: boolean;
  onSelect?: (id: string) => void;
}

export const CollectionCard: React.FC<CollectionCardProps> = ({ 
    collection, 
    onClick,
    selectionMode,
    isSelected,
    onSelect
}) => {
  const theme = getCollectionTheme(collection.id);
  const [isFollowing, setIsFollowing] = useState(false);
  
  const isPrivate = collection.type === 'private';

  const handleFollow = (e: React.MouseEvent) => {
      e.stopPropagation();
      setIsFollowing(!isFollowing);
  };

  const handleCardClick = (e: React.MouseEvent) => {
      if (selectionMode && onSelect) {
          e.stopPropagation();
          onSelect(collection.id);
      } else {
          onClick();
      }
  };
  
  return (
    <div 
        onClick={handleCardClick}
        className={`
            group relative bg-white dark:bg-slate-900 border rounded-xl overflow-hidden transition-all duration-300 flex flex-col h-full
            ${selectionMode ? 'cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800' : 'cursor-pointer hover:shadow-lg hover:border-slate-300 dark:hover:border-slate-700 hover:-translate-y-1'}
            ${isSelected ? 'border-primary-500 ring-1 ring-primary-500' : 'border-slate-200 dark:border-slate-800'}
        `}
    >
        {/* Selection Overlay */}
        {selectionMode && (
            <div className="absolute top-4 right-4 z-20">
                <div className={`
                    w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 shadow-sm
                    ${isSelected ? 'bg-primary-500 border-primary-500 text-white' : 'bg-white/80 dark:bg-slate-900/80 border-slate-300 dark:border-slate-600 hover:border-primary-400'}
                `}>
                    {isSelected && <Check size={14} strokeWidth={3} />}
                </div>
            </div>
        )}

        {/* Top Accent Bar - Differentiate Private vs Public */}
        <div className={`h-1.5 w-full ${isPrivate ? 'bg-slate-200 dark:bg-slate-700' : theme.bg}`} />

        <div className="p-5 flex flex-col flex-1">
            <div className="flex justify-between items-start mb-4">
                {/* Icon Logic: Folder/Lock for Private, Colored Folder/Layers for Public */}
                <div className={`p-2.5 rounded-lg ${isPrivate ? 'bg-slate-100 text-slate-500 dark:bg-slate-800' : `${theme.light} ${theme.text} dark:bg-slate-800`}`}>
                    {isPrivate ? <Lock size={20} strokeWidth={2} /> : <Layers size={20} strokeWidth={2} />}
                </div>

                {/* Follow Button - Hide in selection mode & Hide for private folders (can't follow private) */}
                {!selectionMode && !isPrivate && (
                    <button 
                        onClick={handleFollow}
                        className={`
                            flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded-lg transition-all border
                            ${isFollowing 
                                ? 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-900' 
                                : 'bg-white text-slate-500 border-slate-200 hover:border-primary-300 hover:text-primary-700 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700'
                            }
                        `}
                    >
                        {isFollowing ? (
                            <>
                                <Check size={14} strokeWidth={2.5} />
                                Following
                            </>
                        ) : (
                            <>
                                <Plus size={14} strokeWidth={2.5} />
                                Follow
                            </>
                        )}
                    </button>
                )}
                
                {/* Label for Private Folders */}
                {isPrivate && (
                    <span className="text-[10px] font-bold uppercase tracking-wider text-slate-400 bg-slate-50 dark:bg-slate-800 px-2 py-1 rounded">
                        Folder
                    </span>
                )}
            </div>

            <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2 truncate group-hover:text-primary-600 transition-colors">
                {collection.name}
            </h3>
            
            <div className="flex-1 mb-5 relative" title={collection.description}>
                <p className="text-sm text-slate-500 dark:text-slate-400 line-clamp-2 leading-relaxed">
                    {collection.description || 'No description provided.'}
                </p>
            </div>

            <div className={`flex items-center justify-between mt-auto pt-3 border-t border-slate-100 dark:border-slate-800 ${selectionMode ? 'opacity-50' : ''}`}>
                <div className="flex gap-4 text-xs font-medium text-slate-500 dark:text-slate-400">
                    <span className="flex items-center gap-1.5" title="Items"><Folder size={14} className="text-slate-400 dark:text-slate-500" /> {collection.entries.length}</span>
                    {!isPrivate && (
                        <span className="flex items-center gap-1.5" title="Followers"><Users size={14} className="text-slate-400 dark:text-slate-500" /> {collection.followersCount + (isFollowing ? 1 : 0)}</span>
                    )}
                </div>
                
                <div className="flex items-center gap-1">
                    {/* Only show share if public */}
                    {!isPrivate && (
                        <ShareMenu 
                            data={{
                                type: 'collection',
                                id: collection.id,
                                title: collection.name,
                                shareUrl: `${window.location.origin}/#/collections/${collection.id}`
                            }}
                            meta={{
                                text: collection.description
                            }}
                            className="hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
                            iconSize={16}
                        />
                    )}
                    <span className="flex items-center gap-1 text-xs font-bold text-primary-600 dark:text-primary-400 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 ml-1">
                        Open <ArrowRight size={14} />
                    </span>
                </div>
            </div>
        </div>
    </div>
  );
};









================================================================================
FILE: src\components\collections\TableView.tsx
================================================================================
import React from 'react';
import { Collection } from '@/types';
import { formatDate } from '@/utils/formatters';
import { Tooltip } from '../UI/Tooltip';
import { Info, Lock, Folder, ChevronRight } from 'lucide-react';

interface TableViewProps {
  collections: Collection[];
  onClick: (id: string) => void;
}

export const TableView: React.FC<TableViewProps> = ({ collections, onClick }) => {
    return (
        <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden shadow-sm">
            <div className="overflow-x-auto">
                <table className="w-full text-left text-sm">
                    <thead className="bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-800 text-xs uppercase text-slate-500 font-bold tracking-wider">
                        <tr>
                            <th className="px-4 py-3 w-10 text-center">#</th>
                            <th className="px-4 py-3">Collection Name</th>
                            <th className="px-4 py-3 w-32">Created</th>
                            <th className="px-4 py-3 w-32">
                                <div className="flex items-center gap-1">
                                    Last Updated
                                    <Tooltip content="Date when the last nugget was added.">
                                        <Info size={12} className="text-slate-400 cursor-help" />
                                    </Tooltip>
                                </div>
                            </th>
                            <th className="px-4 py-3 text-center w-24">Nuggets</th>
                            <th className="px-4 py-3 text-center w-24">Followers</th>
                            <th className="px-4 py-3 text-right w-16">Action</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                        {collections.map((col, index) => (
                            <tr key={col.id} onClick={() => onClick(col.id)} className="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer">
                                <td className="px-4 py-3 text-center text-slate-400 font-mono text-xs">{index + 1}</td>
                                <td className="px-4 py-3">
                                    <div className="flex items-center gap-3">
                                        <div className={`p-1.5 rounded-md ${col.type === 'private' ? 'bg-slate-100 text-slate-500' : 'bg-primary-50 text-primary-600'} dark:bg-slate-800`}>
                                            {col.type === 'private' ? <Lock size={14} /> : <Folder size={14} />}
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-900 dark:text-white group-hover:text-primary-600 transition-colors text-sm">{col.name}</div>
                                            {col.description && <div className="text-[10px] text-slate-400 line-clamp-1 max-w-[250px]">{col.description}</div>}
                                        </div>
                                    </div>
                                </td>
                                <td className="px-4 py-3 text-slate-500 text-xs">{formatDate(col.createdAt, false)}</td>
                                <td className="px-4 py-3 text-slate-500 text-xs font-medium">{col.updatedAt ? formatDate(col.updatedAt, false) : '-'}</td>
                                <td className="px-4 py-3 text-center text-slate-600 dark:text-slate-300 font-medium text-xs"><span className="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 rounded-full">{col.entries.length}</span></td>
                                <td className="px-4 py-3 text-center text-slate-600 dark:text-slate-300 font-medium text-xs">{col.followersCount}</td>
                                <td className="px-4 py-3 text-right"><div className="flex justify-end text-slate-300 group-hover:text-primary-500 transition-colors"><ChevronRight size={16} /></div></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};









================================================================================
FILE: src\components\CreateNuggetModal.tsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { useNavigate } from 'react-router-dom';
import { X, Check, Loader2, Globe, Lock, Paperclip, FileText, ChevronDown, Layers, Sparkles } from 'lucide-react';
import { Badge } from './UI/Badge';
import { RichTextEditor } from './RichTextEditor';
import { normalizeCategoryLabel, getInitials } from '@/utils/formatters';
import { storageService } from '@/services/storageService';
import { detectProviderFromUrl } from '@/utils/urlUtils';
import { queryClient } from '@/queryClient';
import { GenericLinkPreview } from './embeds/GenericLinkPreview';
import { Collection } from '@/types';
import { Image } from './Image';
import { useAuth } from '@/hooks/useAuth';
import { aiService } from '@/services/aiService';
import { useToast } from '@/hooks/useToast';

interface CreateNuggetModalProps {
  isOpen: boolean;
  onClose: () => void;
}

interface FileAttachment {
  file: File;
  previewUrl: string;
  type: 'image' | 'document';
}

const MAX_FILE_SIZE = 1024 * 1024; // 1MB

export const CreateNuggetModal: React.FC<CreateNuggetModalProps> = ({ isOpen, onClose }) => {
  // Auth
  const { currentUser, currentUserId, isAdmin } = useAuth();
  const authorName = currentUser?.name || 'User';
  const navigate = useNavigate();
  const toast = useToast();

  // Content State
  const [content, setContent] = useState('');
  const [detectedLink, setDetectedLink] = useState<string | null>(null);
  
  // Attachments
  const [attachments, setAttachments] = useState<FileAttachment[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Metadata State
  const [categories, setCategories] = useState<string[]>([]);
  const [visibility, setVisibility] = useState<'public' | 'private'>('public');
  const [selectedCollections, setSelectedCollections] = useState<string[]>([]);
  
  // Identity State (Admin Only)
  const [postAs, setPostAs] = useState<'me' | 'alias'>('me');
  const [selectedAlias, setSelectedAlias] = useState('');
  const [customAlias, setCustomAlias] = useState('');
  const [availableAliases, setAvailableAliases] = useState<string[]>([]);
  
  // Data Source State
  const [availableCategories, setAvailableCategories] = useState<string[]>([]);
  const [allCollections, setAllCollections] = useState<Collection[]>([]);
  
  // UI State
  const [isCatDropdownOpen, setIsCatDropdownOpen] = useState(false);
  const [categoryInput, setCategoryInput] = useState('');
  
  const [isColDropdownOpen, setIsColDropdownOpen] = useState(false);
  const [collectionInput, setCollectionInput] = useState('');
  
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (isOpen) {
      loadData();
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen]);

  const loadData = async () => {
    try {
      const [cats, cols] = await Promise.all([
        storageService.getCategories(),
        storageService.getCollections()
      ]);
      setAvailableCategories(cats || []);
      setAllCollections(cols || []);
      setAvailableAliases([]); // Content aliases feature not yet implemented
      setSelectedAlias("Custom...");
    } catch (e) {
      console.error("Failed to load metadata", e);
    }
  };

  const resetForm = () => {
    setContent('');
    setDetectedLink(null);
    setAttachments([]);
    setCategories([]);
    setVisibility('public');
    setSelectedCollections([]);
    setCategoryInput('');
    setCollectionInput('');
    setPostAs('me');
    setCustomAlias('');
    setError(null);
    setIsAiLoading(false);
  };

  const handleClose = () => {
    resetForm();
    onClose();
  };

  useEffect(() => {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const matches = content.match(urlRegex);
    if (matches && matches.length > 0) {
       const firstLink = matches[0];
       if (firstLink !== detectedLink) {
           setDetectedLink(firstLink);
       }
    } else {
        if (detectedLink && !content.includes(detectedLink)) {
            setDetectedLink(null);
        }
    }
  }, [content, detectedLink]);

  const addCategory = async (cat: string) => {
    const normalized = normalizeCategoryLabel(cat);
    if (normalized) {
        const cleanCat = normalized.replace(/^#/, '');
        if (!categories.includes(cleanCat)) {
            setCategories([...categories, cleanCat]);
            setCategoryInput('');
            if (!availableCategories.includes(cleanCat)) {
                await storageService.addCategory(cleanCat);
                setAvailableCategories(prev => [...prev, cleanCat].sort());
            }
        }
    }
  };

  const toggleCollection = (colName: string) => {
    if (selectedCollections.includes(colName)) {
      setSelectedCollections(selectedCollections.filter(c => c !== colName));
    } else {
      setSelectedCollections([...selectedCollections, colName]);
    }
    setCollectionInput('');
  };

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
      const files = e.target.files;
      if (!files) return;

      const newAttachments: FileAttachment[] = [];
      
      for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.type.match(/(application\/x-msdownload|application\/x-sh|text\/javascript)/)) {
              setError("Script/Executable files are not allowed.");
              continue;
          }
          if (file.size > MAX_FILE_SIZE) {
              setError(`File "${file.name}" exceeds 1MB limit.`);
              continue;
          }
          const isImage = file.type.startsWith('image/');
          newAttachments.push({
              file,
              previewUrl: URL.createObjectURL(file),
              type: isImage ? 'image' : 'document'
          });
      }
      setAttachments(prev => [...prev, ...newAttachments]);
      setError(null);
      if (fileInputRef.current) fileInputRef.current.value = '';
  };

  const removeAttachment = (index: number) => {
      setAttachments(prev => prev.filter((_, i) => i !== index));
  };

  const convertFileToBase64 = (file: File): Promise<string> => {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result as string);
          reader.onerror = error => reject(error);
      });
  };

  // --- AI HANDLER ---
  const handleAISummarize = async () => {
    if (!content || content.length < 10) {
        toast.error("Please enter some text to summarize first.");
        return;
    }
    
    setIsAiLoading(true);
    try {
        const summary = await aiService.summarizeText(content);
        
        // Safety check if summarization failed silently or returned empty
        if (!summary.title && !summary.excerpt) {
            throw new Error("Empty summary received");
        }

        // Update content with structured format (Title + Summary)
        const formattedContent = `**${summary.title}**\n\n${summary.excerpt}`;
        setContent(formattedContent);
        
        // Add unique categories safely
        const returnedTags = Array.isArray(summary.tags) ? summary.tags : [];
        const newCats = returnedTags.filter(tag => !categories.includes(tag));
        
        if (newCats.length > 0) {
            setCategories(prev => [...prev, ...newCats]);
            // Optimistically add to available if missing
            newCats.forEach(cat => {
                if (!availableCategories.includes(cat)) {
                    setAvailableCategories(prev => [...prev, cat]);
                }
            });
        }
        
        toast.success("Nugget summarized by AI ✨");
    } catch (e) {
        console.error(e);
        toast.error("Failed to generate summary. Try again.");
    } finally {
        setIsAiLoading(false);
    }
  };

  const handleSubmit = async () => {
    if (!content.trim() && attachments.length === 0) return;
    setIsSubmitting(true);
    try {
        const derivedTitle = content.split('\n')[0].replace(/\*\*/g, '').substring(0, 80).trim() || 'Untitled Nugget';
        const wordCount = content.trim().split(/\s+/).length;
        const readTime = Math.max(1, Math.ceil(wordCount / 200));

        const uploadedImages: string[] = [];
        const uploadedDocs: any[] = [];

        for (const att of attachments) {
            const base64 = await convertFileToBase64(att.file);
            if (att.type === 'image') {
                uploadedImages.push(base64);
            } else {
                uploadedDocs.push({
                    title: att.file.name,
                    url: base64,
                    type: att.file.name.split('.').pop() || 'file',
                    size: (att.file.size / 1024).toFixed(0) + 'KB'
                });
            }
        }

        const finalAliasName = selectedAlias === 'Custom...' ? customAlias : selectedAlias;

        const newArticle = await storageService.createArticle({
            title: derivedTitle,
            content: content,
            excerpt: content.substring(0, 150) + (content.length > 150 ? '...' : ''),
            author: { id: currentUserId, name: authorName },
            displayAuthor: (postAs === 'alias' && finalAliasName.trim()) ? { name: finalAliasName.trim() } : undefined,
            categories,
            tags: [], 
            readTime,
            images: uploadedImages,
            documents: uploadedDocs,
            visibility, // Pass visibility state
            media: detectedLink ? {
                type: detectProviderFromUrl(detectedLink),
                url: detectedLink,
                previewMetadata: {
                    url: detectedLink,
                    title: 'New Link', 
                }
            } : null,
            source_type: detectedLink ? 'link' : 'text'
        });

        const allCols = await storageService.getCollections();
        for (const colName of selectedCollections) {
            let targetCol = allCols.find(c => c.name === colName);
            if (!targetCol) {
                targetCol = await storageService.createCollection(colName, '', currentUserId, visibility);
            }
            await storageService.addArticleToCollection(targetCol.id, newArticle.id, currentUserId);
        }

        await queryClient.invalidateQueries({ queryKey: ['articles'] });
        handleClose();
    } catch (e) {
        console.error("Failed to create nugget", e);
        setError("Failed to post nugget. Please try again.");
    } finally {
        setIsSubmitting(false);
    }
  };

  const visibleCollections = (allCollections || []).filter(c => c.type === visibility);

  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-4">
      <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200" onClick={handleClose} />
      
      <div className="relative w-full h-full sm:h-auto sm:max-h-[85vh] sm:max-w-xl bg-white dark:bg-slate-900 sm:rounded-2xl shadow-2xl flex flex-col animate-in zoom-in-95 fade-in duration-200 border border-slate-200 dark:border-slate-800 overflow-hidden">
        
        {/* Header */}
        <div className="flex items-center justify-between px-5 py-3 border-b border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 z-20 shrink-0">
            <h2 className="text-sm font-bold text-slate-900 dark:text-white">Create Nugget</h2>
            <button onClick={handleClose} className="p-1 text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors">
                <X size={18} />
            </button>
        </div>

        {/* Scrollable Content Body */}
        <div className="flex-1 overflow-y-auto custom-scrollbar bg-white dark:bg-slate-900">
            <div className="p-4 space-y-4"> 
                {/* Identity & Visibility */}
                <div className="flex flex-col sm:flex-row items-start justify-between gap-4">
                    
                    {/* Identity Selector (Admin Only) */}
                    {isAdmin ? (
                        <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-800 p-1 rounded-lg border border-slate-200 dark:border-slate-700">
                            <button 
                                onClick={() => setPostAs('me')}
                                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all ${postAs === 'me' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                Me
                            </button>
                            <button 
                                onClick={() => setPostAs('alias')}
                                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all ${postAs === 'alias' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                Alias
                            </button>
                            
                            {postAs === 'alias' && (
                                <div className="flex items-center gap-2">
                                    <select 
                                        value={selectedAlias} 
                                        onChange={(e) => setSelectedAlias(e.target.value)} 
                                        className="bg-transparent border-b border-slate-300 dark:border-slate-600 px-2 py-0.5 text-xs font-medium focus:outline-none focus:border-primary-500 dark:text-white cursor-pointer"
                                    >
                                        {availableAliases.map(a => <option key={a} value={a}>{a}</option>)}
                                        <option value="Custom...">Custom...</option>
                                    </select>
                                    
                                    {selectedAlias === 'Custom...' && (
                                        <input 
                                            autoFocus
                                            className="w-24 bg-transparent border-b border-slate-300 dark:border-slate-600 px-2 py-0.5 text-xs font-medium focus:outline-none focus:border-primary-500 dark:text-white"
                                            placeholder="Name"
                                            value={customAlias}
                                            onChange={(e) => setCustomAlias(e.target.value)}
                                        />
                                    )}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="flex items-center gap-2 mt-1">
                            <div className="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-bold text-slate-600 dark:text-slate-300 text-[10px] border border-slate-200 dark:border-slate-700">
                                {getInitials(authorName)}
                            </div>
                            <span className="text-xs font-bold text-slate-700 dark:text-slate-300">{authorName}</span>
                        </div>
                    )}

                    <div className="flex flex-col items-end gap-1">
                        <div className="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-0.5">
                             <button 
                                onClick={() => { setVisibility('public'); setSelectedCollections([]); }}
                                className={`px-3 py-1.5 text-[10px] font-bold rounded-md flex items-center gap-1.5 transition-all ${visibility === 'public' ? 'bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500'}`}
                             >
                                <Globe size={12} /> Public
                             </button>
                             <button 
                                onClick={() => { setVisibility('private'); setSelectedCollections([]); }}
                                className={`px-3 py-1.5 text-[10px] font-bold rounded-md flex items-center gap-1.5 transition-all ${visibility === 'private' ? 'bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500'}`}
                             >
                                <Lock size={12} /> Private
                             </button>
                        </div>
                    </div>
                </div>

                {/* Organization Rows */}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                    {/* Categories Input */}
                    <div className="relative group">
                        <div 
                            className="w-full flex items-center gap-2 border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 rounded-xl px-3 py-2.5 cursor-pointer hover:border-slate-300 dark:hover:border-slate-600 transition-colors shadow-sm min-h-[42px]"
                            onClick={() => setIsCatDropdownOpen(true)}
                        >
                            <div className="text-slate-400 font-bold text-xs">#</div>
                            
                            <div className="flex-1 flex flex-nowrap gap-1.5 items-center overflow-x-auto custom-scrollbar no-scrollbar-visual">
                                {categories.length > 0 ? (
                                    categories.map(cat => (
                                        <Badge key={cat} label={cat} variant="primary" onRemove={() => setCategories(c => c.filter(x => x !== cat))} />
                                    ))
                                ) : (
                                    <span className="text-xs text-slate-400 whitespace-nowrap">Add category filters...</span>
                                )}
                            </div>
                            
                            <ChevronDown size={14} className="text-slate-400 shrink-0 ml-1" />
                        </div>
                        
                        {isCatDropdownOpen && (
                            <div className="absolute left-0 top-full mt-1 w-full bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 p-2 z-30">
                                <div className="fixed inset-0 -z-10" onClick={(e) => { e.stopPropagation(); setIsCatDropdownOpen(false); }} />
                                <input 
                                    autoFocus
                                    className="w-full text-xs border-b border-slate-100 dark:border-slate-700 pb-2 mb-2 focus:outline-none bg-transparent px-2 text-slate-900 dark:text-white placeholder-slate-400 font-medium"
                                    placeholder="Search or create category..."
                                    value={categoryInput}
                                    onChange={(e) => setCategoryInput(e.target.value)}
                                    onKeyDown={(e) => { if (e.key === 'Enter') addCategory(categoryInput); }}
                                    onClick={(e) => e.stopPropagation()}
                                />
                                <div className="max-h-32 overflow-y-auto custom-scrollbar flex flex-col gap-1">
                                    {(availableCategories || []).filter(c => !categories.includes(c) && c.toLowerCase().includes(categoryInput.toLowerCase())).map(cat => (
                                        <button key={cat} onClick={(e) => { e.stopPropagation(); addCategory(cat); }} className="text-left text-[11px] px-2 py-1.5 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg text-slate-700 dark:text-slate-200 transition-colors font-medium">
                                            #{cat}
                                        </button>
                                    ))}
                                    {categoryInput && !availableCategories.some(c => c.toLowerCase() === normalizeCategoryLabel(categoryInput).toLowerCase().replace('#', '')) && (
                                        <button onClick={(e) => { e.stopPropagation(); addCategory(categoryInput); }} className="text-left text-[11px] px-2 py-1.5 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg text-primary-600 font-bold transition-colors">
                                            Create "{normalizeCategoryLabel(categoryInput)}"
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Collections Input */}
                    <div className="relative group">
                         <div 
                            className="w-full flex items-center gap-2 border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 rounded-xl px-3 py-2.5 cursor-pointer hover:border-slate-300 dark:hover:border-slate-600 transition-colors shadow-sm min-h-[42px]"
                            onClick={() => setIsColDropdownOpen(true)}
                         >
                             <div className="text-slate-400 shrink-0">
                                 {visibility === 'public' ? <Globe size={14} /> : <Lock size={14} />}
                             </div>
                             
                             <div className="flex-1 flex flex-nowrap gap-1.5 items-center overflow-x-auto custom-scrollbar no-scrollbar-visual">
                                {selectedCollections.length > 0 ? selectedCollections.map(col => (
                                    <Badge key={col} label={col} variant="primary" icon={<Check size={10} />} onRemove={() => toggleCollection(col)} />
                                )) : (
                                    <span className="text-xs text-slate-400 whitespace-nowrap">Add to {visibility === 'public' ? 'Collection' : 'Bookmarks'}...</span>
                                )}
                             </div>
                             
                             <ChevronDown size={14} className="text-slate-400 shrink-0 ml-1" />
                         </div>

                         {isColDropdownOpen && (
                            <>
                                <div className="fixed inset-0 z-20" onClick={() => setIsColDropdownOpen(false)} />
                                <div className="absolute top-full mt-1 left-0 w-full bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 p-2 z-30 max-h-48 overflow-y-auto custom-scrollbar">
                                    <input 
                                        autoFocus
                                        className="w-full text-xs border-b border-slate-100 dark:border-slate-700 pb-2 mb-2 focus:outline-none bg-transparent px-2 text-slate-900 dark:text-white placeholder-slate-400 font-medium"
                                        placeholder={`Find ${visibility} collection...`}
                                        value={collectionInput}
                                        onChange={(e) => setCollectionInput(e.target.value)}
                                    />
                                    {visibleCollections.filter(c => c.name.toLowerCase().includes(collectionInput.toLowerCase())).map(col => (
                                        <button 
                                            key={col.id} 
                                            onClick={() => toggleCollection(col.name)} 
                                            className={`w-full text-left text-[11px] px-2 py-1.5 rounded-lg flex items-center justify-between mb-0.5 transition-colors font-medium ${selectedCollections.includes(col.name) ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200'}`}
                                        >
                                            {col.name}
                                            {selectedCollections.includes(col.name) && <Check size={12} />}
                                        </button>
                                    ))}
                                    {collectionInput && !visibleCollections.some(c => c.name.toLowerCase() === collectionInput.toLowerCase()) && (
                                        <button onClick={() => toggleCollection(collectionInput)} className="w-full text-left text-[11px] px-2 py-1.5 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-lg text-primary-600 font-bold transition-colors">
                                            Create "{collectionInput}"
                                        </button>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>

                {/* Editor Area with AI Trigger */}
                <div className="relative group/editor">
                    {/* AI Button - Positioned absolutely within editor context or relative above */}
                    <div className="flex justify-end mb-2">
                        <button 
                            onClick={handleAISummarize}
                            disabled={isAiLoading || !content}
                            className={`
                                flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold transition-all
                                ${isAiLoading 
                                    ? 'bg-slate-100 text-slate-400 dark:bg-slate-800' 
                                    : 'bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white shadow-md hover:shadow-lg hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100'
                                }
                            `}
                        >
                            {isAiLoading ? <Loader2 size={12} className="animate-spin" /> : <Sparkles size={12} fill="currentColor" />}
                            {isAiLoading ? 'Analyzing...' : 'AI Summarize'}
                        </button>
                    </div>

                    <RichTextEditor 
                        value={content}
                        onChange={setContent}
                        placeholder="Share an insight, observation, or paste a long article to summarize..."
                        className={`min-h-[120px] transition-opacity duration-300 ${isAiLoading ? 'opacity-50 pointer-events-none' : ''}`}
                    />
                </div>

                {/* Attachments Preview */}
                {attachments.length > 0 && (
                    <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                        {attachments.map((att, idx) => (
                            <div key={idx} className="relative group shrink-0 w-20 h-20 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden bg-slate-50 dark:bg-slate-800">
                                {att.type === 'image' ? (
                                    <Image src={att.previewUrl} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="w-full h-full flex flex-col items-center justify-center text-slate-400 p-1">
                                        <FileText size={20} />
                                        <span className="text-[8px] truncate w-full text-center mt-1">{att.file.name}</span>
                                    </div>
                                )}
                                <button 
                                    onClick={() => removeAttachment(idx)}
                                    className="absolute top-0.5 right-0.5 bg-black/50 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70"
                                >
                                    <X size={10} />
                                </button>
                            </div>
                        ))}
                    </div>
                )}

                {/* Link Preview */}
                {detectedLink && (
                    <div className="relative group rounded-lg overflow-hidden border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 shadow-sm">
                        <button 
                            onClick={() => setDetectedLink(null)} 
                            className="absolute top-2 right-2 bg-slate-900/80 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10 hover:bg-slate-900"
                        >
                            <X size={12} />
                        </button>
                        <div className="max-h-[160px] overflow-hidden">
                            <GenericLinkPreview url={detectedLink} metadata={{ url: detectedLink, title: 'Loading preview...', description: detectedLink }} type={detectProviderFromUrl(detectedLink)} />
                        </div>
                    </div>
                )}

                {error && (
                    <div className="text-xs text-red-500 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg font-medium">
                        {error}
                    </div>
                )}
            </div>
        </div>

        {/* Footer Toolbar */}
        <div className="px-5 py-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between bg-white dark:bg-slate-900 z-20 shrink-0">
            <div className="flex items-center gap-3">
                <input 
                    type="file" 
                    ref={fileInputRef}
                    className="hidden" 
                    multiple 
                    accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain"
                    onChange={handleFileUpload}
                />
                <button 
                    onClick={() => fileInputRef.current?.click()}
                    className="flex items-center gap-2 px-3 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg transition-colors text-xs font-bold border border-slate-200 dark:border-slate-700"
                    title="Attach files"
                >
                    <Paperclip size={16} />
                    Attach
                </button>
                <span className="text-[10px] text-slate-400 hidden sm:inline-block font-medium">
                    Max 1MB
                </span>
            </div>

            <div className="flex items-center gap-3">
                <button 
                    onClick={() => { onClose(); navigate('/bulk-create'); }}
                    className="text-slate-500 hover:text-slate-900 dark:hover:text-white text-xs font-bold flex items-center gap-1.5 mr-2"
                    title="Bulk Import"
                >
                    <Layers size={14} />
                    <span>Bulk Create</span>
                </button>

                <button 
                    onClick={handleSubmit}
                    disabled={isSubmitting || (!content.trim() && attachments.length === 0)}
                    className={`px-6 py-2 rounded-lg text-xs font-bold text-slate-900 transition-all shadow-sm flex items-center gap-2 ${isSubmitting || (!content.trim() && attachments.length === 0) ? 'bg-slate-200 dark:bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-primary-500 hover:bg-primary-400 active:scale-95 text-slate-900'}`}
                >
                    {isSubmitting ? <Loader2 size={14} className="animate-spin" /> : <Check size={14} strokeWidth={3} />}
                    Post Nugget
                </button>
            </div>
        </div>

      </div>
    </div>,
    document.body
  );
};









================================================================================
FILE: src\components\embeds\EmbeddedMedia.tsx
================================================================================
import React from 'react';
import { NuggetMedia } from '@/types';
import { detectProviderFromUrl } from '@/utils/urlUtils';
import { GenericLinkPreview } from './GenericLinkPreview';
import { YouTubeEmbed } from './YouTubeEmbed';
import { Image } from '../Image';

interface EmbeddedMediaProps {
  media: NuggetMedia;
  onClick?: (e: React.MouseEvent) => void;
}

export const EmbeddedMedia: React.FC<EmbeddedMediaProps> = ({ media, onClick }) => {
  const { url, type, previewMetadata } = media;

  const containerClass = "w-full h-full relative overflow-hidden bg-slate-100 dark:bg-slate-900 rounded-xl";

  // 1. Direct Image
  if (type === 'image') {
      return (
        <div className={containerClass} onClick={onClick}>
            <Image 
                src={url} 
                alt={previewMetadata?.title || 'Image'} 
                className="w-full h-full object-cover transition-transform duration-500 hover:scale-105 cursor-pointer"
            />
        </div>
      );
  }

  // 2. Detect Provider dynamically for robust handling
  const detectedType = detectProviderFromUrl(url);

  switch (detectedType) {
      case 'youtube':
          return (
            <div className={containerClass}>
                <YouTubeEmbed 
                    url={url} 
                    title={previewMetadata?.title} 
                    thumbnailUrl={previewMetadata?.imageUrl || media.thumbnail_url} 
                />
            </div>
          );
      
      case 'twitter':
          return (
             <GenericLinkPreview url={url} metadata={previewMetadata} type="twitter" />
          );

      case 'linkedin':
          return (
             <GenericLinkPreview url={url} metadata={previewMetadata} type="linkedin" />
          );

      default:
          return (
            <div className={containerClass}>
                <GenericLinkPreview url={url} metadata={previewMetadata} type={type} />
            </div>
          );
  }
};





================================================================================
FILE: src\components\embeds\GenericLinkPreview.tsx
================================================================================
/* FORCE_REFRESH_V5_GENERIC_PREVIEW */
import React from 'react';
import { PreviewMetadata } from '@/types';
import { ExternalLink, Globe, Twitter, Linkedin, Youtube, Play } from 'lucide-react';
import { Image } from '../Image';

// --- Configuration ---

type LayoutStyle = 'vertical' | 'horizontal';

interface ProviderConfig {
  label: string;
  icon: React.ReactNode;
  brandColor: string; // Text color
  bgColor?: string; // Optional background accent
  layout: LayoutStyle;
}

const getProviderConfig = (providerName: string = '', type: string = ''): ProviderConfig => {
  const key = (providerName || type || '').toLowerCase();

  if (key.includes('twitter') || key.includes('x.com')) {
    return {
      label: 'View on X',
      icon: <Twitter size={12} fill="currentColor" />,
      brandColor: 'text-slate-900 dark:text-white',
      layout: 'vertical'
    };
  }
  if (key.includes('linkedin')) {
    return {
      label: 'View on LinkedIn',
      icon: <Linkedin size={12} fill="currentColor" />,
      brandColor: 'text-[#0077b5]',
      layout: 'vertical'
    };
  }
  if (key.includes('youtube')) {
    return {
      label: 'Watch on YouTube',
      icon: <Youtube size={12} fill="currentColor" />,
      brandColor: 'text-[#FF0000]',
      layout: 'vertical'
    };
  }
  
  // Default Generic / Article
  return {
    label: 'Open Link',
    icon: <Globe size={12} />,
    brandColor: 'text-slate-500',
    layout: 'horizontal'
  };
};

// --- Helper Functions ---

function extractHostname(url: string): string {
  try {
    const u = new URL(url);
    return u.hostname.replace(/^www\./, "");
  } catch {
    return url;
  }
}

function formatDate(dateString?: string): string {
  if (!dateString) return "";
  try {
    const d = new Date(dateString);
    if (Number.isNaN(d.getTime())) return "";
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch {
    return "";
  }
}

// --- Component ---

interface GenericLinkPreviewProps {
  url: string;
  metadata?: PreviewMetadata;
  type?: string;
}

export const GenericLinkPreview: React.FC<GenericLinkPreviewProps> = ({ 
  url, 
  metadata, 
  type 
}) => {
  // 1. Prepare Data
  const href = metadata?.finalUrl || metadata?.url || url;
  const hostname = extractHostname(href);
  const siteLabel = metadata?.siteName || metadata?.providerName || hostname;
  
  // Title Fallback logic
  let title = (metadata?.title || "").trim();
  if (!title) title = hostname;

  const description = metadata?.description?.trim();
  const imageUrl = metadata?.imageUrl;
  const faviconUrl = metadata?.faviconUrl;
  const author = metadata?.authorName;
  const date = formatDate(metadata?.publishDate);

  // 2. Determine Configuration
  const config = getProviderConfig(metadata?.providerName, type);
  
  // Force horizontal if no image (text only card), unless it's social (social text is main content)
  let layout = config.layout;
  if (!imageUrl && layout === 'vertical' && !config.label.includes('View on X')) {
      layout = 'horizontal';
  }

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    window.open(href, '_blank', 'noopener,noreferrer');
  };

  // --- Render: Vertical Layout (Rich Card) ---
  // Large visual impact. Best for Social & Video.
  if (layout === 'vertical') {
    return (
      <div 
        onClick={handleClick}
        className="group relative w-full flex flex-col bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700/60 rounded-xl overflow-hidden cursor-pointer hover:border-slate-300 dark:hover:border-slate-600 transition-all shadow-sm hover:shadow-md mt-2"
      >
        {/* Hero Image */}
        {imageUrl && (
          <div className="relative w-full aspect-[1.91/1] bg-slate-100 dark:bg-slate-950 border-b border-slate-100 dark:border-slate-800 overflow-hidden">
             <Image 
                src={imageUrl} 
                alt={title} 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
             />
             {config.label.includes('YouTube') && (
               <div className="absolute inset-0 flex items-center justify-center bg-black/10 group-hover:bg-black/20 transition-colors">
                  <div className="w-12 h-12 bg-white/90 rounded-full flex items-center justify-center shadow-lg text-red-600">
                    <Play size={20} fill="currentColor" className="ml-1" />
                  </div>
               </div>
             )}
          </div>
        )}

        {/* Content Box */}
        <div className="p-3.5 flex flex-col gap-2">
           {/* Header: Icon + Site */}
           <div className="flex items-center justify-between text-[11px] font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">
              <div className="flex items-center gap-1.5">
                 {faviconUrl ? (
                   <img src={faviconUrl} className="w-4 h-4 rounded-sm" alt="" onError={(e) => e.currentTarget.style.display='none'} />
                 ) : (
                   <span className={config.brandColor}>{config.icon}</span>
                 )}
                 <span className="truncate max-w-[200px]">{siteLabel}</span>
              </div>
              <ExternalLink size={12} className="opacity-0 group-hover:opacity-100 transition-opacity text-slate-400" />
           </div>

           {/* Title */}
           <h3 className="text-[15px] font-bold text-slate-900 dark:text-slate-100 leading-snug line-clamp-2">
             {title}
           </h3>

           {/* Description (Optional) */}
           {description && (
             <p className="text-xs text-slate-600 dark:text-slate-400 line-clamp-2 leading-relaxed">
               {description}
             </p>
           )}
           
           {/* Author/Date Footer (Optional) */}
           {(author || date) && (
             <div className="pt-1 flex items-center gap-2 text-[10px] font-medium text-slate-400">
                {author && <span>{author}</span>}
                {author && date && <span>•</span>}
                {date && <span>{date}</span>}
             </div>
           )}
        </div>
      </div>
    );
  }

  // --- Render: Horizontal Layout (Article/News) ---
  // Dense information. Best for articles/blogs.
  return (
    <div
      onClick={handleClick}
      className="group w-full flex flex-col sm:flex-row bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700/60 rounded-xl overflow-hidden cursor-pointer hover:border-slate-300 dark:hover:border-slate-600 transition-all shadow-sm hover:shadow-md h-full mt-2"
    >
      {/* Text Side */}
      <div className="flex-1 p-3.5 flex flex-col justify-between min-w-0">
         <div>
            {/* Header */}
            <div className="flex items-center gap-2 mb-1.5 text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                {faviconUrl ? (
                   <img src={faviconUrl} className="w-3.5 h-3.5 rounded-sm" alt="" onError={(e) => e.currentTarget.style.display='none'} />
                 ) : (
                   <span className={config.brandColor}>{config.icon}</span>
                 )}
                <span className="truncate">{siteLabel}</span>
            </div>

            {/* Title */}
            <h3 className="text-sm font-bold text-slate-900 dark:text-slate-100 leading-snug line-clamp-2 mb-1.5 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
              {title}
            </h3>

            {/* Description */}
            {description && (
              <p className="text-xs text-slate-600 dark:text-slate-400 line-clamp-2 leading-relaxed">
                {description}
              </p>
            )}
         </div>

         {/* Footer */}
         {(author || date) && (
           <div className="mt-2 pt-2 border-t border-slate-100 dark:border-slate-800 flex items-center gap-2 text-[10px] font-medium text-slate-400">
              {author && <span className="truncate max-w-[100px]">{author}</span>}
              {author && date && <span>•</span>}
              {date && <span>{date}</span>}
           </div>
         )}
      </div>

      {/* Image Side (Desktop: Right, Mobile: Bottom/Hidden depending on pref, here we stack or show side) */}
      {imageUrl && (
        <div className="relative sm:w-32 md:w-36 h-36 sm:h-auto shrink-0 bg-slate-100 dark:bg-slate-800 border-t sm:border-t-0 sm:border-l border-slate-100 dark:border-slate-800">
           <Image 
              src={imageUrl} 
              alt={title} 
              className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
           />
        </div>
      )}
    </div>
  );
};








================================================================================
FILE: src\components\embeds\YouTubeEmbed.tsx
================================================================================
import React from 'react';
import { getYoutubeId } from '@/utils/urlUtils';
import { Play } from 'lucide-react';

interface YouTubeEmbedProps {
  url: string;
  title?: string;
  thumbnailUrl?: string;
}

export const YouTubeEmbed: React.FC<YouTubeEmbedProps> = ({ url, title, thumbnailUrl }) => {
  const videoId = getYoutubeId(url);

  if (!videoId) {
      return (
        <div className="w-full h-full flex items-center justify-center bg-slate-900 text-slate-400 text-xs">
            Invalid YouTube URL
        </div>
      );
  }

  // Use provided thumbnail or fallback to YouTube high-res default
  const poster = thumbnailUrl || `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;

  const handleClick = (e: React.MouseEvent) => {
    e.stopPropagation(); // Prevent card expansion
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  return (
    <div 
      className="relative w-full h-full bg-slate-900 group cursor-pointer overflow-hidden"
      onClick={handleClick}
    >
      {/* Thumbnail */}
      <img 
        src={poster} 
        alt={title || "Video thumbnail"} 
        className="w-full h-full object-cover opacity-90 transition-opacity duration-300 group-hover:opacity-100"
        loading="lazy"
        onError={(e) => {
          // Fallback to hqdefault if maxres doesn't exist
          const target = e.target as HTMLImageElement;
          if (target.src.includes('maxresdefault')) {
             target.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
          }
        }}
      />

      {/* Play Overlay (WhatsApp Style) */}
      <div className="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/10 transition-colors">
        <div className="w-12 h-12 bg-slate-900/60 backdrop-blur-sm rounded-full flex items-center justify-center text-white border border-white/20 shadow-lg transform transition-transform duration-300 group-hover:scale-110">
           <Play size={20} fill="currentColor" className="ml-0.5" />
        </div>
      </div>

      {/* Metadata Overlay (Bottom) */}
      <div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 via-black/40 to-transparent">
        <div className="flex items-center gap-1.5 text-white/90">
             <img src="https://www.youtube.com/favicon.ico" className="w-4 h-4" alt="YT" />
             <span className="text-xs font-medium truncate">{title || 'Watch on YouTube'}</span>
        </div>
      </div>
    </div>
  );
};





================================================================================
FILE: src\components\Header.tsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { Menu, LayoutGrid, Rows, Filter, ArrowUpDown, Maximize, Sun, Moon, Plus, User as UserIcon, LogOut, Settings, Shield, LogIn, Layers, X, Globe, FileText, Lock, BookOpen, MessageSquare, Send, CheckCircle2 } from 'lucide-react';
import { Link, useLocation } from 'react-router-dom';
import { SortOrder } from '@/types';
import { storageService } from '@/services/storageService';
import { Avatar } from './shared/Avatar';
import { FilterScrollRow } from './header/FilterScrollRow';
import { SearchInput } from './header/SearchInput';
import { NavTab } from './header/NavTab';
import { useAuth } from '@/hooks/useAuth';
import { useRequireAuth } from '@/hooks/useRequireAuth';
import { createPortal } from 'react-dom';

// --- Internal Feedback Form Component ---
const DrawerFeedbackForm: React.FC<{ isAuthenticated: boolean }> = ({ isAuthenticated }) => {
  const [feedback, setFeedback] = useState('');
  const [email, setEmail] = useState('');
  const [isSending, setIsSending] = useState(false);
  const [sent, setSent] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    e.stopPropagation(); // Prevent bubbling causing drawer close
    if (!feedback.trim()) return;
    
    setIsSending(true);
    // Simulate API call
    await new Promise(resolve => setTimeout(resolve, 1000));
    setIsSending(false);
    setSent(true);
    
    setTimeout(() => {
        setSent(false);
        setFeedback('');
        setEmail('');
    }, 3000);
  };

  if (sent) {
      return (
        <div className="mx-3 my-2 p-4 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 text-xs rounded-xl font-bold text-center border border-green-100 dark:border-green-900/30 animate-in fade-in flex items-center justify-center gap-2 h-32">
           <CheckCircle2 size={24} />
           <div>
             Thanks for your thoughts! <br/> We read every message.
           </div>
        </div>
      );
  }

  return (
    <div className="mx-3 my-4 px-4 py-3 bg-primary-50/40 dark:bg-primary-900/10 rounded-xl border border-primary-100/50 dark:border-primary-900/20" onClick={(e) => e.stopPropagation()}>
        <p className="text-[10px] font-bold text-primary-700 dark:text-primary-300 uppercase tracking-wider mb-2 flex items-center gap-1.5">
            <MessageSquare size={12} className="text-primary-500" /> Feedback
        </p>
        <p className="text-xs text-slate-500 dark:text-slate-400 mb-3 leading-relaxed">
            Have an idea? Send suggestions directly to the founder.
        </p>
        <form onSubmit={handleSubmit} className="space-y-2">
            <textarea 
                value={feedback}
                onChange={(e) => setFeedback(e.target.value)}
                placeholder="I wish this app had..."
                className="w-full text-xs p-3 bg-white dark:bg-slate-950 border border-primary-100 dark:border-primary-900/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/50 resize-none h-24 text-slate-700 dark:text-slate-200 placeholder:text-slate-400 cursor-text"
                onKeyDown={(e) => e.stopPropagation()} // Ensure typing doesn't trigger hotkeys
            />
            {!isAuthenticated && (
                <input 
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="Your email (optional)"
                    className="w-full text-xs p-2.5 bg-white dark:bg-slate-950 border border-primary-100 dark:border-primary-900/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/50 text-slate-700 dark:text-slate-200 placeholder:text-slate-400"
                    onKeyDown={(e) => e.stopPropagation()}
                />
            )}
            <button 
                type="submit"
                disabled={!feedback.trim() || isSending}
                className="w-full py-2 bg-primary-100 dark:bg-primary-900/30 text-primary-900 dark:text-primary-100 border border-primary-200 dark:border-primary-800 text-xs font-bold rounded-xl hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-sm"
                onClick={(e) => e.stopPropagation()}
            >
                {isSending ? 'Sending...' : <><Send size={12} /> Send to Founder</>}
            </button>
        </form>
    </div>
  );
};

// --- Extracted Navigation Drawer ---
interface NavigationDrawerProps {
  isOpen: boolean;
  onClose: () => void;
  isAuthenticated: boolean;
  currentUser: any;
  isAdmin: boolean;
  logout: () => void;
  openAuthModal: () => void;
}

const NavigationDrawer: React.FC<NavigationDrawerProps> = ({
  isOpen, onClose, isAuthenticated, isAdmin, logout, openAuthModal
}) => {
  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-[100]">
      <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in" onClick={onClose} />
      <div className="absolute top-0 bottom-0 left-0 w-[280px] bg-white dark:bg-slate-950 shadow-2xl flex flex-col animate-in slide-in-from-left duration-300 border-r border-slate-200 dark:border-slate-800">
        
        <div className="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
           <div className="flex items-center gap-2.5">
              <div className="w-8 h-8 bg-primary-500 rounded-lg flex items-center justify-center text-slate-900 font-bold text-lg shadow-sm">N</div>
              <span className="font-extrabold text-lg text-slate-900 dark:text-white">Nuggets</span>
           </div>
           <button onClick={onClose} className="p-2 -mr-2 text-slate-400 hover:text-slate-900 dark:hover:text-white rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
             <X size={20} />
           </button>
        </div>

        <div className="flex-1 overflow-y-auto py-4 px-3 space-y-1 custom-scrollbar">
           <p className="px-4 pb-2 pt-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Navigation</p>
           <Link to="/" onClick={onClose} className="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold text-sm transition-colors">
              <LayoutGrid size={18} /> Home
           </Link>
           <Link to="/collections" onClick={onClose} className="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold text-sm transition-colors">
              <Layers size={18} /> Collections
           </Link>
           
           {isAuthenticated && (
             <>
               <div className="my-2 h-px bg-slate-100 dark:border-slate-800 mx-4" />
               <p className="px-4 pb-2 pt-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Personal</p>
               <Link to="/myspace" onClick={onClose} className="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold text-sm transition-colors">
                  <UserIcon size={18} /> My Space
               </Link>
               <Link to="/account" onClick={onClose} className="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold text-sm transition-colors">
                  <Settings size={18} /> Settings
               </Link>
             </>
           )}

           {isAdmin && (
             <>
               <div className="my-2 h-px bg-slate-100 dark:border-slate-800 mx-4" />
               <p className="px-4 pb-2 pt-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Admin</p>
               <Link to="/admin" onClick={onClose} className="flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-900 text-white shadow-md font-bold text-sm mb-1">
                  <Shield size={18} /> Admin Panel
               </Link>
               <Link to="/bulk-create" onClick={onClose} className="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 font-bold text-sm transition-colors">
                  <Layers size={18} /> Batch Import
               </Link>
             </>
           )}

           <div className="my-4 h-px bg-slate-100 dark:border-slate-800 mx-4" />
           
           {/* Feedback Widget - Enhanced Styling */}
           <DrawerFeedbackForm isAuthenticated={isAuthenticated} />

           <div className="my-4 h-px bg-slate-100 dark:border-slate-800 mx-4" />
           
           {/* Legal & Info - Now at bottom of scrollable area */}
           <div className="px-4 pb-2">
             <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Legal & Info</p>
             <div className="flex flex-col gap-1">
               <Link to="/about" onClick={onClose} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 rounded-lg transition-colors">
                  <Globe size={16} /> About Us
               </Link>
               <Link to="/terms" onClick={onClose} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 rounded-lg transition-colors">
                  <FileText size={16} /> Terms of Service
               </Link>
               <Link to="/privacy" onClick={onClose} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 rounded-lg transition-colors">
                  <Lock size={16} /> Privacy Policy
               </Link>
               <Link to="/guidelines" onClick={onClose} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 rounded-lg transition-colors">
                  <BookOpen size={16} /> Guidelines
               </Link>
               <Link to="/contact" onClick={onClose} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 rounded-lg transition-colors">
                  <MessageSquare size={16} /> Contact
               </Link>
             </div>
           </div>
        </div>

        <div className="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50">
           {isAuthenticated ? (
             <button onClick={() => { logout(); onClose(); }} className="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-red-600 font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors shadow-sm">
               <LogOut size={18} /> Sign Out
             </button>
           ) : (
             <button onClick={() => { openAuthModal(); onClose(); }} className="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl bg-primary-500 text-slate-900 font-bold text-sm shadow-lg shadow-primary-500/20 hover:scale-[1.02] transition-transform">
               <LogIn size={18} /> Sign In
             </button>
           )}
        </div>
      </div>
    </div>,
    document.body
  );
};

interface HeaderProps {
  isDark: boolean;
  toggleTheme: () => void;
  searchQuery: string;
  setSearchQuery: (q: string) => void;
  sidebarOpen: boolean;
  setSidebarOpen: (o: boolean) => void;
  viewMode: 'grid' | 'feed';
  setViewMode: (mode: 'grid' | 'feed') => void;
  selectedCategories: string[];
  setSelectedCategories: (c: string[]) => void;
  selectedTag: string | null;
  setSelectedTag: (t: string | null) => void;
  sortOrder: SortOrder;
  setSortOrder: (s: SortOrder) => void;
  onCreateNugget: () => void;
  currentUserId?: string;
}

export const Header: React.FC<HeaderProps> = ({ 
  isDark, toggleTheme, searchQuery, setSearchQuery, 
  sidebarOpen, setSidebarOpen, viewMode, setViewMode,
  selectedCategories, setSelectedCategories,
  setSortOrder, onCreateNugget
}) => {
  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [isSortOpen, setIsSortOpen] = useState(false);
  const [isUserMenuOpen, setIsUserMenuOpen] = useState(false);
  const [categories, setCategories] = useState<string[]>([]);
  const [isScrolled, setIsScrolled] = useState(false);
  
  const sortRef = useRef<HTMLDivElement>(null);
  const userMenuRef = useRef<HTMLDivElement>(null);
  const location = useLocation();
  const { currentUser, isAuthenticated, openAuthModal, logout } = useAuth();
  const { withAuth } = useRequireAuth();

  const isAdmin = currentUser?.role === 'admin';

  useEffect(() => {
    storageService.getCategories().then(setCategories);
    const handleScroll = () => setIsScrolled(window.scrollY > 10);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const toggleCategory = (cat: string) => setSelectedCategories(selectedCategories.includes(cat) ? selectedCategories.filter(c => c !== cat) : [...selectedCategories, cat]);
  const clearCategories = () => setSelectedCategories([]);
  
  useEffect(() => {
    if (selectedCategories.length > 0) {
      setIsFilterOpen(true);
    }
  }, [selectedCategories]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Node;
      if (sortRef.current && !sortRef.current.contains(target)) setIsSortOpen(false);
      if (userMenuRef.current && !userMenuRef.current.contains(target)) setIsUserMenuOpen(false);
    };
    if (isSortOpen || isUserMenuOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isSortOpen, isUserMenuOpen]);

  const toggleFullScreen = () => !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen();

  return (
    <>
      <header className={`sticky top-0 z-40 w-full transition-all duration-300 ${isScrolled || isFilterOpen ? 'bg-white/95 dark:bg-slate-950/95 backdrop-blur-xl border-b border-slate-200 dark:border-slate-800 shadow-sm' : 'bg-slate-100/50 dark:bg-slate-950/50 backdrop-blur-none border-b border-transparent'}`}>
        <div className="hidden lg:flex w-full px-4 sm:px-6 lg:px-8 h-[4.5rem] items-center justify-between gap-4 relative">
          
          {/* Logo & Navigation Tabs */}
          <div className="flex items-center gap-2 shrink-0">
            {/* Desktop Menu Button */}
            <button 
                onClick={() => setSidebarOpen(true)} 
                className="p-2 rounded-xl text-slate-500 hover:text-slate-900 dark:hover:text-white hover:bg-white dark:hover:bg-slate-800 transition-all mr-1"
                aria-label="Open Menu"
            >
                <Menu size={22} />
            </button>

            <Link to="/" className="flex items-center gap-2.5 group mr-2">
                <div className="w-9 h-9 bg-primary-500 rounded-xl flex items-center justify-center text-slate-900 font-bold text-xl shadow-sm">N</div>
                <span className="block text-xl font-extrabold text-slate-900 dark:text-slate-100 tracking-tight hidden xl:block">Nuggets</span>
            </Link>

            <nav className="flex items-center gap-1 bg-white/50 dark:bg-slate-900/50 p-1 rounded-2xl border border-slate-200/50 dark:border-slate-800/50 backdrop-blur-sm">
                <NavTab to="/" label="Home" active={location.pathname === '/'} />
                <NavTab to="/collections" label="Collections" active={location.pathname === '/collections'} />
                {isAuthenticated && (
                   <NavTab to="/myspace" label="My Space" active={location.pathname.includes('/profile') || location.pathname === '/myspace'} />
                )}
                {isAdmin && (
                  <>
                    <NavTab to="/bulk-create" label="Batch Import" active={location.pathname === '/bulk-create'} />
                    <NavTab to="/admin" label="Admin" active={location.pathname.startsWith('/admin')} />
                  </>
                )}
            </nav>
          </div>

          {/* Search Bar */}
          <div className="flex-1 max-w-4xl mx-auto justify-center relative px-2">
            <div className={`flex w-full items-center rounded-2xl p-1 transition-all duration-300 ${isScrolled || isFilterOpen ? 'bg-slate-100/80 dark:bg-slate-900/80' : 'bg-white dark:bg-slate-900 shadow-sm border border-slate-200 dark:border-slate-800'}`}>
              <div className="flex-1 min-w-0">
                <SearchInput value={searchQuery} onChange={setSearchQuery} />
              </div>
              <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1" />
              <div className="flex items-center pr-1 gap-1">
                <button 
                    onClick={() => setIsFilterOpen(!isFilterOpen)} 
                    className={`p-2 rounded-xl transition-all duration-200 ${isFilterOpen ? 'bg-primary-500 text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-200 dark:hover:bg-slate-800'}`}
                >
                    <Filter size={18} fill={isFilterOpen ? "currentColor" : "none"} />
                </button>
                <div className="relative" ref={sortRef}>
                  <button onClick={() => setIsSortOpen(!isSortOpen)} className="p-2 rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-200 dark:hover:bg-slate-800"><ArrowUpDown size={18} /></button>
                  {isSortOpen && <div className="absolute top-full right-0 mt-3 w-36 bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-800 overflow-hidden z-50 p-1">
                      <button onClick={() => { setSortOrder('latest'); setIsSortOpen(false); }} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl text-slate-700 dark:text-slate-200">Latest</button>
                      <button onClick={() => { setSortOrder('oldest'); setIsSortOpen(false); }} className="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl text-slate-700 dark:text-slate-200">Oldest</button>
                  </div>}
                </div>
              </div>
            </div>
          </div>

          {/* Actions */}
          <div className="flex items-center gap-3 shrink-0">
            <button 
                onClick={withAuth(onCreateNugget)} 
                className="hidden lg:flex items-center gap-2 bg-primary-500 text-slate-900 px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-primary-600 transition-all shadow-sm active:scale-95 shadow-primary-500/20"
            >
                <Plus size={18} strokeWidth={2.5} />
                <span>Create</span>
            </button>
            
            {/* Unified Tools Group */}
            <div className="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-xl border border-slate-200 dark:border-slate-700">
                <button onClick={() => setViewMode('grid')} className={`p-2 rounded-lg transition-all ${viewMode === 'grid' ? 'bg-white dark:bg-slate-700 shadow-sm text-primary-600' : 'text-slate-400 hover:text-slate-600'}`} title="Grid View">
                    <LayoutGrid size={18} />
                </button>
                <button onClick={() => setViewMode('feed')} className={`p-2 rounded-lg transition-all ${viewMode === 'feed' ? 'bg-white dark:bg-slate-700 shadow-sm text-primary-600' : 'text-slate-400 hover:text-slate-600'}`} title="Feed View">
                    <Rows size={18} />
                </button>
                <div className="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1" />
                <button onClick={toggleFullScreen} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all" title="Toggle Fullscreen">
                    <Maximize size={18} />
                </button>
                <button onClick={toggleTheme} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all" title="Toggle Theme">
                    {isDark ? <Sun size={18} /> : <Moon size={18} />}
                </button>
            </div>

            {/* User Avatar Menu or Login */}
            <div className="relative" ref={userMenuRef}>
                {isAuthenticated ? (
                    <>
                        <button 
                            onClick={() => setIsUserMenuOpen(!isUserMenuOpen)} 
                            className={`p-1 rounded-full border-2 transition-colors ${isUserMenuOpen ? 'border-primary-500' : 'border-slate-200 dark:border-slate-700 hover:border-primary-500'}`}
                        >
                            <Avatar name={currentUser?.name || 'User'} size="md" />
                        </button>

                        {isUserMenuOpen && (
                            <div className="absolute top-full right-0 mt-3 w-64 bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 overflow-hidden z-50 animate-in slide-in-from-top-2 fade-in duration-200">
                                <div className="px-4 py-3 border-b border-slate-100 dark:border-slate-800">
                                    <p className="text-sm font-bold text-slate-900 dark:text-white truncate">{currentUser?.name}</p>
                                    <p className="text-xs text-slate-500 dark:text-slate-400 truncate">{currentUser?.email}</p>
                                </div>
                                <div className="p-1.5 flex flex-col gap-0.5">
                                    <Link to="/myspace" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                        <UserIcon size={16} /> My Profile
                                    </Link>
                                    <Link to="/account" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                        <Settings size={16} /> Account Settings
                                    </Link>
                                    {isAdmin && (
                                        <>
                                          <Link to="/admin" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                              <Shield size={16} /> Admin Panel
                                          </Link>
                                          <Link to="/bulk-create" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                              <Layers size={16} /> Batch Import
                                          </Link>
                                        </>
                                    )}
                                </div>

                                {/* Divider & Legal Links */}
                                <div className="border-t border-slate-100 dark:border-slate-800 my-1"></div>
                                <div className="p-1.5">
                                    <p className="px-3 py-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Legal & Info</p>
                                    <Link to="/about" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                        <Globe size={14} /> About Us
                                    </Link>
                                    <Link to="/guidelines" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                        <BookOpen size={14} /> Guidelines
                                    </Link>
                                    <Link to="/contact" onClick={() => setIsUserMenuOpen(false)} className="flex items-center gap-3 px-3 py-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                        <MessageSquare size={14} /> Contact
                                    </Link>
                                </div>

                                <div className="p-1.5 border-t border-slate-100 dark:border-slate-800">
                                    <button onClick={() => { logout(); setIsUserMenuOpen(false); }} className="w-full flex items-center gap-3 px-3 py-2 text-sm font-bold text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl transition-colors">
                                        <LogOut size={16} /> Log Out
                                    </button>
                                </div>
                            </div>
                        )}
                    </>
                ) : (
                    <button 
                        onClick={() => openAuthModal('login')}
                        className="flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold text-sm bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:opacity-90 transition-all shadow-sm"
                    >
                        <LogIn size={18} />
                        <span>Sign In</span>
                    </button>
                )}
            </div>
          </div>
        </div>

        {/* Filter Overlay */}
        {isFilterOpen && (
            <div className="hidden lg:block absolute top-full left-0 right-0 z-30 bg-white/95 dark:bg-slate-950/95 backdrop-blur-xl border-b border-slate-200 dark:border-slate-800 animate-in slide-in-from-top-2 duration-300 shadow-lg">
                <div className="py-3">
                    <FilterScrollRow categories={categories} selectedCategories={selectedCategories} onToggle={toggleCategory} onClear={clearCategories} />
                </div>
            </div>
        )}

        {/* Mobile Header (Sticky & always visible on Mobile) */}
        <div className="lg:hidden w-full flex flex-col bg-white/80 dark:bg-slate-950/80 backdrop-blur-xl border-b border-slate-100 dark:border-slate-800">
           <div className="h-14 px-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                  <button onClick={() => setSidebarOpen(true)} className="p-1"><Menu size={24} /></button>
                  <span className="font-bold text-xl">Nuggets</span>
              </div>
              <div className="flex items-center gap-3">
                  <button onClick={withAuth(onCreateNugget)} className="text-primary-600 dark:text-primary-400"><Plus size={24} /></button>
                  <button onClick={toggleTheme}>{isDark ? <Sun size={20} /> : <Moon size={20} />}</button>
                  {isAuthenticated ? (
                     <Link to="/myspace">
                        <Avatar name={currentUser?.name || 'U'} size="sm" />
                     </Link>
                  ) : (
                      <button onClick={() => openAuthModal('login')} className="text-sm font-bold text-primary-600">Login</button>
                  )}
              </div>
           </div>
           <div className="flex p-2 gap-2 overflow-x-auto no-scrollbar-visual">
                <NavTab to="/" label="Home" active={location.pathname === '/'} />
                <NavTab to="/collections" label="Collections" active={location.pathname === '/collections'} />
                {isAuthenticated && <NavTab to="/myspace" label="My Space" active={location.pathname.includes('/profile')} />}
                {isAdmin && (
                  <>
                    <NavTab to="/bulk-create" label="Batch Import" active={location.pathname === '/bulk-create'} />
                    <NavTab to="/admin" label="Admin" active={location.pathname.startsWith('/admin')} />
                  </>
                )}
           </div>
        </div>
      </header>
      
      <NavigationDrawer 
        isOpen={sidebarOpen} 
        onClose={() => setSidebarOpen(false)}
        isAuthenticated={isAuthenticated}
        currentUser={currentUser}
        isAdmin={isAdmin}
        logout={logout}
        openAuthModal={() => openAuthModal('login')}
      />
    </>
  );
};









================================================================================
FILE: src\components\header\FilterScrollRow.tsx
================================================================================
import React, { useRef } from 'react';
import { ChevronLeft, ChevronRight } from 'lucide-react';

interface FilterScrollRowProps {
  categories: string[];
  selectedCategories: string[];
  onToggle: (cat: string) => void;
  onClear: () => void;
}

const CategoryChip: React.FC<{ label: string; isActive: boolean; onClick: () => void }> = ({ label, isActive, onClick }) => (
  <button 
    onClick={onClick} 
    className={`
      px-3 py-1.5 text-xs font-bold rounded-full border shrink-0 transition-all 
      ${isActive 
        ? 'bg-primary-500 border-primary-500 text-slate-900 shadow-sm' 
        : 'bg-slate-100/50 dark:bg-slate-800/50 border-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
      }
    `}
  >
    {label}
  </button>
);

export const FilterScrollRow: React.FC<FilterScrollRowProps> = ({ categories, selectedCategories, onToggle, onClear }) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);

  const scroll = (direction: 'left' | 'right') => {
    if (scrollContainerRef.current) {
      const scrollAmount = 400; 
      scrollContainerRef.current.scrollBy({
        left: direction === 'left' ? -scrollAmount : scrollAmount,
        behavior: 'smooth',
      });
    }
  };

  return (
    <div className="relative group w-full flex items-center max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8">
      <button 
        onClick={() => scroll('left')}
        className="absolute left-4 z-20 p-2 bg-white/90 dark:bg-slate-800/90 shadow-md rounded-full text-slate-500 hover:text-primary-600 border border-slate-200 dark:border-slate-700 hidden md:flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 backdrop-blur-sm"
      >
        <ChevronLeft size={18} />
      </button>

      <div 
        ref={scrollContainerRef}
        className="flex items-center gap-2 overflow-x-auto px-1 py-1 scroll-smooth [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none'] w-full mask-linear-fade"
      >
        <button 
            onClick={onClear} 
            className={`
              px-4 py-1.5 rounded-full text-xs font-bold border shrink-0 transition-all 
              ${selectedCategories.length === 0 
                ? 'bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 border-transparent shadow-sm' 
                : 'bg-slate-100/50 dark:bg-slate-800/50 border-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'
              }
            `}
        >
            All
        </button>
        {categories.map((cat) => (
            <CategoryChip 
                key={cat} 
                label={cat} 
                isActive={selectedCategories.includes(cat)} 
                onClick={() => onToggle(cat)} 
            />
        ))}
      </div>

      <button 
        onClick={() => scroll('right')}
        className="absolute right-4 z-20 p-2 bg-white/90 dark:bg-slate-800/90 shadow-md rounded-full text-slate-500 hover:text-primary-600 border border-slate-200 dark:border-slate-700 hidden md:flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 backdrop-blur-sm"
      >
        <ChevronRight size={18} />
      </button>
    </div>
  );
};








================================================================================
FILE: src\components\header\NavTab.tsx
================================================================================
import React from 'react';
import { Link } from 'react-router-dom';

interface NavTabProps {
  to: string;
  label: string;
  active: boolean;
}

export const NavTab: React.FC<NavTabProps> = ({ to, label, active }) => (
    <Link 
        to={to} 
        className={`px-2.5 py-1.5 text-sm font-bold rounded-xl transition-all duration-200 whitespace-nowrap ${active ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}`}
    >
        {label}
    </Link>
);









================================================================================
FILE: src\components\header\SearchInput.tsx
================================================================================
import React from 'react';
import { Search } from 'lucide-react';

interface SearchInputProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}

export const SearchInput: React.FC<SearchInputProps> = ({ value, onChange, placeholder = "Search..." }) => {
  return (
    <div className="flex items-center px-3 transition-colors cursor-text w-full overflow-hidden">
      <Search size={18} className="text-slate-400 mr-3 shrink-0" />
      <input 
        className="flex-1 bg-transparent py-2.5 text-sm font-medium focus:outline-none text-slate-700 dark:text-slate-200 min-w-[50px] placeholder-slate-400 w-full" 
        value={value} 
        onChange={(e) => onChange(e.target.value)} 
        placeholder={placeholder} 
      />
    </div>
  );
};









================================================================================
FILE: src\components\Image.tsx
================================================================================
import React from 'react';

interface ImageProps extends React.ImgHTMLAttributes<HTMLImageElement> {
  fallbackSrc?: string;
}

export const Image: React.FC<ImageProps> = ({ src, alt, className, fallbackSrc, ...props }) => {
  const [error, setError] = React.useState(false);

  const handleError = (e: React.SyntheticEvent<HTMLImageElement, Event>) => {
    if (fallbackSrc && !error) {
      setError(true);
      e.currentTarget.src = fallbackSrc;
    }
  };

  return (
    <img
      src={src}
      alt={alt || 'Image'}
      className={className}
      loading="lazy"
      decoding="async"
      onError={handleError}
      {...props}
    />
  );
};








================================================================================
FILE: src\components\ImageLightbox.tsx
================================================================================
import React, { useEffect, useState, useCallback } from 'react';
import { createPortal } from 'react-dom';
import { X, ChevronLeft, ChevronRight } from 'lucide-react';

interface ImageLightboxProps {
  isOpen: boolean;
  onClose: () => void;
  images: string[];
  initialIndex?: number;
  sidebarContent?: React.ReactNode;
}

export const ImageLightbox: React.FC<ImageLightboxProps> = ({ 
  isOpen, 
  onClose, 
  images, 
  initialIndex = 0,
  sidebarContent
}) => {
  const [currentIndex, setCurrentIndex] = useState(initialIndex);

  useEffect(() => {
    if (isOpen) {
      setCurrentIndex(initialIndex);
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, initialIndex]);

  const handlePrev = useCallback((e?: React.MouseEvent) => {
    e?.stopPropagation();
    setCurrentIndex(prev => (prev === 0 ? images.length - 1 : prev - 1));
  }, [images.length]);

  const handleNext = useCallback((e?: React.MouseEvent) => {
    e?.stopPropagation();
    setCurrentIndex(prev => (prev === images.length - 1 ? 0 : prev + 1));
  }, [images.length]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isOpen) return;
      if (e.key === 'Escape') onClose();
      if (e.key === 'ArrowLeft') handlePrev();
      if (e.key === 'ArrowRight') handleNext();
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, onClose, handlePrev, handleNext]);

  if (!isOpen) return null;

  return createPortal(
    <div 
      className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-sm flex animate-in fade-in duration-200"
      onClick={onClose}
    >
      {/* Image Area */}
      <div className="flex-1 relative flex items-center justify-center h-full overflow-hidden w-full">
          {/* Close Button (Floating if sidebar is present on desktop, or simply absolute on mobile) */}
          <button 
            onClick={onClose}
            className={`absolute top-4 ${sidebarContent ? 'left-4' : 'right-4'} p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-colors z-50`}
          >
            <X size={24} />
          </button>

          {/* Image Counter */}
          <div className="absolute top-4 left-1/2 -translate-x-1/2 text-white/70 font-medium z-50 bg-black/30 px-3 py-1 rounded-full backdrop-blur-md">
            {currentIndex + 1} / {images.length}
          </div>

          {/* Navigation Buttons */}
          {images.length > 1 && (
            <>
              <button 
                onClick={handlePrev}
                className="absolute left-4 top-1/2 -translate-y-1/2 p-3 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-colors z-50"
              >
                <ChevronLeft size={32} />
              </button>
              <button 
                onClick={handleNext}
                className="absolute right-4 top-1/2 -translate-y-1/2 p-3 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-colors z-50"
              >
                <ChevronRight size={32} />
              </button>
            </>
          )}

          {/* Main Image Container */}
          <div 
            className="w-full h-full flex items-center justify-center p-4 md:p-12"
            onClick={(e) => e.stopPropagation()} // Prevent closing when clicking image area
          >
            <img 
              src={images[currentIndex]} 
              alt={`View ${currentIndex + 1}`} 
              className="max-w-full max-h-full object-contain shadow-2xl animate-in zoom-in-95 duration-200"
            />
          </div>
      </div>

      {/* Sidebar Area (Visible on Large Screens) */}
      {sidebarContent && (
        <div 
          className="hidden lg:block w-[400px] h-full shrink-0 shadow-2xl z-[101] bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800"
          onClick={(e) => e.stopPropagation()} 
        >
           <div className="relative h-full overflow-y-auto custom-scrollbar">
              {/* Close button inside sidebar header area */}
              <div className="absolute top-2 right-2 z-20">
                 <button 
                   onClick={onClose} 
                   className="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
                 >
                   <X size={20} />
                 </button>
              </div>
              {sidebarContent}
           </div>
        </div>
      )}
    </div>,
    document.body
  );
};








================================================================================
FILE: src\components\layouts\MainLayout.tsx
================================================================================

import React from 'react';
import { LegalFooter } from '../LegalFooter';

interface MainLayoutProps {
  children: React.ReactNode;
}

export const MainLayout: React.FC<MainLayoutProps> = ({ children }) => {
  return (
    <div className="min-h-screen bg-slate-100 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-200 font-sans selection:bg-primary-500/30 flex flex-col">
      <div className="flex-1">
        {children}
      </div>
      <LegalFooter />
    </div>
  );
};





================================================================================
FILE: src\components\LegalFooter.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { Link } from 'react-router-dom';
import { ChevronDown, ChevronUp } from 'lucide-react';
import { adminConfigService } from '@/admin/services/adminConfigService';
import { LegalPage } from '@/types/legal';

export const LegalFooter: React.FC = () => {
  const [pages, setPages] = useState<LegalPage[]>([]);
  const [isMobileOpen, setIsMobileOpen] = useState(false);

  useEffect(() => {
    // In a real app, this might be passed via context or layout loader
    // to avoid fetching on every page load if footer re-renders
    const load = async () => {
        const all = await adminConfigService.getLegalPages();
        setPages(all.filter(p => p.isEnabled));
    };
    load();
  }, []);

  if (pages.length === 0) return null;

  return (
    <footer className="w-full bg-white dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 mt-auto">
      <div className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8">
        
        {/* Desktop View */}
        <div className="hidden md:flex h-14 items-center justify-between text-xs font-medium text-slate-500 dark:text-slate-400">
            <div>
                © {new Date().getFullYear()} Nuggets. All rights reserved.
            </div>
            <div className="flex items-center gap-6">
                {pages.map(page => (
                    <Link 
                        key={page.id} 
                        to={`/${page.slug}`} 
                        className="hover:text-slate-900 dark:hover:text-slate-200 transition-colors"
                    >
                        {page.title}
                    </Link>
                ))}
            </div>
        </div>

        {/* Mobile View */}
        <div className="md:hidden py-4 border-t border-transparent">
            <button 
                onClick={() => setIsMobileOpen(!isMobileOpen)}
                className="w-full flex items-center justify-between text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider"
            >
                <span>Legal & Information</span>
                {isMobileOpen ? <ChevronUp size={14} /> : <ChevronDown size={14} />}
            </button>
            
            <div className={`overflow-hidden transition-all duration-300 ease-in-out ${isMobileOpen ? 'max-h-64 opacity-100 mt-3' : 'max-h-0 opacity-0'}`}>
                <div className="flex flex-col gap-3 pl-2 border-l-2 border-slate-100 dark:border-slate-800">
                    {pages.map(page => (
                        <Link 
                            key={page.id} 
                            to={`/${page.slug}`} 
                            className="text-sm text-slate-600 dark:text-slate-300 hover:text-primary-600 transition-colors"
                        >
                            {page.title}
                        </Link>
                    ))}
                </div>
            </div>
            
            <div className="mt-4 text-[10px] text-slate-400 text-center">
                © {new Date().getFullYear()} Nuggets.
            </div>
        </div>

      </div>
    </footer>
  );
};





================================================================================
FILE: src\components\NewsCard.tsx
================================================================================
import React, { useState, forwardRef, useRef, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Article } from '@/types';
import { formatDate } from '@/utils/formatters';
import { Bookmark, FolderPlus, MoreVertical, Flag, Trash2, Edit2, FileText, StickyNote, Lightbulb, Check } from 'lucide-react';
import { ShareMenu } from './shared/ShareMenu';
import { CollectionPopover } from './CollectionPopover';
import { ReportModal } from './ReportModal';
import { useToast } from '@/hooks/useToast';
import { storageService } from '@/services/storageService';
import { ArticleModal } from './ArticleModal';
import { Tooltip } from './UI/Tooltip';
import { NewsCardMedia } from './newscard/NewsCardMedia';
import { ImageLightbox } from './ImageLightbox';
import { useAuth } from '@/hooks/useAuth';
import { queryClient } from '@/queryClient';
import { useRequireAuth } from '@/hooks/useRequireAuth';

interface NewsCardProps {
  article: Article;
  viewMode: 'grid' | 'feed';
  isBookmarked: boolean;
  onToggleBookmark: (id: string) => void;
  onCategoryClick: (category: string) => void;
  onTagClick?: (tag: string) => void;
  onClick: (article: Article) => void;
  expanded?: boolean; 
  onToggleExpand?: () => void;
  currentUserId?: string;
  // Selection Props
  selectionMode?: boolean;
  isSelected?: boolean;
  onSelect?: (id: string) => void;
}

const TagPill: React.FC<{ label: string; onClick?: (e: React.MouseEvent) => void }> = ({ label, onClick }) => {
  const pill = (
    <span 
        onClick={onClick}
        className={`
            inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-medium transition-colors border
            ${onClick ? 'cursor-pointer hover:border-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 hover:shadow-sm' : ''}
            bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700
        `}
    >
        {label}
    </span>
  );
  return onClick ? <Tooltip content="Click to filter">{pill}</Tooltip> : pill;
};

export const NewsCard = forwardRef<HTMLDivElement, NewsCardProps>(({
  article,
  viewMode,
  isBookmarked,
  onToggleBookmark,
  onCategoryClick,
  onClick,
  currentUserId,
  selectionMode,
  isSelected,
  onSelect
}, ref) => {
  const navigate = useNavigate();
  const toast = useToast();
  const { isAdmin } = useAuth();
  const { withAuth } = useRequireAuth();
  
  // -- State --
  const [showCollection, setShowCollection] = useState(false);
  const [showReport, setShowReport] = useState(false);
  const [showMenu, setShowMenu] = useState(false);
  const [showTagPopover, setShowTagPopover] = useState(false);
  const [showFullModal, setShowFullModal] = useState(false);
  const [showLightbox, setShowLightbox] = useState(false);
  
  const [collectionMode, setCollectionMode] = useState<'public' | 'private'>('public');
  const [collectionAnchor, setCollectionAnchor] = useState<DOMRect | null>(null);
  
  const menuRef = useRef<HTMLDivElement>(null);
  const tagPopoverRef = useRef<HTMLDivElement>(null);
  const bookmarkButtonRef = useRef<HTMLButtonElement>(null);

  if (!article) return null;

  const isOwner = currentUserId === article.author.id;

  // -- Content Classification --
  const hasMedia = !!article.media || (article.images && article.images.length > 0) || !!article.video;
  const isLink = article.source_type === 'link';
  const isNoteOrIdea = article.source_type === 'note' || article.source_type === 'idea';
  const isTextNugget = !hasMedia && !isLink; 

  // -- Contributor Logic --
  // Show only if addedBy exists AND the user who added it is NOT the original author
  const showContributor = article.addedBy && article.addedBy.userId !== article.author.id;

  // -- Author Display Logic --
  const authorName = article.displayAuthor?.name || article.author.name;
  const isAliased = !!article.displayAuthor;

  // -- Event Handlers --
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) setShowMenu(false);
      if (tagPopoverRef.current && !tagPopoverRef.current.contains(event.target as Node)) setShowTagPopover(false);
    };
    if (showMenu || showTagPopover) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showMenu, showTagPopover]);

  const handleCardClick = (e: React.MouseEvent) => {
      if (selectionMode && onSelect) {
          e.stopPropagation(); // Stop navigation
          onSelect(article.id);
      } else {
          onClick(article);
      }
  };

  const handleBookmarkClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation(); // CRITICAL: Stop bubbling before any logic
    
    if (selectionMode) return; // Disable in selection mode

    const performBookmark = () => {
        onToggleBookmark(article.id);
        
        if (!isBookmarked) {
            // "Toast-Action" Flow
            toast.success("Saved to General Bookmarks", { 
                actionLabel: "Change", 
                onAction: () => {
                    setCollectionMode('private');
                    // Use ref to get fresh coordinates even if user scrolled
                    if (bookmarkButtonRef.current) {
                        setCollectionAnchor(bookmarkButtonRef.current.getBoundingClientRect());
                    } else {
                        // Fallback to event coordinates if ref missing (unlikely)
                        setCollectionAnchor(e.currentTarget.getBoundingClientRect());
                    }
                    setShowCollection(true);
                },
                duration: 4000
            });
        } else {
            // Undo Flow
            toast.info("Removed from Bookmarks", {
                actionLabel: "Undo",
                onAction: () => onToggleBookmark(article.id), // Toggling again re-adds it
                duration: 3000
            });
            setShowCollection(false);
        }
    };

    withAuth(performBookmark, 'guestBookmarks')();
  };


  const handleMediaClick = (e: React.MouseEvent) => {
      if (selectionMode && onSelect) {
          e.stopPropagation();
          onSelect(article.id);
          return;
      }

      e?.stopPropagation();
      const linkUrl = article.media?.previewMetadata?.url || article.media?.url;
      if (article.source_type === 'link' && linkUrl) {
          window.open(linkUrl, '_blank', 'noopener,noreferrer');
      } else {
          // If image type, open lightbox, else modal
          if (article.media?.type === 'image' || (article.images && article.images.length > 0)) {
             setShowLightbox(true);
          } else {
             setShowFullModal(true);
          }
      }
  };

  const handleDelete = async (e: React.MouseEvent) => {
      e.stopPropagation();
      setShowMenu(false);
      if(window.confirm("Delete this nugget permanently?")) {
          await storageService.deleteArticle(article.id);
          await queryClient.invalidateQueries({ queryKey: ['articles'] });
          toast.success("Nugget deleted");
      }
  };

  const shouldShowTitle = article.title && !isNoteOrIdea; 

  return (
    <>
      <div 
        ref={ref}
        className={`
            group relative flex flex-col bg-white dark:bg-slate-900 
            border rounded-2xl shadow-sm transition-all duration-300 
            ${selectionMode ? 'cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800' : 'cursor-default hover:shadow-lg hover:border-slate-300 dark:hover:border-slate-700'}
            ${isSelected ? 'border-primary-500 ring-1 ring-primary-500' : 'border-slate-200 dark:border-slate-800'}
            ${viewMode === 'feed' ? 'w-full' : 'h-full'} 
            p-4 gap-3
        `}
        onClick={handleCardClick}
      >
        {/* Selection Overlay Indicator */}
        {selectionMode && (
            <div className="absolute top-4 right-4 z-20">
                <div className={`
                    w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 shadow-sm
                    ${isSelected ? 'bg-primary-500 border-primary-500 text-white' : 'bg-white/80 dark:bg-slate-900/80 border-slate-300 dark:border-slate-600 hover:border-primary-400'}
                `}>
                    {isSelected && <Check size={14} strokeWidth={3} />}
                </div>
            </div>
        )}

        {hasMedia && <NewsCardMedia article={article} onClick={handleMediaClick} />}

        <div className="flex flex-col flex-1 min-w-0">
            {isTextNugget && (
                <div className="mb-3 flex items-center justify-between">
                    <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[10px] font-bold tracking-wider">
                        {article.source_type === 'idea' ? <Lightbulb size={10} /> : article.source_type === 'note' ? <StickyNote size={10} /> : <FileText size={10} />}
                        {article.source_type === 'idea' ? 'Thoughts' : article.source_type === 'note' ? 'Note' : 'Text'}
                    </span>
                </div>
            )}

            <div className="flex flex-wrap items-center gap-1.5 mb-2 relative">
              {(article.categories || []).slice(0, 2).map(cat => (
                  <TagPill key={cat} label={cat} onClick={(e) => { e.stopPropagation(); onCategoryClick(cat); }} />
              ))}
              {(article.categories?.length || 0) > 2 && (
                  <div className="relative" ref={tagPopoverRef}>
                      <button onClick={(e) => { e.stopPropagation(); setShowTagPopover(!showTagPopover); }} className="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-bold bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors">
                          +{(article.categories?.length || 0) - 2}
                      </button>
                      {showTagPopover && (
                          <div className="absolute top-full left-0 mt-1 w-40 z-30 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl p-2 animate-in fade-in zoom-in-95 duration-200">
                              <div className="flex flex-col gap-1">
                                  {article.categories.slice(2).map(cat => (
                                      <button key={cat} onClick={(e) => { e.stopPropagation(); onCategoryClick(cat); setShowTagPopover(false); }} className="text-left text-xs px-2 py-1 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 transition-colors">
                                          {cat}
                                      </button>
                                  ))}
                              </div>
                          </div>
                      )}
                  </div>
              )}
            </div>

            {shouldShowTitle && (
                <h3 className="text-sm font-bold text-slate-900 dark:text-slate-100 line-clamp-2 leading-snug mb-1 group-hover:text-primary-600 transition-colors">
                    {article.title}
                </h3>
            )}

            <div className="relative mb-1">
                <p className={`text-xs text-slate-600 dark:text-slate-400 leading-relaxed ${isTextNugget ? 'line-clamp-4 text-[13px]' : 'line-clamp-3'}`}>
                    {article.excerpt || article.content}
                </p>
                <div className="absolute bottom-0 left-0 right-0 h-4 bg-gradient-to-t from-white dark:from-slate-900 to-transparent pointer-events-none" />
            </div>

            <button onClick={(e) => { e.stopPropagation(); setShowFullModal(true); }} className="text-[11px] font-medium text-slate-400 hover:text-primary-600 transition-colors self-start mb-2">
                Read more →
            </button>
        </div>

        <div className={`mt-auto pt-1.5 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between shrink-0 ${selectionMode ? 'opacity-50 pointer-events-none' : ''}`}>
            <div className="flex items-center gap-1.5 text-[10px] font-medium text-slate-400 dark:text-slate-500" onClick={(e) => {e.stopPropagation(); if (!isAliased) navigate(`/profile/${article.author.id}`)}}>
                <span className={`text-slate-700 dark:text-slate-300 ${!isAliased ? 'hover:underline cursor-pointer' : ''}`}>{authorName}</span>
                <span>·</span>
                <span>{formatDate(article.publishedAt, false)}</span>
            </div>

            <div className="flex items-center gap-1">
                <ShareMenu 
                    data={{
                        type: 'nugget',
                        id: article.id,
                        title: article.title,
                        shareUrl: `${window.location.origin}/#/article/${article.id}`
                    }}
                    meta={{
                        author: authorName,
                        text: article.excerpt
                    }}
                />
                
                {/* Collection Button */}
                <button 
                    onClick={withAuth((e: React.MouseEvent) => { // Auth check here
                        e.stopPropagation(); 
                        setCollectionAnchor(e.currentTarget.getBoundingClientRect()); 
                        setCollectionMode('public'); 
                        setShowCollection(true); 
                    })} 
                    className="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition-colors" 
                    title="Add to Collection"
                    type="button"
                >
                    <FolderPlus size={14} />
                </button>
                
                {/* Bookmark Button */}
                <button 
                    ref={bookmarkButtonRef}
                    onClick={withAuth(handleBookmarkClick, 'guestBookmarks')} // CHECK 'guestBookmarks' FLAG
                    className={`w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors ${isBookmarked ? 'text-primary-600' : 'text-slate-400'}`} 
                    title="Bookmark"
                    type="button"
                >
                    <Bookmark size={14} fill={isBookmarked ? "currentColor" : "none"} />
                </button>
                
                <div className="relative" ref={menuRef}>
                    <button onClick={(e) => { e.stopPropagation(); setShowMenu(!showMenu); }} className="w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition-colors">
                        <MoreVertical size={14} />
                    </button>
                    {showMenu && (
                        <div className="absolute right-0 bottom-full mb-1 w-32 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 py-1 z-20 overflow-hidden">
                            {(isOwner || isAdmin) && (
                                <button onClick={(e) => {e.stopPropagation(); toast.info("Edit coming soon"); setShowMenu(false);}} className="w-full text-left px-3 py-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 flex items-center gap-2"><Edit2 size={12} /> Edit</button>
                            )}
                            
                            {/* Report Button */}
                            <button 
                                onClick={withAuth((e: React.MouseEvent) => { // CHECK 'guestReports' FLAG
                                    e.stopPropagation(); 
                                    setShowReport(true); 
                                    setShowMenu(false); 
                                }, 'guestReports')} 
                                className="w-full text-left px-3 py-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 flex items-center gap-2"
                            >
                                <Flag size={12} /> Report
                            </button>
                            
                            {(isOwner || isAdmin) && (
                                <button onClick={handleDelete} className="w-full text-left px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50 flex items-center gap-2"><Trash2 size={12} /> Delete</button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </div>

        {/* Soft Footer Extension for Contributors */}
        {showContributor && (
            <div className="-mx-4 -mb-4 -mt-3 px-4 py-1.5 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800 rounded-b-2xl flex items-center">
                <span className="text-[10px] text-slate-500 dark:text-slate-400 font-medium truncate flex-1 min-w-0" title={`Added by ${article.addedBy!.name}`}>
                    Added by <span className="text-slate-600 dark:text-slate-300">{article.addedBy!.name}</span>
                </span>
            </div>
        )}
      </div>

      {/* -- Modals -- */}
      <CollectionPopover isOpen={showCollection} onClose={() => setShowCollection(false)} articleId={article.id} mode={collectionMode} anchorRect={collectionAnchor} />
      <ReportModal isOpen={showReport} onClose={() => setShowReport(false)} onSubmit={async () => { await new Promise(r => setTimeout(r, 1000)); toast.success("Reported"); }} articleId={article.id} />
      {showFullModal && <ArticleModal isOpen={showFullModal} onClose={() => setShowFullModal(false)} article={article} />}
      <ImageLightbox isOpen={showLightbox} onClose={() => setShowLightbox(false)} images={article.images || []} />
    </>
  );
});
NewsCard.displayName = 'NewsCard';





================================================================================
FILE: src\components\newscard\NewsCardMedia.tsx
================================================================================
import React from 'react';
import { Article } from '@/types';
import { EmbeddedMedia } from '../embeds/EmbeddedMedia';
import { Image } from '../Image';
import { ExternalLink, Lock } from 'lucide-react';

interface NewsCardMediaProps {
  article: Article;
  onClick: (e: React.MouseEvent) => void;
}

export const NewsCardMedia: React.FC<NewsCardMediaProps> = ({ article, onClick }) => {
  return (
    <div 
        className="w-full aspect-[4/3] rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 relative shrink-0 cursor-pointer group/media"
        onClick={onClick}
    >
        {article.media ? (
            <EmbeddedMedia media={article.media} onClick={onClick} />
        ) : (
            article.images && article.images.length > 0 && (
                <Image src={article.images[0]} className="w-full h-full object-cover transition-transform duration-500 group-hover/media:scale-105" />
            )
        )}
        
        <div className="absolute top-2 left-2 flex gap-1">
            {article.source_type === 'link' && (
                <div className="bg-black/60 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded-full tracking-wide flex items-center gap-1 transition-transform group-hover/media:scale-105">
                    <ExternalLink size={8} /> Link
                </div>
            )}
            {article.visibility === 'private' && (
                <div className="bg-black/60 backdrop-blur-sm text-white p-1 rounded-full">
                    <Lock size={10} />
                </div>
            )}
        </div>
    </div>
  );
};





================================================================================
FILE: src\components\profile\CollectionsGrid.tsx
================================================================================
import React from 'react';
import { Collection } from '@/types';
import { CollectionCard } from '../collections/CollectionCard';
import { Folder } from 'lucide-react';

interface CollectionsGridProps {
  collections: Collection[];
  onCollectionClick?: (id: string) => void;
  // Selection
  selectionMode?: boolean;
  selectedIds?: string[];
  onSelect?: (id: string) => void;
}

export const CollectionsGrid: React.FC<CollectionsGridProps> = ({ 
    collections, 
    onCollectionClick,
    selectionMode = false,
    selectedIds = [],
    onSelect
}) => {
  if (collections.length === 0) {
    return (
      <div className="py-12 text-center border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-2xl">
        <Folder className="mx-auto text-slate-300 mb-2" size={32} />
        <p className="text-slate-500">No collections found.</p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {collections.map(col => (
        <CollectionCard 
            key={col.id} 
            collection={col}
            onClick={() => onCollectionClick?.(col.id)}
            selectionMode={selectionMode}
            isSelected={selectedIds.includes(col.id)}
            onSelect={onSelect}
        />
      ))}
    </div>
  );
};









================================================================================
FILE: src\components\profile\NuggetCard.tsx
================================================================================
// This component has been deprecated in favor of the unified `components/NewsCard.tsx`
// to ensure design consistency across Home Feed and Profile.
import { NewsCard } from '../NewsCard';
export const NuggetCard = NewsCard;





================================================================================
FILE: src\components\profile\ProfileCard.tsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { User } from '@/types';
import { MapPin, Link as LinkIcon, Twitter, Linkedin, Github, Camera, Save, Edit3, Calendar } from 'lucide-react';
import { useToast } from '@/hooks/useToast';
import { storageService } from '@/services/storageService';
import { Avatar } from '../shared/Avatar';
import { adminConfigService } from '@/admin/services/adminConfigService';

interface ProfileCardProps {
  user: User;
  isOwner: boolean;
  nuggetCount: number;
  onUpdate: (updatedUser: User) => void;
}

export const ProfileCard: React.FC<ProfileCardProps> = ({ user, isOwner, nuggetCount, onUpdate }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [allowUpload, setAllowUpload] = useState(false);
  const toast = useToast();
  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    adminConfigService.getFeatureFlags().then(flags => {
        setAllowUpload(flags.enableAvatarUpload);
    });
  }, []);

  // Form State
  const [formData, setFormData] = useState({
    name: user.name,
    avatarUrl: user.avatarUrl,
    title: 'Senior Product Designer', // Mock field
    company: 'TechFlow Inc.', // Mock field
    bio: 'Building minimalist interfaces for busy people. Obsessed with typography and whitespace.', // Mock field
    location: 'San Francisco, CA', // Mock field
    website: 'https://akash.design', // Mock field
    twitter: 'akash_ux', // Mock field
    linkedin: 'akash-solanki', // Mock field
  });

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        toast.error("Image size must be less than 2MB");
        return;
      }
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, avatarUrl: reader.result as string }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSave = async () => {
    setIsSaving(true);
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 800));
      
      const updatedUser = { ...user, name: formData.name, avatarUrl: formData.avatarUrl };
      await storageService.updateUser(user.id, { name: formData.name, avatarUrl: formData.avatarUrl });
      
      onUpdate(updatedUser);
      setIsEditing(false);
      toast.success("Profile updated");
    } catch (e) {
      toast.error("Failed to save profile");
    } finally {
      setIsSaving(false);
    }
  };

  const handleCancel = () => {
    // Reset form
    setFormData({
        name: user.name,
        avatarUrl: user.avatarUrl,
        title: 'Senior Product Designer',
        company: 'TechFlow Inc.',
        bio: 'Building minimalist interfaces for busy people. Obsessed with typography and whitespace.',
        location: 'San Francisco, CA',
        website: 'https://akash.design',
        twitter: 'akash_ux',
        linkedin: 'akash-solanki',
    });
    setIsEditing(false);
  };

  return (
    <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm sticky top-24 flex flex-col gap-6">
      {/* 1. Avatar Section */}
      <div className="relative w-24 h-24">
        <div className="w-full h-full rounded-full bg-slate-100 dark:bg-slate-800 border-4 border-white dark:border-slate-900 shadow-lg flex items-center justify-center overflow-hidden">
            <Avatar name={formData.name} src={formData.avatarUrl} size="xl" className="w-full h-full text-3xl" />
        </div>
        {isEditing && allowUpload && (
            <>
                <button 
                    onClick={() => fileInputRef.current?.click()}
                    className="absolute bottom-0 right-0 p-2 bg-slate-900 text-white rounded-full hover:bg-primary-500 hover:text-slate-900 transition-colors shadow-md z-10"
                >
                    <Camera size={14} />
                </button>
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    onChange={handleFileChange} 
                    className="hidden" 
                    accept="image/*"
                />
            </>
        )}
      </div>

      {/* 2. Main Info */}
      <div className="flex flex-col gap-4">
        {isEditing ? (
            <div className="space-y-3 animate-in fade-in duration-200">
                <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Full Name</label>
                    <input 
                        name="name"
                        value={formData.name}
                        onChange={handleInputChange}
                        className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold focus:outline-none focus:ring-2 focus:ring-primary-500 dark:text-white"
                    />
                </div>
                <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Title & Company</label>
                    <input 
                        name="title"
                        value={formData.title}
                        onChange={handleInputChange}
                        placeholder="Job Title"
                        className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:text-white"
                    />
                    <input 
                        name="company"
                        value={formData.company}
                        onChange={handleInputChange}
                        placeholder="Company"
                        className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 dark:text-white"
                    />
                </div>
                <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Bio</label>
                    <textarea 
                        name="bio"
                        value={formData.bio}
                        onChange={handleInputChange}
                        rows={3}
                        className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 dark:text-white"
                    />
                </div>
                <div>
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Location</label>
                    <input 
                        name="location"
                        value={formData.location}
                        onChange={handleInputChange}
                        className="w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 dark:text-white"
                    />
                </div>
            </div>
        ) : (
            <div className="animate-in fade-in duration-200">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white leading-tight mb-1">{formData.name}</h1>
                <p className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-4">
                    {formData.title} at <span className="text-slate-900 dark:text-slate-200">{formData.company}</span>
                </p>
                <p className="text-sm text-slate-600 dark:text-slate-300 leading-relaxed mb-4">
                    {formData.bio}
                </p>
                
                <div className="flex flex-wrap gap-4 text-xs text-slate-500 dark:text-slate-400">
                    <div className="flex items-center gap-1.5">
                        <MapPin size={14} />
                        <span>{formData.location}</span>
                    </div>
                    <div className="flex items-center gap-1.5">
                        <Calendar size={14} />
                        <span>Joined {new Date(user.joinedAt).getFullYear()}</span>
                    </div>
                </div>
            </div>
        )}
      </div>

      {/* 3. Stats - Followers removed for MVP, Centered, Sentence Case */}
      {!isEditing && (
        <div className="flex items-center justify-center py-4 border-t border-b border-slate-100 dark:border-slate-800">
            <div className="text-center">
                <div className="text-lg font-bold text-slate-900 dark:text-white">{nuggetCount}</div>
                <div className="text-[10px] font-bold text-slate-400 tracking-wider">Nuggets</div>
            </div>
        </div>
      )}

      {/* 4. Social Links */}
      <div className="flex flex-col gap-2">
        {isEditing ? (
            <>
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-2">Social Links</label>
                <div className="flex items-center gap-2">
                    <LinkIcon size={16} className="text-slate-400" />
                    <input name="website" value={formData.website} onChange={handleInputChange} placeholder="Website" className="flex-1 px-2 py-1.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 dark:text-white" />
                </div>
                <div className="flex items-center gap-2">
                    <Twitter size={16} className="text-slate-400" />
                    <input name="twitter" value={formData.twitter} onChange={handleInputChange} placeholder="Twitter" className="flex-1 px-2 py-1.5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md text-xs focus:outline-none focus:ring-1 focus:ring-primary-500 dark:text-white" />
                </div>
            </>
        ) : (
            <div className="flex gap-3 pt-1">
                <a href={formData.website} target="_blank" rel="noopener" className="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-500 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/10 transition-colors">
                    <LinkIcon size={18} />
                </a>
                <a href={`https://twitter.com/${formData.twitter}`} target="_blank" rel="noopener" className="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-500 hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors">
                    <Twitter size={18} />
                </a>
                <div className="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-300 cursor-not-allowed">
                    <Linkedin size={18} />
                </div>
                <div className="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-slate-300 cursor-not-allowed">
                    <Github size={18} />
                </div>
            </div>
        )}
      </div>

      {/* 5. Action Buttons (Always Last) */}
      {isOwner && (
        <div className="pt-2">
            {isEditing ? (
                <div className="flex gap-3">
                    <button 
                        onClick={handleCancel}
                        className="flex-1 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        onClick={handleSave}
                        disabled={isSaving}
                        className="flex-1 py-2.5 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-bold hover:opacity-90 transition-opacity shadow-lg shadow-slate-900/10 flex items-center justify-center gap-2"
                    >
                        {isSaving ? <span className="animate-pulse">Saving...</span> : <><Save size={16} /> Save Changes</>}
                    </button>
                </div>
            ) : (
                <button 
                    onClick={() => setIsEditing(true)}
                    className="w-full py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center gap-2 group"
                >
                    <Edit3 size={16} className="text-slate-400 group-hover:text-primary-500 transition-colors" />
                    Edit Profile
                </button>
            )}
        </div>
      )}
    </div>
  );
};








================================================================================
FILE: src\components\profile\TabsBar.tsx
================================================================================
import React from 'react';

interface TabOption {
  id: string;
  label: string;
  count?: number;
}

interface TabsBarProps {
  tabs: TabOption[];
  activeTab: string;
  onTabChange: (id: string) => void;
}

export const TabsBar: React.FC<TabsBarProps> = ({ tabs, activeTab, onTabChange }) => {
  return (
    <div className="inline-flex items-center bg-white/70 backdrop-blur-sm border border-slate-200/60 rounded-xl px-4 py-2 space-x-6">
      {tabs.map((tab) => {
        const isActive = activeTab === tab.id;
        return (
          <button
            key={tab.id}
            onClick={() => onTabChange(tab.id)}
            className={`
              relative text-sm font-medium transition-colors duration-200
              ${isActive ? 'text-slate-900' : 'text-slate-500 hover:text-slate-900'}
            `}
          >
            {tab.label}
            {tab.count !== undefined && (
              <span className={`ml-1.5 text-xs ${isActive ? 'text-slate-500' : 'text-slate-400'}`}>
                {tab.count}
              </span>
            )}
            
            {/* Active Indicator */}
            {isActive && (
              <span className="absolute -bottom-[9px] left-0 right-0 h-[2px] bg-slate-800 rounded-t-full" />
            )}
          </button>
        );
      })}
    </div>
  );
};









================================================================================
FILE: src\components\ReportModal.tsx
================================================================================
import React, { useState, useEffect, useRef } from 'react';
import { createPortal } from 'react-dom';
import { X, Flag, AlertTriangle, Info, ShieldAlert, FileWarning, HelpCircle } from 'lucide-react';

export type ReportReasonCode = 'spam' | 'misleading' | 'abusive' | 'copyright' | 'other';

export interface ReportPayload {
  articleId: string;
  reason: ReportReasonCode;
  comment?: string;
}

interface ReportModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (payload: ReportPayload) => Promise<void>;
  articleId: string;
}

const REASONS: { code: ReportReasonCode; label: string; icon: React.ReactNode }[] = [
  { code: 'spam', label: 'Spam or promotional', icon: <AlertTriangle size={16} /> },
  { code: 'misleading', label: 'Misleading or false information', icon: <FileWarning size={16} /> },
  { code: 'abusive', label: 'Inappropriate or abusive content', icon: <ShieldAlert size={16} /> },
  { code: 'copyright', label: 'Copyright or ownership issue', icon: <Info size={16} /> },
  { code: 'other', label: 'Other', icon: <HelpCircle size={16} /> },
];

export const ReportModal: React.FC<ReportModalProps> = ({ isOpen, onClose, onSubmit, articleId }) => {
  const [selectedReason, setSelectedReason] = useState<ReportReasonCode | null>(null);
  const [comment, setComment] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const modalRef = useRef<HTMLDivElement>(null);

  // Reset state when opening
  useEffect(() => {
    if (isOpen) {
      setSelectedReason(null);
      setComment('');
      setError(null);
      setIsSubmitting(false);
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen]);

  // Handle Escape key
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) onClose();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, onClose]);

  const handleSubmit = async () => {
    if (!selectedReason) return;

    setIsSubmitting(true);
    setError(null);

    try {
      await onSubmit({
        articleId,
        reason: selectedReason,
        comment: comment.trim()
      });
      onClose();
    } catch (err) {
      setError("Something went wrong. Please try again.");
      setIsSubmitting(false);
    }
  };

  if (!isOpen) return null;

  return createPortal(
    <div 
      className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200"
      role="dialog"
      aria-modal="true"
      onClick={(e) => {
          e.stopPropagation();
          onClose();
      }}
    >
      <div 
        ref={modalRef}
        className="
          w-full max-w-[380px] bg-white/90 dark:bg-slate-900/90 backdrop-blur-md 
          rounded-2xl shadow-2xl border border-white/60 dark:border-slate-800 
          overflow-hidden animate-in zoom-in-95 duration-200
        "
        onClick={(e) => e.stopPropagation()} // Prevent click inside modal from closing it
      >
        {/* Header */}
        <div className="flex items-center justify-between px-5 py-4 border-b border-slate-100 dark:border-slate-800">
          <div className="flex items-center gap-2 text-red-600 dark:text-red-500">
            <Flag size={20} fill="currentColor" />
            <h2 className="text-lg font-bold text-slate-900 dark:text-white">Report nugget</h2>
          </div>
          <button 
            onClick={(e) => { e.stopPropagation(); onClose(); }}
            className="p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
            type="button"
          >
            <X size={20} />
          </button>
        </div>

        {/* Content */}
        <div className="p-5">
          <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">
            Help us keep the community safe. Why are you reporting this?
          </p>

          {/* Reasons List */}
          <div className="space-y-2 mb-4">
            {REASONS.map((r) => (
              <label 
                key={r.code}
                className={`
                  flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all border
                  ${selectedReason === r.code 
                    ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800' 
                    : 'bg-transparent border-transparent hover:bg-slate-50 dark:hover:bg-slate-800'
                  }
                `}
              >
                <input 
                  type="radio" 
                  name="reportReason" 
                  value={r.code}
                  checked={selectedReason === r.code}
                  onChange={() => setSelectedReason(r.code)}
                  className="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                />
                <div className={`text-sm font-medium ${selectedReason === r.code ? 'text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-300'}`}>
                  {r.label}
                </div>
              </label>
            ))}
          </div>

          {/* Optional Comment */}
          <div className="space-y-1.5 mb-4">
            <label className="text-xs font-bold text-slate-500 uppercase tracking-wide">Optional comment</label>
            <textarea 
              value={comment}
              onChange={(e) => setComment(e.target.value)}
              placeholder="Add specific details..."
              className="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-black/20 p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 min-h-[80px] resize-none dark:text-white placeholder:text-slate-400"
              onClick={(e) => e.stopPropagation()}
            />
          </div>

          {/* Privacy Hint */}
          <div className="flex gap-2 items-start text-[11px] text-slate-400 dark:text-slate-500 mb-1">
            <Info size={14} className="shrink-0 mt-0.5" />
            <p>Reports are confidential. Your identity is not shown to the author.</p>
          </div>

          {/* Error Message */}
          {error && (
            <p className="text-xs text-red-500 font-medium mt-2">{error}</p>
          )}
        </div>

        {/* Footer */}
        <div className="px-5 py-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 flex justify-end gap-3">
          <button 
            onClick={(e) => { e.stopPropagation(); onClose(); }}
            className="px-4 py-2 text-sm font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-xl transition-colors"
            type="button"
          >
            Cancel
          </button>
          <button 
            onClick={(e) => { e.stopPropagation(); handleSubmit(); }}
            disabled={!selectedReason || isSubmitting}
            className="
              px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-xl shadow-sm hover:bg-blue-700 
              disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95
            "
            type="button"
          >
            {isSubmitting ? 'Submitting...' : 'Submit Report'}
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
};








================================================================================
FILE: src\components\RichTextEditor.tsx
================================================================================
import React, { useRef } from 'react';
import { 
  Bold, Italic, List, Link as LinkIcon, 
  Heading1, Heading2, Quote, Code, 
  ListOrdered, LucideIcon
} from 'lucide-react';

interface RichTextEditorProps {
  label?: string;
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  className?: string;
  error?: string;
}

interface ToolbarButtonProps {
  icon: LucideIcon;
  onClick: () => void;
  tooltip: string;
}

// --- HTML to Markdown Conversion Logic for Paste ---
const convertHtmlToMarkdown = (html: string): string => {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  
  const processNode = (node: Node): string => {
    if (node.nodeType === Node.TEXT_NODE) {
      return node.textContent || '';
    }
    
    if (node.nodeType !== Node.ELEMENT_NODE) return '';
    
    const el = node as HTMLElement;
    let content = '';
    
    // Recursively process children
    node.childNodes.forEach(child => {
      content += processNode(child);
    });

    switch (el.tagName.toLowerCase()) {
      case 'strong':
      case 'b':
        return content.trim() ? `**${content}**` : '';
      case 'em':
      case 'i':
        return content.trim() ? `*${content}*` : '';
      case 'p':
        // Avoid adding too many newlines if the p is empty or just whitespace
        return content.trim() ? `\n\n${content.trim()}\n` : ''; 
      case 'br':
        return '\n';
      case 'a':
        const href = el.getAttribute('href');
        return href ? `[${content}](${href})` : content;
      case 'ul':
      case 'ol':
        return `\n${content}\n`;
      case 'li':
        // Clean up newlines inside list items
        return `- ${content.trim()}\n`;
      case 'h1': return `\n# ${content.trim()}\n\n`;
      case 'h2': return `\n## ${content.trim()}\n\n`;
      case 'h3': return `\n### ${content.trim()}\n\n`;
      case 'blockquote': return `\n> ${content.trim()}\n\n`;
      case 'code': return `\`${content}\``;
      case 'pre': return `\n\`\`\`\n${content}\n\`\`\`\n`;
      case 'div': 
        return `\n${content}\n`;
      default:
        return content;
    }
  };

  // Start processing from body, trim resulting whitespace
  let markdown = processNode(doc.body);
  
  // Collapse multiple newlines (3 or more) into 2
  return markdown.replace(/\n{3,}/g, '\n\n').trim();
};

export const RichTextEditor: React.FC<RichTextEditorProps> = ({
  label,
  value,
  onChange,
  placeholder,
  className = '',
  error
}) => {
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const insertFormat = (startTag: string, endTag: string = '') => {
    const textarea = textareaRef.current;
    if (!textarea) return;

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selectedText = text.substring(start, end);

    const newText = 
      text.substring(0, start) + 
      startTag + selectedText + endTag + 
      text.substring(end);

    onChange(newText);

    // Restore focus and cursor position
    setTimeout(() => {
      textarea.focus();
      textarea.setSelectionRange(
        start + startTag.length,
        end + startTag.length
      );
    }, 0);
  };

  const insertLineFormat = (prefix: string) => {
    const textarea = textareaRef.current;
    if (!textarea) return;

    const start = textarea.selectionStart;
    const text = textarea.value;
    
    // Find start of current line
    let lineStart = text.lastIndexOf('\n', start - 1) + 1;
    
    const newText = 
      text.substring(0, lineStart) + 
      prefix + 
      text.substring(lineStart);

    onChange(newText);
    
    setTimeout(() => {
      textarea.focus();
      textarea.setSelectionRange(start + prefix.length, start + prefix.length);
    }, 0);
  };

  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {
    // Check if clipboard has HTML content
    const html = e.clipboardData.getData('text/html');
    
    if (html) {
      e.preventDefault();
      
      const markdown = convertHtmlToMarkdown(html);
      
      // If conversion resulted in empty string (e.g. unrecognizable tags), 
      // fallback to plain text paste manually to be safe, or just insert the plain text version.
      const plainText = e.clipboardData.getData('text/plain');
      const textToInsert = markdown || plainText;

      const textarea = textareaRef.current;
      if (!textarea) return;

      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;

      const newText = 
        text.substring(0, start) + 
        textToInsert + 
        text.substring(end);

      onChange(newText);
      
      // Move cursor to end of pasted text
      setTimeout(() => {
        textarea.focus();
        textarea.setSelectionRange(
          start + textToInsert.length,
          start + textToInsert.length
        );
      }, 0);
    }
    // If no HTML, allow default behavior (text/plain paste)
  };

  const ToolbarButton: React.FC<ToolbarButtonProps> = ({ icon: Icon, onClick, tooltip }) => (
    <button
      type="button"
      onClick={onClick}
      className="p-2 text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
      title={tooltip}
    >
      <Icon size={18} />
    </button>
  );

  return (
    <div className={`space-y-2 ${className}`}>
      {label && (
        <label className="block text-sm font-medium text-slate-900 dark:text-slate-200">
          {label}
        </label>
      )}
      
      <div className={`
        bg-slate-50 dark:bg-slate-800 
        border rounded-xl overflow-hidden
        transition-all focus-within:ring-2 focus-within:ring-primary-500 focus-within:border-primary-500
        ${error ? 'border-red-300 ring-red-500' : 'border-slate-200 dark:border-slate-700'}
      `}>
        {/* Toolbar */}
        <div className="flex items-center gap-1 p-2 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900/50 overflow-x-auto">
          <ToolbarButton icon={Bold} onClick={() => insertFormat('**', '**')} tooltip="Bold" />
          <ToolbarButton icon={Italic} onClick={() => insertFormat('*', '*')} tooltip="Italic" />
          <div className="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1" />
          <ToolbarButton icon={Heading1} onClick={() => insertLineFormat('# ')} tooltip="Heading 1" />
          <ToolbarButton icon={Heading2} onClick={() => insertLineFormat('## ')} tooltip="Heading 2" />
          <div className="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1" />
          <ToolbarButton icon={List} onClick={() => insertLineFormat('- ')} tooltip="Bullet List" />
          <ToolbarButton icon={ListOrdered} onClick={() => insertLineFormat('1. ')} tooltip="Numbered List" />
          <ToolbarButton icon={Quote} onClick={() => insertLineFormat('> ')} tooltip="Quote" />
          <ToolbarButton icon={Code} onClick={() => insertFormat('`', '`')} tooltip="Inline Code" />
          <div className="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1" />
          <ToolbarButton icon={LinkIcon} onClick={() => insertFormat('[', '](url)')} tooltip="Link" />
        </div>

        <textarea
          ref={textareaRef}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          onPaste={handlePaste}
          placeholder={placeholder}
          className="w-full p-4 bg-transparent border-none focus:ring-0 min-h-[200px] font-mono text-sm leading-relaxed dark:text-slate-200 resize-y"
        />
      </div>
      {error && <p className="text-xs text-red-500">{error}</p>}
    </div>
  );
};








================================================================================
FILE: src\components\RichTextRenderer.tsx
================================================================================
import React from 'react';

interface RichTextRendererProps {
  content: string;
  className?: string;
  onTagClick?: (tag: string) => void;
  truncate?: boolean; // Kept for interface compatibility, though visual truncation is handled by parent line-clamp
}

export const RichTextRenderer: React.FC<RichTextRendererProps> = ({ 
  content, 
  className = '',
  onTagClick,
  truncate: _truncate = false
}) => {
  if (!content) return null;

  // Basic Markdown Parser
  // Note: For a production app, use a library like 'react-markdown' or 'marked'.
  // This is a custom lightweight implementation for the demo environment.

  const renderText = (text: string) => {
    // 1. Split by formatting tokens
    const parts = text.split(/(\*\*.*?\*\*|\*.*?\*|`.*?`|\[.*?\]\(.*?\)|#[a-zA-Z0-9_]+)/g);
    
    return parts.map((part, index) => {
      // Bold
      if (part.startsWith('**') && part.endsWith('**')) {
        return <strong key={index} className="font-bold text-slate-900 dark:text-slate-100">{part.slice(2, -2)}</strong>;
      }
      // Italic
      if (part.startsWith('*') && part.endsWith('*')) {
        return <em key={index} className="italic">{part.slice(1, -1)}</em>;
      }
      // Inline Code
      if (part.startsWith('`') && part.endsWith('`')) {
        return <code key={index} className="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-xs font-mono text-pink-600 dark:text-pink-400">{part.slice(1, -1)}</code>;
      }
      // Links
      if (part.startsWith('[') && part.includes('](') && part.endsWith(')')) {
        const matches = part.match(/\[(.*?)\]\((.*?)\)/);
        if (matches) {
          return (
            <a 
              key={index} 
              href={matches[2]} 
              target="_blank" 
              rel="noopener noreferrer"
              onClick={(e) => e.stopPropagation()} 
              className="text-primary-600 dark:text-primary-400 hover:underline"
            >
              {matches[1]}
            </a>
          );
        }
      }
      // Hashtags
      if (part.startsWith('#') && !part.includes(' ')) {
        const tag = part.slice(1);
        return (
          <span 
            key={index}
            onClick={(e) => {
              e.stopPropagation();
              if (onTagClick) onTagClick(tag);
            }}
            className="text-primary-600 dark:text-primary-400 font-medium hover:underline cursor-pointer"
          >
            {part}
          </span>
        );
      }
      
      return part;
    });
  };

  // Split content into blocks (paragraphs, headers, lists)
  const lines = content.split('\n');
  const elements: React.ReactNode[] = [];
  
  let inList = false;
  let listItems: React.ReactNode[] = [];

  lines.forEach((line, i) => {
    const trimmed = line.trim();
    
    // Empty lines (Reset list)
    if (!trimmed) {
      if (inList) {
        elements.push(<ul key={`list-${i}`} className="list-disc list-outside ml-5 mb-4 space-y-1">{listItems}</ul>);
        listItems = [];
        inList = false;
      }
      return; 
    }

    // Headers
    if (trimmed.startsWith('# ')) {
      elements.push(<h1 key={i} className="text-2xl font-bold text-slate-900 dark:text-white mt-6 mb-3">{renderText(trimmed.slice(2))}</h1>);
      return;
    }
    if (trimmed.startsWith('## ')) {
      elements.push(<h2 key={i} className="text-xl font-bold text-slate-900 dark:text-white mt-5 mb-2">{renderText(trimmed.slice(3))}</h2>);
      return;
    }

    // Blockquote
    if (trimmed.startsWith('> ')) {
        elements.push(
            <blockquote key={i} className="border-l-4 border-primary-500 pl-4 italic text-slate-600 dark:text-slate-400 my-4">
                {renderText(trimmed.slice(2))}
            </blockquote>
        );
        return;
    }

    // Lists
    if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
      inList = true;
      listItems.push(<li key={i}>{renderText(trimmed.slice(2))}</li>);
      return;
    }

    // Standard Paragraph
    if (inList) {
       // Close previous list if we hit a paragraph
        elements.push(<ul key={`list-${i}`} className="list-disc list-outside ml-5 mb-4 space-y-1">{listItems}</ul>);
        listItems = [];
        inList = false;
    }

    // Always render as block, allowing line-clamp on parent to handle truncation visually
    elements.push(
      <p key={i} className="mb-3 last:mb-0 leading-relaxed block">
        {renderText(line)}
      </p>
    );
  });

  // Flush remaining list
  if (inList && listItems.length > 0) {
    elements.push(<ul key="list-end" className="list-disc list-outside ml-5 mb-4 space-y-1">{listItems}</ul>);
  }

  return (
    <div className={`prose prose-slate dark:prose-invert max-w-none ${className}`}>
      {elements}
    </div>
  );
};








================================================================================
FILE: src\components\settings\AvatarSelectorModal.tsx
================================================================================

import React, { useState, useRef } from 'react';
import { createPortal } from 'react-dom';
import { X, Check, Upload } from 'lucide-react';
import { AvatarColor, AVATAR_COLORS } from '../../types/settings';
import { getInitials } from '../../utils/formatters';

interface AvatarSelectorModalProps {
  isOpen: boolean;
  onClose: () => void;
  currentName: string;
  currentColor: string;
  onSelect: (result: { type: 'color' | 'image'; value: string }) => void;
  allowUpload?: boolean;
}

export const AvatarSelectorModal: React.FC<AvatarSelectorModalProps> = ({
  isOpen,
  onClose,
  currentName,
  currentColor,
  onSelect,
  allowUpload = true
}) => {
  const [activeTab, setActiveTab] = useState<'colors' | 'upload'>('colors');
  const fileInputRef = useRef<HTMLInputElement>(null);

  if (!isOpen) return null;

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            alert("Image must be less than 2MB");
            return;
        }
        const reader = new FileReader();
        reader.onloadend = () => {
            onSelect({ type: 'image', value: reader.result as string });
            onClose();
        };
        reader.readAsDataURL(file);
    }
  };

  return createPortal(
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      <div 
        className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200"
        onClick={onClose}
      />
      
      <div className="relative w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 overflow-hidden animate-in zoom-in-95 duration-200">
        
        {/* Header */}
        <div className="flex justify-between items-center px-6 py-4 border-b border-slate-100 dark:border-slate-800">
          <h3 className="text-lg font-bold text-slate-900 dark:text-white">Choose Avatar</h3>
          <button onClick={onClose} className="p-1 text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">
            <X size={20} />
          </button>
        </div>

        {/* Tabs - Only show if upload is allowed */}
        {allowUpload && (
            <div className="flex p-2 bg-slate-50 dark:bg-slate-950/50 gap-1 border-b border-slate-100 dark:border-slate-800">
                <button 
                    onClick={() => setActiveTab('colors')}
                    className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${activeTab === 'colors' ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                >
                    Presets
                </button>
                <button 
                    onClick={() => setActiveTab('upload')}
                    className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors ${activeTab === 'upload' ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                >
                    Upload Image
                </button>
            </div>
        )}

        <div className="p-6">
            {(activeTab === 'colors' || !allowUpload) && (
                <div className="grid grid-cols-4 gap-4">
                {(Object.keys(AVATAR_COLORS) as AvatarColor[]).map((colorKey) => {
                    const bgClass = AVATAR_COLORS[colorKey];
                    const isSelected = currentColor === colorKey;
                    
                    return (
                    <button
                        key={colorKey}
                        onClick={() => { onSelect({ type: 'color', value: colorKey }); onClose(); }}
                        className={`
                        relative aspect-square rounded-full flex items-center justify-center
                        ${bgClass} text-white font-bold text-xl shadow-sm
                        hover:scale-110 transition-transform
                        ring-offset-2 ring-offset-white dark:ring-offset-slate-900
                        ${isSelected ? 'ring-2 ring-slate-900 dark:ring-white' : ''}
                        `}
                    >
                        {getInitials(currentName)}
                        {isSelected && (
                        <div className="absolute inset-0 flex items-center justify-center bg-black/20 rounded-full">
                            <Check size={20} />
                        </div>
                        )}
                    </button>
                    );
                })}
                </div>
            )}

            {activeTab === 'upload' && allowUpload && (
                <div className="flex flex-col items-center justify-center gap-4">
                    <div 
                        onClick={() => fileInputRef.current?.click()}
                        className="w-full h-32 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors group"
                    >
                        <div className="p-3 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 group-hover:text-primary-500 transition-colors mb-2">
                            <Upload size={24} />
                        </div>
                        <span className="text-sm font-bold text-slate-500 dark:text-slate-400 group-hover:text-slate-700 dark:group-hover:text-slate-200">
                            Click to upload image
                        </span>
                        <span className="text-[10px] text-slate-400 mt-1">Max 2MB</span>
                    </div>
                    <input 
                        type="file" 
                        ref={fileInputRef} 
                        onChange={handleFileUpload} 
                        className="hidden" 
                        accept="image/*"
                    />
                </div>
            )}
        </div>
      </div>
    </div>,
    document.body
  );
};





================================================================================
FILE: src\components\settings\ConfirmActionModal.tsx
================================================================================

import React, { useState } from 'react';
import { createPortal } from 'react-dom';
import { AlertTriangle, Loader2 } from 'lucide-react';

interface ConfirmActionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => Promise<void>;
  title: string;
  description: string;
  confirmString?: string; // If provided, user must type this
  actionLabel?: string;
  isDestructive?: boolean;
}

export const ConfirmActionModal: React.FC<ConfirmActionModalProps> = ({
  isOpen,
  onClose,
  onConfirm,
  title,
  description,
  confirmString,
  actionLabel = 'Confirm',
  isDestructive = false,
}) => {
  const [inputValue, setInputValue] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);

  if (!isOpen) return null;

  const isConfirmDisabled = confirmString ? inputValue !== confirmString : false;

  const handleConfirm = async () => {
    if (isConfirmDisabled) return;
    setIsProcessing(true);
    try {
      await onConfirm();
      onClose();
    } finally {
      setIsProcessing(false);
    }
  };

  return createPortal(
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      <div 
        className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200"
        onClick={() => !isProcessing && onClose()}
      />
      
      <div className="relative w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 p-6 animate-in zoom-in-95 duration-200">
        <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-4 ${isDestructive ? 'bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400' : 'bg-slate-100 text-slate-600'}`}>
          <AlertTriangle size={24} />
        </div>

        <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">{title}</h3>
        <p className="text-sm text-slate-500 dark:text-slate-400 mb-6 leading-relaxed">
          {description}
        </p>

        {confirmString && (
          <div className="mb-6">
            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">
              Type <span className="text-slate-900 dark:text-white select-all">"{confirmString}"</span> to confirm
            </label>
            <input 
              className="w-full px-4 py-2 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg focus:outline-none focus:border-red-500 transition-colors font-mono text-sm"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              placeholder={confirmString}
            />
          </div>
        )}

        <div className="flex gap-3 justify-end">
          <button 
            onClick={onClose}
            disabled={isProcessing}
            className="px-4 py-2 text-sm font-bold text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors"
          >
            Cancel
          </button>
          <button 
            onClick={handleConfirm}
            disabled={isConfirmDisabled || isProcessing}
            className={`
              flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-bold text-white shadow-sm transition-all
              ${isDestructive 
                ? 'bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed' 
                : 'bg-primary-500 hover:bg-primary-600 disabled:opacity-50'
              }
            `}
          >
            {isProcessing && <Loader2 size={16} className="animate-spin" />}
            {actionLabel}
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
};





================================================================================
FILE: src\components\settings\SettingsSectionCard.tsx
================================================================================

import React from 'react';

interface SettingsSectionCardProps {
  id?: string;
  title: string;
  description?: string;
  children: React.ReactNode;
  rightAction?: React.ReactNode;
  icon?: React.ReactNode;
  className?: string;
}

export const SettingsSectionCard: React.FC<SettingsSectionCardProps> = ({
  id,
  title,
  description,
  children,
  rightAction,
  icon,
  className = ''
}) => {
  return (
    <section 
      id={id}
      className={`
        relative overflow-hidden
        bg-white/80 dark:bg-slate-900/60 backdrop-blur-xl
        border border-slate-200/60 dark:border-slate-800/60
        rounded-2xl shadow-sm
        transition-all duration-300
        ${className}
      `}
    >
      <div className="p-6">
        <div className="flex items-start justify-between mb-6">
          <div className="flex gap-4">
            {icon && (
              <div className="p-2.5 bg-slate-100 dark:bg-slate-800 rounded-xl text-slate-500 dark:text-slate-400 h-fit">
                {icon}
              </div>
            )}
            <div>
              <h2 className="text-lg font-bold text-slate-900 dark:text-white leading-tight">
                {title}
              </h2>
              {description && (
                <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 leading-relaxed max-w-xl">
                  {description}
                </p>
              )}
            </div>
          </div>
          {rightAction && (
            <div className="shrink-0 ml-4">
              {rightAction}
            </div>
          )}
        </div>
        
        <div className="space-y-6">
          {children}
        </div>
      </div>
    </section>
  );
};





================================================================================
FILE: src\components\settings\SettingsSidebarNav.tsx
================================================================================

import React from 'react';
import { User, Shield, Sliders, AlertTriangle, CreditCard } from 'lucide-react';

interface NavItem {
  id: string;
  label: string;
  icon: React.ReactNode;
}

const ITEMS: NavItem[] = [
  { id: 'profile', label: 'Profile', icon: <User size={18} /> },
  { id: 'account', label: 'Account Info', icon: <CreditCard size={18} /> },
  { id: 'security', label: 'Security', icon: <Shield size={18} /> },
  { id: 'preferences', label: 'Preferences', icon: <Sliders size={18} /> },
  { id: 'danger', label: 'Danger Zone', icon: <AlertTriangle size={18} /> },
];

interface SettingsSidebarNavProps {
  activeSection: string;
  onSelect: (id: string) => void;
}

export const SettingsSidebarNav: React.FC<SettingsSidebarNavProps> = ({ activeSection, onSelect }) => {
  return (
    <nav className="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 custom-scrollbar sticky top-[5.5rem]">
      {ITEMS.map((item) => (
        <button
          key={item.id}
          onClick={() => onSelect(item.id)}
          className={`
            flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all whitespace-nowrap
            ${activeSection === item.id 
              ? 'bg-white dark:bg-slate-800 text-primary-600 dark:text-primary-400 shadow-sm ring-1 ring-slate-200 dark:ring-slate-700' 
              : 'text-slate-500 hover:text-slate-900 dark:hover:text-slate-200 hover:bg-slate-100/50 dark:hover:bg-slate-800/50'
            }
          `}
        >
          {item.icon}
          {item.label}
        </button>
      ))}
    </nav>
  );
};





================================================================================
FILE: src\components\shared\Avatar.tsx
================================================================================
import React from 'react';
import { getInitials } from '@/utils/formatters';

interface AvatarProps {
  name: string;
  src?: string;
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl';
  className?: string;
}

const SIZE_CLASSES = {
  xs: 'w-5 h-5 text-[9px]',
  sm: 'w-6 h-6 text-[10px]',
  md: 'w-9 h-9 text-xs',
  lg: 'w-12 h-12 text-sm',
  xl: 'w-24 h-24 text-3xl',
};

export const Avatar: React.FC<AvatarProps> = ({ name, src, size = 'md', className = '' }) => {
  const sizeClass = SIZE_CLASSES[size];

  if (src) {
    return (
      <img 
        src={src} 
        alt={name} 
        className={`rounded-full object-cover ${sizeClass} ${className}`} 
      />
    );
  }

  return (
    <div 
      className={`
        rounded-full flex items-center justify-center font-bold 
        bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300
        ${sizeClass} ${className}
      `}
    >
      {getInitials(name)}
    </div>
  );
};









================================================================================
FILE: src\components\shared\ShareMenu.tsx
================================================================================
import React from 'react';
import { Share2 } from 'lucide-react';
import { useShare } from '@/hooks/useShare';
import { ShareModal } from '../ShareModal';
import { Tooltip } from '../UI/Tooltip';

interface ShareItemData {
  type: 'nugget' | 'collection';
  id: string;
  title: string;
  shareUrl: string;
}

interface ShareMeta {
  text?: string;   // Excerpt or Description
  author?: string;
}

interface ShareMenuProps {
  data: ShareItemData;
  meta?: ShareMeta;
  className?: string;
  iconSize?: number;
}

export const ShareMenu: React.FC<ShareMenuProps> = ({ 
  data, 
  meta, 
  className = '',
  iconSize = 14 
}) => {
  const { isOpen, anchorRect, handleShareClick, handleClose } = useShare();

  return (
    <>
      <Tooltip content="Share">
        <button 
          onClick={handleShareClick} 
          className={`w-7 h-7 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition-colors ${className}`}
          title="Share"
        >
          <Share2 size={iconSize} strokeWidth={1.5} />
        </button>
      </Tooltip>

      <ShareModal 
        isOpen={isOpen} 
        onClose={handleClose} 
        title={data.title} 
        url={data.shareUrl} 
        author={meta?.author} 
        excerpt={meta?.text} 
        anchorRect={anchorRect} 
      />
    </>
  );
};









================================================================================
FILE: src\components\ShareModal.tsx
================================================================================
import React, { useEffect, useState, useRef } from 'react';
import { createPortal } from 'react-dom';
import { Mail, Send, Linkedin, Facebook, Check, Copy, X } from 'lucide-react';
import { Tooltip } from './UI/Tooltip';

interface ShareModalProps {
  isOpen: boolean;
  onClose: () => void;
  title: string;
  url: string;
  author?: string;
  excerpt?: string;
  anchorRect?: DOMRect | null;
}

export const ShareModal: React.FC<ShareModalProps> = ({ 
  isOpen, 
  onClose, 
  title, 
  url, 
  author, 
  excerpt, 
  anchorRect 
}) => {
  const [copied, setCopied] = useState(false);
  const modalRef = useRef<HTMLDivElement>(null);
  
  const encodedUrl = encodeURIComponent(url);
  const encodedTitle = encodeURIComponent(title);
  
  // Format WhatsApp specific text
  const waText = `*${title}*${author ? ` by ${author}` : ''}${excerpt ? `\n\n${excerpt}` : ''}\n\n${url}`;
  const encodedWaText = encodeURIComponent(waText);

  // Close when clicking outside or resizing
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (isOpen && modalRef.current && !modalRef.current.contains(e.target as Node)) {
        onClose();
      }
    };

    const handleScroll = () => {
        if (isOpen) onClose();
    };

    if (isOpen) {
      window.addEventListener('mousedown', handleClickOutside);
      window.addEventListener('resize', onClose);
      window.addEventListener('scroll', handleScroll, { capture: true });
    }
    return () => {
      window.removeEventListener('mousedown', handleClickOutside);
      window.removeEventListener('resize', onClose);
      window.removeEventListener('scroll', handleScroll, { capture: true });
    };
  }, [isOpen, onClose]);

  if (!isOpen || !anchorRect) return null;

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(url);
      setCopied(true);
      setTimeout(() => {
        setCopied(false);
      }, 2000);
    } catch (err) {
      // Legacy fallback
      try {
        const textArea = document.createElement("textarea");
        textArea.value = url;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
            setCopied(true);
            setTimeout(() => {
                setCopied(false);
            }, 2000);
            return;
        }
        throw new Error("execCommand failed");
      } catch (fallbackErr) {
        console.error('Failed to copy', err, fallbackErr);
      }
    }
  };

  const socialApps = [
    {
      name: 'WhatsApp',
      url: `https://api.whatsapp.com/send?text=${encodedWaText}`,
      color: 'bg-[#25D366] hover:bg-[#20bd5a] ring-1 ring-[#25D366]/20',
      icon: (
        <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5 text-white">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
      )
    },
    {
      name: 'Telegram',
      url: `https://t.me/share/url?url=${encodedUrl}&text=${encodedTitle}`,
      color: 'bg-[#0088cc] hover:bg-[#0077b5] ring-1 ring-[#0088cc]/20',
      icon: <Send className="w-5 h-5 text-white -ml-0.5" strokeWidth={2.5} />
    },
    {
      name: 'LinkedIn',
      url: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
      color: 'bg-[#0077b5] hover:bg-[#006097] ring-1 ring-[#0077b5]/20',
      icon: <Linkedin className="w-5 h-5 text-white" strokeWidth={2.5} />
    },
    {
      name: 'Facebook',
      url: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
      color: 'bg-[#1877f2] hover:bg-[#166fe5] ring-1 ring-[#1877f2]/20',
      icon: <Facebook className="w-5 h-5 text-white" strokeWidth={2.5} />
    },
    {
      name: 'X',
      url: `https://twitter.com/intent/tweet?text=${encodedTitle}&url=${encodedUrl}`,
      color: 'bg-black hover:bg-neutral-800 ring-1 ring-black/20',
      icon: (
        <svg viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5 text-white">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
        </svg>
      )
    },
    {
      name: 'Email',
      url: `mailto:?subject=${encodedTitle}&body=${excerpt || title}%0A%0A${encodedUrl}`,
      color: 'bg-slate-500 hover:bg-slate-600 ring-1 ring-slate-500/20',
      icon: <Mail className="w-5 h-5 text-white" strokeWidth={2.5} />
    }
  ];

  // --- POSITIONING LOGIC ---
  const margin = 16; // Safety margin from screen edge
  const viewportWidth = window.innerWidth;
  
  // Center relative to the anchor
  const targetCenterX = anchorRect.left + window.scrollX + (anchorRect.width / 2);
  
  // Default centered position
  let left = targetCenterX;
  
  // The modal width is fixed at w-64 (256px) for compact design
  const modalWidth = 256;
  const halfWidth = modalWidth / 2;
  
  const minLeft = margin + halfWidth;
  const maxLeft = viewportWidth - margin - halfWidth;
  
  if (left < minLeft) left = minLeft;
  if (left > maxLeft) left = maxLeft;
  
  // Calculate arrow offset relative to the modal center
  const arrowOffset = targetCenterX - left;

  // Vertical Position
  const top = anchorRect.bottom + window.scrollY + 10;
  // Estimated height ~ 240px with smaller buttons
  const estimatedHeight = 240; 
  const isTooCloseToBottom = (anchorRect.bottom + estimatedHeight + margin) > window.innerHeight + window.scrollY;
  
  const finalTop = isTooCloseToBottom 
    ? (anchorRect.top + window.scrollY - estimatedHeight - 10) 
    : top;

  return createPortal(
    <div 
      id="share-popover"
      ref={modalRef}
      className={`absolute z-[100] w-64 flex flex-col items-center animate-in zoom-in-95 fade-in duration-200 ease-out origin-top`}
      style={{ 
        top: finalTop, 
        left: left, 
        transform: 'translateX(-50%)' 
      }}
      onClick={(e) => e.stopPropagation()}
    >
      {/* Main Card */}
      <div className="w-full bg-white dark:bg-slate-800 rounded-2xl shadow-2xl ring-1 ring-black/5 dark:ring-white/10 overflow-hidden">
        
        {/* Header - Minimal, just close button */}
        <div className="px-3 py-2 bg-white dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700/50 flex justify-end items-center">
            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
              <X size={16} />
            </button>
        </div>

        {/* Social Grid - Smaller Icons */}
        <div className="p-4 grid grid-cols-3 gap-y-4 gap-x-2 place-items-center bg-slate-50/30 dark:bg-black/20">
            {socialApps.map((app) => (
                <Tooltip key={app.name} content={app.name}>
                    <a
                        href={app.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className={`w-10 h-10 flex items-center justify-center rounded-xl text-white shadow-md transition-all duration-300 hover:scale-110 hover:-translate-y-1 hover:shadow-xl ${app.color}`}
                        aria-label={`Share on ${app.name}`}
                    >
                        {app.icon}
                    </a>
                </Tooltip>
            ))}
        </div>

        {/* Footer: Copy Link */}
        <div className="px-4 pb-4 pt-2">
             <div className="relative flex items-center">
                <div className="w-full flex items-center gap-2 bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-1.5 pr-2 pl-3">
                    <div className="flex-1 min-w-0">
                        <div className="text-xs text-slate-500 truncate font-mono select-all">
                            {url}
                        </div>
                    </div>
                    <button
                        onClick={handleCopy}
                        className={`
                            shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-md text-[10px] font-bold transition-all shadow-sm uppercase tracking-wide
                            ${copied 
                                ? 'bg-green-500 text-white ring-1 ring-green-600' 
                                : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 ring-1 ring-slate-200 dark:ring-slate-600'
                            }
                        `}
                    >
                        {copied ? <Check size={12} strokeWidth={3} /> : <Copy size={12} strokeWidth={3} />}
                        {copied ? 'COPIED' : 'COPY'}
                    </button>
                </div>
             </div>
        </div>
      </div>
      
      {/* Arrow Indicator */}
      <div 
        className={`w-3 h-3 bg-white dark:bg-slate-800 border-l border-t border-slate-100 dark:border-slate-700 transform rotate-45 absolute ${
            isTooCloseToBottom 
                ? 'bottom-[-6px] border-l-0 border-t-0 border-r border-b shadow-[2px_2px_2px_-1px_rgba(0,0,0,0.05)]' 
                : 'top-[-6px] shadow-[-1px_-1px_1px_rgba(0,0,0,0.02)]'
        }`}
        style={{ marginLeft: arrowOffset }}
      />
      
    </div>,
    document.body
  );
};








================================================================================
FILE: src\components\UI\BackToTopButton.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { ArrowUp } from 'lucide-react';

export const BackToTopButton: React.FC = () => {
  const [isVisible, setIsVisible] = useState(false);

  useEffect(() => {
    const toggleVisibility = () => {
      // Show button when page is scrolled down 300px
      if (window.scrollY > 300) {
        setIsVisible(true);
      } else {
        setIsVisible(false);
      }
    };

    window.addEventListener('scroll', toggleVisibility);
    return () => window.removeEventListener('scroll', toggleVisibility);
  }, []);

  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth',
    });
  };

  return (
    <button
      onClick={scrollToTop}
      className={`fixed bottom-6 right-6 md:bottom-8 md:right-8 z-30 p-2.5 rounded-full bg-primary-500 text-slate-900 shadow-lg shadow-primary-500/30 hover:bg-primary-400 hover:scale-110 transition-all duration-300 transform flex items-center justify-center ${
        isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10 pointer-events-none'
      }`}
    >
      <ArrowUp size={20} />
    </button>
  );
};









================================================================================
FILE: src\components\UI\Badge.tsx
================================================================================
import React from 'react';
import { X } from 'lucide-react';

type BadgeVariant = 'primary' | 'outline' | 'success' | 'danger' | 'neutral' | 'purple' | 'orange' | 'category';

interface BadgeProps {
  label: string;
  variant?: BadgeVariant;
  className?: string;
  onClick?: (e: React.MouseEvent) => void;
  onRemove?: (e: React.MouseEvent) => void;
  icon?: React.ReactNode;
}

export const Badge: React.FC<BadgeProps> = ({ 
  label, 
  variant = 'neutral', 
  className = '', 
  onClick,
  onRemove,
  icon
}) => {
  
  const variants = {
    primary: 'bg-primary-100 text-primary-900 border border-primary-200 dark:bg-primary-900/30 dark:border-primary-800 dark:text-primary-100',
    category: 'bg-primary-50 text-primary-600 border border-primary-200 dark:bg-primary-900/30 dark:border-primary-800 dark:text-primary-400',
    outline: 'bg-transparent border border-slate-200 text-slate-600 dark:border-slate-700 dark:text-slate-400 hover:border-slate-300',
    neutral: 'bg-slate-100 text-slate-700 border border-slate-200 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300',
    success: 'bg-green-100 text-green-700 border border-green-200 dark:bg-green-900/30 dark:border-green-800 dark:text-green-300',
    danger: 'bg-red-100 text-red-700 border border-red-200 dark:bg-red-900/30 dark:border-red-800 dark:text-red-300',
    purple: 'bg-purple-100 text-purple-700 border border-purple-200 dark:bg-purple-900/30 dark:border-purple-800 dark:text-purple-300',
    orange: 'bg-orange-100 text-orange-700 border border-orange-200 dark:bg-orange-900/30 dark:border-orange-800 dark:text-orange-300',
  };

  const baseStyles = `
    inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold transition-all duration-200
    ${variants[variant]}
    ${onClick ? 'cursor-pointer hover:opacity-80' : 'cursor-default'}
    ${className}
  `;

  return (
    <span 
      className={baseStyles}
      onClick={onClick}
    >
      {icon && <span className="mr-1">{icon}</span>}
      {label}
      {onRemove && (
        <button 
          onClick={(e) => {
            e.stopPropagation();
            onRemove(e);
          }}
          className="ml-1 p-0.5 hover:bg-black/10 dark:hover:bg-white/10 rounded-full transition-colors"
        >
          <X size={10} />
        </button>
      )}
    </span>
  );
};









================================================================================
FILE: src\components\UI\EmptyState.tsx
================================================================================
import React from 'react';

interface EmptyStateProps {
  icon: React.ReactElement<any>;
  title: string;
  description: string;
  action?: React.ReactNode;
  className?: string;
}

export const EmptyState: React.FC<EmptyStateProps> = ({ 
  icon, 
  title, 
  description, 
  action, 
  className = '' 
}) => {
  return (
    <div className={`flex flex-col items-center justify-center py-16 px-4 text-center animate-in fade-in duration-500 ${className}`}>
      <div className="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-sm text-slate-400 dark:text-slate-500">
        {React.cloneElement(icon, { size: 40 })}
      </div>
      
      <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">
        {title}
      </h3>
      
      <p className="text-slate-500 dark:text-slate-400 max-w-sm mb-8 leading-relaxed">
        {description}
      </p>
      
      {action && (
        <div className="mt-2">
          {action}
        </div>
      )}
    </div>
  );
};









================================================================================
FILE: src\components\UI\FeedbackButton.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { MessageSquare, X, Send, Loader2, Check } from 'lucide-react';

interface FeedbackModalProps {
  isOpen: boolean;
  onClose: () => void;
}

const FeedbackModal: React.FC<FeedbackModalProps> = ({ isOpen, onClose }) => {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSent, setIsSent] = useState(false);
  const [feedback, setFeedback] = useState('');

  useEffect(() => {
    if (isOpen) document.body.style.overflow = 'hidden';
    else document.body.style.overflow = 'unset';
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!feedback.trim()) return;
    
    setIsSubmitting(true);
    // Simulate API call
    await new Promise(resolve => setTimeout(resolve, 1500));
    setIsSubmitting(false);
    setIsSent(true);
    
    // Close after success message
    setTimeout(() => {
        onClose();
        // Reset form after close animation
        setTimeout(() => {
            setIsSent(false);
            setFeedback('');
        }, 300);
    }, 2000);
  };

  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-[105] flex items-center justify-center p-4">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-slate-900/30 backdrop-blur-[2px] animate-in fade-in duration-300" 
        onClick={onClose}
      />

      {/* Glassy Modal */}
      <div className="relative w-full max-w-md bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border border-white/20 dark:border-white/10 shadow-2xl rounded-2xl p-6 animate-in zoom-in-95 slide-in-from-bottom-2 duration-300">
        
        {/* Close Button */}
        <button 
            onClick={onClose}
            className="absolute top-4 right-4 p-1 rounded-full text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
        >
            <X size={18} />
        </button>

        {isSent ? (
            <div className="flex flex-col items-center justify-center py-8 text-center animate-in fade-in slide-in-from-bottom-2">
                <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full flex items-center justify-center mb-4 shadow-sm">
                    <Check size={24} strokeWidth={3} />
                </div>
                <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-2">Thanks for sharing!</h3>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Your feedback helps us make Nuggets better.</p>
            </div>
        ) : (
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <h3 className="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <MessageSquare size={20} className="text-primary-500" />
                        Share Feedback
                    </h3>
                    <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">
                        Spot a bug? Have a suggestion? Let us know.
                    </p>
                </div>

                <div className="space-y-3">
                    <textarea 
                        autoFocus
                        className="w-full h-32 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all resize-none placeholder:text-slate-400 dark:text-white"
                        placeholder="I think it would be cool if..."
                        value={feedback}
                        onChange={(e) => setFeedback(e.target.value)}
                    />
                    
                    <input 
                        type="email"
                        className="w-full bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all dark:text-white"
                        placeholder="Email (optional)"
                    />
                </div>

                <div className="flex gap-3 pt-2">
                    <button 
                        type="button" 
                        onClick={onClose}
                        className="flex-1 px-4 py-2.5 rounded-xl text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-white/5 transition-colors"
                    >
                        Cancel
                    </button>
                    <button 
                        type="submit"
                        disabled={!feedback.trim() || isSubmitting}
                        className="flex-[2] px-4 py-2.5 rounded-xl text-sm font-bold bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:opacity-90 transition-all shadow-lg shadow-primary-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                        {isSubmitting ? <Loader2 size={16} className="animate-spin" /> : <>Submit <Send size={16} /></>}
                    </button>
                </div>
            </form>
        )}
      </div>
    </div>,
    document.body
  );
};

export const FeedbackButton: React.FC = () => {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      <button
        onClick={() => setIsOpen(true)}
        className="
            fixed right-0 top-1/2 -translate-y-1/2 z-[90] 
            group flex items-center gap-2 
            pl-3 pr-4 py-3 
            bg-white/80 dark:bg-slate-900/80 backdrop-blur-md 
            border-l border-t border-b border-slate-200/60 dark:border-slate-700/60
            rounded-l-2xl shadow-lg hover:shadow-xl
            transition-all duration-300 ease-out
            translate-x-[calc(100%-48px)] hover:translate-x-0
        "
        aria-label="Share Feedback"
      >
        <MessageSquare size={20} className="text-slate-600 dark:text-slate-300 shrink-0" />
        <span className="text-xs font-bold text-slate-600 dark:text-slate-300 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75">
            Feedback
        </span>
        
        {/* Subtle indicator strip */}
        <div className="absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1 bg-primary-500 rounded-r-full opacity-50 group-hover:opacity-100 transition-opacity" />
      </button>

      <FeedbackModal isOpen={isOpen} onClose={() => setIsOpen(false)} />
    </>
  );
};









================================================================================
FILE: src\components\UI\IconButton.tsx
================================================================================
import React, { ButtonHTMLAttributes, forwardRef } from 'react';
import { Tooltip } from './Tooltip';

interface IconButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  icon: React.ReactNode;
  tooltip?: string;
  variant?: 'ghost' | 'primary' | 'danger' | 'surface' | 'success';
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export const IconButton = forwardRef<HTMLButtonElement, IconButtonProps>(({ 
  icon, 
  tooltip, 
  variant = 'ghost', 
  size = 'md', 
  className = '',
  ...props 
}, ref) => {

  const variants = {
    ghost: 'text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800',
    primary: 'text-primary-600 bg-primary-50 hover:bg-primary-100 dark:text-primary-400 dark:bg-primary-900/20 dark:hover:bg-primary-900/40',
    danger: 'text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 dark:bg-red-900/10 dark:hover:bg-red-900/30',
    surface: 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-slate-300 shadow-sm',
    success: 'text-green-600 bg-green-50 hover:bg-green-100 dark:text-green-400 dark:bg-green-900/20 dark:hover:bg-green-900/40'
  };

  const sizes = {
    sm: 'p-1.5',
    md: 'p-2',
    lg: 'p-3'
  };

  const buttonElement = (
    <button
      ref={ref}
      className={`
        rounded-lg transition-all duration-200 flex items-center justify-center
        ${variants[variant]}
        ${sizes[size]}
        ${className}
      `}
      {...props}
    >
      {icon}
    </button>
  );

  if (tooltip) {
    return (
      <Tooltip content={tooltip}>
        {buttonElement}
      </Tooltip>
    );
  }

  return buttonElement;
});

IconButton.displayName = 'IconButton';









================================================================================
FILE: src\components\UI\Input.tsx
================================================================================
import React, { InputHTMLAttributes, ReactNode } from 'react';

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  leftIcon?: ReactNode;
  rightIcon?: ReactNode;
  onRightIconClick?: () => void;
  error?: string;
  containerClassName?: string;
}

export const Input: React.FC<InputProps> = ({
  label,
  leftIcon,
  rightIcon,
  onRightIconClick,
  error,
  containerClassName = '',
  className = '',
  ...props
}) => {
  return (
    <div className={`space-y-1 ${containerClassName}`}>
      {label && (
        <label className="block text-sm font-medium text-slate-900 dark:text-slate-200">
          {label}
        </label>
      )}
      <div className="relative group">
        {leftIcon && (
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary-500 transition-colors">
            {leftIcon}
          </div>
        )}
        <input
          className={`
            block w-full py-2.5 
            ${leftIcon ? 'pl-10' : 'pl-4'} 
            ${rightIcon ? 'pr-10' : 'pr-4'} 
            bg-slate-50 dark:bg-slate-800 
            border rounded-xl 
            text-slate-900 dark:text-white 
            placeholder-slate-400 
            focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent 
            transition-all
            ${error ? 'border-red-300 focus:ring-red-500' : 'border-slate-200 dark:border-slate-700'}
            ${className}
          `}
          {...props}
        />
        {rightIcon && (
          <div 
            className={`absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 ${onRightIconClick ? 'cursor-pointer hover:text-slate-600 dark:hover:text-slate-300' : 'pointer-events-none'}`}
            onClick={onRightIconClick}
          >
            {rightIcon}
          </div>
        )}
      </div>
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
};









================================================================================
FILE: src\components\UI\SectionHeader.tsx
================================================================================
import React from 'react';

interface SectionHeaderProps {
  title: string;
  subtitle?: string;
  action?: React.ReactNode;
  className?: string;
}

export const SectionHeader: React.FC<SectionHeaderProps> = ({ title, subtitle, action, className = '' }) => {
  return (
    <div className={`flex flex-col md:flex-row md:items-center justify-between gap-4 ${className}`}>
      <div>
        <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{title}</h2>
        {subtitle && <p className="text-slate-500 dark:text-slate-400 mt-1">{subtitle}</p>}
      </div>
      {action && <div className="shrink-0">{action}</div>}
    </div>
  );
};









================================================================================
FILE: src\components\UI\TagChip.tsx
================================================================================
import React from 'react';

interface TagChipProps {
  label: string;
  onClick?: () => void;
  active?: boolean;
}

export const TagChip: React.FC<TagChipProps> = ({ label, onClick, active }) => {
  return (
    <button
      onClick={(e) => {
        e.stopPropagation();
        onClick?.();
      }}
      className={`
        inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium transition-colors duration-200 border
        ${active 
          ? 'bg-primary-100 border-primary-200 text-primary-900 dark:bg-primary-900/50 dark:border-primary-800 dark:text-primary-100' 
          : 'bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 hover:border-slate-300 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700'
        }
      `}
    >
      #{label}
    </button>
  );
};









================================================================================
FILE: src\components\UI\TextArea.tsx
================================================================================
import React, { TextareaHTMLAttributes } from 'react';

interface TextAreaProps extends TextareaHTMLAttributes<HTMLTextAreaElement> {
  label?: string;
  error?: string;
  containerClassName?: string;
}

export const TextArea: React.FC<TextAreaProps> = ({
  label,
  error,
  containerClassName = '',
  className = '',
  ...props
}) => {
  return (
    <div className={`space-y-1 ${containerClassName}`}>
      {label && (
        <label className="block text-sm font-medium text-slate-900 dark:text-slate-200">
          {label}
        </label>
      )}
      <textarea
        className={`
          block w-full px-4 py-3
          bg-slate-50 dark:bg-slate-800 
          border rounded-xl 
          text-slate-900 dark:text-white 
          placeholder-slate-400 
          focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent 
          transition-all
          ${error ? 'border-red-300 focus:ring-red-500' : 'border-slate-200 dark:border-slate-700'}
          ${className}
        `}
        {...props}
      />
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
};









================================================================================
FILE: src\components\UI\Toast.tsx
================================================================================
import React, { useEffect, useState, useRef } from 'react';
import { useToastContext, Toast as ToastType } from '@/context/ToastContext';
import { CheckCircle2, AlertCircle, Info, X, AlertTriangle } from 'lucide-react';

const ToastItem: React.FC<{ toast: ToastType; onRemove: (id: string) => void }> = ({ toast, onRemove }) => {
  const [isPaused, setIsPaused] = useState(false);
  const [isVisible, setIsVisible] = useState(false);
  
  // Default durations: 2.5s for success/info, 5s for error/warning
  const duration = toast.duration || (toast.type === 'error' || toast.type === 'warning' ? 5000 : 2500);
  
  const timeRef = useRef(duration);
  const timerRef = useRef<number | undefined>(undefined);
  const lastStartRef = useRef<number>(0);

  // Trigger entrance animation
  useEffect(() => {
    requestAnimationFrame(() => setIsVisible(true));
  }, []);

  // Timer Logic with Pause/Resume
  useEffect(() => {
    if (isPaused) {
      if (timerRef.current) window.clearTimeout(timerRef.current);
      return;
    }

    lastStartRef.current = Date.now();
    
    timerRef.current = window.setTimeout(() => {
      setIsVisible(false); // Trigger exit animation
      setTimeout(() => onRemove(toast.id), 300); // Wait for animation
    }, timeRef.current);

    return () => {
      if (timerRef.current) window.clearTimeout(timerRef.current);
    };
  }, [isPaused, toast.id, onRemove]);

  const handleMouseEnter = () => {
    setIsPaused(true);
    const elapsed = Date.now() - lastStartRef.current;
    timeRef.current = Math.max(0, timeRef.current - elapsed);
  };

  const handleMouseLeave = () => {
    setIsPaused(false);
  };

  const handleAction = (e: React.MouseEvent) => {
    e.stopPropagation();
    if (toast.onAction) toast.onAction();
    setIsVisible(false);
    setTimeout(() => onRemove(toast.id), 300);
  };

  return (
    <div
      onMouseEnter={handleMouseEnter}
      onMouseLeave={handleMouseLeave}
      className={`
        pointer-events-auto 
        w-full max-w-[360px] 
        flex items-center gap-3 
        p-3.5 
        bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl
        border border-slate-200/50 dark:border-slate-700/50
        rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-black/50
        transition-all duration-500 ease-out
        ${isVisible ? 'translate-y-0 opacity-100 scale-100' : 'translate-y-4 opacity-0 scale-95'}
      `}
      role="alert"
    >
      {/* Icon */}
      <div className="shrink-0 flex items-center">
        {toast.type === 'success' && <CheckCircle2 size={20} className="text-green-600 dark:text-green-400" />}
        {toast.type === 'error' && <AlertCircle size={20} className="text-red-600 dark:text-red-400" />}
        {toast.type === 'warning' && <AlertTriangle size={20} className="text-amber-600 dark:text-amber-400" />}
        {toast.type === 'info' && <Info size={20} className="text-blue-600 dark:text-blue-400" />}
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <h4 className="text-sm font-bold text-slate-900 dark:text-white leading-tight">
          {toast.title}
        </h4>
        {toast.description && (
          <p className="text-[11px] text-slate-500 dark:text-slate-400 mt-0.5 leading-tight line-clamp-1">
            {toast.description}
          </p>
        )}
      </div>

      {/* Action Button - High Contrast Style */}
      {toast.actionLabel && (
        <button
          onClick={handleAction}
          className="shrink-0 text-xs font-bold text-white dark:text-slate-900 bg-slate-900 dark:bg-white border border-transparent px-3 py-1.5 rounded-lg hover:opacity-90 transition-all shadow-sm whitespace-nowrap active:scale-95"
        >
          {toast.actionLabel}
        </button>
      )}

      {/* Close Button */}
      <button 
        onClick={() => {
            setIsVisible(false);
            setTimeout(() => onRemove(toast.id), 300);
        }}
        className="shrink-0 p-1 text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
        aria-label="Dismiss"
      >
        <X size={16} />
      </button>
    </div>
  );
};

export const ToastContainer: React.FC = () => {
  const { toasts, removeToast } = useToastContext();

  return (
    <div className="fixed z-[100] inset-x-0 bottom-0 p-4 pointer-events-none flex flex-col items-center sm:items-end gap-3 sm:bottom-6 sm:right-6">
      {toasts.map((toast) => (
        <ToastItem key={toast.id} toast={toast} onRemove={removeToast} />
      ))}
    </div>
  );
};









================================================================================
FILE: src\components\UI\Tooltip.tsx
================================================================================
import React, { useState, useRef, ReactElement } from 'react';
import { createPortal } from 'react-dom';

interface TooltipProps {
  content: string;
  children: ReactElement;
  position?: 'top' | 'bottom';
}

export const Tooltip: React.FC<TooltipProps> = ({ content, children, position = 'top' }) => {
  const [isVisible, setIsVisible] = useState(false);
  const [coords, setCoords] = useState({ top: 0, left: 0 });
  const triggerRef = useRef<HTMLElement>(null);
  const timeoutRef = useRef<ReturnType<typeof setTimeout>>(null);

  const showTooltip = () => {
    timeoutRef.current = setTimeout(() => {
      if (triggerRef.current) {
        const rect = triggerRef.current.getBoundingClientRect();
        setCoords({
          top: position === 'top' ? rect.top - 10 : rect.bottom + 10,
          left: rect.left + rect.width / 2,
        });
        setIsVisible(true);
      }
    }, 300); // 300ms delay for smoother UX
  };

  const hideTooltip = () => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    setIsVisible(false);
  };

  return (
    <>
      {React.cloneElement(children, {
        ref: triggerRef,
        onMouseEnter: showTooltip,
        onMouseLeave: hideTooltip,
        onFocus: showTooltip,
        onBlur: hideTooltip
      } as any)}
      
      {isVisible && createPortal(
        <div
          className={`fixed z-[70] px-3 py-1.5 text-xs font-semibold text-slate-100 bg-slate-900/90 dark:bg-slate-700/90 backdrop-blur-sm rounded-lg shadow-xl pointer-events-none transform -translate-x-1/2 animate-in fade-in zoom-in-95 duration-200 whitespace-nowrap border border-slate-700/50 ${
            position === 'top' ? '-translate-y-full' : ''
          }`}
          style={{ top: coords.top, left: coords.left }}
        >
          {content}
          <div 
            className={`absolute left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-900/90 dark:bg-slate-700/90 transform rotate-45 border-slate-700/50 ${
                position === 'top' ? 'bottom-[-4px] border-r border-b' : 'top-[-4px] border-l border-t'
            }`} 
          />
        </div>,
        document.body
      )}
    </>
  );
};









================================================================================
FILE: src\components\VideoPlayer.tsx
================================================================================
import React from 'react';
import { ExternalLink, Youtube } from 'lucide-react';

interface VideoPlayerProps {
  src: string;
  poster?: string;
  className?: string;
}

export const VideoPlayer: React.FC<VideoPlayerProps> = ({ src, poster, className = '' }) => {
  // Helper to extract YouTube ID
  const getYoutubeId = (url: string) => {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  };

  const youtubeId = getYoutubeId(src);

  if (youtubeId) {
    return (
      <div className={`flex flex-col gap-2 ${className}`}>
        <div className="relative w-full rounded-xl overflow-hidden bg-black aspect-video shadow-sm border border-slate-100 dark:border-slate-800">
          <iframe
            className="w-full h-full"
            src={`https://www.youtube-nocookie.com/embed/${youtubeId}?rel=0&origin=${window.location.origin}`}
            title="YouTube video player"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowFullScreen
          ></iframe>
        </div>
        <a
          href={src}
          target="_blank"
          rel="noopener noreferrer"
          onClick={(e) => e.stopPropagation()}
          className="flex items-center gap-1.5 text-xs font-bold text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition-colors w-fit px-2 py-1 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20"
        >
          <Youtube size={16} />
          <span>Watch on YouTube</span>
          <ExternalLink size={12} className="ml-0.5" />
        </a>
      </div>
    );
  }

  // Fallback for standard video files (mp4, etc.)
  return (
    <div className={`relative w-full rounded-xl overflow-hidden bg-black aspect-video group/video shadow-sm border border-slate-100 dark:border-slate-800 ${className}`}>
      <video
        controls
        className="w-full h-full"
        poster={poster}
        src={src}
        preload="metadata"
        onClick={(e) => e.stopPropagation()}
      >
        Your browser does not support the video tag.
      </video>
    </div>
  );
};








================================================================================
FILE: src\constants\theme.ts
================================================================================
export interface AccentTheme {
  bg: string;
  text: string;
  light: string;
}

const COLLECTION_COLORS: AccentTheme[] = [
  { bg: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-50' },
  { bg: 'bg-emerald-500', text: 'text-emerald-600', light: 'bg-emerald-50' },
  { bg: 'bg-indigo-500', text: 'text-indigo-600', light: 'bg-indigo-50' },
  { bg: 'bg-amber-500', text: 'text-amber-600', light: 'bg-amber-50' },
  { bg: 'bg-teal-500', text: 'text-teal-600', light: 'bg-teal-50' },
  { bg: 'bg-cyan-500', text: 'text-cyan-600', light: 'bg-cyan-50' },
  { bg: 'bg-slate-500', text: 'text-slate-600', light: 'bg-slate-50' },
];

/**
 * Deterministically gets a color theme based on a string ID.
 */
export const getCollectionTheme = (id: string): AccentTheme => {
  const sum = id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
  return COLLECTION_COLORS[sum % COLLECTION_COLORS.length];
};









================================================================================
FILE: src\context\AuthContext.tsx
================================================================================
import React, { createContext, useContext, useState, useEffect, useCallback, useMemo } from 'react';
import { User as LegacyUser } from '@/types';
import { User as ModularUser } from '../types/user';
import { LoginPayload, SignupPayload, AuthProvider as AuthProviderType } from '../types/auth';
import { authService } from '@/services/authService';
import { FeatureFlags, SignupConfig } from '@/admin/types/admin';
import { adminConfigService } from '@/admin/services/adminConfigService';

interface AuthContextType {
  user: LegacyUser | null; // Backward compatibility
  modularUser: ModularUser | null; // New Schema
  isAuthenticated: boolean;
  isLoading: boolean;
  token: string | null;
  featureFlags: FeatureFlags | null;
  signupConfig: SignupConfig | null;
  login: (payload: LoginPayload) => Promise<void>;
  signup: (payload: SignupPayload) => Promise<void>;
  socialLogin: (provider: AuthProviderType) => Promise<void>;
  logout: () => Promise<void>;
  isAuthModalOpen: boolean;
  openAuthModal: (view?: 'login' | 'signup') => void;
  closeAuthModal: () => void;
  authModalView: 'login' | 'signup';
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

const AUTH_STORAGE_KEY = 'nuggets_auth_data_v2'; // Bumped version for schema change

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [modularUser, setModularUser] = useState<ModularUser | null>(null);
  const [token, setToken] = useState<string | null>(null);
  const [featureFlags, setFeatureFlags] = useState<FeatureFlags | null>(null);
  const [signupConfig, setSignupConfig] = useState<SignupConfig | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  
  // Modal State
  const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
  const [authModalView, setAuthModalView] = useState<'login' | 'signup'>('login');

  // Hydrate from storage & Load Flags
  useEffect(() => {
    const init = async () => {
      try {
        // 1. Load Auth
        const stored = localStorage.getItem(AUTH_STORAGE_KEY);
        if (stored) {
          const { user: storedUser, token: storedToken } = JSON.parse(stored);
          setModularUser(storedUser);
          setToken(storedToken);
        }
        
        // 2. Load Global Config
        const [flags, sConf] = await Promise.all([
            adminConfigService.getFeatureFlags(),
            adminConfigService.getSignupConfig()
        ]);
        setFeatureFlags(flags);
        setSignupConfig(sConf);

      } catch (e) {
        console.error("Initialization failed", e);
        localStorage.removeItem(AUTH_STORAGE_KEY);
      } finally {
        setIsLoading(false);
      }
    };
    init();
  }, []);

  const persistAuth = (u: ModularUser, t: string) => {
    localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ user: u, token: t }));
    setModularUser(u);
    setToken(t);
  };

  // --- ADAPTER: Modular -> Legacy ---
  const legacyUser: LegacyUser | null = useMemo(() => {
    if (!modularUser) return null;
    return {
      id: modularUser.id,
      name: modularUser.profile.displayName,
      username: modularUser.profile.username,
      email: modularUser.auth.email,
      role: modularUser.role,
      status: 'active', // Default
      joinedAt: modularUser.auth.createdAt,
      authProvider: modularUser.auth.provider,
      emailVerified: modularUser.auth.emailVerified,
      phoneNumber: modularUser.profile.phoneNumber,
      avatarUrl: modularUser.profile.avatarUrl,
      preferences: {
        interestedCategories: modularUser.preferences.interestedCategories
      },
      lastFeedVisit: modularUser.appState.lastLoginAt
    };
  }, [modularUser]);

  const login = async (payload: LoginPayload) => {
    const response = await authService.loginWithEmail(payload);
    persistAuth(response.user, response.token);
    closeAuthModal();
  };

  const signup = async (payload: SignupPayload) => {
    const response = await authService.signupWithEmail(payload);
    persistAuth(response.user, response.token);
    closeAuthModal();
  };

  const socialLogin = async (provider: AuthProviderType) => {
    const response = await authService.loginWithProvider(provider);
    persistAuth(response.user, response.token);
    closeAuthModal();
  };

  const logout = async () => {
    try {
        await authService.logoutApi();
    } catch (e) {
        console.error("Logout API failed", e);
    }
    localStorage.removeItem(AUTH_STORAGE_KEY);
    setModularUser(null);
    setToken(null);
  };

  const openAuthModal = useCallback((view: 'login' | 'signup' = 'login') => {
      setAuthModalView(view);
      setIsAuthModalOpen(true);
  }, []);

  const closeAuthModal = useCallback(() => {
      setIsAuthModalOpen(false);
  }, []);

  return (
    <AuthContext.Provider value={{
      user: legacyUser, // Expose adapted legacy user
      modularUser,      // Expose new schema
      isAuthenticated: !!modularUser,
      isLoading,
      token,
      featureFlags,
      signupConfig,
      login,
      signup,
      socialLogin,
      logout,
      isAuthModalOpen,
      openAuthModal,
      closeAuthModal,
      authModalView
    }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuthContext = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error("useAuthContext must be used within AuthProvider");
  return context;
};





================================================================================
FILE: src\context\ToastContext.tsx
================================================================================
import React, { createContext, useContext, useState, useCallback } from 'react';

export type ToastType = 'success' | 'error' | 'warning' | 'info';

export interface Toast {
  id: string;
  type: ToastType;
  title: string;
  description?: string;
  duration?: number;
  actionLabel?: string;
  onAction?: () => void;
}

interface ToastContextType {
  toasts: Toast[];
  showToast: (options: Omit<Toast, 'id'>) => void;
  removeToast: (id: string) => void;
}

const ToastContext = createContext<ToastContextType | undefined>(undefined);

export const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [toasts, setToasts] = useState<Toast[]>([]);

  const removeToast = useCallback((id: string) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, []);

  const showToast = useCallback((options: Omit<Toast, 'id'>) => {
    const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
    const newToast = { ...options, id };
    
    setToasts((prev) => {
        // Limit max toasts to 3 to prevent clutter
        const updated = [...prev, newToast];
        if (updated.length > 3) return updated.slice(updated.length - 3);
        return updated;
    });
  }, []);

  return (
    <ToastContext.Provider value={{ toasts, showToast, removeToast }}>
      {children}
    </ToastContext.Provider>
  );
};

export const useToastContext = () => {
  const context = useContext(ToastContext);
  if (!context) {
    throw new Error('useToastContext must be used within a ToastProvider');
  }
  return context;
};









================================================================================
FILE: src\data\articles.ts
================================================================================
import { Article } from '@/types';

export const ARTICLES: Article[] = [
  {
    id: '1',
    title: "SaaS is more than just a buzzword",
    excerpt: "Discover how software as a service is reshaping the global economy and enabling rapid scaling for small businesses.",
    content: "Software as a Service (SaaS) has fundamentally shifted how companies operate. Gone are the days of purchasing expensive licenses and managing on-premise servers.",
    author: { id: "u1", name: "Akash Solanki" },
    publishedAt: "2025-11-25T18:12:00",
    created_at: "2025-11-25T18:12:00",
    updated_at: "2025-11-25T18:12:00",
    categories: ["Finance", "Business"],
    tags: ["Business", "SaaS"],
    readTime: 5,
    engagement: { likes: 120, bookmarks: 45, shares: 12, views: 1500 },
    source_type: 'link',
    visibility: 'public',
    media: {
        type: "image",
        url: "https://picsum.photos/seed/tech/800/400",
        aspect_ratio: "16:9",
        previewMetadata: {
            url: "https://stripe.com",
            title: "Stripe | Financial Infrastructure",
            description: "Financial infrastructure for the internet.",
            imageUrl: "https://picsum.photos/seed/tech/800/400",
            providerName: "Stripe"
        }
    }
  },
  {
    id: '2',
    title: "The future of remote work",
    excerpt: "Exploring how distributed teams are becoming the new norm and what it means for productivity and company culture.",
    content: "Remote work has transformed from a temporary solution to a permanent fixture in the modern workplace.",
    author: { id: "u2", name: "Hemant Sharma" },
    publishedAt: "2025-11-24T14:30:00",
    created_at: "2025-11-24T14:30:00",
    updated_at: "2025-11-24T14:30:00",
    categories: ["Business", "Lifestyle"],
    tags: ["Remote Work", "Culture"],
    readTime: 4,
    engagement: { likes: 89, bookmarks: 32, shares: 8, views: 1200 },
    source_type: 'link',
    visibility: 'public'
  },
  {
    id: '3',
    title: "Climate tech investments surge",
    excerpt: "Venture capital is pouring into climate technology startups as the world races to meet carbon neutrality goals.",
    content: "The climate tech sector has seen unprecedented growth in funding over the past year.",
    author: { id: "u1", name: "Akash Solanki" },
    publishedAt: "2025-11-23T10:15:00",
    created_at: "2025-11-23T10:15:00",
    updated_at: "2025-11-23T10:15:00",
    categories: ["Environment", "Finance"],
    tags: ["Climate", "Investment"],
    readTime: 6,
    engagement: { likes: 156, bookmarks: 67, shares: 23, views: 2100 },
    source_type: 'link',
    visibility: 'public'
  },
  {
    id: '4',
    title: "India's economic growth trajectory",
    excerpt: "Analyzing the factors driving India's rapid economic expansion and its position in the global market.",
    content: "India has emerged as one of the fastest-growing major economies in the world.",
    author: { id: "u2", name: "Hemant Sharma" },
    publishedAt: "2025-11-22T16:45:00",
    created_at: "2025-11-22T16:45:00",
    updated_at: "2025-11-22T16:45:00",
    categories: ["Finance", "Growth"],
    tags: ["India", "Economy"],
    readTime: 7,
    engagement: { likes: 234, bookmarks: 98, shares: 45, views: 3400 },
    source_type: 'link',
    visibility: 'public'
  },
  {
    id: '5',
    title: "AI in healthcare: promise and challenges",
    excerpt: "How artificial intelligence is revolutionizing medical diagnosis while navigating ethical considerations.",
    content: "Artificial intelligence is making significant strides in healthcare, from diagnostic tools to treatment recommendations.",
    author: { id: "u1", name: "Akash Solanki" },
    publishedAt: "2025-11-21T09:20:00",
    created_at: "2025-11-21T09:20:00",
    updated_at: "2025-11-21T09:20:00",
    categories: ["Health", "Tech"],
    tags: ["AI", "Healthcare"],
    readTime: 5,
    engagement: { likes: 178, bookmarks: 54, shares: 19, views: 1800 },
    source_type: 'link',
    visibility: 'public'
  },
  {
    id: '6',
    title: "Design systems for scale",
    excerpt: "Building maintainable design systems that grow with your product and team.",
    content: "A well-designed system is crucial for maintaining consistency as products and teams scale.",
    author: { id: "u2", name: "Hemant Sharma" },
    publishedAt: "2025-11-20T13:10:00",
    created_at: "2025-11-20T13:10:00",
    updated_at: "2025-11-20T13:10:00",
    categories: ["Design", "Tech"],
    tags: ["Design Systems", "UX"],
    readTime: 4,
    engagement: { likes: 145, bookmarks: 43, shares: 15, views: 1600 },
    source_type: 'link',
    visibility: 'public'
  }
];







================================================================================
FILE: src\hooks\useArticles.ts
================================================================================
import { useQuery } from '@tanstack/react-query';
import { articleService } from '@/services/articleService';
import { FilterState, SortOrder } from '@/types';

interface UseArticlesOptions {
  searchQuery: string;
  selectedCategories: string[];
  selectedTag: string | null;
  sortOrder: SortOrder;
  userId?: string;
  limit?: number;
}

export const useArticles = ({
  searchQuery,
  selectedCategories,
  selectedTag,
  sortOrder,
  limit
}: UseArticlesOptions) => {
  return useQuery({
    queryKey: ['articles', 'discover', searchQuery, selectedCategories, selectedTag, sortOrder, limit],
    queryFn: async () => {
      // Standard Discover Feed
      const filters: FilterState = {
        query: searchQuery,
        categories: selectedCategories,
        tag: selectedTag,
        sort: sortOrder,
        limit
      };
      return articleService.getArticles(filters);
    },
    // Keep previous data to avoid flickering
    placeholderData: (previousData) => previousData,
    staleTime: 1000 * 60 * 2, // 2 minutes
  });
};









================================================================================
FILE: src\hooks\useAuth.ts
================================================================================
import { useAuthContext } from '@/context/AuthContext';

// Wrapper hook to maintain compatibility with existing components
// and provide easy access to auth context
export const useAuth = () => {
  const context = useAuthContext();
  
  return {
    ...context,
    currentUser: context.user,
    currentUserId: context.user?.id || '', // Fallback for components demanding an ID string
    isAdmin: context.user?.role === 'admin'
  };
};







================================================================================
FILE: src\hooks\useBookmarks.ts
================================================================================
import { useState, useEffect } from 'react';
import { useAuth } from './useAuth';
import { storageService } from '@/services/storageService';

export const useBookmarks = () => {
  const [bookmarks, setBookmarks] = useState<string[]>([]);
  const { currentUserId } = useAuth();

  useEffect(() => {
    const saved = localStorage.getItem('newsbytes_bookmarks');
    if (saved) {
      setBookmarks(JSON.parse(saved));
    }
  }, []);

  const toggleBookmark = async (articleId: string) => {
    // Optimistic Update
    const isAdding = !bookmarks.includes(articleId);
    
    setBookmarks(prev => {
      const newBookmarks = isAdding
        ? [...prev, articleId]
        : prev.filter(id => id !== articleId);
      
      localStorage.setItem('newsbytes_bookmarks', JSON.stringify(newBookmarks));
      return newBookmarks;
    });

    // Background Sync with "General Bookmarks" Collection
    if (currentUserId) {
        try {
            const collections = await storageService.getCollections();
            // Find user's general bookmarks
            let generalCol = collections.find(c => c.creatorId === currentUserId && c.name === 'General Bookmarks' && c.type === 'private');
            
            // Auto-create if missing
            if (!generalCol) {
                generalCol = await storageService.createCollection('General Bookmarks', 'Auto-saved bookmarks.', currentUserId, 'private');
            }

            if (isAdding) {
                await storageService.addArticleToCollection(generalCol.id, articleId, currentUserId);
            } else {
                await storageService.removeArticleFromCollection(generalCol.id, articleId, currentUserId);
            }
        } catch (error) {
            console.error("Failed to sync bookmark with collection:", error);
        }
    }
  };

  const isBookmarked = (articleId: string) => bookmarks.includes(articleId);

  return { bookmarks, toggleBookmark, isBookmarked };
};









================================================================================
FILE: src\hooks\useRequireAuth.ts
================================================================================
import { useCallback } from 'react';
import { useAuthContext } from '@/context/AuthContext';
import { FeatureFlags } from '@/admin/types/admin';

export const useRequireAuth = () => {
  const { isAuthenticated, openAuthModal, featureFlags } = useAuthContext();

  const withAuth = useCallback((callback: (...args: any[]) => void, featureKey?: keyof FeatureFlags) => {
    return (...args: any[]) => {
      // 1. If user is authenticated, always allow
      if (isAuthenticated) {
        callback(...args);
        return;
      }

      // 2. If a specific feature key is provided, check if it's allowed for guests
      // e.g. if featureKey is 'guestBookmarks' and flag is true, allow it.
      if (featureKey && featureFlags && featureFlags[featureKey]) {
        callback(...args);
        return;
      }

      // 3. Otherwise, block and show login
      openAuthModal('login');
    };
  }, [isAuthenticated, openAuthModal, featureFlags]);

  return { withAuth };
};





================================================================================
FILE: src\hooks\useRowExpansion.ts
================================================================================
import { useState, useCallback, useRef } from 'react';

export const useRowExpansion = () => {
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const cardRefs = useRef<Map<string, HTMLDivElement>>(new Map());

  const registerCard = useCallback((id: string, el: HTMLDivElement | null) => {
    if (el) {
      cardRefs.current.set(id, el);
    } else {
      cardRefs.current.delete(id);
    }
  }, []);

  const toggleExpansion = useCallback((id: string) => {
    setExpandedId(prev => (prev === id ? null : id));
  }, []);

  return {
    expandedId,
    toggleExpansion,
    registerCard
  };
};









================================================================================
FILE: src\hooks\useShare.ts
================================================================================
import React, { useState, useCallback } from 'react';

export const useShare = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [anchorRect, setAnchorRect] = useState<DOMRect | null>(null);

  const handleShareClick = useCallback((event: React.MouseEvent) => {
    event.preventDefault();
    event.stopPropagation();
    setAnchorRect(event.currentTarget.getBoundingClientRect());
    setIsOpen(true);
  }, []);

  const handleClose = useCallback(() => {
    setIsOpen(false);
    setAnchorRect(null);
  }, []);

  return {
    isOpen,
    anchorRect,
    handleShareClick,
    handleClose
  };
};









================================================================================
FILE: src\hooks\useToast.ts
================================================================================
import { useToastContext, ToastType } from '@/context/ToastContext';

interface ToastOptions {
  duration?: number;
  description?: string;
  actionLabel?: string;
  onAction?: () => void;
}

export const useToast = () => {
  const { showToast } = useToastContext();

  const trigger = (type: ToastType, title: string, optionsOrDesc?: string | ToastOptions) => {
    let options: ToastOptions = {};
    
    if (typeof optionsOrDesc === 'string') {
      options = { description: optionsOrDesc };
    } else if (optionsOrDesc) {
      options = optionsOrDesc;
    }

    showToast({
      type,
      title,
      description: options.description,
      duration: options.duration,
      actionLabel: options.actionLabel,
      onAction: options.onAction,
    });
  };

  return {
    success: (title: string, options?: string | ToastOptions) => trigger('success', title, options),
    error: (title: string, options?: string | ToastOptions) => trigger('error', title, options),
    warning: (title: string, options?: string | ToastOptions) => trigger('warning', title, options),
    info: (title: string, options?: string | ToastOptions) => trigger('info', title, options),
    
    // Low-level access
    show: (opts: { type: ToastType; title: string } & ToastOptions) => showToast(opts)
  };
};









================================================================================
FILE: src\main.tsx
================================================================================
import React from 'react';
import { createRoot } from 'react-dom/client';
import { HashRouter as Router } from 'react-router-dom';
import { QueryClientProvider } from '@tanstack/react-query';
import { queryClient } from './queryClient';
import { ToastProvider } from './context/ToastContext';
import { AuthProvider } from './context/AuthContext';
import App from './App';
import './index.css';

const renderApp = () => {
  const container = document.getElementById('root');
  
  if (container) {
    const root = createRoot(container);
    root.render(
      <React.StrictMode>
        <QueryClientProvider client={queryClient}>
          <Router>
            <ToastProvider>
              <AuthProvider>
                <App />
              </AuthProvider>
            </ToastProvider>
          </Router>
        </QueryClientProvider>
      </React.StrictMode>
    );
  } else {
    console.error("Failed to find the root element. Application cannot mount.");
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', renderApp);
} else {
  renderApp();
}





================================================================================
FILE: src\mocks\mockUser.ts
================================================================================
import { createDefaultUser } from '@/models/userDefaults';
import { User } from '@/types/user';

export const MOCK_USER_ID = 'u_123456';

export const mockUser: User = createDefaultUser(MOCK_USER_ID, 'akash@nuggets.app', {
  role: 'admin',
  profile: {
    displayName: 'Akash Solanki',
    username: 'akash_ux',
    bio: 'Building minimalist interfaces. Architect @ Nuggets.',
    avatarColor: 'indigo',
    location: 'San Francisco, CA',
    website: 'https://akash.design',
  },
  preferences: {
    interestedCategories: ['Tech', 'Design', 'Psychology'],
    compactMode: false,
    theme: 'light',
  },
  appState: {
    onboardingCompleted: true,
    lastLoginAt: new Date().toISOString(),
  }
});









================================================================================
FILE: src\models\userDefaults.ts
================================================================================
import { 
  User, UserAuth, UserProfile, UserPreferences, UserSecurity, UserAppState 
} from '../types/user';

// Helper type for deep partial overrides
type DeepPartial<T> = {
  [P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : T[P];
};

export const createDefaultUserAuth = (overrides?: Partial<UserAuth>): UserAuth => ({
  email: '',
  emailVerified: false,
  provider: 'email',
  createdAt: new Date().toISOString(),
  ...overrides,
});

export const createDefaultUserProfile = (overrides?: Partial<UserProfile>): UserProfile => ({
  displayName: 'New User',
  username: '',
  avatarColor: 'blue',
  ...overrides,
});

export const createDefaultUserSecurity = (overrides?: Partial<UserSecurity>): UserSecurity => ({
  mfaEnabled: false,
  ...overrides,
});

export const createDefaultUserPreferences = (overrides?: DeepPartial<UserPreferences>): UserPreferences => {
  const { notifications, ...rest } = overrides || {};

  return {
    theme: 'system',
    defaultVisibility: 'public',
    interestedCategories: [],
    compactMode: false,
    richMediaPreviews: true,
    autoFollowCollections: true,
    ...rest as any,
    notifications: {
      emailDigest: true,
      productUpdates: false,
      newFollowers: true,
      ...notifications,
    },
  };
};

export const createDefaultUserAppState = (overrides?: Partial<UserAppState>): UserAppState => ({
  onboardingCompleted: false,
  ...overrides,
});

export const createDefaultUser = (
  id: string, 
  email: string, 
  overrides?: DeepPartial<User>
): User => {
  return {
    id,
    role: overrides?.role || 'user',
    auth: createDefaultUserAuth({ email, ...overrides?.auth }),
    profile: createDefaultUserProfile(overrides?.profile),
    security: createDefaultUserSecurity(overrides?.security),
    preferences: createDefaultUserPreferences(overrides?.preferences),
    appState: createDefaultUserAppState(overrides?.appState),
  };
};





================================================================================
FILE: src\models\userFormMappers.ts
================================================================================
import { User, UserProfile, UserPreferences } from '../types/user';
import { ProfileFormValues, PreferencesFormValues } from '../types/userSettingsForms';

// --- PROFILE ---

export const userToProfileForm = (user: User): ProfileFormValues => ({
  displayName: user.profile.displayName,
  username: user.profile.username,
  bio: user.profile.bio || '',
  phoneNumber: user.profile.phoneNumber || '',
  avatarColor: user.profile.avatarColor || 'blue',
  location: user.profile.city ? `${user.profile.city}, ${user.profile.country}` : (user.profile.location || ''),
  website: user.profile.website || '',
});

export const profileFormToUpdatePayload = (form: ProfileFormValues): Partial<UserProfile> => ({
  displayName: form.displayName,
  username: form.username,
  bio: form.bio,
  phoneNumber: form.phoneNumber,
  avatarColor: form.avatarColor,
  location: form.location,
  website: form.website,
});

// --- PREFERENCES ---

export const userToPreferencesForm = (user: User): PreferencesFormValues => ({
  theme: user.preferences.theme,
  defaultVisibility: user.preferences.defaultVisibility,
  compactMode: user.preferences.compactMode,
  richMediaPreviews: user.preferences.richMediaPreviews,
  autoFollowCollections: user.preferences.autoFollowCollections,
});

export const preferencesFormToUpdatePayload = (form: PreferencesFormValues): Partial<UserPreferences> => ({
  ...form
});





================================================================================
FILE: src\models\userMappers.ts
================================================================================
import { User } from '../types/user';
import { createDefaultUser } from './userDefaults';

// Assume backend payload is flat or snake_cased
interface BackendUserPayload {
  _id: string;
  email: string;
  role?: string;
  display_name?: string;
  username?: string;
  avatar_url?: string;
  preferences?: any;
  created_at?: string;
  // ... other fields
}

export const mapBackendUserToUser = (payload: BackendUserPayload): User => {
  // We use the factory to ensure no fields are missing, 
  // layering the backend data on top.
  return createDefaultUser(payload._id, payload.email, {
    role: (payload.role === 'admin' ? 'admin' : 'user'),
    auth: {
      createdAt: payload.created_at,
    },
    profile: {
      displayName: payload.display_name,
      username: payload.username,
      avatarUrl: payload.avatar_url,
    },
    preferences: payload.preferences, // Assume structure matches or add sub-mapper here
  });
};

export const mapUserToUpdatePayload = (user: User): Partial<BackendUserPayload> => {
  // Flattens the modular object back for API consumption
  return {
    email: user.auth.email,
    display_name: user.profile.displayName,
    username: user.profile.username,
    preferences: user.preferences,
  };
};









================================================================================
FILE: src\pages\AccountSettingsPage.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '@/hooks/useAuth';
import { useToast } from '@/hooks/useToast';
import { userSettingsService } from '@/services/userSettingsService';
import { SettingsSectionCard } from '@/components/settings/SettingsSectionCard';
import { SettingsSidebarNav } from '@/components/settings/SettingsSidebarNav';
import { AvatarSelectorModal } from '@/components/settings/AvatarSelectorModal';
import { ConfirmActionModal } from '@/components/settings/ConfirmActionModal';
import { Input } from '@/components/UI/Input';
import { TextArea } from '@/components/UI/TextArea';
import { getInitials } from '@/utils/formatters';
import { User, Mail, Shield, Check, Loader2, Camera, Eye, EyeOff, LayoutTemplate, Globe, Link as LinkIcon, UserPlus, AlertTriangle, ChevronDown } from 'lucide-react';
import { ProfileFormData, UserPreferences, AVATAR_COLORS } from '@/types/settings';
import { userToProfileForm, userToPreferencesForm } from '@/models/userFormMappers';
import { adminConfigService } from '@/admin/services/adminConfigService';

const Label: React.FC<{ children: React.ReactNode }> = ({ children }) => (
  <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide mb-1.5 ml-1">
    {children}
  </label>
);

interface ToggleProps {
  label: string;
  description?: string;
  checked: boolean;
  onChange: () => void;
  icon?: React.ReactNode;
}

const Toggle: React.FC<ToggleProps> = ({ label, description, checked, onChange, icon }) => (
  <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-transparent hover:border-slate-200 dark:hover:border-slate-700 transition-colors">
    <div className="flex items-start gap-3">
      {icon && <div className="mt-0.5 text-slate-400">{icon}</div>}
      <div>
        <div className="text-sm font-bold text-slate-900 dark:text-white">{label}</div>
        {description && <div className="text-xs text-slate-500 mt-0.5">{description}</div>}
      </div>
    </div>
    <button 
      onClick={onChange}
      className={`w-11 h-6 rounded-full transition-colors flex items-center px-0.5 ${checked ? 'bg-primary-500' : 'bg-slate-200 dark:bg-slate-700'}`}
    >
      <div className={`w-5 h-5 bg-white rounded-full shadow-sm transition-transform ${checked ? 'translate-x-5' : 'translate-x-0'}`} />
    </button>
  </div>
);

export const AccountSettingsPage: React.FC<{ userId: string }> = ({ userId: _userId }) => {
  const { modularUser, currentUser } = useAuth();
  const toast = useToast();
  
  // --- STATE ---
  const [activeSection, setActiveSection] = useState('profile');
  const [isSavingProfile, setIsSavingProfile] = useState(false);
  const [isSavingSecurity, setIsSavingSecurity] = useState(false);
  const [isDangerZoneOpen, setIsDangerZoneOpen] = useState(false);
  
  // Config State
  const [enableAvatarUpload, setEnableAvatarUpload] = useState(false);
  
  // Modals
  const [showAvatarModal, setShowAvatarModal] = useState(false);
  const [showDeleteModal, setShowDeleteModal] = useState(false);

  // Profile Form
  const [profileData, setProfileData] = useState<ProfileFormData & { avatarUrl?: string }>({
    displayName: '',
    username: '',
    bio: '',
    phoneNumber: '',
    avatarColor: 'blue',
    avatarUrl: ''
  });

  // Security Form
  const [securityData, setSecurityData] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });
  const [showPasswords, setShowPasswords] = useState(false);

  // Preferences Form
  const [preferences, setPreferences] = useState<UserPreferences>({
    defaultVisibility: 'public',
    compactMode: true,
    richMediaPreviews: true,
    autoFollowCollections: false,
    theme: 'system',
    interestedCategories: [],
    notifications: { emailDigest: true, productUpdates: false, newFollowers: true }
  });

  // --- INIT ---
  useEffect(() => {
    // PREFER MODULAR USER if available
    if (modularUser) {
      setProfileData({
          ...userToProfileForm(modularUser),
          avatarUrl: modularUser.profile.avatarUrl
      });
      setPreferences(userToPreferencesForm(modularUser));
    } 
    // FALLBACK to Legacy User if context not yet fully migrated (safety net)
    else if (currentUser) {
      setProfileData({
        displayName: currentUser.name,
        username: currentUser.username || '',
        bio: 'Tech enthusiast and full-stack developer.', // Mock
        phoneNumber: currentUser.phoneNumber || '',
        avatarColor: 'blue',
        avatarUrl: currentUser.avatarUrl
      });
    }

    // Load Config
    adminConfigService.getFeatureFlags().then(flags => {
        setEnableAvatarUpload(flags.enableAvatarUpload);
    });
  }, [modularUser, currentUser]);

  // --- HANDLERS ---

  const scrollToSection = (id: string) => {
    setActiveSection(id);
    const el = document.getElementById(id);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  const handleProfileUpdate = async () => {
    if (!currentUser) return;
    setIsSavingProfile(true);
    try {
      await userSettingsService.updateProfile(currentUser.id, profileData);
      toast.success("Profile updated successfully");
    } catch (e) {
      toast.error("Failed to update profile");
    } finally {
      setIsSavingProfile(false);
    }
  };

  const handlePasswordUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    if (securityData.newPassword !== securityData.confirmPassword) {
      toast.error("New passwords do not match");
      return;
    }
    setIsSavingSecurity(true);
    try {
      await userSettingsService.updatePassword(currentUser!.id, securityData.currentPassword, securityData.newPassword);
      toast.success("Password updated");
      setSecurityData({ currentPassword: '', newPassword: '', confirmPassword: '' });
    } catch (e) {
      toast.error("Incorrect current password");
    } finally {
      setIsSavingSecurity(false);
    }
  };

  const togglePreference = (key: keyof UserPreferences) => {
    if (!currentUser) return;
    const newPrefs = { ...preferences, [key]: !preferences[key] };
    setPreferences(newPrefs);
    userSettingsService.updatePreferences(currentUser.id, newPrefs);
  };

  const handleDeleteAccount = async () => {
    await userSettingsService.deleteAccount(currentUser!.id);
    toast.error("Account deleted. Redirecting...");
    setTimeout(() => window.location.href = '/', 2000);
  };

  const handleAvatarSelection = (result: { type: 'color' | 'image'; value: string }) => {
      if (result.type === 'color') {
          setProfileData({ ...profileData, avatarColor: result.value, avatarUrl: undefined });
      } else {
          setProfileData({ ...profileData, avatarUrl: result.value });
      }
  };

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-20">
      
      {/* Page Header */}
      <div className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 pt-8 pb-8 sticky top-[4.5rem] z-20">
        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
          <h1 className="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">Settings</h1>
          <p className="text-slate-500 dark:text-slate-400 mt-1">Manage your identity, security, and preferences.</p>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start">
          
          {/* Sidebar */}
          <div className="lg:col-span-1">
            <SettingsSidebarNav activeSection={activeSection} onSelect={scrollToSection} />
          </div>

          {/* Content Area */}
          <div className="lg:col-span-3 space-y-8">
            
            {/* 1. PROFILE */}
            <SettingsSectionCard 
              id="profile" 
              title="Public Profile" 
              description="This information will be displayed publicly on your Nuggets profile."
              icon={<User size={20} />}
              rightAction={
                <button 
                  onClick={handleProfileUpdate}
                  disabled={isSavingProfile}
                  className="px-5 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl text-sm font-bold shadow-lg shadow-slate-900/10 hover:scale-105 active:scale-95 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isSavingProfile ? <Loader2 size={16} className="animate-spin" /> : 'Save Changes'}
                </button>
              }
            >
              <div className="flex flex-col sm:flex-row gap-6">
                {/* Avatar */}
                <div className="shrink-0 flex flex-col items-center gap-3">
                  <div className="relative group">
                    <button 
                        onClick={() => setShowAvatarModal(true)}
                        className="relative group rounded-full overflow-hidden shadow-xl transition-transform hover:scale-105"
                    >
                        {profileData.avatarUrl ? (
                            <img src={profileData.avatarUrl} alt="Avatar" className="w-24 h-24 object-cover" />
                        ) : (
                            <div className={`w-24 h-24 flex items-center justify-center text-3xl font-bold text-white ${AVATAR_COLORS[profileData.avatarColor as keyof typeof AVATAR_COLORS] || 'bg-blue-500'}`}>
                                {getInitials(profileData.displayName)}
                            </div>
                        )}
                        <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <Camera size={24} className="text-white drop-shadow-md" />
                        </div>
                    </button>
                  </div>
                  <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Avatar</p>
                </div>

                {/* Fields */}
                <div className="flex-1 space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label>Display Name</Label>
                      <Input 
                        value={profileData.displayName}
                        onChange={(e) => setProfileData({...profileData, displayName: e.target.value})}
                        placeholder="e.g. Jane Doe"
                        className="bg-slate-50 dark:bg-black/20 border-transparent focus:bg-white dark:focus:bg-slate-900"
                      />
                    </div>
                    <div>
                      <Label>Username</Label>
                      <Input 
                        value={profileData.username}
                        onChange={(e) => setProfileData({...profileData, username: e.target.value})}
                        placeholder="@username"
                        leftIcon={<span className="text-slate-400 font-bold">@</span>}
                        className="bg-slate-50 dark:bg-black/20 border-transparent focus:bg-white dark:focus:bg-slate-900"
                      />
                      <p className="text-[10px] text-slate-400 mt-1.5">Unique handle for your profile URL.</p>
                    </div>
                  </div>

                  <div>
                    <Label>Bio</Label>
                    <TextArea 
                      value={profileData.bio}
                      onChange={(e) => setProfileData({...profileData, bio: e.target.value})}
                      placeholder="Tell us a little about yourself..."
                      rows={3}
                      className="bg-slate-50 dark:bg-black/20 border-transparent focus:bg-white dark:focus:bg-slate-900 resize-none"
                    />
                  </div>
                </div>
              </div>
            </SettingsSectionCard>

            {/* 2. ACCOUNT INFO */}
            <SettingsSectionCard 
              id="account" 
              title="Account Information" 
              description="Manage your login details and verification status."
              icon={<Mail size={20} />}
            >
              <div className="flex items-center gap-4 p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-100 dark:border-slate-800">
                <div className="p-3 bg-white dark:bg-slate-800 rounded-full text-slate-400">
                  <Mail size={24} />
                </div>
                <div className="flex-1 min-w-0">
                  <Label>Email Address</Label>
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-bold text-slate-900 dark:text-white">{currentUser?.email}</span>
                    <span className="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-bold bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                      <Check size={10} className="mr-1" /> Verified
                    </span>
                  </div>
                </div>
                {/* Stub Button */}
                <button disabled className="text-xs font-bold text-slate-400 cursor-not-allowed">Change</button>
              </div>
            </SettingsSectionCard>

            {/* 3. SECURITY */}
            <SettingsSectionCard 
              id="security" 
              title="Security" 
              description="Update your password to keep your account safe."
              icon={<Shield size={20} />}
            >
              <form onSubmit={handlePasswordUpdate} className="max-w-md space-y-4">
                <div className="relative">
                  <Label>Current Password</Label>
                  <Input 
                    type={showPasswords ? "text" : "password"}
                    value={securityData.currentPassword}
                    onChange={(e) => setSecurityData({...securityData, currentPassword: e.target.value})}
                    className="bg-slate-50 dark:bg-black/20 border-transparent focus:bg-white dark:focus:bg-slate-900"
                  />
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label>New Password</Label>
                    <Input 
                      type={showPasswords ? "text" : "password"}
                      value={securityData.newPassword}
                      onChange={(e) => setSecurityData({...securityData, newPassword: e.target.value})}
                      className="bg-slate-50 dark:bg-black/20 border-transparent focus:bg-white dark:focus:bg-slate-900"
                    />
                  </div>
                  <div>
                    <Label>Confirm New</Label>
                    <Input 
                      type={showPasswords ? "text" : "password"}
                      value={securityData.confirmPassword}
                      onChange={(e) => setSecurityData({...securityData, confirmPassword: e.target.value})}
                      className="bg-slate-50 dark:bg-black/20 border-transparent focus:bg-white dark:focus:bg-slate-900"
                    />
                  </div>
                </div>

                <div className="flex items-center justify-between pt-2">
                  <button 
                    type="button" 
                    onClick={() => setShowPasswords(!showPasswords)}
                    className="text-xs font-bold text-slate-500 hover:text-slate-800 dark:hover:text-slate-300 flex items-center gap-1.5"
                  >
                    {showPasswords ? <EyeOff size={14} /> : <Eye size={14} />} 
                    {showPasswords ? 'Hide' : 'Show'} Passwords
                  </button>

                  <button 
                    type="submit"
                    disabled={isSavingSecurity || !securityData.currentPassword || !securityData.newPassword}
                    className="px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg text-xs font-bold hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                  >
                    {isSavingSecurity ? 'Updating...' : 'Update Password'}
                  </button>
                </div>
              </form>
            </SettingsSectionCard>

            {/* 4. PREFERENCES */}
            <SettingsSectionCard 
              id="preferences" 
              title="Preferences" 
              description="Customize your Nuggets experience."
              icon={<LayoutTemplate size={20} />}
            >
              <div className="space-y-4">
                {/* Visibility Radio */}
                <div className="p-4 bg-slate-50 dark:bg-black/20 rounded-xl border border-transparent">
                  <Label>Default Nugget Visibility</Label>
                  <div className="flex gap-4 mt-2">
                    <label className="flex items-center gap-2 cursor-pointer group">
                      <input 
                        type="radio" 
                        name="visibility" 
                        checked={preferences.defaultVisibility === 'public'}
                        onChange={() => setPreferences({...preferences, defaultVisibility: 'public'})}
                        className="text-primary-500 focus:ring-primary-500"
                      />
                      <Globe size={16} className="text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300" />
                      <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Public</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer group">
                      <input 
                        type="radio" 
                        name="visibility" 
                        checked={preferences.defaultVisibility === 'private'}
                        onChange={() => setPreferences({...preferences, defaultVisibility: 'private'})}
                        className="text-primary-500 focus:ring-primary-500"
                      />
                      <Shield size={16} className="text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300" />
                      <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Private</span>
                    </label>
                  </div>
                </div>

                <Toggle 
                  label="Compact Card Mode" 
                  description="Reduce whitespace in the feed for denser information."
                  checked={preferences.compactMode} 
                  onChange={() => togglePreference('compactMode')}
                  icon={<LayoutTemplate size={18} />}
                />

                <Toggle 
                  label="Rich Media Previews" 
                  description="Show full-size images and embeds in the feed."
                  checked={preferences.richMediaPreviews} 
                  onChange={() => togglePreference('richMediaPreviews')}
                  icon={<LinkIcon size={18} />}
                />

                <Toggle 
                  label="Auto-Follow Collections" 
                  description="Automatically follow a collection when you contribute to it."
                  checked={preferences.autoFollowCollections} 
                  onChange={() => togglePreference('autoFollowCollections')}
                  icon={<UserPlus size={18} />}
                />
              </div>
            </SettingsSectionCard>

            {/* 5. DANGER ZONE */}
            <div id="danger" className="border border-red-200 dark:border-red-900/30 rounded-2xl overflow-hidden bg-red-50/30 dark:bg-red-900/10">
              <button
                onClick={() => setIsDangerZoneOpen(!isDangerZoneOpen)}
                className="w-full flex items-center justify-between p-6 hover:bg-red-50/80 dark:hover:bg-red-900/20 transition-colors text-left group"
              >
                <div className="flex items-center gap-4">
                  <div className="p-2.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl group-hover:scale-110 transition-transform duration-200">
                    <AlertTriangle size={20} />
                  </div>
                  <div>
                    <h3 className="text-lg font-bold text-red-700 dark:text-red-400">Danger Zone</h3>
                    <p className="text-xs text-red-600/70 dark:text-red-400/70 font-medium">Irreversible actions regarding your account</p>
                  </div>
                </div>
                <ChevronDown size={20} className={`text-red-400 transition-transform duration-300 ${isDangerZoneOpen ? 'rotate-180' : ''}`} />
              </button>

              <div className={`transition-all duration-300 ease-in-out overflow-hidden ${isDangerZoneOpen ? 'max-h-48 opacity-100' : 'max-h-0 opacity-0'}`}>
                <div className="px-6 pb-6 pt-2">
                  <div className="h-px w-full bg-red-200/50 dark:bg-red-900/30 mb-6" />
                  <p className="text-sm text-slate-600 dark:text-slate-300 mb-6 max-w-xl leading-relaxed">
                    Deleting your account is permanent. All your nuggets, collections, and bookmarks will be wiped immediately. This action cannot be undone.
                  </p>
                  <button 
                    onClick={() => setShowDeleteModal(true)}
                    className="px-5 py-2.5 bg-white dark:bg-slate-950 text-red-600 border border-red-200 dark:border-red-900/50 rounded-xl text-sm font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors shadow-sm flex items-center gap-2"
                  >
                    Delete Account
                  </button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      {/* Modals */}
      <AvatarSelectorModal 
        isOpen={showAvatarModal}
        onClose={() => setShowAvatarModal(false)}
        currentName={profileData.displayName}
        currentColor={profileData.avatarColor || 'blue'}
        onSelect={handleAvatarSelection}
        allowUpload={enableAvatarUpload}
      />

      <ConfirmActionModal 
        isOpen={showDeleteModal}
        onClose={() => setShowDeleteModal(false)}
        onConfirm={handleDeleteAccount}
        title="Delete Account?"
        description="This action is irreversible. All your data will be permanently removed from our servers."
        confirmString="DELETE MY ACCOUNT"
        actionLabel="Delete Everything"
        isDestructive={true}
      />

    </div>
  );
};





================================================================================
FILE: src\pages\AdminPanelPage.tsx
================================================================================
import React from 'react';
import { Routes, Route, Navigate } from 'react-router-dom';
import { AdminLayout } from '@/admin/layout/AdminLayout';
import { AdminDashboardPage } from '@/admin/pages/AdminDashboardPage';
import { AdminUsersPage } from '@/admin/pages/AdminUsersPage';
import { AdminNuggetsPage } from '@/admin/pages/AdminNuggetsPage';
import { AdminCollectionsPage } from '@/admin/pages/AdminCollectionsPage';
import { AdminTagsPage } from '@/admin/pages/AdminTagsPage';
import { AdminConfigPage } from '@/admin/pages/AdminConfigPage';
import { AdminModerationPage } from '@/admin/pages/AdminModerationPage';
import { AdminActivityLogPage } from '@/admin/pages/AdminActivityLogPage';
import { AdminFeedbackPage } from '@/admin/pages/AdminFeedbackPage';
import { AdminDownloadsPage } from '@/admin/pages/AdminDownloadsPage';
import { AdminLegalPages } from '@/admin/pages/AdminLegalPages';
import { RequireAdmin } from '@/admin/components/RequireAdmin';

export const AdminPanelPage: React.FC = () => {
  return (
    <RequireAdmin>
      <Routes>
        <Route element={<AdminLayout />}>
          <Route index element={<AdminDashboardPage />} />
          <Route path="dashboard" element={<Navigate to="/admin" replace />} />
          <Route path="users" element={<AdminUsersPage />} />
          <Route path="nuggets" element={<AdminNuggetsPage />} />
          <Route path="collections" element={<AdminCollectionsPage />} />
          <Route path="tags" element={<AdminTagsPage />} />
          <Route path="moderation" element={<AdminModerationPage />} />
          <Route path="activity" element={<AdminActivityLogPage />} />
          <Route path="config" element={<AdminConfigPage />} />
          <Route path="feedback" element={<AdminFeedbackPage />} />
          <Route path="downloads" element={<AdminDownloadsPage />} />
          <Route path="legal" element={<AdminLegalPages />} />
        </Route>
      </Routes>
    </RequireAdmin>
  );
};





================================================================================
FILE: src\pages\BulkCreateNuggetsPage.tsx
================================================================================
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '@/hooks/useAuth';
import { BatchRow, ImportMode } from '@/types/batch';
import { batchService } from '@/services/batchService';
import { BatchPreviewTable } from '@/components/batch/BatchPreviewTable';
import { FileSpreadsheet, FileText, Link as LinkIcon, Download, ChevronRight, Loader2, CheckCircle2, ArrowLeft } from 'lucide-react';
import { useToast } from '@/hooks/useToast';

export const BulkCreateNuggetsPage: React.FC = () => {
  const { currentUserId } = useAuth();
  const navigate = useNavigate();
  const toast = useToast();

  // --- State ---
  const [activeTab, setActiveTab] = useState<ImportMode>('links');
  const [rows, setRows] = useState<BatchRow[]>([]);
  const [step, setStep] = useState<'input' | 'review'>('input');
  
  const [linkInput, setLinkInput] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);

  // --- Handlers ---

  const handleLinksParse = async () => {
    if (!linkInput.trim()) return;
    setIsProcessing(true);
    try {
      const parsed = await batchService.parseLinks(linkInput);
      const withMeta = await batchService.fetchMetadataForRows(parsed);
      setRows(withMeta);
      setStep('review');
    } catch (e) {
      toast.error("Failed to parse links");
    } finally {
      setIsProcessing(false);
    }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, type: 'csv' | 'excel') => {
    const file = e.target.files?.[0];
    if (!file) return;

    setIsProcessing(true);
    try {
      const parsed = type === 'csv' 
        ? await batchService.parseCSV(file) 
        : await batchService.parseExcel(file);
        
      // If titles are missing, try to fetch meta
      const needsMeta = parsed.some(r => !r.title);
      const finalRows = needsMeta ? await batchService.fetchMetadataForRows(parsed) : parsed;
      
      setRows(finalRows);
      setStep('review');
    } catch (e) {
      console.error(e);
      toast.error(`Failed to parse ${type.toUpperCase()} file`);
    } finally {
      setIsProcessing(false);
      // Reset input
      e.target.value = '';
    }
  };

  const handleImport = async () => {
    setIsProcessing(true);
    try {
      const result = await batchService.createBatch(rows, currentUserId);
      setRows(result);
      
      const successCount = result.filter(r => r.status === 'success').length;
      if (successCount > 0) {
        toast.success(`Successfully created ${successCount} nuggets!`);
      }
    } catch (e) {
      toast.error("Batch creation failed");
    } finally {
      setIsProcessing(false);
    }
  };

  // --- Render Helpers ---

  const downloadTemplate = (type: 'csv' | 'excel') => {
    const headers = ['url', 'title', 'text', 'categories', 'visibility'];
    const row = ['https://example.com', 'Example Title', 'Optional note', 'tech, news', 'public'];
    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), row.join(',')].join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    // Use .csv for both as content is csv structure in data uri
    const ext = type === 'excel' ? 'csv' : 'csv';
    link.setAttribute("download", `nuggets_template.${ext}`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-20">
      
      {/* Header */}
      <div className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800">
        <div className="max-w-6xl mx-auto px-4 sm:px-6 py-6">
          <button onClick={() => navigate('/myspace')} className="flex items-center gap-2 text-sm text-slate-500 hover:text-slate-900 dark:hover:text-white mb-4 transition-colors">
            <ArrowLeft size={16} /> Back to My Space
          </button>
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                Batch Nugget Creation
              </h1>
              <p className="text-slate-500 dark:text-slate-400 mt-1">Import multiple nuggets at once from links or files.</p>
            </div>
            {step === 'review' && (
                <div className="flex items-center gap-3">
                   <div className="text-sm font-medium text-slate-500">
                      {rows.filter(r => r.selected).length} items selected
                   </div>
                   <button 
                      onClick={handleImport}
                      disabled={isProcessing || rows.filter(r => r.selected && r.status !== 'success').length === 0}
                      className="px-6 py-2 bg-primary-500 text-slate-900 rounded-xl font-bold text-sm hover:bg-primary-400 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm transition-all"
                   >
                      {isProcessing ? <Loader2 size={16} className="animate-spin" /> : <CheckCircle2 size={16} />}
                      Import Selected
                   </button>
                </div>
            )}
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 sm:px-6 py-8">
        
        {step === 'input' && (
          <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden min-h-[500px] flex flex-col">
            {/* Tabs */}
            <div className="flex border-b border-slate-100 dark:border-slate-800">
              <button 
                onClick={() => setActiveTab('links')}
                className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition-colors ${activeTab === 'links' ? 'border-primary-500 text-slate-900 dark:text-white bg-primary-50/50 dark:bg-primary-900/10' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50'}`}
              >
                <LinkIcon size={18} /> Paste Links
              </button>
              <button 
                onClick={() => setActiveTab('csv')}
                className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition-colors ${activeTab === 'csv' ? 'border-primary-500 text-slate-900 dark:text-white bg-primary-50/50 dark:bg-primary-900/10' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50'}`}
              >
                <FileText size={18} /> Import CSV
              </button>
              <button 
                onClick={() => setActiveTab('excel')}
                className={`flex-1 py-4 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition-colors ${activeTab === 'excel' ? 'border-primary-500 text-slate-900 dark:text-white bg-primary-50/50 dark:bg-primary-900/10' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50'}`}
              >
                <FileSpreadsheet size={18} /> Import Excel
              </button>
            </div>

            <div className="p-8 flex-1 flex flex-col">
              
              {/* LINK MODE */}
              {activeTab === 'links' && (
                <div className="flex flex-col h-full max-w-2xl mx-auto w-full gap-6">
                  <div className="space-y-2">
                    <label className="text-sm font-bold text-slate-700 dark:text-slate-200">Paste URLs (one per line)</label>
                    <textarea 
                      value={linkInput}
                      onChange={(e) => setLinkInput(e.target.value)}
                      placeholder="https://example.com/article-1&#10;https://example.com/article-2"
                      className="w-full h-64 p-4 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 font-mono text-sm resize-none"
                    />
                  </div>
                  <div className="flex justify-end">
                    <button 
                      onClick={handleLinksParse}
                      disabled={!linkInput.trim() || isProcessing}
                      className="px-8 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold hover:opacity-90 disabled:opacity-50 flex items-center gap-2 transition-all shadow-lg shadow-primary-500/20"
                    >
                      {isProcessing ? <Loader2 size={18} className="animate-spin" /> : <>Next <ChevronRight size={18} /></>}
                    </button>
                  </div>
                </div>
              )}

              {/* FILE MODES */}
              {(activeTab === 'csv' || activeTab === 'excel') && (
                <div className="flex flex-col items-center justify-center h-full gap-6 max-w-xl mx-auto w-full text-center">
                   <div className="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-400 mb-2">
                      {activeTab === 'csv' ? <FileText size={40} /> : <FileSpreadsheet size={40} />}
                   </div>
                   
                   <div>
                     <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">Upload your {activeTab === 'csv' ? 'CSV' : 'Excel'} file</h3>
                     <p className="text-sm text-slate-500 dark:text-slate-400">
                       Ensure your file has headers: <code>url, title, text, categories, visibility</code>
                     </p>
                   </div>

                   <div className="flex flex-col gap-4 w-full max-w-sm">
                      <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 dark:border-slate-700 border-dashed rounded-xl cursor-pointer bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group">
                          <div className="flex flex-col items-center justify-center pt-5 pb-6">
                              <p className="mb-2 text-sm text-slate-500 dark:text-slate-400 group-hover:text-primary-600 transition-colors font-bold">Click to upload</p>
                              <p className="text-xs text-slate-500 dark:text-slate-400">or drag and drop</p>
                          </div>
                          <input type="file" className="hidden" accept={activeTab === 'csv' ? ".csv" : ".xlsx, .xls"} onChange={(e) => handleFileUpload(e, activeTab === 'csv' ? 'csv' : 'excel')} />
                      </label>

                      <button 
                        onClick={() => downloadTemplate(activeTab === 'csv' ? 'csv' : 'excel')}
                        className="text-xs font-bold text-primary-600 hover:text-primary-700 flex items-center justify-center gap-1.5 py-2 hover:bg-primary-50 rounded-lg transition-colors"
                      >
                         <Download size={14} /> Download {activeTab.toUpperCase()} Template
                      </button>
                   </div>
                   
                   {isProcessing && <div className="flex items-center gap-2 text-sm font-bold text-slate-500"><Loader2 size={16} className="animate-spin" /> Parsing file...</div>}
                </div>
              )}
            </div>
          </div>
        )}

        {step === 'review' && (
          <div className="space-y-4">
             <div className="flex items-center justify-between">
                <h2 className="text-lg font-bold text-slate-900 dark:text-white">Review & Edit ({rows.length} items)</h2>
                <button onClick={() => { setRows([]); setStep('input'); }} className="text-sm font-bold text-red-500 hover:text-red-600">Discard All</button>
             </div>
             
             <BatchPreviewTable 
                rows={rows}
                onUpdateRow={(id, updates) => setRows(prev => prev.map(r => r.id === id ? { ...r, ...updates } : r))}
                onRemoveRow={(id) => setRows(prev => prev.filter(r => r.id !== id))}
                onRetryRow={async (id) => {
                   const row = rows.find(r => r.id === id);
                   if (!row) return;
                   // Simple retry logic: just refetch meta
                   const [updated] = await batchService.fetchMetadataForRows([{ ...row, status: 'pending', errorMessage: undefined }]);
                   setRows(prev => prev.map(r => r.id === id ? updated : r));
                }}
             />
          </div>
        )}

      </div>
    </div>
  );
};









================================================================================
FILE: src\pages\CollectionDetailPage.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Collection, Article, Contributor } from '@/types';
import { storageService } from '@/services/storageService';
import { ArrowLeft, Folder, Users, Layers, Plus, Info } from 'lucide-react';
import { ArticleGrid } from '@/components/ArticleGrid';
import { useBookmarks } from '@/hooks/useBookmarks';
import { useToast } from '@/hooks/useToast';
import { ArticleModal } from '@/components/ArticleModal';
import { getCollectionTheme } from '@/constants/theme';
import { ShareMenu } from '@/components/shared/ShareMenu';
import { useAuth } from '@/hooks/useAuth';

export const CollectionDetailPage: React.FC = () => {
  const { collectionId } = useParams<{ collectionId: string }>();
  const navigate = useNavigate();
  const toast = useToast();
  const { isBookmarked, toggleBookmark } = useBookmarks();
  const { currentUserId } = useAuth();

  const [collection, setCollection] = useState<Collection | null>(null);
  const [nuggets, setNuggets] = useState<Article[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedArticle, setSelectedArticle] = useState<Article | null>(null);

  useEffect(() => {
    if (collectionId) loadData(collectionId);
  }, [collectionId]);

  const loadData = async (id: string) => {
    setIsLoading(true);
    try {
      const col = await storageService.getCollectionById(id);
      if (!col) { navigate('/collections'); return; }
      
      const [allArticles, allUsers] = await Promise.all([
          storageService.getAllArticles(),
          storageService.getUsers()
      ]);

      const collectionNuggets = col.entries.map(entry => {
          const article = allArticles.find(a => a.id === entry.articleId);
          if (!article) return null;
          
          // Inject addedBy data for display
          const adder = allUsers.find(u => u.id === entry.addedByUserId);
          const contributor: Contributor | undefined = adder ? {
              userId: adder.id,
              name: adder.name,
              username: adder.email.split('@')[0], 
              addedAt: entry.addedAt
          } : undefined;

          return {
              ...article,
              addedBy: contributor
          };
      }).filter(Boolean) as Article[];

      setCollection(col);
      setNuggets(collectionNuggets);
    } catch (e) { console.error(e); } finally { setIsLoading(false); }
  };

  const handleAddNugget = () => {
      toast.info("To add a nugget:", {
          description: "Find any nugget in your feed, click the 'Add to Collection' folder icon, and select this collection.",
          duration: 5000
      });
  };

  if (isLoading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div></div>;
  if (!collection) return null;

  const theme = getCollectionTheme(collection.id);

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-20">
      <div className="bg-slate-900 border-b border-slate-800">
        <div className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <button onClick={() => navigate('/collections')} className="flex items-center gap-2 text-sm font-bold text-slate-400 hover:text-white mb-6 transition-colors">
                <ArrowLeft size={16} /> Back to Collections
            </button>
            <div className="flex flex-col md:flex-row gap-6 md:items-start justify-between">
                <div className="flex gap-5">
                    <div className={`w-16 h-16 rounded-2xl flex items-center justify-center shrink-0 ${theme.light} ${theme.text} dark:bg-slate-800`}>
                        <Folder size={32} strokeWidth={1.5} />
                    </div>
                    <div>
                        <h1 className="text-3xl font-bold text-white mb-2">{collection.name}</h1>
                        <p className="text-slate-400 max-w-2xl leading-relaxed">{collection.description || "No description provided."}</p>
                        <div className="flex items-center gap-6 mt-4 text-sm text-slate-400 font-medium">
                            <span className="flex items-center gap-1.5"><Layers size={16} /> {nuggets.length} nuggets</span>
                            <span className="flex items-center gap-1.5"><Users size={16} /> {collection.followersCount} followers</span>
                            <span className="flex items-center gap-1.5"><Info size={16} /> Created by u1</span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-3 shrink-0 items-center">
                    <ShareMenu 
                        data={{
                            type: 'collection',
                            id: collection.id,
                            title: collection.name,
                            shareUrl: `${window.location.origin}/#/collections/${collection.id}`
                        }}
                        meta={{
                            text: collection.description
                        }}
                        className="hover:!bg-slate-800 hover:text-white w-10 h-10"
                        iconSize={20}
                    />
                    <button onClick={handleAddNugget} className="px-4 py-2 bg-white text-slate-900 rounded-xl text-sm font-bold hover:opacity-90 transition-colors flex items-center gap-2 shadow-sm">
                        <Plus size={16} /> Add Nugget
                    </button>
                </div>
            </div>
        </div>
      </div>
      <div className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <ArticleGrid 
            articles={nuggets}
            viewMode="grid"
            isLoading={false}
            onArticleClick={setSelectedArticle}
            isBookmarked={isBookmarked}
            onToggleBookmark={toggleBookmark}
            onCategoryClick={() => {}}
            emptyTitle="Empty Collection"
            emptyMessage="This collection has no nuggets yet. Be the first to add one!"
            currentUserId={currentUserId}
        />
      </div>
      {selectedArticle && <ArticleModal isOpen={!!selectedArticle} onClose={() => setSelectedArticle(null)} article={selectedArticle} />}
    </div>
  );
};









================================================================================
FILE: src\pages\CollectionsPage.tsx
================================================================================
import React, { useEffect, useState, useMemo, useRef } from 'react';
import { Collection } from '@/types';
import { storageService } from '@/services/storageService';
import { Search, LayoutGrid, List, ArrowUp, ArrowDown, ChevronDown, Plus, X, Folder, CheckSquare } from 'lucide-react';
import { EmptyState } from '@/components/UI/EmptyState';
import { useNavigate } from 'react-router-dom';
import { CollectionCard } from '@/components/collections/CollectionCard';
import { TableView } from '@/components/collections/TableView';
import { createPortal } from 'react-dom';
import { useToast } from '@/hooks/useToast';
import { Tooltip } from '@/components/UI/Tooltip';

type ViewMode = 'grid' | 'table';
type SortField = 'created' | 'updated' | 'followers' | 'nuggets' | 'name';
type SortDirection = 'asc' | 'desc';

// -- Internal Instruction Modal --
const CreateCollectionInstructionModal: React.FC<{ isOpen: boolean; onClose: () => void }> = ({ isOpen, onClose }) => {
  if (!isOpen) return null;
  return createPortal(
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm animate-in fade-in" onClick={onClose} />
      <div className="relative w-full max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 p-6 animate-in zoom-in-95">
        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
          <X size={20} />
        </button>
        
        <div className="flex flex-col items-center text-center">
          <div className="w-12 h-12 bg-primary-100 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400 rounded-full flex items-center justify-center mb-4">
            <Folder size={24} />
          </div>
          <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">How to create a Collection</h3>
          <p className="text-sm text-slate-500 dark:text-slate-400 mb-6 leading-relaxed">
            Collections must start with at least one nugget. <br/>
            To create a new one, find any nugget in your feed, click the <strong>Folder Icon</strong>, and select <strong>"Create new public collection"</strong>.
          </p>
          <button 
            onClick={onClose}
            className="w-full py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm hover:opacity-90 transition-opacity"
          >
            Got it
          </button>
        </div>
      </div>
    </div>,
    document.body
  );
};

export const CollectionsPage: React.FC = () => {
  const [collections, setCollections] = useState<Collection[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [viewMode, setViewMode] = useState<ViewMode>('grid');
  const [sortField, setSortField] = useState<SortField>('created');
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');
  const [showInstruction, setShowInstruction] = useState(false);

  // Selection State
  const [selectionMode, setSelectionMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [isActionMenuOpen, setIsActionMenuOpen] = useState(false);
  const actionMenuRef = useRef<HTMLDivElement>(null);

  const navigate = useNavigate();
  const toast = useToast();

  useEffect(() => {
    loadCollections();
  }, []);

  // Close dropdown on click outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (actionMenuRef.current && !actionMenuRef.current.contains(event.target as Node)) {
        setIsActionMenuOpen(false);
      }
    };
    if (isActionMenuOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isActionMenuOpen]);

  const loadCollections = async () => {
    setIsLoading(true);
    const [all, allUsers] = await Promise.all([
        storageService.getCollections(),
        storageService.getUsers()
    ]);

    const hydrated = all.map(col => ({
        ...col,
        creator: allUsers.find(u => u.id === col.creatorId)
    }));

    setCollections(hydrated.filter(c => c.type === 'public'));
    setIsLoading(false);
  };

  const processedCollections = useMemo(() => {
    let result = [...collections];
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        result = result.filter(c => c.name.toLowerCase().includes(q) || (c.description && c.description.toLowerCase().includes(q)));
    }
    result.sort((a, b) => {
        let valA: any, valB: any;
        switch (sortField) {
            case 'created': valA = new Date(a.createdAt).getTime(); valB = new Date(b.createdAt).getTime(); break;
            case 'updated': valA = new Date(a.updatedAt || a.createdAt).getTime(); valB = new Date(b.updatedAt || b.createdAt).getTime(); break;
            case 'followers': valA = a.followersCount; valB = b.followersCount; break;
            case 'nuggets': valA = a.entries.length; valB = b.entries.length; break;
            case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
            default: return 0;
        }
        return sortDirection === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
    });
    return result;
  }, [collections, searchQuery, sortField, sortDirection]);

  const toggleSelectionMode = () => {
      const newMode = !selectionMode;
      setSelectionMode(newMode);
      if (!newMode) setSelectedIds([]);
  };

  const handleSelect = (id: string) => {
      setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };

  const handleBulkFollow = (action: 'follow' | 'unfollow') => {
      if (selectedIds.length === 0) return;
      
      setCollections(prev => prev.map(c => {
          if (selectedIds.includes(c.id)) {
              const change = action === 'follow' ? 1 : -1;
              return { ...c, followersCount: Math.max(0, c.followersCount + change) };
          }
          return c;
      }));

      toast.success(`${action === 'follow' ? 'Followed' : 'Unfollowed'} ${selectedIds.length} collections`);
      setSelectionMode(false);
      setSelectedIds([]);
      setIsActionMenuOpen(false);
  };

  if (isLoading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div></div>;

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 pb-32">
      <div className="sticky top-[4.5rem] z-30 bg-slate-900 border-b border-slate-800 shadow-sm transition-colors">
          <div className="max-w-[1280px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div className="flex flex-col gap-6">
                <div className="flex flex-col md:flex-row md:items-start justify-between gap-4">
                    <div>
                        <h1 className="text-2xl font-bold text-white tracking-tight mb-1">Community Collections</h1>
                        <p className="text-sm text-slate-400 max-w-xl">Curated themes and topics shared across the Nuggets ecosystem.</p>
                    </div>
                    
                    <div className="flex gap-2 items-center self-end md:self-auto">
                        {/* Select Toggle */}
                        {collections.length > 0 && (
                            <>
                                {selectionMode ? (
                                    <div className="flex items-center gap-2 bg-slate-800 p-1 rounded-xl border border-slate-700 animate-in fade-in slide-in-from-right-4 duration-200">
                                        <span className="text-xs font-bold text-slate-300 ml-2">{selectedIds.length} Selected</span>
                                        
                                        <div className="relative" ref={actionMenuRef}>
                                            <button 
                                                onClick={() => setIsActionMenuOpen(!isActionMenuOpen)}
                                                disabled={selectedIds.length === 0}
                                                className="flex items-center gap-1.5 px-3 py-1.5 bg-primary-500 text-slate-900 rounded-lg text-xs font-bold hover:bg-primary-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                Actions <ChevronDown size={14} />
                                            </button>
                                            
                                            {isActionMenuOpen && (
                                                <div className="absolute right-0 top-full mt-2 w-40 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 z-50 overflow-hidden animate-in zoom-in-95 duration-100 origin-top-right">
                                                    <button onClick={() => handleBulkFollow('follow')} className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-green-600 hover:bg-green-50 dark:hover:bg-green-900/10 transition-colors">
                                                        <Plus size={14} /> Follow All
                                                    </button>
                                                    <div className="h-px bg-slate-100 dark:bg-slate-800" />
                                                    <button onClick={() => handleBulkFollow('unfollow')} className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors">
                                                        <X size={14} /> Unfollow All
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        <button 
                                            onClick={toggleSelectionMode}
                                            className="p-1.5 hover:bg-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors"
                                        >
                                            <X size={16} />
                                        </button>
                                    </div>
                                ) : (
                                    <Tooltip content="Select collections to follow/unfollow">
                                        <button 
                                            onClick={toggleSelectionMode}
                                            className="flex items-center gap-2 px-3 py-2 bg-primary-50 text-primary-700 border border-primary-200 hover:bg-primary-100 dark:bg-primary-900/10 dark:text-primary-400 dark:border-primary-900/30 rounded-xl text-sm font-bold transition-all shadow-sm"
                                        >
                                            <CheckSquare size={16} /> Select
                                        </button>
                                    </Tooltip>
                                )}
                            </>
                        )}
                        
                        {!selectionMode && (
                            <button 
                                onClick={() => setShowInstruction(true)} 
                                className="flex items-center gap-2 bg-slate-800 text-white border border-slate-700 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-700 transition-all"
                            >
                                <Plus size={16} /> Create
                            </button>
                        )}
                    </div>
                </div>

                {/* Filter Row */}
                <div className={`flex flex-col md:flex-row gap-4 items-center justify-between w-full transition-opacity duration-300 ${selectionMode ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                    <div className="relative w-full md:max-w-2xl">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                        <input type="text" placeholder="Search collections..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2.5 bg-slate-800 border border-slate-700 focus:bg-slate-900 focus:border-primary-500 rounded-xl text-sm text-white placeholder-slate-500 focus:outline-none transition-all shadow-sm" />
                    </div>
                    <div className="flex items-center gap-3 w-full md:w-auto justify-end">
                        <div className="flex items-center bg-slate-800 rounded-xl border border-slate-700 p-0.5 shadow-sm">
                            <div className="relative shrink-0 border-r border-slate-700 pr-1">
                                <select value={sortField} onChange={(e) => setSortField(e.target.value as SortField)} className="appearance-none pl-3 pr-8 py-2 bg-transparent text-sm font-medium text-slate-200 focus:outline-none cursor-pointer w-[140px]">
                                    <option value="created" className="text-slate-900 bg-white">Created Date</option>
                                    <option value="updated" className="text-slate-900 bg-white">Last Updated</option>
                                    <option value="followers" className="text-slate-900 bg-white">Followers</option>
                                    <option value="nuggets" className="text-slate-900 bg-white">Nugget Count</option>
                                    <option value="name" className="text-slate-900 bg-white">Name (A-Z)</option>
                                </select>
                                <ChevronDown className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={14} />
                            </div>
                            <button onClick={() => setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc')} className="p-2 text-slate-400 hover:text-white transition-colors">
                                {sortDirection === 'asc' ? <ArrowUp size={16} /> : <ArrowDown size={16} />}
                            </button>
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-xl border border-slate-700 shrink-0 shadow-sm">
                            <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded-lg transition-all ${viewMode === 'grid' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}><LayoutGrid size={18} /></button>
                            <button onClick={() => setViewMode('table')} className={`p-1.5 rounded-lg transition-all ${viewMode === 'table' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}><List size={18} /></button>
                        </div>
                    </div>
                </div>
            </div>
          </div>
      </div>

      <div className="max-w-[1280px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {processedCollections.length === 0 ? (
            <EmptyState icon={<Search />} title="No collections found" description={searchQuery ? `We couldn't find anything matching "${searchQuery}".` : "Be the first to create a community collection!"} />
        ) : (
            <div className={`animate-in fade-in slide-in-from-bottom-2 duration-500`}>
                {viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {processedCollections.map(col => (
                            <CollectionCard 
                                key={col.id} 
                                collection={col} 
                                onClick={() => selectionMode ? handleSelect(col.id) : navigate(`/collections/${col.id}`)} 
                                selectionMode={selectionMode}
                                isSelected={selectedIds.includes(col.id)}
                                onSelect={handleSelect}
                            />
                        ))}
                    </div>
                ) : (
                    <TableView collections={processedCollections} onClick={(id) => navigate(`/collections/${id}`)} />
                )}
            </div>
        )}
      </div>

      {showInstruction && <CreateCollectionInstructionModal isOpen={showInstruction} onClose={() => setShowInstruction(false)} />}
    </div>
  );
};









================================================================================
FILE: src\pages\HomePage.tsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { Article, SortOrder, Collection } from '@/types';
import { useBookmarks } from '@/hooks/useBookmarks';
import { useArticles } from '@/hooks/useArticles';
import { Loader2, AlertCircle, TrendingUp, Folder, Hash } from 'lucide-react';
import { ArticleModal } from '@/components/ArticleModal';
import { ArticleGrid } from '@/components/ArticleGrid';
import { storageService } from '@/services/storageService';
import { Badge } from '@/components/UI/Badge';
import { useAuth } from '@/hooks/useAuth';
import { Link } from 'react-router-dom';

interface HomePageProps {
  searchQuery: string;
  viewMode: 'grid' | 'feed';
  setViewMode: (mode: 'grid' | 'feed') => void;
  selectedCategories: string[];
  setSelectedCategories: (c: string[]) => void;
  selectedTag: string | null;
  setSelectedTag: (t: string | null) => void;
  sortOrder: SortOrder;
}

export const HomePage: React.FC<HomePageProps> = ({
  searchQuery,
  viewMode,
  selectedCategories,
  setSelectedCategories,
  selectedTag,
  setSelectedTag: _setSelectedTag,
  sortOrder
}) => {
  const [selectedArticle, setSelectedArticle] = useState<Article | null>(null);
  const { toggleBookmark, isBookmarked } = useBookmarks();
  const [pullY, setPullY] = useState(0);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const touchStartRef = useRef(0);
  const containerRef = useRef<HTMLDivElement>(null);

  const { currentUserId } = useAuth();

  // Sidebar Data
  const [allCategories, setAllCategories] = useState<string[]>([]);
  const [featuredCollections, setFeaturedCollections] = useState<Collection[]>([]);

  useEffect(() => {
    const loadSidebarData = async () => {
        const cats = await storageService.getCategories();
        const cols = await storageService.getCollections();
        
        setAllCategories(cats);
        
        // Sort by nugget count (descending) and take top 10
        const sortedCols = cols
            .filter(c => c.type === 'public')
            .sort((a, b) => b.entries.length - a.entries.length)
            .slice(0, 10);
            
        setFeaturedCollections(sortedCols);
    };
    loadSidebarData();
  }, []);

  const { data: articles = [], isLoading, isError, refetch } = useArticles({
    searchQuery,
    selectedCategories,
    selectedTag,
    sortOrder,
    userId: currentUserId,
    limit: 6
  });

  const handleRefreshFeed = async () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      await refetch();
  };

  const handleTouchStart = (e: React.TouchEvent) => {
    if (window.scrollY === 0 && !isRefreshing) {
      touchStartRef.current = e.touches[0].clientY;
    }
  };

  const handleTouchMove = (e: React.TouchEvent) => {
    const currentY = e.touches[0].clientY;
    const diff = currentY - touchStartRef.current;
    if (window.scrollY === 0 && diff > 0 && touchStartRef.current > 0) {
      const newPullY = Math.min(diff * 0.4, 120); 
      setPullY(newPullY);
    }
  };

  const handleTouchEnd = async () => {
    if (pullY > 60) {
      setIsRefreshing(true);
      setPullY(60); 
      await handleRefreshFeed();
      setIsRefreshing(false);
      setPullY(0);
    } else {
      setPullY(0);
    }
    touchStartRef.current = 0;
  };

  const toggleCategory = (cat: string) => {
      setSelectedCategories(
          selectedCategories.includes(cat) 
            ? selectedCategories.filter(c => c !== cat) 
            : [...selectedCategories, cat]
      );
  };

  if (isError) {
    return (
      <div className="w-full h-[60vh] flex flex-col items-center justify-center text-slate-500">
        <AlertCircle className="w-10 h-10 mb-2 text-red-500" />
        <p>Something went wrong loading the feed.</p>
        <button onClick={() => refetch()} className="mt-4 px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg font-bold text-sm hover:bg-slate-200 dark:hover:bg-slate-700">Try Again</button>
      </div>
    );
  }

  return (
    <main className="w-full flex flex-col min-h-screen relative" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd} ref={containerRef}>
      
      {/* Refresh Indicator */}
      <div className="absolute top-0 left-0 w-full flex justify-center pointer-events-none z-10" style={{ height: `${pullY}px`, opacity: pullY > 0 ? 1 : 0, transition: isRefreshing ? 'height 0.3s ease' : 'none' }}>
        <div className="mt-6 p-2 bg-white dark:bg-slate-800 rounded-full shadow-lg border border-slate-200 dark:border-slate-700 h-10 w-10 flex items-center justify-center transform transition-transform" style={{ transform: isRefreshing ? 'scale(1)' : `scale(${Math.min(pullY / 60, 1)}) rotate(${pullY * 3}deg)` }}>
          <Loader2 size={20} className={`text-primary-600 dark:text-primary-400 ${isRefreshing ? 'animate-spin' : ''}`} />
        </div>
      </div>

      <div className="w-full transition-transform duration-300 ease-out origin-top" style={{ transform: `translateY(${pullY}px)` }}>
        
        {/* Holy Grail Layout for Feed View */}
        {viewMode === 'feed' ? (
            <div className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 md:grid-cols-12 gap-6 lg:gap-8 items-start">
                
                {/* Left Sidebar: Topics Widget */}
                {/* Fixed height + Scrollable if too many topics */}
                <div className="hidden md:block md:col-span-3 lg:col-span-3 sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar pr-2 space-y-6">
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-5 shadow-sm">
                        <div className="flex items-center gap-2 mb-4 text-slate-900 dark:text-white">
                            <Hash size={16} className="text-primary-500" />
                            <h3 className="text-sm font-bold uppercase tracking-wider">Topics</h3>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {allCategories.map(cat => (
                                <Badge 
                                    key={cat} 
                                    label={cat} 
                                    variant={selectedCategories.includes(cat) ? 'primary' : 'neutral'}
                                    className="cursor-pointer text-[11px] py-1.5 px-3"
                                    onClick={() => toggleCategory(cat)}
                                />
                            ))}
                        </div>
                    </div>

                    {/* Site Footer Links - Moved to Left for visibility on MD */}
                    <div className="px-2">
                        <div className="flex flex-wrap gap-x-4 gap-y-2 text-[11px] font-medium text-slate-400 dark:text-slate-500">
                            <Link to="/about" className="hover:text-slate-600 dark:hover:text-slate-300 transition-colors">About</Link>
                            <Link to="/terms" className="hover:text-slate-600 dark:hover:text-slate-300 transition-colors">Terms</Link>
                            <Link to="/privacy" className="hover:text-slate-600 dark:hover:text-slate-300 transition-colors">Privacy</Link>
                            <Link to="/guidelines" className="hover:text-slate-600 dark:hover:text-slate-300 transition-colors">Guidelines</Link>
                            <Link to="/contact" className="hover:text-slate-600 dark:hover:text-slate-300 transition-colors">Contact</Link>
                        </div>
                        <div className="mt-3 text-[10px] text-slate-300 dark:text-slate-600">
                            © {new Date().getFullYear()} Nuggets. All rights reserved.
                        </div>
                    </div>
                </div>

                {/* Center: Feed */}
                <div className="md:col-span-9 lg:col-span-6 w-full mx-auto">
                    <ArticleGrid 
                        articles={articles}
                        viewMode="feed" // Forces full width single column
                        isLoading={isLoading}
                        onArticleClick={setSelectedArticle}
                        isBookmarked={isBookmarked}
                        onToggleBookmark={toggleBookmark}
                        onCategoryClick={(c) => toggleCategory(c)}
                        emptyTitle="No nuggets found"
                        emptyMessage="We couldn't find any nuggets matching your filters."
                        currentUserId={currentUserId}
                    />
                </div>

                {/* Right Sidebar: Collections & Footer */}
                {/* Fixed height + Scrollable */}
                <div className="hidden lg:block lg:col-span-3 sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar pl-2 space-y-6">
                    {/* Collections Widget */}
                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-5 shadow-sm">
                        <div className="flex items-center gap-2 mb-4 text-slate-900 dark:text-white">
                            <TrendingUp size={16} className="text-primary-500" />
                            <h3 className="text-sm font-bold uppercase tracking-wider">Top Collections</h3>
                        </div>
                        <div className="space-y-1">
                            {featuredCollections.map(col => (
                                <div key={col.id} className="group cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-800/50 rounded-xl transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-lg bg-primary-50 dark:bg-primary-900/20 flex items-center justify-center text-primary-600 dark:text-primary-400 shrink-0">
                                            <Folder size={14} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="text-xs font-bold text-slate-700 dark:text-slate-300 truncate group-hover:text-primary-600 transition-colors">{col.name}</div>
                                            <div className="text-[10px] text-slate-400 font-medium">{col.entries.length} nuggets</div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

            </div>
        ) : (
            // Grid View: Standard Full Width Container
            <div className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <ArticleGrid 
                    articles={articles}
                    viewMode="grid"
                    isLoading={isLoading}
                    onArticleClick={setSelectedArticle}
                    isBookmarked={isBookmarked}
                    onToggleBookmark={toggleBookmark}
                    onCategoryClick={(c) => toggleCategory(c)}
                    currentUserId={currentUserId}
                />
            </div>
        )}
      </div>

      {selectedArticle && (
        <ArticleModal
          isOpen={!!selectedArticle}
          onClose={() => setSelectedArticle(null)}
          article={selectedArticle}
        />
      )}
    </main>
  );
};





================================================================================
FILE: src\pages\LegalPageRenderer.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { adminConfigService } from '@/admin/services/adminConfigService';
import { LegalPage } from '../types/legal';
import { RichTextRenderer } from '@/components/RichTextRenderer';
import { Loader2, ArrowLeft, Clock } from 'lucide-react';
import { formatDate } from '@/utils/formatters';

// Map pathnames to slugs
const PATH_TO_SLUG: Record<string, string> = {
  '/about': 'about',
  '/terms': 'terms',
  '/privacy': 'privacy',
  '/contact': 'contact',
  '/guidelines': 'guidelines',
  '/disclaimer': 'disclaimer',
  '/cookie-policy': 'cookie-policy',
};

export const LegalPageRenderer: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  
  // Get slug from pathname
  const slug = PATH_TO_SLUG[location.pathname] || location.pathname.slice(1);
  
  const [page, setPage] = useState<LegalPage | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const load = async () => {
        setLoading(true);
        setError(null);
        try {
            const data = await adminConfigService.getLegalPage(slug);
            if (!data || !data.isEnabled) {
                setError("Page not found");
            } else {
                setPage(data);
                document.title = `${data.title} | Nuggets`;
            }
        } catch (e) {
            setError("Error loading content");
        } finally {
            setLoading(false);
        }
    };
    load();
  }, [slug]);

  if (loading) {
      return (
          <div className="min-h-[60vh] flex items-center justify-center">
              <Loader2 className="w-8 h-8 text-slate-300 animate-spin" />
          </div>
      );
  }

  if (error || !page) {
      return (
          <div className="min-h-[60vh] flex flex-col items-center justify-center px-4 text-center">
              <h1 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">404</h1>
              <p className="text-slate-500 mb-6">{error || "Page not found"}</p>
              <button onClick={() => navigate('/')} className="px-4 py-2 bg-slate-900 text-white rounded-xl text-sm font-bold">Go Home</button>
          </div>
      );
  }

  return (
    <div className="min-h-screen py-12 px-4 sm:px-6">
        <div className="max-w-3xl mx-auto">
            
            {/* Back Link */}
            <button 
                onClick={() => navigate(-1)} 
                className="flex items-center gap-2 text-sm font-bold text-slate-400 hover:text-slate-900 dark:hover:text-white mb-8 transition-colors"
            >
                <ArrowLeft size={16} /> Back
            </button>

            {/* Glass Card */}
            <article className="bg-white/80 dark:bg-slate-900/60 backdrop-blur-xl border border-slate-200/60 dark:border-slate-800/60 rounded-3xl p-8 sm:p-12 shadow-sm">
                
                {/* Meta Header */}
                <div className="flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-400 mb-8 pb-4 border-b border-slate-100 dark:border-slate-800/50">
                    <Clock size={14} />
                    Last Updated: {formatDate(page.lastUpdated)}
                </div>

                {/* Content */}
                <div className="prose prose-slate dark:prose-invert prose-lg max-w-none prose-headings:font-bold prose-headings:tracking-tight prose-a:text-primary-600">
                    <RichTextRenderer content={page.content} />
                </div>

            </article>
        </div>
    </div>
  );
};





================================================================================
FILE: src\pages\MySpacePage.tsx
================================================================================
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { User, Article, Collection } from '@/types';
import { storageService } from '@/services/storageService';
import { ProfileCard } from '@/components/profile/ProfileCard';
import { TabsBar } from '@/components/profile/TabsBar';
import { NewsCard } from '@/components/NewsCard';
import { CollectionsGrid } from '@/components/profile/CollectionsGrid';
import { Loader2, Layers, CheckSquare, X, Trash2, Lock, Globe, FolderPlus, ChevronDown, Info, Folder } from 'lucide-react';
import { ArticleModal } from '@/components/ArticleModal';
import { AddToCollectionModal } from '@/components/AddToCollectionModal';
import { useBookmarks } from '@/hooks/useBookmarks';
import { useToast } from '@/hooks/useToast';
import { ConfirmActionModal } from '@/components/settings/ConfirmActionModal';
import { Tooltip } from '@/components/UI/Tooltip';

interface MySpacePageProps {
  currentUserId: string;
}

// Dynamic descriptions based on state
const getDescription = (tab: string, visibility: 'public' | 'private') => {
  if (tab === 'collections') return "Thematic lists you have curated for the community.";
  if (tab === 'folders') return "Your private folders for organizing nuggets. Visible only to you.";
  if (tab === 'bookmarks') return "A flat list of everything you've saved.";
  if (tab === 'nuggets') {
      return visibility === 'public' 
        ? "Your nuggets that you've shared with the community."
        : "These are nuggets you have created that are not shared publicly.";
  }
  return "";
};

export const MySpacePage: React.FC<MySpacePageProps> = ({ currentUserId }) => {
  const { userId } = useParams<{ userId: string }>();
  const navigate = useNavigate();
  const toast = useToast();
  
  // Data State
  const [profileUser, setProfileUser] = useState<User | null>(null);
  const [articles, setArticles] = useState<Article[]>([]);
  const [bookmarkedArticles, setBookmarkedArticles] = useState<Article[]>([]);
  const [collections, setCollections] = useState<Collection[]>([]);
  
  // UI State
  const [activeTab, setActiveTab] = useState('nuggets');
  
  // Sub-Navigation State (Hierarchy)
  const [nuggetVisibility, setNuggetVisibility] = useState<'public' | 'private'>('public');

  const [selectedArticle, setSelectedArticle] = useState<Article | null>(null);
  const [loading, setLoading] = useState(true);

  // Selection Mode State
  const [selectionMode, setSelectionMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [showAddToCollection, setShowAddToCollection] = useState(false);
  const [isActionMenuOpen, setIsActionMenuOpen] = useState(false);
  const actionMenuRef = useRef<HTMLDivElement>(null);

  // Hooks
  const { isBookmarked, toggleBookmark, bookmarks } = useBookmarks();
  
  // Context
  const targetUserId = userId || currentUserId;
  const isOwner = currentUserId === targetUserId;

  useEffect(() => {
    loadData();
  }, [targetUserId, bookmarks]);

  // Clear selection when tab changes
  useEffect(() => {
      setSelectionMode(false);
      setSelectedIds([]);
      setIsActionMenuOpen(false);
  }, [activeTab, nuggetVisibility]);

  // Click outside listener for dropdown
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (actionMenuRef.current && !actionMenuRef.current.contains(event.target as Node)) {
        setIsActionMenuOpen(false);
      }
    };
    if (isActionMenuOpen) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isActionMenuOpen]);

  const loadData = async () => {
    setLoading(true);
    try {
      const [user, userArticles, allCollections, allArticles] = await Promise.all([
        storageService.getUserById(targetUserId),
        storageService.getArticlesByAuthor(targetUserId),
        storageService.getCollections(),
        storageService.getAllArticles()
      ]);

      setProfileUser(user || null);
      setArticles(userArticles);
      setCollections(allCollections.filter(c => c.creatorId === targetUserId));
      
      const userBookmarks = allArticles.filter(a => bookmarks.includes(a.id));
      setBookmarkedArticles(userBookmarks);

    } catch (e) {
      console.error("Failed to load profile data", e);
    } finally {
      setLoading(false);
    }
  };

  const publicNuggets = articles.filter(a => a.visibility === 'public' || !a.visibility);
  const privateNuggets = articles.filter(a => a.visibility === 'private');
  
  // SEGREGATION LOGIC
  const publicCollections = collections.filter(c => c.type === 'public');
  const privateFolders = collections.filter(c => c.type === 'private');

  // Hierarchy: Top Level Tabs
  const tabs: { id: string; label: string; count?: number }[] = [
    { 
        id: 'nuggets', 
        label: 'My Nuggets', 
        count: isOwner ? (publicNuggets.length + privateNuggets.length) : publicNuggets.length 
    },
    { 
        id: 'collections', 
        label: 'Collections', 
        count: publicCollections.length 
    },
  ];

  if (isOwner) {
    // Add Private Folders tab for owner
    tabs.push({ id: 'folders', label: 'Folders', count: privateFolders.length });
    // Add All Bookmarks tab for owner
    tabs.push({ id: 'bookmarks', label: 'All Saved', count: bookmarkedArticles.length });
  }

  const handleUpdateProfile = (updated: User) => setProfileUser(updated);

  const toggleSelectionMode = () => {
      const newMode = !selectionMode;
      setSelectionMode(newMode);
      if (!newMode) setSelectedIds([]);
  };

  const handleSelect = (id: string) => {
      setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };

  const handleBulkDelete = async () => {
      if (selectedIds.length === 0) return;
      
      if (activeTab === 'collections' || activeTab === 'folders') {
          for (const id of selectedIds) {
              await storageService.deleteCollection(id);
          }
          toast.success(`Deleted ${selectedIds.length} ${activeTab === 'folders' ? 'folders' : 'collections'}`);
      } else {
          if (activeTab === 'bookmarks') {
              for (const id of selectedIds) {
                  toggleBookmark(id);
              }
              toast.success(`Removed ${selectedIds.length} bookmarks`);
          } else {
              for (const id of selectedIds) {
                  await storageService.deleteArticle(id);
              }
              toast.success(`Deleted ${selectedIds.length} nuggets`);
          }
      }
      
      setShowDeleteConfirm(false);
      setSelectionMode(false);
      setSelectedIds([]);
      loadData();
  };

  const handleBulkVisibility = async (visibility: 'public' | 'private') => {
      if (activeTab !== 'nuggets') return;
      
      for (const id of selectedIds) {
          await storageService.updateArticle(id, { visibility });
      }
      toast.success(`Updated ${selectedIds.length} items to ${visibility}`);
      setSelectionMode(false);
      setSelectedIds([]);
      loadData();
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="animate-spin text-slate-400" /></div>;
  if (!profileUser) return <div className="p-12 text-center text-slate-500">User not found</div>;

  // --- HIERARCHY LOGIC ---
  // Determine what list to show based on Tab + Sub-Filter
  let currentList: any[] = [];
  
  if (activeTab === 'nuggets') {
      if (nuggetVisibility === 'public') currentList = publicNuggets;
      else currentList = privateNuggets;
  } else if (activeTab === 'collections') {
      currentList = publicCollections;
  } else if (activeTab === 'folders') {
      currentList = privateFolders;
  } else if (activeTab === 'bookmarks') {
      currentList = bookmarkedArticles;
  }

  // Determine current description
  const tabDescription = getDescription(activeTab, nuggetVisibility);

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 font-sans text-slate-900 dark:text-white pb-32">
      <div className="max-w-[1280px] mx-auto px-6 py-8">
        
        <div className="flex flex-col lg:flex-row items-start">
          
          {/* Left Column: Sidebar */}
          <div className="w-full lg:w-[270px] flex-shrink-0 mb-8 lg:mb-0">
            <ProfileCard 
                user={profileUser} 
                nuggetCount={publicNuggets.length} 
                isOwner={isOwner}
                onUpdate={handleUpdateProfile}
            />
          </div>

          {/* Right Column: Content */}
          <div className="flex-grow min-w-0 lg:ml-10 w-full relative">
            
            {/* Header / Toolbar Area */}
            <div className="flex flex-col gap-4 mb-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 min-h-[44px]">
                    
                    {/* Tabs */}
                    <div className={`overflow-x-auto pb-2 sm:pb-0 w-full sm:w-auto transition-opacity duration-200 ${selectionMode ? 'opacity-40 pointer-events-none' : 'opacity-100'}`}>
                        <TabsBar 
                            tabs={tabs} 
                            activeTab={activeTab} 
                            onTabChange={(t) => {
                                setActiveTab(t);
                                // Reset visibility filter to public when switching back to nuggets tab
                                if (t === 'nuggets') setNuggetVisibility('public');
                            }} 
                        />
                    </div>
                    
                    {/* Contextual Toolbar */}
                    {isOwner && currentList.length > 0 && (
                        <div className="flex items-center gap-3 w-full sm:w-auto justify-end">
                            
                            {selectionMode ? (
                                // --- SELECTION ACTIVE STATE ---
                                <div className="flex items-center gap-2 animate-in slide-in-from-right-2 duration-200">
                                    <span className="text-xs font-bold text-slate-500 dark:text-slate-400 mr-2">
                                        {selectedIds.length} Selected
                                    </span>

                                    {/* Dropdown Menu */}
                                    <div className="relative" ref={actionMenuRef}>
                                        <button 
                                            onClick={() => setIsActionMenuOpen(!isActionMenuOpen)}
                                            disabled={selectedIds.length === 0}
                                            className="flex items-center gap-2 px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl text-xs font-bold shadow-sm hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Actions <ChevronDown size={14} />
                                        </button>

                                        {isActionMenuOpen && (
                                            <div className="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 z-50 overflow-hidden animate-in zoom-in-95 duration-100 origin-top-right">
                                                {activeTab === 'nuggets' && (
                                                    <>
                                                        {nuggetVisibility === 'private' && (
                                                            <button onClick={() => { handleBulkVisibility('public'); setIsActionMenuOpen(false); }} className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                                                <Globe size={14} className="text-blue-500" /> Make Public
                                                            </button>
                                                        )}
                                                        {nuggetVisibility === 'public' && (
                                                            <button onClick={() => { handleBulkVisibility('private'); setIsActionMenuOpen(false); }} className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                                                <Lock size={14} className="text-amber-500" /> Make Private
                                                            </button>
                                                        )}
                                                        <button onClick={() => { setShowAddToCollection(true); setIsActionMenuOpen(false); }} className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                                            <FolderPlus size={14} className="text-indigo-500" /> Add to Collection
                                                        </button>
                                                        <div className="h-px bg-slate-100 dark:bg-slate-800 my-1" />
                                                    </>
                                                )}
                                                
                                                {activeTab === 'bookmarks' && (
                                                    <>
                                                        <button onClick={() => { setShowAddToCollection(true); setIsActionMenuOpen(false); }} className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                                            <FolderPlus size={14} className="text-indigo-500" /> Organize to Folder
                                                        </button>
                                                        <div className="h-px bg-slate-100 dark:bg-slate-800 my-1" />
                                                    </>
                                                )}

                                                <button 
                                                    onClick={() => { setShowDeleteConfirm(true); setIsActionMenuOpen(false); }} 
                                                    className="w-full flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                                                >
                                                    <Trash2 size={14} /> {activeTab === 'bookmarks' ? 'Remove Bookmarks' : 'Delete Items'}
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <button 
                                        onClick={toggleSelectionMode}
                                        className="p-2 rounded-xl text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                                        title="Cancel Selection"
                                    >
                                        <X size={18} />
                                    </button>
                                </div>
                            ) : (
                                // --- DEFAULT STATE ---
                                <>
                                    <Tooltip content="Import links or CSV files">
                                        <button 
                                            onClick={() => navigate('/bulk-create')}
                                            className="flex items-center gap-2 px-4 py-2 text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white rounded-xl text-xs font-bold transition-colors"
                                        >
                                            <Layers size={16} /> Batch Import
                                        </button>
                                    </Tooltip>
                                    
                                    <Tooltip content="Select multiple items to organize or delete">
                                        <button 
                                            onClick={toggleSelectionMode}
                                            className="flex items-center gap-2 px-3 py-2 bg-primary-50 text-primary-700 border border-primary-200 hover:bg-primary-100 dark:bg-primary-900/10 dark:text-primary-400 dark:border-primary-900/30 rounded-xl text-xs font-bold transition-all shadow-sm"
                                        >
                                            <CheckSquare size={16} /> Select
                                        </button>
                                    </Tooltip>
                                </>
                            )}
                        </div>
                    )}
                </div>
                
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center w-full">
                        {/* Hierarchy Sub-Navigation (For Nuggets Tab Only) - MOVED TO LEFT */}
                        {activeTab === 'nuggets' && isOwner && (
                            <div className="flex bg-slate-200 dark:bg-slate-800 p-1 rounded-xl shrink-0">
                                <button
                                    onClick={() => setNuggetVisibility('public')}
                                    className={`px-4 py-1.5 text-xs font-bold rounded-lg flex items-center gap-2 transition-all ${nuggetVisibility === 'public' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                                >
                                    <Globe size={12} /> Public <span className="opacity-60 text-[10px]">{publicNuggets.length}</span>
                                </button>
                                <button
                                    onClick={() => setNuggetVisibility('private')}
                                    className={`px-4 py-1.5 text-xs font-bold rounded-lg flex items-center gap-2 transition-all ${nuggetVisibility === 'private' ? 'bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}
                                >
                                    <Lock size={12} /> Private <span className="opacity-60 text-[10px]">{privateNuggets.length}</span>
                                </button>
                            </div>
                        )}

                        {/* Tab Description Helper */}
                        <div className="flex items-center gap-2 text-xs text-slate-400 dark:text-slate-500 px-1 animate-in fade-in">
                            <Info size={12} className="shrink-0" />
                            {tabDescription}
                        </div>
                    </div>
                </div>
            </div>

            {/* Content Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {activeTab === 'collections' || activeTab === 'folders' ? (
                  <div className="col-span-full">
                      <CollectionsGrid 
                        collections={currentList} 
                        onCollectionClick={(id) => selectionMode ? handleSelect(id) : navigate(`/collections/${id}`)}
                        selectionMode={selectionMode}
                        selectedIds={selectedIds}
                        onSelect={handleSelect}
                      />
                  </div>
              ) : (
                  currentList.map(item => (
                    <NewsCard 
                      key={item.id} 
                      article={item as Article}
                      viewMode="grid"
                      isBookmarked={isBookmarked(item.id)}
                      onToggleBookmark={toggleBookmark}
                      onTagClick={() => {}}
                      onCategoryClick={() => {}}
                      onClick={() => setSelectedArticle(item as Article)}
                      currentUserId={currentUserId}
                      selectionMode={selectionMode}
                      isSelected={selectedIds.includes(item.id)}
                      onSelect={handleSelect}
                    />
                  ))
              )}

              {currentList.length === 0 && (
                <div className="col-span-full py-16 text-center border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-2xl">
                  {activeTab === 'folders' ? (
                      <div className="flex flex-col items-center">
                          <Folder className="w-12 h-12 text-slate-300 mb-2" />
                          <p className="text-slate-400 text-sm">No folders yet. Save a bookmark to create one.</p>
                      </div>
                  ) : (
                      <p className="text-slate-400 text-sm">Nothing to see here yet.</p>
                  )}
                </div>
              )}
            </div>

          </div>
        </div>
      </div>

      {selectedArticle && (
        <ArticleModal
          isOpen={!!selectedArticle}
          onClose={() => setSelectedArticle(null)}
          article={selectedArticle}
        />
      )}

      <ConfirmActionModal 
        isOpen={showDeleteConfirm}
        onClose={() => setShowDeleteConfirm(false)}
        onConfirm={handleBulkDelete}
        title={activeTab === 'bookmarks' ? "Remove Bookmarks?" : activeTab === 'folders' ? "Delete Folders?" : "Delete Items?"}
        description={`Are you sure you want to delete ${selectedIds.length} items? This cannot be undone.`}
        actionLabel="Delete"
        isDestructive
      />

      <AddToCollectionModal 
        isOpen={showAddToCollection}
        onClose={() => setShowAddToCollection(false)}
        articleIds={selectedIds}
        mode={activeTab === 'bookmarks' ? 'private' : 'public'} 
      />
    </div>
  );
};









================================================================================
FILE: src\pages\ResetPasswordPage.tsx
================================================================================
import React, { useState } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { authService } from '@/services/authService';
import { Lock, ArrowRight, Check, Loader2 } from 'lucide-react';
import { Input } from '@/components/UI/Input';

export const ResetPasswordPage: React.FC = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const token = searchParams.get('token');
  
  const [password, setPassword] = useState('');
  const [confirm, setConfirm] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);

  if (!token) return <div className="p-8 text-center text-red-500">Invalid Token</div>;

  const handleSubmit = async (e: React.FormEvent) => {
      e.preventDefault();
      if (password !== confirm) {
          setError("Passwords do not match");
          return;
      }
      setIsSubmitting(true);
      setError(null);
      try {
          await authService.resetPassword(token, password);
          setIsSuccess(true);
          setTimeout(() => navigate('/'), 3000);
      } catch (err) {
          setError("Failed to reset password. Token may be expired.");
      } finally {
          setIsSubmitting(false);
      }
  };

  return (
    <div className="min-h-[60vh] flex flex-col items-center justify-center px-4">
        <div className="w-full max-w-md bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800">
            {isSuccess ? (
                <div className="text-center">
                    <div className="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Check size={24} />
                    </div>
                    <h2 className="text-xl font-bold mb-2">Password Reset!</h2>
                    <p className="text-slate-500">You can now login with your new password.</p>
                </div>
            ) : (
                <>
                    <h1 className="text-xl font-bold mb-6 flex items-center gap-2">
                        <Lock className="text-primary-500" /> Reset Password
                    </h1>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <Input 
                            type="password" 
                            label="New Password" 
                            value={password} 
                            onChange={e => setPassword(e.target.value)} 
                            required 
                        />
                        <Input 
                            type="password" 
                            label="Confirm Password" 
                            value={confirm} 
                            onChange={e => setConfirm(e.target.value)} 
                            required 
                        />
                        {error && <p className="text-xs text-red-500 font-bold bg-red-50 p-2 rounded">{error}</p>}
                        <button 
                            type="submit" 
                            disabled={isSubmitting}
                            className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:opacity-90"
                        >
                            {isSubmitting ? <Loader2 className="animate-spin" /> : <>Reset Password <ArrowRight size={16} /></>}
                        </button>
                    </form>
                </>
            )}
        </div>
    </div>
  );
};









================================================================================
FILE: src\pages\VerifyEmailPage.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { authService } from '@/services/authService';
import { CheckCircle2, XCircle, Loader2 } from 'lucide-react';

export const VerifyEmailPage: React.FC = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const token = searchParams.get('token');
  const [status, setStatus] = useState<'verifying' | 'success' | 'error'>('verifying');

  useEffect(() => {
    if (!token) {
        setStatus('error');
        return;
    }
    const verify = async () => {
        try {
            await authService.verifyEmail(token);
            setStatus('success');
            setTimeout(() => navigate('/'), 3000);
        } catch (e) {
            setStatus('error');
        }
    };
    verify();
  }, [token, navigate]);

  return (
    <div className="min-h-[60vh] flex flex-col items-center justify-center text-center px-4">
      {status === 'verifying' && (
          <>
            <Loader2 className="w-12 h-12 text-primary-500 animate-spin mb-4" />
            <h1 className="text-xl font-bold">Verifying your email...</h1>
          </>
      )}
      {status === 'success' && (
          <>
            <CheckCircle2 className="w-16 h-16 text-green-500 mb-4" />
            <h1 className="text-2xl font-bold mb-2">Email Verified!</h1>
            <p className="text-slate-500">Redirecting you to the home page...</p>
          </>
      )}
      {status === 'error' && (
          <>
            <XCircle className="w-16 h-16 text-red-500 mb-4" />
            <h1 className="text-2xl font-bold mb-2">Verification Failed</h1>
            <p className="text-slate-500">The link may be invalid or expired.</p>
            <button onClick={() => navigate('/')} className="mt-6 px-6 py-2 bg-slate-900 text-white rounded-xl font-bold">Go Home</button>
          </>
      )}
    </div>
  );
};









================================================================================
FILE: src\queryClient.ts
================================================================================
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 0, // Always fetch fresh data to prevent sync issues
      gcTime: 1000 * 60 * 30, // 30 minutes
      retry: 1,
      refetchOnWindowFocus: true, // Refetch when window gains focus
    },
  },
});





================================================================================
FILE: src\services\adapterFactory.ts
================================================================================
import { IAdapter } from './adapters/IAdapter';
import { LocalAdapter } from './adapters/LocalAdapter';
import { RestAdapter } from './adapters/RestAdapter';

// Cast import.meta to any to avoid TS errors if vite types are missing
const adapterType = (import.meta as any).env?.VITE_ADAPTER_TYPE || 'local';

let adapter: IAdapter;

if (adapterType === 'rest') {
  adapter = new RestAdapter();
} else {
  adapter = new LocalAdapter();
}

export const getAdapter = (): IAdapter => adapter;









================================================================================
FILE: src\services\adapters\IAdapter.ts
================================================================================
import { Article, User, Collection } from '@/types';

export interface IAdapter {
  // Articles
  getAllArticles(): Promise<Article[]>;
  getArticleById(id: string): Promise<Article | undefined>;
  getArticlesByAuthor(authorId: string): Promise<Article[]>;
  createArticle(article: Omit<Article, 'id' | 'publishedAt'>): Promise<Article>;
  updateArticle(id: string, updates: Partial<Article>): Promise<Article | null>;
  deleteArticle(id: string): Promise<boolean>;

  // Users
  getUsers(): Promise<User[]>;
  getUserById(id: string): Promise<User | undefined>;
  updateUser(id: string, updates: Partial<User>): Promise<User | null>;
  deleteUser(id: string): Promise<void>;
  
  // Personalization
  updateUserPreferences(userId: string, interestedCategories: string[]): Promise<void>;
  updateLastFeedVisit(userId: string): Promise<void>;
  getPersonalizedFeed(userId: string): Promise<{ articles: Article[], newCount: number }>;

  // Categories
  getCategories(): Promise<string[]>;
  addCategory(category: string): Promise<void>;
  deleteCategory(category: string): Promise<void>;

  // Collections
  getCollections(): Promise<Collection[]>;
  getCollectionById(id: string): Promise<Collection | undefined>;
  createCollection(name: string, description: string, creatorId: string, type: 'public' | 'private'): Promise<Collection>;
  deleteCollection(id: string): Promise<void>;
  updateCollection(id: string, updates: Partial<Collection>): Promise<Collection | null>;
  addArticleToCollection(collectionId: string, articleId: string, userId: string): Promise<void>;
  removeArticleFromCollection(collectionId: string, articleId: string, userId: string): Promise<void>;
  flagEntryAsIrrelevant(collectionId: string, articleId: string, userId: string): Promise<void>;
}









================================================================================
FILE: src\services\adapters\LocalAdapter.ts
================================================================================
import { Article, User, Collection, CollectionEntry } from '@/types';
import { ARTICLES as INITIAL_DATA } from '@/data/articles';
import { IAdapter } from './IAdapter';

const STORAGE_KEY = 'newsbytes_articles_db';
const USERS_KEY = 'newsbytes_users_db';
const CATEGORIES_KEY = 'newsbytes_categories_db';
const COLLECTIONS_KEY = 'newsbytes_collections_db';

const INITIAL_CATEGORIES = [
  'Finance', 'Tech', 'Design', 'Politics', 'Environment', 
  'Health', 'Culture', 'Science', 'Lifestyle', 'Business', 'Growth'
];

const INITIAL_USERS: User[] = [
  {
    id: 'u1',
    name: 'Akash Solanki',
    email: 'akash@example.com',
    role: 'admin',
    status: 'active',
    joinedAt: '2025-01-15T10:00:00Z',
    preferences: {
        interestedCategories: ['Tech', 'Business', 'Finance']
    },
    lastFeedVisit: new Date(Date.now() - 86400000 * 2).toISOString() 
  },
  {
    id: 'u2',
    name: 'Hemant Sharma',
    email: 'hemant@example.com',
    role: 'user',
    status: 'active',
    joinedAt: '2025-02-20T14:30:00Z',
    preferences: {
        interestedCategories: ['Design', 'Lifestyle']
    },
    lastFeedVisit: new Date().toISOString()
  }
];

const INITIAL_COLLECTIONS: Collection[] = [
  {
    id: 'col_general_bookmarks_u1',
    name: 'General Bookmarks',
    description: 'Auto-saved bookmarks.',
    creatorId: 'u1',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    followersCount: 0,
    entries: [],
    type: 'private'
  },
  {
    id: 'col_read_later',
    name: 'Read Later',
    description: 'Articles saved for later reading.',
    creatorId: 'u1',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    followersCount: 0,
    entries: [],
    type: 'private'
  },
  {
    id: 'col_india_growth',
    name: 'The India Growth Story',
    description: 'A curated list of nuggets tracking India\'s economic rise.',
    creatorId: 'u1',
    createdAt: '2025-10-01T10:00:00Z',
    updatedAt: '2025-10-02T11:30:00Z',
    followersCount: 15420,
    entries: [
        { articleId: '1', addedByUserId: 'u1', addedAt: '2025-10-01T10:00:00Z', flaggedBy: [] },
        { articleId: '4', addedByUserId: 'u2', addedAt: '2025-10-02T11:30:00Z', flaggedBy: [] },
    ],
    type: 'public'
  }
];

export class LocalAdapter implements IAdapter {
  constructor() {
    this.initStorage();
  }

  private initStorage() {
    if (!localStorage.getItem(STORAGE_KEY)) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(INITIAL_DATA));
    }
    if (!localStorage.getItem(USERS_KEY)) {
      localStorage.setItem(USERS_KEY, JSON.stringify(INITIAL_USERS));
    }
    if (!localStorage.getItem(CATEGORIES_KEY)) {
      localStorage.setItem(CATEGORIES_KEY, JSON.stringify(INITIAL_CATEGORIES));
    }
    if (!localStorage.getItem(COLLECTIONS_KEY)) {
      localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(INITIAL_COLLECTIONS));
    }
  }

  async getAllArticles(): Promise<Article[]> {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : [];
  }

  async getArticleById(id: string): Promise<Article | undefined> {
    const articles = await this.getAllArticles();
    return articles.find(a => a.id === id);
  }

  async getArticlesByAuthor(authorId: string): Promise<Article[]> {
    const articles = await this.getAllArticles();
    return articles.filter(a => a.author.id === authorId);
  }

  async createArticle(article: Omit<Article, 'id' | 'publishedAt'>): Promise<Article> {
    const articles = await this.getAllArticles();
    const newArticle: Article = {
      ...article,
      id: Date.now().toString(),
      publishedAt: new Date().toISOString(),
      readTime: article.readTime || 5,
      images: article.images || [],
      categories: article.categories || [],
      tags: article.tags || [],
      visibility: article.visibility || 'public',
      displayAuthor: article.displayAuthor // Ensure displayAuthor is saved
    };
    const updated = [newArticle, ...articles];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
    return newArticle;
  }

  async updateArticle(id: string, updates: Partial<Article>): Promise<Article | null> {
    const articles = await this.getAllArticles();
    const index = articles.findIndex(a => a.id === id);
    if (index === -1) return null;
    const updatedArticle = { ...articles[index], ...updates };
    articles[index] = updatedArticle;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(articles));
    return updatedArticle;
  }

  async deleteArticle(id: string): Promise<boolean> {
    const articles = await this.getAllArticles();
    const filtered = articles.filter(a => a.id !== id);
    if (articles.length === filtered.length) return false;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
    return true;
  }

  async getUsers(): Promise<User[]> {
    const data = localStorage.getItem(USERS_KEY);
    return data ? JSON.parse(data) : [];
  }

  async getUserById(id: string): Promise<User | undefined> {
    const users = await this.getUsers();
    let user = users.find(u => u.id === id);
    if (!user) {
      user = {
        id: id,
        name: "Unknown User",
        email: "unknown@nuggets.app",
        role: "user",
        status: "active",
        joinedAt: new Date().toISOString()
      };
    }
    return user;
  }

  async updateUser(id: string, updates: Partial<User>): Promise<User | null> {
    const users = await this.getUsers();
    const index = users.findIndex(u => u.id === id);
    if (index === -1) return null;
    const updatedUser = { ...users[index], ...updates };
    users[index] = updatedUser;
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
    return updatedUser;
  }

  async deleteUser(id: string): Promise<void> {
    const users = await this.getUsers();
    const updated = users.filter(u => u.id !== id);
    localStorage.setItem(USERS_KEY, JSON.stringify(updated));
  }

  async updateUserPreferences(userId: string, interestedCategories: string[]): Promise<void> {
    await this.updateUser(userId, { preferences: { interestedCategories } });
  }

  async updateLastFeedVisit(userId: string): Promise<void> {
    await this.updateUser(userId, { lastFeedVisit: new Date().toISOString() });
  }

  async getPersonalizedFeed(userId: string): Promise<{ articles: Article[], newCount: number }> {
    const articles = await this.getAllArticles();
    const user = await this.getUserById(userId);
    if (!user) return { articles: [], newCount: 0 };
    const interests = user.preferences?.interestedCategories || [];
    const lastVisit = user.lastFeedVisit ? new Date(user.lastFeedVisit).getTime() : 0;
    let filtered = interests.length === 0 
      ? articles 
      : articles.filter(a => a.categories.some(c => interests.includes(c)));
    filtered.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());
    const newCount = filtered.reduce((acc, a) => new Date(a.publishedAt).getTime() > lastVisit ? acc + 1 : acc, 0);
    return { articles: filtered, newCount };
  }

  async getCategories(): Promise<string[]> {
    const data = localStorage.getItem(CATEGORIES_KEY);
    return data ? JSON.parse(data) : [];
  }

  async addCategory(category: string): Promise<void> {
    const categories = await this.getCategories();
    if (!categories.includes(category)) {
      const updated = [...categories, category].sort();
      localStorage.setItem(CATEGORIES_KEY, JSON.stringify(updated));
    }
  }

  async deleteCategory(category: string): Promise<void> {
    const categories = await this.getCategories();
    const updated = categories.filter(c => c !== category);
    localStorage.setItem(CATEGORIES_KEY, JSON.stringify(updated));
  }

  async getCollections(): Promise<Collection[]> {
    const data = localStorage.getItem(COLLECTIONS_KEY);
    const parsed: Collection[] = data ? JSON.parse(data) : [];
    // Ensure existing data has type property if missing
    return parsed.map(c => ({ 
        ...c, 
        entries: c.entries || [],
        type: c.type || 'public', // Default to public for migration
        updatedAt: c.updatedAt || c.createdAt // Backfill updatedAt
    }));
  }

  async getCollectionById(id: string): Promise<Collection | undefined> {
    const collections = await this.getCollections();
    return collections.find(c => c.id === id);
  }

  async createCollection(name: string, description: string, creatorId: string, type: 'public' | 'private' = 'public'): Promise<Collection> {
    const collections = await this.getCollections();
    const now = new Date().toISOString();
    const newCollection: Collection = {
      id: Date.now().toString(),
      name,
      description,
      creatorId,
      createdAt: now,
      updatedAt: now,
      followersCount: 0,
      entries: [],
      type
    };
    const updated = [newCollection, ...collections];
    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(updated));
    return newCollection;
  }

  async deleteCollection(id: string): Promise<void> {
    const collections = await this.getCollections();
    const updated = collections.filter(c => c.id !== id);
    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(updated));
  }

  async updateCollection(id: string, updates: Partial<Collection>): Promise<Collection | null> {
    const collections = await this.getCollections();
    const index = collections.findIndex(c => c.id === id);
    if (index === -1) return null;
    const updated = { ...collections[index], ...updates, updatedAt: new Date().toISOString() };
    collections[index] = updated;
    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections));
    return updated;
  }

  async addArticleToCollection(collectionId: string, articleId: string, userId: string): Promise<void> {
    const collections = await this.getCollections();
    const index = collections.findIndex(c => c.id === collectionId);
    if (index === -1) return;
    const existingEntry = collections[index].entries.find(e => e.articleId === articleId);
    if (existingEntry) return;
    const newEntry: CollectionEntry = {
      articleId,
      addedByUserId: userId,
      addedAt: new Date().toISOString(),
      flaggedBy: []
    };
    collections[index].entries.push(newEntry);
    collections[index].updatedAt = new Date().toISOString(); // Update timestamp
    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections));
  }

  async removeArticleFromCollection(collectionId: string, articleId: string): Promise<void> {
    const collections = await this.getCollections();
    const index = collections.findIndex(c => c.id === collectionId);
    if (index === -1) return;
    collections[index].entries = collections[index].entries.filter(e => e.articleId !== articleId);
    collections[index].updatedAt = new Date().toISOString(); // Update timestamp
    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections));
  }

  async flagEntryAsIrrelevant(collectionId: string, articleId: string, userId: string): Promise<void> {
    const collections = await this.getCollections();
    const cIndex = collections.findIndex(c => c.id === collectionId);
    if (cIndex === -1) return;
    const entryIndex = collections[cIndex].entries.findIndex(e => e.articleId === articleId);
    if (entryIndex === -1) return;
    const entry = collections[cIndex].entries[entryIndex];
    if (!entry.flaggedBy) entry.flaggedBy = [];
    if (!entry.flaggedBy.includes(userId)) {
      entry.flaggedBy.push(userId);
    } else {
      entry.flaggedBy = entry.flaggedBy.filter(id => id !== userId);
    }
    collections[cIndex].entries[entryIndex] = entry;
    localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections));
  }
}









================================================================================
FILE: src\services\adapters\RestAdapter.ts
================================================================================
import { IAdapter } from './IAdapter';
import { Article, User, Collection } from '@/types';
import { apiClient } from '../apiClient';

export class RestAdapter implements IAdapter {
  // --- Articles ---
  getAllArticles(): Promise<Article[]> {
    return apiClient.get('/articles');
  }

  getArticleById(id: string): Promise<Article | undefined> {
    return apiClient.get<Article>(`/articles/${id}`).catch(() => undefined);
  }

  getArticlesByAuthor(authorId: string): Promise<Article[]> {
    return apiClient.get(`/articles?authorId=${authorId}`);
  }

  createArticle(article: Omit<Article, 'id' | 'publishedAt'>): Promise<Article> {
    return apiClient.post('/articles', article);
  }

  updateArticle(id: string, updates: Partial<Article>): Promise<Article | null> {
    return apiClient.put(`/articles/${id}`, updates);
  }

  deleteArticle(id: string): Promise<boolean> {
    return apiClient.delete(`/articles/${id}`).then(() => true);
  }

  // --- Users ---
  getUsers(): Promise<User[]> {
    return apiClient.get('/users');
  }

  getUserById(id: string): Promise<User | undefined> {
    return apiClient.get<User>(`/users/${id}`).catch(() => undefined);
  }

  updateUser(id: string, updates: Partial<User>): Promise<User | null> {
    return apiClient.put(`/users/${id}`, updates);
  }

  async deleteUser(id: string): Promise<void> {
    await apiClient.delete(`/users/${id}`);
  }

  // --- Personalization ---
  async updateUserPreferences(userId: string, interestedCategories: string[]): Promise<void> {
    await this.updateUser(userId, { preferences: { interestedCategories } });
  }

  async updateLastFeedVisit(userId: string): Promise<void> {
    await this.updateUser(userId, { lastFeedVisit: new Date().toISOString() });
  }

  async getPersonalizedFeed(userId: string): Promise<{ articles: Article[], newCount: number }> {
    return apiClient.get(`/users/${userId}/feed`);
  }

  // --- Categories ---
  getCategories(): Promise<string[]> {
    return apiClient.get('/categories');
  }

  async addCategory(category: string): Promise<void> {
    await apiClient.post('/categories', { name: category });
  }

  async deleteCategory(category: string): Promise<void> {
    await apiClient.delete(`/categories/${encodeURIComponent(category)}`);
  }

  // --- Collections ---
  getCollections(): Promise<Collection[]> {
    return apiClient.get('/collections');
  }

  getCollectionById(id: string): Promise<Collection | undefined> {
    return apiClient.get<Collection>(`/collections/${id}`).catch(() => undefined);
  }

  createCollection(name: string, description: string, creatorId: string, type: 'public' | 'private'): Promise<Collection> {
    return apiClient.post('/collections', { name, description, creatorId, type });
  }

  async deleteCollection(id: string): Promise<void> {
    await apiClient.delete(`/collections/${id}`);
  }

  updateCollection(id: string, updates: Partial<Collection>): Promise<Collection | null> {
    return apiClient.put(`/collections/${id}`, updates);
  }

  async addArticleToCollection(collectionId: string, articleId: string, userId: string): Promise<void> {
    await apiClient.post(`/collections/${collectionId}/entries`, { articleId, userId });
  }

  async removeArticleFromCollection(collectionId: string, articleId: string): Promise<void> {
    await apiClient.delete(`/collections/${collectionId}/entries/${articleId}`);
  }

  async flagEntryAsIrrelevant(collectionId: string, articleId: string, userId: string): Promise<void> {
    await apiClient.post(`/collections/${collectionId}/entries/${articleId}/flag`, { userId });
  }
}









================================================================================
FILE: src\services\adminConfigService.ts
================================================================================
import { RolePermissions, ServiceDefinition } from '@/admin/types/admin';
import { LegalPage, LegalPageSlug, LegalConfig } from '../types/legal';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

export const AVAILABLE_SERVICES: ServiceDefinition[] = [
  { id: 'batch_import', label: 'Batch Import', description: 'Import content via CSV/Excel.', category: 'data' },
  { id: 'data_export', label: 'Data Export', description: 'Download personal data.', category: 'data' },
  { id: 'ai_summary', label: 'AI Summaries', description: 'Generate AI takeaways for nuggets.', category: 'ai' },
  { id: 'ai_auto_tag', label: 'AI Auto-Tagging', description: 'Suggest tags based on content.', category: 'ai' },
  { id: 'create_public_collection', label: 'Public Collections', description: 'Publish collections to the community.', category: 'content' },
  { id: 'view_analytics', label: 'View Analytics', description: 'Access read/view counts on content.', category: 'content' },
  { id: 'unlimited_nuggets', label: 'Unlimited Nuggets', description: 'Bypass storage quotas.', category: 'content' },
];

const INITIAL_PERMISSIONS: RolePermissions = {
  admin: ['batch_import', 'data_export', 'ai_summary', 'ai_auto_tag', 'create_public_collection', 'view_analytics', 'unlimited_nuggets'],
  user: ['create_public_collection', 'ai_summary'],
  superadmin: ['batch_import', 'data_export', 'ai_summary', 'ai_auto_tag', 'create_public_collection', 'view_analytics', 'unlimited_nuggets']
};

// --- MOCK LEGAL CONTENT ---
const INITIAL_LEGAL_CONFIG: LegalConfig = {
  pages: {
    about: {
      id: 'about',
      title: 'About Us',
      slug: 'about',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# About Nuggets

**Busy people need relevant information in less time.**

Nuggets is designed to strip away the noise of the modern web. We believe in high-signal, low-latency knowledge consumption. 

### Our Mission
To empower professionals to stay informed without the doom-scrolling. We curate, summarize, and organize the world's most valuable insights into bite-sized "nuggets".

### The Team
We are a small, distributed team of designers, engineers, and curators passionate about information architecture and digital wellbeing.`
    },
    terms: {
      id: 'terms',
      title: 'Terms of Service',
      slug: 'terms',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Terms of Service

By using Nuggets, you agree to these terms.

1. **Acceptable Use**: You agree not to misuse the platform or post harmful content.
2. **Content Ownership**: You retain rights to your content, but grant us a license to display it.
3. **Termination**: We reserve the right to suspend accounts that violate our policies.

*These terms are subject to change.*`
    },
    privacy: {
      id: 'privacy',
      title: 'Privacy Policy',
      slug: 'privacy',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Privacy Policy

Your privacy is paramount.

**Data We Collect**:
- Account information (email, name)
- Usage data (bookmarks, collections)

**How We Use It**:
- To provide and improve the service.
- We **do not** sell your data to third parties.

**Your Rights**:
- You can export or delete your data at any time via the Settings page.`
    },
    contact: {
      id: 'contact',
      title: 'Contact Us',
      slug: 'contact',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Contact Us

We'd love to hear from you.

**Support**: support@nuggets.app  
**Partnerships**: partners@nuggets.app  
**Press**: press@nuggets.app

Or use the **Feedback** button in the bottom right corner of the app.`
    },
    guidelines: {
      id: 'guidelines',
      title: 'Community Guidelines',
      slug: 'guidelines',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Community Guidelines

1. **Be Respectful**: Disagreement is fine, harassment is not.
2. **No Spam**: Do not use Nuggets purely for self-promotion.
3. **Quality Matters**: Ensure your shared nuggets provide value to others.

Violations may result in content removal or account suspension.`
    },
    disclaimer: {
      id: 'disclaimer',
      title: 'Disclaimer',
      slug: 'disclaimer',
      isEnabled: true,
      lastUpdated: new Date().toISOString(),
      content: `# Disclaimer

The content provided on Nuggets is for informational purposes only. We do not guarantee the accuracy or completeness of any information found here. 

Links to third-party websites are provided for convenience; we do not endorse their content.`
    },
    'cookie-policy': {
      id: 'cookie-policy',
      title: 'Cookie Policy',
      slug: 'cookie-policy',
      isEnabled: false, // Disabled by default
      lastUpdated: new Date().toISOString(),
      content: `# Cookie Policy

We use cookies to improve your experience.

- **Essential Cookies**: Required for login and security.
- **Analytics Cookies**: Help us understand how you use the site.

You can manage cookie preferences in your browser settings.`
    }
  }
};

class AdminConfigService {
  // In-memory mock storage
  private permissions: RolePermissions = { ...INITIAL_PERMISSIONS };
  private legalConfig: LegalConfig = { ...INITIAL_LEGAL_CONFIG };

  // --- RBAC ---
  async getRolePermissions(): Promise<RolePermissions> {
    await delay(400);
    return JSON.parse(JSON.stringify(this.permissions));
  }

  async updateRolePermission(role: keyof RolePermissions, services: string[]): Promise<void> {
    await delay(300);
    this.permissions[role] = services as any;
    console.log(`[Config] Updated permissions for ${String(role)}:`, services);
  }

  // --- LEGAL PAGES ---
  async getLegalPages(): Promise<LegalPage[]> {
    await delay(300);
    return Object.values(this.legalConfig.pages);
  }

  async getLegalPage(slug: string): Promise<LegalPage | undefined> {
    await delay(200);
    return Object.values(this.legalConfig.pages).find(p => p.slug === slug);
  }

  async updateLegalPage(id: LegalPageSlug, updates: Partial<LegalPage>): Promise<void> {
    await delay(500);
    const current = this.legalConfig.pages[id];
    if (current) {
        this.legalConfig.pages[id] = { 
            ...current, 
            ...updates,
            lastUpdated: updates.content ? new Date().toISOString() : current.lastUpdated 
        };
    }
  }
}

export const adminConfigService = new AdminConfigService();




================================================================================
FILE: src\services\aiService.ts
================================================================================

import { apiClient } from './apiClient';

export interface SummaryResult {
  title: string;
  excerpt: string;
  tags: string[];
}

export const aiService = {
  /**
   * Summarizes the provided text into a nugget-friendly format via Backend API.
   * This keeps the API key secure on the server.
   */
  async summarizeText(text: string): Promise<SummaryResult> {
    if (!text || text.length < 10) {
      throw new Error("Text is too short to summarize.");
    }

    try {
      // POST to our own backend, which then talks to Gemini
      const response = await apiClient.post<SummaryResult>('/ai/summarize', { text });
      return response;
    } catch (e) {
      console.error("AI Service Error:", e);
      // Return empty fallback
      return {
        title: '',
        excerpt: '',
        tags: []
      };
    }
  },

  /**
   * Generates concise key takeaways via Backend API.
   */
  async generateTakeaways(text: string): Promise<string> {
    if (!text || text.length < 50) return "This content is too short to summarize.";

    try {
      const response = await apiClient.post<{ takeaway: string }>('/ai/takeaways', { text });
      return response.takeaway;
    } catch (e) {
      console.error("AI Summary Error:", e);
      return "Failed to generate summary. Please try again later.";
    }
  }
};





================================================================================
FILE: src\services\apiClient.ts
================================================================================
const BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:5000/api';

class ApiClient {
  private async request<T>(endpoint: string, options?: RequestInit): Promise<T> {
    const config = {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options?.headers,
      },
    };

    const response = await fetch(`${BASE_URL}${endpoint}`, config);

    if (!response.ok) {
      if (response.status === 404) {
        throw new Error('Resource not found');
      }
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.message || `API Error: ${response.status}`);
    }

    if (response.status === 204) {
      return {} as T;
    }

    return response.json();
  }

  get<T>(url: string, headers?: HeadersInit) {
    return this.request<T>(url, { method: 'GET', headers });
  }

  post<T>(url: string, body: any, headers?: HeadersInit) {
    return this.request<T>(url, { method: 'POST', body: JSON.stringify(body), headers });
  }

  put<T>(url: string, body: any, headers?: HeadersInit) {
    return this.request<T>(url, { method: 'PUT', body: JSON.stringify(body), headers });
  }

  delete<T>(url: string, headers?: HeadersInit) {
    return this.request<T>(url, { method: 'DELETE', headers });
  }
}

export const apiClient = new ApiClient();





================================================================================
FILE: src\services\articleService.ts
================================================================================
import { storageService } from './storageService';
import { Article, FilterState } from '@/types';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

export const articleService = {
  getArticles: async (filters: FilterState): Promise<Article[]> => {
    // Simulate network delay
    await delay(300);

    // Fetch from dynamic storage
    let filtered = await storageService.getAllArticles();

    // 1. Filter by Query
    if (filters.query) {
      const q = filters.query.toLowerCase();
      filtered = filtered.filter(a => 
        a.title.toLowerCase().includes(q) || 
        a.excerpt.toLowerCase().includes(q) ||
        a.content.toLowerCase().includes(q) ||
        a.categories.some(cat => cat.toLowerCase().includes(q)) ||
        a.tags.some(tag => tag.toLowerCase().includes(q))
      );
    }

    // 2. Filter by Categories (Multiple)
    if (filters.categories && filters.categories.length > 0) {
      // Check if the article has ANY of the selected categories
      filtered = filtered.filter(a => 
        a.categories.some(cat => filters.categories.includes(cat))
      );
    }

    // 3. Filter by Tag
    if (filters.tag) {
      filtered = filtered.filter(a => a.tags.includes(filters.tag!));
    }

    // 4. Sort
    filtered.sort((a, b) => {
      const dateA = new Date(a.publishedAt).getTime();
      const dateB = new Date(b.publishedAt).getTime();
      return filters.sort === 'oldest' ? dateA - dateB : dateB - dateA;
    });

    // 5. Limit
    if (filters.limit && filters.limit > 0) {
      filtered = filtered.slice(0, filters.limit);
    }

    return filtered;
  },

  getArticleById: async (id: string): Promise<Article | undefined> => {
    await delay(200);
    return storageService.getArticleById(id);
  }
};









================================================================================
FILE: src\services\authService.ts
================================================================================
import { User as LegacyUser } from '@/types';
import { User as ModularUser } from '@/types/user';
import { LoginPayload, SignupPayload, AuthProvider } from '@/types/auth';
import { storageService } from './storageService';
import { createDefaultUser } from '@/models/userDefaults';
import { adminConfigService } from '@/admin/services/adminConfigService';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Helper: Map Legacy Storage Data -> New Modular Schema
const mapLegacyToModular = (legacy: LegacyUser): ModularUser => {
  return createDefaultUser(legacy.id, legacy.email, {
    role: legacy.role,
    auth: {
      createdAt: legacy.joinedAt,
      emailVerified: legacy.emailVerified,
      provider: legacy.authProvider || 'email',
    },
    profile: {
      displayName: legacy.name,
      username: legacy.username || legacy.email.split('@')[0],
      phoneNumber: legacy.phoneNumber,
      avatarUrl: legacy.avatarUrl,
    },
    preferences: {
      interestedCategories: legacy.preferences?.interestedCategories || [],
    },
    appState: {
      lastLoginAt: legacy.lastFeedVisit
    }
  });
};

class AuthService {
  // Simulate backend latency
  private LATENCY = 800;

  async loginWithEmail(payload: LoginPayload): Promise<{ user: ModularUser; token: string }> {
    await delay(this.LATENCY);

    // Stub: Check against storageService users for MVP simulation
    const users = await storageService.getUsers();
    const legacyUser = users.find(u => u.email.toLowerCase() === payload.email.toLowerCase());

    if (!legacyUser) {
      throw new Error("Invalid email or password");
    }

    const modularUser = mapLegacyToModular(legacyUser);

    return {
      user: modularUser,
      token: `fake-jwt-token-${legacyUser.id}-${Date.now()}`
    };
  }

  async signupWithEmail(payload: SignupPayload): Promise<{ user: ModularUser; token: string }> {
    await delay(this.LATENCY);

    const users = await storageService.getUsers();
    if (users.some(u => u.email.toLowerCase() === payload.email.toLowerCase())) {
      throw new Error("Email already registered");
    }

    if (users.some(u => u.username?.toLowerCase() === payload.username.toLowerCase())) {
        throw new Error("Username already taken");
    }

    // Check Feature Flag for Verification
    const flags = await adminConfigService.getFeatureFlags();
    const isVerificationEnabled = flags.enableEmailVerification;

    // Create new user in storage stub
    const newLegacyUser: LegacyUser = {
      id: `u-${Date.now()}`,
      name: payload.fullName, // Mapped from fullName
      username: payload.username,
      email: payload.email,
      role: 'user',
      status: 'active',
      joinedAt: new Date().toISOString(),
      authProvider: 'email',
      emailVerified: !isVerificationEnabled, // Auto-verify if disabled
      phoneNumber: payload.phoneNumber,
      preferences: { interestedCategories: [] },
      // Extended profile fields preserved in modularUser
      pincode: payload.pincode,
      city: payload.city,
      country: payload.country,
      gender: payload.gender,
      dateOfBirth: payload.dateOfBirth,
    };

    // Create Modular User (richer model)
    const modularUser = createDefaultUser(newLegacyUser.id, newLegacyUser.email, {
        profile: {
            displayName: payload.fullName,
            username: payload.username,
            pincode: payload.pincode,
            city: payload.city,
            country: payload.country,
            gender: payload.gender,
            phoneNumber: payload.phoneNumber,
            dateOfBirth: payload.dateOfBirth
        },
        auth: {
            emailVerified: !isVerificationEnabled
        }
    });
    
    return {
        user: modularUser,
        token: `fake-jwt-token-${newLegacyUser.id}-${Date.now()}`
    };
  }

  async loginWithProvider(provider: AuthProvider): Promise<{ user: ModularUser; token: string }> {
    await delay(this.LATENCY);
    
    // Simulate social login success
    const mockLegacyUser: LegacyUser = {
        id: `social-${Date.now()}`,
        name: 'Social User',
        username: 'social_user',
        email: `user@${provider}.com`,
        role: 'user',
        status: 'active',
        joinedAt: new Date().toISOString(),
        authProvider: provider,
        emailVerified: true,
        avatarUrl: 'https://i.pravatar.cc/150?u=social'
    };

    const modularUser = mapLegacyToModular(mockLegacyUser);

    return {
        user: modularUser,
        token: `fake-social-token-${Date.now()}`
    };
  }

  async requestPasswordReset(email: string): Promise<void> {
    await delay(this.LATENCY);
    console.log(`Password reset requested for ${email}`);
  }

  async resetPassword(token: string, _newPassword: string): Promise<void> {
    await delay(this.LATENCY);
    if (token === 'invalid') throw new Error("Invalid or expired token");
    console.log("Password reset successful");
  }

  async changePassword(_current: string, _next: string): Promise<void> {
      await delay(this.LATENCY);
      console.log("Password changed");
  }

  async verifyEmail(token: string): Promise<void> {
      await delay(this.LATENCY);
      if (token === 'invalid') throw new Error("Invalid verification link");
  }

  async logoutApi(): Promise<void> {
      await delay(300);
  }
}

export const authService = new AuthService();





================================================================================
FILE: src\services\batchService.ts
================================================================================
import { BatchRow } from '@/types/batch';
import { storageService } from './storageService';
import Papa from 'papaparse';
import * as XLSX from 'xlsx';
import { detectProviderFromUrl } from '@/utils/urlUtils';
import { normalizeCategoryLabel } from '@/utils/formatters';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

export const batchService = {
  // --- Generators ---
  generateId: () => Math.random().toString(36).substr(2, 9),

  // --- Parsers ---

  async parseLinks(text: string): Promise<BatchRow[]> {
    const lines = text.split('\n').filter(line => line.trim() !== '');
    
    return lines.map(line => {
      const url = line.trim();
      return {
        id: this.generateId(),
        url,
        title: '', // Will be fetched
        content: '',
        categories: [],
        visibility: 'public',
        status: 'pending',
        selected: true
      };
    });
  },

  async parseCSV(file: File): Promise<BatchRow[]> {
    return new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const rows: BatchRow[] = results.data.map((row: any) => ({
            id: this.generateId(),
            url: row.url || '',
            title: row.title || '',
            content: row.text || row.content || row.notes || '',
            categories: row.categories ? row.categories.split(',').map((c: string) => c.trim()) : [],
            visibility: (row.visibility?.toLowerCase() === 'private') ? 'private' : 'public',
            status: 'ready',
            selected: true
          }));
          resolve(rows.filter(r => r.url)); // Filter out rows without URLs
        },
        error: (err) => reject(err)
      });
    });
  },

  async parseExcel(file: File): Promise<BatchRow[]> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = e.target?.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json: any[] = XLSX.utils.sheet_to_json(sheet);

          const rows: BatchRow[] = json.map((row: any) => ({
            id: this.generateId(),
            url: row.url || '',
            title: row.title || '',
            content: row.text || row.content || row.notes || '',
            categories: row.categories ? row.categories.toString().split(',').map((c: string) => c.trim()) : [],
            visibility: (row.visibility?.toLowerCase() === 'private') ? 'private' : 'public',
            status: 'ready',
            selected: true
          }));
          resolve(rows.filter(r => r.url));
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = (err) => reject(err);
      reader.readAsBinaryString(file);
    });
  },

  // --- Processing ---

  async fetchMetadataForRows(rows: BatchRow[]): Promise<BatchRow[]> {
    // In a real app, we might use a Promise.all with concurrency limit
    // For now, we simulate a bulk fetch or individual fetches
    const updatedRows = [...rows];

    for (const row of updatedRows) {
      if (row.url && !row.title && row.status !== 'success') {
        row.status = 'fetching';
        
        try {
          // Simulate network request
          await delay(300 + Math.random() * 500);
          
          // Dummy logic to generate metadata from URL
          const urlObj = new URL(row.url);
          const domain = urlObj.hostname.replace('www.', '');
          
          row.title = `${domain} - ${urlObj.pathname.split('/').pop() || 'Untitled Page'} `
            .replace(/-/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase())
            .trim();
            
          if (row.title.length < 5) row.title = `Nugget from ${domain}`;

          row.content = row.content || `Saved from ${row.url}`;
          row.status = 'ready';
        } catch (e) {
          row.status = 'error';
          row.errorMessage = 'Failed to fetch preview';
        }
      }
    }
    
    return updatedRows;
  },

  async createBatch(rows: BatchRow[], currentUserId: string): Promise<BatchRow[]> {
    const results = [...rows];

    for (const row of results) {
      if (row.selected && row.status === 'ready') {
        try {
          // Create the article using existing storage service
          await storageService.createArticle({
            title: row.title || 'Untitled Nugget',
            content: row.content || row.url,
            excerpt: (row.content || row.url).substring(0, 150),
            author: { id: currentUserId, name: 'Admin User' }, // In real app, name comes from profile
            categories: row.categories.map(c => normalizeCategoryLabel(c).replace('#', '')).filter(Boolean),
            tags: [],
            readTime: 1,
            visibility: row.visibility,
            source_type: 'link',
            media: {
              type: detectProviderFromUrl(row.url),
              url: row.url,
              previewMetadata: {
                url: row.url,
                title: row.title,
                providerName: new URL(row.url).hostname
              }
            }
          });

          row.status = 'success';
          await delay(100); // Small delay to visualize progress
        } catch (e) {
          row.status = 'error';
          row.errorMessage = 'Creation failed';
        }
      }
    }

    return results;
  }
};









================================================================================
FILE: src\services\storageService.ts
================================================================================
import { getAdapter } from './adapterFactory';

export const storageService = getAdapter();









================================================================================
FILE: src\services\userSettingsService.ts
================================================================================
import { ProfileFormData, UserPreferences } from '@/types/settings';

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

class UserSettingsService {
  async updateProfile(userId: string, data: ProfileFormData): Promise<void> {
    await delay(1000);
    console.log(`[Mock] Updated profile for ${userId}:`, data);
    // In a real app, verify username uniqueness here
  }

  async updateAccountInfo(userId: string, data: { email: string }): Promise<void> {
    await delay(1000);
    console.log(`[Mock] Updated account info for ${userId}:`, data);
  }

  async resendVerificationEmail(email: string): Promise<void> {
    await delay(800);
    console.log(`[Mock] Verification email sent to ${email}`);
  }

  async updatePassword(userId: string, current: string, _next: string): Promise<void> {
    await delay(1500);
    if (current === 'wrong') throw new Error("Incorrect current password");
    console.log(`[Mock] Password updated for ${userId}`);
  }

  async updatePreferences(userId: string, prefs: UserPreferences): Promise<void> {
    await delay(600);
    console.log(`[Mock] Preferences updated for ${userId}:`, prefs);
  }

  async deleteAccount(userId: string): Promise<void> {
    await delay(2000);
    console.log(`[Mock] Account ${userId} deleted`);
  }
}

export const userSettingsService = new UserSettingsService();





================================================================================
FILE: src\types\auth.ts
================================================================================
export type AuthProvider = "email" | "google" | "linkedin";

export interface LoginPayload {
  email: string;
  password?: string;
}

export interface SignupPayload {
  fullName: string;
  username: string;
  email: string;
  password?: string;
  pincode?: string;
  city?: string;
  country?: string;
  gender?: string;
  phoneNumber?: string;
  dateOfBirth?: string;
}

export const ENABLED_SOCIAL_PROVIDERS: AuthProvider[] = ["google", "linkedin"];





================================================================================
FILE: src\types\batch.ts
================================================================================
export interface BatchRow {
  id: string;
  url: string;
  title: string;
  content: string; // Maps to 'text' or 'excerpt'
  categories: string[];
  visibility: 'public' | 'private';
  status: 'pending' | 'fetching' | 'ready' | 'success' | 'error';
  errorMessage?: string;
  selected?: boolean;
}

export type ImportMode = 'links' | 'csv' | 'excel';









================================================================================
FILE: src\types\index.ts
================================================================================
import type { AuthProvider } from './auth';

// --- Domain Models ---

export interface Document {
  title: string;
  url: string;
  type: 'pdf' | 'doc' | 'docx' | 'xls' | 'xlsx' | 'ppt' | 'pptx' | 'txt' | 'zip';
  size: string;
}

export type MediaType = 'image' | 'video' | 'document' | 'link' | 'text' | 'youtube' | 'twitter' | 'linkedin' | 'instagram' | 'tiktok' | 'rich';

export interface PreviewMetadata {
  url: string;
  finalUrl?: string;
  providerName?: string;
  siteName?: string;
  title?: string;
  description?: string;
  imageUrl?: string;
  faviconUrl?: string;
  authorName?: string;
  publishDate?: string;
  mediaType?: MediaType;
}

export interface NuggetMedia {
  type: MediaType;
  url: string;
  thumbnail_url?: string;
  aspect_ratio?: string;
  filename?: string;
  previewMetadata?: PreviewMetadata;
}

export interface Engagement {
  likes: number;
  bookmarks: number;
  shares: number;
  views: number;
}

export interface Contributor {
  userId: string;
  name: string;
  username?: string;
  avatarUrl?: string;
  addedAt?: string;
}

export interface DisplayAuthor {
  name: string;
  avatarUrl?: string;
}

export interface Article {
  id: string;
  title: string;
  excerpt: string;
  content: string;
  author: {
    id: string;
    name: string;
    avatar_url?: string;
  };
  // New field for masking the real author
  displayAuthor?: DisplayAuthor;
  
  publishedAt: string; // ISO date string
  categories: string[]; 
  tags: string[];
  readTime: number; 
  visibility?: 'public' | 'private';
  
  // Media
  media?: NuggetMedia | null;
  // Legacy fields
  images?: string[]; 
  video?: string; 
  documents?: Document[]; 
  themes?: string[]; 

  // System
  created_at?: string;
  updated_at?: string;
  engagement?: Engagement;
  source_type?: string; // 'link' | 'video' | 'note' | 'idea' | etc
  
  // Contextual
  addedBy?: Contributor; // When inside a collection
}

// Alias
export type Nugget = Article;

export interface User {
  id: string;
  name: string; // Display Name
  username?: string; // Added for auth
  email: string;
  role: 'admin' | 'user';
  status: 'active' | 'blocked';
  joinedAt: string;
  
  // Auth Specific
  authProvider?: AuthProvider;
  emailVerified?: boolean;
  phoneNumber?: string;
  avatarUrl?: string;
  
  // Extended profile fields (from ModularUser)
  pincode?: string;
  city?: string;
  country?: string;
  gender?: string;
  dateOfBirth?: string;
  website?: string;
  bio?: string;
  location?: string;
  
  preferences?: {
      interestedCategories: string[];
  };
  lastFeedVisit?: string;
}

export interface Collection {
  id: string;
  name: string;
  description: string;
  creatorId: string;
  createdAt: string;
  updatedAt?: string;
  followersCount: number;
  entries: CollectionEntry[];
  type: 'public' | 'private';
  
  // Display
  creator?: {
    id: string;
    name: string;
    avatar?: string;
  };
}

export interface CollectionEntry {
  articleId: string;
  addedByUserId: string;
  addedAt: string;
  flaggedBy: string[];
}

// --- UI & State ---

export type Theme = 'light' | 'dark';
export type SortOrder = 'latest' | 'oldest';

export interface FilterState {
  query: string;
  categories: string[];
  tag: string | null;
  sort: SortOrder;
  limit?: number;
}






================================================================================
FILE: src\types\legal.ts
================================================================================
export type LegalPageSlug = 'about' | 'terms' | 'privacy' | 'contact' | 'guidelines' | 'disclaimer' | 'cookie-policy';

export interface LegalPage {
  id: LegalPageSlug;
  title: string;
  slug: string;
  content: string;
  isEnabled: boolean;
  lastUpdated: string;
}

export interface LegalConfig {
  pages: Record<LegalPageSlug, LegalPage>;
}





================================================================================
FILE: src\types\settings.ts
================================================================================
export interface UserPreferences {
  defaultVisibility: 'public' | 'private';
  compactMode: boolean;
  richMediaPreviews: boolean;
  autoFollowCollections: boolean;
  theme?: 'light' | 'dark' | 'system';
  interestedCategories?: string[];
  notifications?: {
    emailDigest?: boolean;
    productUpdates?: boolean;
    newFollowers?: boolean;
  };
}

export interface ProfileFormData {
  displayName: string;
  username: string;
  bio: string;
  phoneNumber: string;
  avatarColor?: string;
  // Future fields
  location?: string;
  website?: string;
}

export type AvatarColor = 'blue' | 'green' | 'purple' | 'amber' | 'rose' | 'teal' | 'indigo' | 'slate';

export const AVATAR_COLORS: { [key in AvatarColor]: string } = {
  blue: 'bg-blue-500',
  green: 'bg-green-500',
  purple: 'bg-purple-500',
  amber: 'bg-amber-500',
  rose: 'bg-rose-500',
  teal: 'bg-teal-500',
  indigo: 'bg-indigo-500',
  slate: 'bg-slate-500',
};





================================================================================
FILE: src\types\user.ts
================================================================================

export type UserRole = 'admin' | 'user';
export type ThemePreference = 'light' | 'dark' | 'system';
export type Visibility = 'public' | 'private';
export type AvatarColor = 'blue' | 'green' | 'purple' | 'amber' | 'rose' | 'teal' | 'indigo' | 'slate';

export interface UserAuth {
  readonly email: string;
  readonly emailVerified: boolean;
  readonly provider: 'email' | 'google' | 'linkedin';
  readonly createdAt: string; // ISO Date
  updatedAt?: string; // ISO Date
}

export interface UserProfile {
  displayName: string;
  username: string;
  bio?: string;
  avatarUrl?: string; // Custom image
  avatarColor?: AvatarColor; // Fallback color
  phoneNumber?: string;
  location?: string; // Legacy/Display
  // New Fields
  pincode?: string;
  city?: string;
  country?: string;
  gender?: string;
  dateOfBirth?: string;
  website?: string;
}

export interface UserSecurity {
  lastPasswordChangeAt?: string; // ISO Date
  mfaEnabled: boolean;
}

export interface UserPreferences {
  // General
  theme: ThemePreference;
  defaultVisibility: Visibility;
  
  // Feed & Content
  interestedCategories: string[];
  compactMode: boolean;
  richMediaPreviews: boolean;
  autoFollowCollections: boolean;
  
  // Notifications
  notifications: {
    emailDigest: boolean;
    productUpdates: boolean;
    newFollowers: boolean;
  };
}

export interface UserAppState {
  lastLoginAt?: string;
  onboardingCompleted: boolean;
  featureFlags?: Record<string, boolean>;
}

// The Modular User Aggregate
export interface User {
  readonly id: string;
  readonly role: UserRole; // Critical for routing
  
  auth: UserAuth;
  profile: UserProfile;
  security: UserSecurity;
  preferences: UserPreferences;
  appState: UserAppState;
}





================================================================================
FILE: src\types\userSettingsForms.ts
================================================================================
import { AvatarColor, Visibility, ThemePreference } from './user';

export interface ProfileFormValues {
  displayName: string;
  username: string;
  bio: string;
  phoneNumber: string;
  avatarColor: AvatarColor;
  location: string;
  website: string;
}

export interface PreferencesFormValues {
  theme: ThemePreference;
  defaultVisibility: Visibility;
  compactMode: boolean;
  richMediaPreviews: boolean;
  autoFollowCollections: boolean;
}

// Security form is often separate due to sensitive fields
export interface PasswordFormValues {
  currentPassword: string;
  newPassword: string;
  confirmPassword: string;
}









================================================================================
FILE: src\utils\formatters.ts
================================================================================
export const formatDate = (isoString: string, includeTime: boolean = true): string => {
  if (!isoString) return '';
  
  try {
    const date = new Date(isoString);
    
    // Check for Invalid Date
    if (isNaN(date.getTime())) {
        return '';
    }
    
    const day = date.getDate();
    const month = date.toLocaleString('en-US', { month: 'short' });
    const year = date.getFullYear().toString().slice(-2); // Get last 2 digits of year
    
    if (!includeTime) {
        return `${day} ${month} '${year}`;
    }

    const time = date.toLocaleString('en-US', { 
        hour: 'numeric', 
        minute: 'numeric', 
        hour12: true 
    });

    // Returns: "6:12 PM • 25 Nov '25"
    return `${time} • ${day} ${month} '${year}`;
  } catch (e) {
    console.error("Error formatting date:", isoString, e);
    return '';
  }
};

export const getInitials = (name: string): string => {
  if (!name) return '??';
  return name
    .split(' ')
    .map(n => n[0])
    .join('')
    .substring(0, 2)
    .toUpperCase();
};

export const normalizeCategoryLabel = (input: string): string => {
  let cleaned = input.trim();
  if (!cleaned) return '';
  
  // Remove existing hash to re-add it cleanly
  cleaned = cleaned.replace(/^#/, '');
  
  // Title Case
  cleaned = cleaned
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
    
  return `#${cleaned}`;
};









================================================================================
FILE: src\utils\themes.ts
================================================================================
export const THEMES = {
  violet: {
    50: '#f5f3ff',
    100: '#ede9fe',
    200: '#ddd6fe',
    300: '#c4b5fd',
    400: '#a78bfa',
    500: '#8b5cf6',
    600: '#7c3aed',
    700: '#6d28d9',
    800: '#5b21b6',
    900: '#4c1d95',
  },
  blue: {
    50: '#eff6ff',
    100: '#dbeafe',
    200: '#bfdbfe',
    300: '#93c5fd',
    400: '#60a5fa',
    500: '#3b82f6',
    600: '#2563eb',
    700: '#1d4ed8',
    800: '#1e40af',
    900: '#1e3a8a',
  },
  rose: {
    50: '#fff1f2',
    100: '#ffe4e6',
    200: '#fecdd3',
    300: '#fda4af',
    400: '#fb7185',
    500: '#f43f5e',
    600: '#e11d48',
    700: '#be123c',
    800: '#9f1239',
    900: '#881337',
  },
  amber: {
    50: '#fffbeb',
    100: '#fef3c7',
    200: '#fde68a',
    300: '#fcd34d',
    400: '#fbbf24',
    500: '#f59e0b',
    600: '#d97706',
    700: '#b45309',
    800: '#92400e',
    900: '#78350f',
  },
  teal: {
    50: '#f0fdfa',
    100: '#ccfbf1',
    200: '#99f6e4',
    300: '#5eead4',
    400: '#2dd4bf',
    500: '#14b8a6',
    600: '#0d9488',
    700: '#0f766e',
    800: '#115e59',
    900: '#134e4a',
  },
};

export type ThemeKey = keyof typeof THEMES;









================================================================================
FILE: src\utils\urlUtils.ts
================================================================================
import { MediaType } from '@/types';

export const isValidUrl = (urlString: string): boolean => {
  try {
    const url = new URL(urlString);
    return url.protocol === "http:" || url.protocol === "https:";
  } catch (e) {
    return false;
  }
};

export const detectProviderFromUrl = (url: string): MediaType => {
  if (!isValidUrl(url)) return 'link';
  
  try {
    const hostname = new URL(url).hostname.toLowerCase();
    
    if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) return 'youtube';
    if (hostname.includes('twitter.com') || hostname.includes('x.com')) return 'twitter';
    if (hostname.includes('linkedin.com')) return 'linkedin';
    if (hostname.includes('instagram.com')) return 'instagram';
    if (hostname.includes('tiktok.com')) return 'tiktok';
    
    // Simple image extension check
    if (/\.(jpeg|jpg|gif|png|webp|bmp|svg)$/i.test(url)) return 'image';

    return 'link';
  } catch (e) {
    return 'link';
  }
};

export const getProviderFromUrl = detectProviderFromUrl; // Alias for backward compatibility

export const getYoutubeId = (url: string): string | null => {
  if (!isValidUrl(url)) return null;
  try {
    // Handle both youtube.com/watch?v= and youtu.be/
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  } catch (e) {
    return null;
  }
};

export const getTweetId = (url: string): string | null => {
  if (!isValidUrl(url)) return null;
  try {
    const match = url.match(/(?:twitter|x)\.com\/\w+\/status\/(\d+)/);
    return match ? match[1] : null;
  } catch (e) {
    return null;
  }
};







================================================================================
FILE: src\vite-env.d.ts
================================================================================
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_URL?: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}






================================================================================
FILE: package.json
================================================================================
{
  "name": "nuggets_v60",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.32.0",
    "@tanstack/react-query": "^5.90.12",
    "@vitejs/plugin-react": "^5.1.2",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "lucide-react": "^0.556.0",
    "morgan": "^1.10.1",
    "papaparse": "^5.5.3",
    "path": "^0.12.7",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-router-dom": "^7.10.1",
    "url": "^0.11.4",
    "vite": "^7.2.7",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@types/papaparse": "^5.5.1",
    "@types/react": "^19.2.0",
    "@types/react-dom": "^19.2.0",
    "@vitejs/plugin-react": "^5.0.0",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.47",
    "tailwindcss": "^3.4.13",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}





================================================================================
FILE: tsconfig.json
================================================================================

{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "moduleResolution": "bundler",
    "jsx": "react-jsx",
    "allowJs": false,
    "strict": true,
    "noImplicitAny": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "isolatedModules": true,
    "skipLibCheck": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*", "src/vite-env.d.ts"],
  "exclude": ["node_modules", "server", "dist"]
}





================================================================================
FILE: vite.config.ts
================================================================================

import path from 'path';
import { fileURLToPath } from 'url';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, '.', '');

  return {
    server: {
      port: 3000,
      host: '0.0.0.0',
      proxy: {
        '/api': {
          target: 'http://localhost:5000',
          changeOrigin: true,
        },
      },
    },
    plugins: [react()],
    define: {
      // SECURITY UPDATE: Removed API_KEY injection. 
      // The frontend should NOT have access to secrets.
      'process.env.REACT_APP_VERSION': JSON.stringify(process.env.npm_package_version),
    },
    resolve: {
      alias: {
        '@': path.resolve(__dirname, 'src'),
      },
    },
  };
});





================================================================================
FILE: tailwind.config.js
================================================================================
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class',
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#fffbea',
          100: '#fff5c8',
          200: '#ffea96',
          300: '#fde047',
          400: '#facc15',
          500: '#eab308',
          600: '#ca8a04',
          700: '#a16207',
          800: '#854d0e',
          900: '#713f12',
        }
      }
    }
  },
  plugins: [],
}










================================================================================
FILE: postcss.config.js
================================================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}










================================================================================
FILE: index.html
================================================================================

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuggets</title>
  </head>
  <body class="bg-slate-100 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-200">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>




